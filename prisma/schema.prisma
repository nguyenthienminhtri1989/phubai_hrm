// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. Bảng Nhà Máy
model Factory {
  id          Int          @id @default(autoincrement())
  code        String       @unique
  name        String
  departments Department[] // Quan hệ ngược: 1 nhà máy có nhiều phòng

  // --- BỔ SUNG DÒNG NÀY VÀO ---
  kips        Kip[]        // Quan hệ ngược: 1 nhà máy có nhiều Kíp
}

// 2. Kíp (BẢNG MỚI - Định nghĩa Kíp 1 -> Kíp 10)
model Kip {
  id   Int    @id @default(autoincrement())
  name String // "Kíp 1", "Kíp 2", ..., "Kíp 10"
  
  // Liên kết với Nhà máy (Vì Kíp 1 nhà máy 2 khác Kíp 1 nhà máy 3)
  factoryId Int
  factory   Factory @relation(fields: [factoryId], references: [id])
  
  employees Employee[] // 1 Kíp có nhiều nhân viên
}

// 2. Bảng Phòng Ban - Công đoạn
model Department {
  id        Int        @id @default(autoincrement())
  code      String     @unique
  name      String     // Tên hiển thị: "Sợi con", "Bông chải"

  // --- THÊM CỘT NÀY ---
  // true: Là bộ phận sản xuất theo Kíp (Kíp 1, Kíp 2...)
  // false: Là bộ phận hành chính/phụ trợ (Bảo trì, Kho...)
  isKip     Boolean  @default(false) 
  // --------------------
  
  // Khóa ngoại liên kết nhà máy
  factoryId Int      
  factory   Factory   @relation(fields: [factoryId], references: [id])
  employees Employee[] // Quan hệ ngược: 1 phòng có nhiều nhân viên
  // Thêm dòng này: Những user nào quản lý phòng này?
  managers User[]
  // --> THÊM DÒNG NÀY VÀO:
  timesheetLocks TimesheetLock[]
}

// 3. Bảng Nhân Viên
model Employee {
  id         Int        @id @default(autoincrement())
  code       String     @unique // Mã NV nhập tay/import
  fullName   String
  birthday   DateTime?
  gender     String?
  address    String?
  phone      String?
  position   String?    // Nhập tay thoải mái
  
  // Khóa ngoại liên kết phòng ban
  departmentId Int
  department   Department @relation(fields: [departmentId], references: [id])
  // Thêm dòng này vào model Employee cũ của bạn

  // --- MỚI: THÊM CÁI NÀY ĐỂ LỌC ---
  kipId        Int?     // Cho phép NULL (để ông Bảo trì/Văn phòng không cần điền)
  kip          Kip?     @relation(fields: [kipId], references: [id])
  // --------------------------------
  timesheets Timesheet[]
}

// 1. Bảng định nghĩa các loại công (X, F, Ô...)
model AttendanceCode {
  id          Int      @id @default(autoincrement())
  code        String   @unique // Ví dụ: X, F, XD
  name        String   // Ví dụ: Đi làm, Nghỉ phép
  
  // Nhóm chế độ (Lương thời gian, Ốm, Thai sản...)
  category    String   
  
  // Hệ số: Thêm dấu ? để không bắt buộc nhập lúc này
  factor      Float?   
  
  color       String?  // Màu sắc (để ? luôn cho thoải mái, nhập sau cũng được)
  description String?  
  
  // Mối quan hệ ngược: Một loại công link tới NHIỀU dòng chấm công
  timesheets  Timesheet[]
}

// 2. Bảng chấm công hàng ngày
model Timesheet {
  id               Int      @id @default(autoincrement())
  date             DateTime // Ngày chấm công
  
  // Liên kết với Nhân viên
  employeeId       Int
  employee         Employee @relation(fields: [employeeId], references: [id])
  
  // Liên kết với Loại công
  attendanceCodeId Int
  attendanceCode   AttendanceCode @relation(fields: [attendanceCodeId], references: [id])
  
  note             String? // Ghi chú (VD: Đi muộn 30p)
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Đảm bảo 1 nhân viên trong 1 ngày chỉ có 1 dòng chấm công
  @@unique([employeeId, date], name: "employeeId_date")
}

// 1. Thêm Enum cho các Vai trò (Role)
enum Role {
  ADMIN       // Quản trị hệ thống cao nhất
  HR_MANAGER  // Quản lý nhân sự (Sửa danh mục, xem tất cả)
  LEADER      // Lãnh đạo (Chỉ xem)
  TIMEKEEPER  // Người chấm công (Chỉ được chấm các phòng được giao)
}

// 2. Thêm bảng User
model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique // Dùng tên đăng nhập (vd: to1, admin) thay vì email
  password  String   // Mật khẩu đã mã hóa
  fullName  String?
  role      Role     @default(TIMEKEEPER)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Quan hệ Nhiều-Nhiều: Một User quản lý nhiều Phòng ban
  managedDepartments Department[] 
}

// Bảng lưu trạng thái khóa sổ chấm công
model TimesheetLock {
  id           Int      @id @default(autoincrement())
  departmentId Int
  department   Department @relation(fields: [departmentId], references: [id])
  month        Int      // Tháng (1-12)
  year         Int      // Năm (2025)
  isLocked     Boolean  @default(false)
  
  lockedBy     String?  // Ai là người khóa (lưu username)
  updatedAt    DateTime @updatedAt

  // --- SỬA DÒNG NÀY ---
  // Thêm name: "departmentId_month_year" để khớp với code API
  @@unique([departmentId, month, year], name: "departmentId_month_year")
}

