--- PROJECT SOURCE CODE ---



================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\package.json
================================================================================
{
  "name": "phubai-hrm",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "prisma": {
    "seed": "ts-node --compiler-options {\"module\":\"CommonJS\"} prisma/seed.ts"
  },
  "dependencies": {
    "@ant-design/cssinjs": "^2.0.1",
    "@ant-design/icons": "^6.1.0",
    "@prisma/client": "^5.22.0",
    "antd": "^6.1.1",
    "bcryptjs": "^3.0.3",
    "dayjs": "^1.11.19",
    "exceljs": "^4.4.0",
    "file-saver": "^2.0.5",
    "next": "16.0.10",
    "next-auth": "^5.0.0-beta.30",
    "react": "19.2.1",
    "react-dom": "19.2.1",
    "recharts": "^3.6.0"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/bcryptjs": "^2.4.6",
    "@types/file-saver": "^2.0.7",
    "@types/node": "^20.19.27",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.0.10",
    "prisma": "^5.22.0",
    "tailwindcss": "^4",
    "ts-node": "^10.9.2",
    "typescript": "^5.9.3"
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\package.json ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\prisma\schema.prisma
================================================================================
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. B·∫£ng Nh√† M√°y
model Factory {
  id          Int          @id @default(autoincrement())
  code        String       @unique
  name        String
  departments Department[] // Quan h·ªá ng∆∞·ª£c: 1 nh√† m√°y c√≥ nhi·ªÅu ph√≤ng

  // --- B·ªî SUNG D√íNG N√ÄY V√ÄO ---
  kips        Kip[]        // Quan h·ªá ng∆∞·ª£c: 1 nh√† m√°y c√≥ nhi·ªÅu K√≠p
}

// 2. K√≠p (B·∫¢NG M·ªöI - ƒê·ªãnh nghƒ©a K√≠p 1 -> K√≠p 10)
model Kip {
  id   Int    @id @default(autoincrement())
  name String // "K√≠p 1", "K√≠p 2", ..., "K√≠p 10"
  
  // Li√™n k·∫øt v·ªõi Nh√† m√°y (V√¨ K√≠p 1 nh√† m√°y 2 kh√°c K√≠p 1 nh√† m√°y 3)
  factoryId Int
  factory   Factory @relation(fields: [factoryId], references: [id])
  
  employees Employee[] // 1 K√≠p c√≥ nhi·ªÅu nh√¢n vi√™n
}

// 2. B·∫£ng Ph√≤ng Ban - C√¥ng ƒëo·∫°n
model Department {
  id        Int        @id @default(autoincrement())
  code      String     @unique
  name      String     // T√™n hi·ªÉn th·ªã: "S·ª£i con", "B√¥ng ch·∫£i"

  // --- TH√äM C·ªòT N√ÄY ---
  // true: L√† b·ªô ph·∫≠n s·∫£n xu·∫•t theo K√≠p (K√≠p 1, K√≠p 2...)
  // false: L√† b·ªô ph·∫≠n h√†nh ch√≠nh/ph·ª• tr·ª£ (B·∫£o tr√¨, Kho...)
  isKip     Boolean  @default(false) 
  // --------------------
  
  // Kh√≥a ngo·∫°i li√™n k·∫øt nh√† m√°y
  factoryId Int      
  factory   Factory   @relation(fields: [factoryId], references: [id])
  employees Employee[] // Quan h·ªá ng∆∞·ª£c: 1 ph√≤ng c√≥ nhi·ªÅu nh√¢n vi√™n
  // Th√™m d√≤ng n√†y: Nh·ªØng user n√†o qu·∫£n l√Ω ph√≤ng n√†y?
  managers User[]
  // --> TH√äM D√íNG N√ÄY V√ÄO:
  timesheetLocks TimesheetLock[]
}

// 3. B·∫£ng Nh√¢n Vi√™n
model Employee {
  id         Int        @id @default(autoincrement())
  code       String     @unique // M√£ NV nh·∫≠p tay/import
  fullName   String
  birthday   DateTime?
  gender     String?
  address    String?
  phone      String?
  position   String?    // Nh·∫≠p tay tho·∫£i m√°i
  
  // Kh√≥a ngo·∫°i li√™n k·∫øt ph√≤ng ban
  departmentId Int
  department   Department @relation(fields: [departmentId], references: [id])
  // Th√™m d√≤ng n√†y v√†o model Employee c≈© c·ªßa b·∫°n

  // --- M·ªöI: TH√äM C√ÅI N√ÄY ƒê·ªÇ L·ªåC ---
  kipId        Int?     // Cho ph√©p NULL (ƒë·ªÉ √¥ng B·∫£o tr√¨/VƒÉn ph√≤ng kh√¥ng c·∫ßn ƒëi·ªÅn)
  kip          Kip?     @relation(fields: [kipId], references: [id])
  // --------------------------------
  timesheets Timesheet[]
}

// 1. B·∫£ng ƒë·ªãnh nghƒ©a c√°c lo·∫°i c√¥ng (X, F, √î...)
model AttendanceCode {
  id          Int      @id @default(autoincrement())
  code        String   @unique // V√≠ d·ª•: X, F, XD
  name        String   // V√≠ d·ª•: ƒêi l√†m, Ngh·ªâ ph√©p
  
  // Nh√≥m ch·∫ø ƒë·ªô (L∆∞∆°ng th·ªùi gian, ·ªêm, Thai s·∫£n...)
  category    String   
  
  // H·ªá s·ªë: Th√™m d·∫•u ? ƒë·ªÉ kh√¥ng b·∫Øt bu·ªôc nh·∫≠p l√∫c n√†y
  factor      Float?   
  
  color       String?  // M√†u s·∫Øc (ƒë·ªÉ ? lu√¥n cho tho·∫£i m√°i, nh·∫≠p sau c≈©ng ƒë∆∞·ª£c)
  description String?  
  
  // M·ªëi quan h·ªá ng∆∞·ª£c: M·ªôt lo·∫°i c√¥ng link t·ªõi NHI·ªÄU d√≤ng ch·∫•m c√¥ng
  timesheets  Timesheet[]
}

// 2. B·∫£ng ch·∫•m c√¥ng h√†ng ng√†y
model Timesheet {
  id               Int      @id @default(autoincrement())
  date             DateTime // Ng√†y ch·∫•m c√¥ng
  
  // Li√™n k·∫øt v·ªõi Nh√¢n vi√™n
  employeeId       Int
  employee         Employee @relation(fields: [employeeId], references: [id])
  
  // Li√™n k·∫øt v·ªõi Lo·∫°i c√¥ng
  attendanceCodeId Int
  attendanceCode   AttendanceCode @relation(fields: [attendanceCodeId], references: [id])
  
  note             String? // Ghi ch√∫ (VD: ƒêi mu·ªôn 30p)
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // ƒê·∫£m b·∫£o 1 nh√¢n vi√™n trong 1 ng√†y ch·ªâ c√≥ 1 d√≤ng ch·∫•m c√¥ng
  @@unique([employeeId, date], name: "employeeId_date")
}

// 1. Th√™m Enum cho c√°c Vai tr√≤ (Role)
enum Role {
  ADMIN       // Qu·∫£n tr·ªã h·ªá th·ªëng cao nh·∫•t
  HR_MANAGER  // Qu·∫£n l√Ω nh√¢n s·ª± (S·ª≠a danh m·ª•c, xem t·∫•t c·∫£)
  LEADER      // L√£nh ƒë·∫°o (Ch·ªâ xem)
  TIMEKEEPER  // Ng∆∞·ªùi ch·∫•m c√¥ng (Ch·ªâ ƒë∆∞·ª£c ch·∫•m c√°c ph√≤ng ƒë∆∞·ª£c giao)
}

// 2. Th√™m b·∫£ng User
model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique // D√πng t√™n ƒëƒÉng nh·∫≠p (vd: to1, admin) thay v√¨ email
  password  String   // M·∫≠t kh·∫©u ƒë√£ m√£ h√≥a
  fullName  String?
  role      Role     @default(TIMEKEEPER)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Quan h·ªá Nhi·ªÅu-Nhi·ªÅu: M·ªôt User qu·∫£n l√Ω nhi·ªÅu Ph√≤ng ban
  managedDepartments Department[] 
}

// B·∫£ng l∆∞u tr·∫°ng th√°i kh√≥a s·ªï ch·∫•m c√¥ng
model TimesheetLock {
  id           Int      @id @default(autoincrement())
  departmentId Int
  department   Department @relation(fields: [departmentId], references: [id])
  month        Int      // Th√°ng (1-12)
  year         Int      // NƒÉm (2025)
  isLocked     Boolean  @default(false)
  
  lockedBy     String?  // Ai l√† ng∆∞·ªùi kh√≥a (l∆∞u username)
  updatedAt    DateTime @updatedAt

  // --- S·ª¨A D√íNG N√ÄY ---
  // Th√™m name: "departmentId_month_year" ƒë·ªÉ kh·ªõp v·ªõi code API
  @@unique([departmentId, month, year], name: "departmentId_month_year")
}



--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\prisma\schema.prisma ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\prisma\seed.ts
================================================================================
// prisma/seed.ts
import { PrismaClient, Role } from "@prisma/client";
import * as bcrypt from "bcryptjs"; // Import th∆∞ vi·ªán m√£ h√≥a

const prisma = new PrismaClient();

// ƒê·ªãnh nghƒ©a d·ªØ li·ªáu c√°c lo·∫°i c√¥ng
const attendanceCodes = [
  // --- NH√ìM 1: L∆Ø∆†NG TH·ªúI GIAN (ƒêi l√†m, C√¥ng t√°c...) ---
  {
    code: "X",
    name: "ƒêi l√†m b√¨nh th∆∞·ªùng",
    category: "TIME_WORK",
    color: "#22c55e",
  }, // Xanh l√°
  { code: "XD", name: "L√†m ca 3", category: "TIME_WORK", color: "#15803d" }, // Xanh ƒë·∫≠m
  {
    code: "Lƒê",
    name: "Lao ƒë·ªông nghƒ©a v·ª•",
    category: "TIME_WORK",
    color: "#0ea5e9",
  }, // Xanh d∆∞∆°ng ƒë·∫≠m (ƒê√£ s·ª≠a Lƒê)
  {
    code: "LD",
    name: "L√†m ca 3 ng√†y l·ªÖ",
    category: "TIME_WORK",
    color: "#7e22ce",
  }, // T√≠m ƒë·∫≠m (ƒê√£ s·ª≠a LD)
  {
    code: "XL",
    name: "ƒêi l√†m ng√†y l·ªÖ",
    category: "TIME_WORK",
    color: "#a855f7",
  }, // T√≠m
  {
    code: "LE",
    name: "C√¥ng ƒëi l√†m ng√†y l·ªÖ",
    category: "TIME_WORK",
    color: "#9333ea",
  }, // T√≠m
  { code: "CT", name: "ƒêi c√¥ng t√°c", category: "TIME_WORK", color: "#06b6d4" }, // Cyan

  // --- NH√ìM 2: NGH·ªà H∆Ø·ªûNG 100% L∆Ø∆†NG (Ph√©p, L·ªÖ...) ---
  {
    code: "F",
    name: "Ngh·ªâ ph√©p nƒÉm",
    category: "PAID_LEAVE",
    color: "#3b82f6",
  }, // Xanh d∆∞∆°ng
  { code: "L", name: "Ngh·ªâ l·ªÖ", category: "PAID_LEAVE", color: "#f97316" }, // Cam
  {
    code: "R",
    name: "Ngh·ªâ ch·∫ø ƒë·ªô (Hi·∫øu/H·ªâ)",
    category: "PAID_LEAVE",
    color: "#60a5fa",
  }, // Xanh d∆∞∆°ng nh·∫°t
  { code: "B", name: "Ngh·ªâ b√£o l≈©", category: "PAID_LEAVE", color: "#64748b" }, // X√°m xanh
  { code: "ƒêC", name: "Ngh·ªâ ƒë·∫£o ca", category: "PAID_LEAVE", color: "#94a3b8" }, // X√°m nh·∫°t

  // --- NH√ìM 3: CH·∫æ ƒê·ªò ·ªêM / TAI N·∫†N (BHXH chi tr·∫£ ho·∫∑c L∆∞∆°ng cty) ---
  { code: "√î", name: "Ngh·ªâ ·ªëm", category: "SICK", color: "#eab308" }, // V√†ng
  { code: "C√î", name: "Ngh·ªâ con ·ªëm", category: "SICK", color: "#fbbf24" }, // V√†ng cam
  { code: "T", name: "Tai n·∫°n lao ƒë·ªông", category: "SICK", color: "#ef4444" }, // ƒê·ªè
  { code: "DS", name: "Ngh·ªâ d∆∞·ª°ng s·ª©c", category: "SICK", color: "#facc15" }, // V√†ng chanh
  { code: "CL", name: "Ngh·ªâ c√°ch ly", category: "SICK", color: "#84cc16" }, // Xanh n√µn chu·ªëi

  // --- NH√ìM 4: THAI S·∫¢N ---
  {
    code: "TS",
    name: "Ngh·ªâ thai s·∫£n",
    category: "MATERNITY",
    color: "#ec4899",
  }, // H·ªìng

  // --- NH√ìM 5: KH√îNG L∆Ø∆†NG ---
  {
    code: "RO",
    name: "Ngh·ªâ kh√¥ng l∆∞∆°ng",
    category: "UNPAID",
    color: "#d1d5db",
  }, // X√°m tr·∫Øng

  // --- NH√ìM 6: NGH·ªà V√î L√ù DO (K·ª∑ lu·∫≠t) ---
  { code: "O", name: "Ngh·ªâ v√¥ l√Ω do", category: "AWOL", color: "#000000" }, // ƒêen
];

async function main() {
  console.log("üå± B·∫Øt ƒë·∫ßu n·∫°p d·ªØ li·ªáu k√Ω hi·ªáu ch·∫•m c√¥ng...");

  for (const item of attendanceCodes) {
    // D√πng upsert: N·∫øu c√≥ code r·ªìi th√¨ update, ch∆∞a c√≥ th√¨ create (Tr√°nh l·ªói tr√πng)
    await prisma.attendanceCode.upsert({
      where: { code: item.code },
      update: item,
      create: item,
    });
  }

  // T·∫†O USER ADMIN
  const hashedPassword = await bcrypt.hash("150489", 10); // M·∫≠t kh·∫©u l√† 150489

  const admin = await prisma.user.upsert({
    where: { username: "admin" },
    update: {},
    create: {
      username: "admin",
      password: hashedPassword,
      fullName: "Qu·∫£n tr·ªã vi√™n",
      role: Role.ADMIN,
    },
  });

  // T·∫†O USER TR∆Ø·ªûNG PH√íNG ƒêI·ªÜN (Qu·∫£n l√Ω Ph√≤ng ƒêi·ªán NM1 v√† NM3)
  const tpDien = await prisma.user.upsert({
    where: { username: "truongca1" },
    update: {},
    create: {
      username: "tpdien",
      password: hashedPassword,
      fullName: "Tr∆∞·ªüng Ph√≤ng ƒêi·ªán",
      role: Role.TIMEKEEPER,
      managedDepartments: {
        connect: [{ id: 19 }, { id: 74 }], // K·∫øt n·ªëi v·ªõi 2 ph√≤ng ban
      },
    },
  });

  console.log("‚úÖ ƒê√£ n·∫°p xong danh m·ª•c ch·∫•m c√¥ng!");
  console.log({ admin, tpDien });
}

main()
  .then(async () => {
    await prisma.$disconnect();
  })
  .catch(async (e) => {
    console.error(e);
    await prisma.$disconnect();
    process.exit(1);
  });


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\prisma\seed.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\admin\users\page.tsx
================================================================================
"use client";

import React, { useEffect, useState } from "react";
import AdminLayout from "@/components/AdminLayout";
import {
  Table,
  Button,
  Modal,
  Form,
  Input,
  Select,
  Tag,
  message,
  Popconfirm,
  Space,
  Tooltip,
} from "antd";
import {
  UserAddOutlined,
  DeleteOutlined,
  EditOutlined,
} from "@ant-design/icons";
import { useSession } from "next-auth/react";

const ROLES = [
  { value: "ADMIN", label: "Qu·∫£n tr·ªã h·ªá th·ªëng (Admin)", color: "red" },
  { value: "HR_MANAGER", label: "Qu·∫£n l√Ω nh√¢n s·ª±", color: "blue" },
  { value: "LEADER", label: "L√£nh ƒë·∫°o (Xem b√°o c√°o)", color: "purple" },
  { value: "TIMEKEEPER", label: "Ng∆∞·ªùi ch·∫•m c√¥ng", color: "green" },
];

export default function UserManagementPage() {
  const { data: session } = useSession();
  const [users, setUsers] = useState<any[]>([]);
  const [departments, setDepartments] = useState<any[]>([]);
  const [loading, setLoading] = useState(false);

  // State qu·∫£n l√Ω Modal
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingUser, setEditingUser] = useState<any>(null); // null = Ch·∫ø ƒë·ªô Th√™m, c√≥ object = Ch·∫ø ƒë·ªô S·ª≠a

  const [form] = Form.useForm();
  const selectedRole = Form.useWatch("role", form);

  // 1. T·∫£i d·ªØ li·ªáu
  const fetchData = async () => {
    setLoading(true);
    try {
      const [userRes, deptRes] = await Promise.all([
        fetch("/api/users"),
        fetch("/api/departments"),
      ]);
      if (userRes.ok) setUsers(await userRes.json());
      if (deptRes.ok) setDepartments(await deptRes.json());
    } catch (error) {
      message.error("L·ªói t·∫£i d·ªØ li·ªáu");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
  }, []);

  // 2. M·ªü Modal ·ªü ch·∫ø ƒë·ªô TH√äM M·ªöI
  const handleOpenAdd = () => {
    setEditingUser(null); // X√≥a user ƒëang s·ª≠a
    form.resetFields(); // X√≥a tr·∫Øng form
    form.setFieldValue("role", "TIMEKEEPER"); // M·∫∑c ƒë·ªãnh role
    setIsModalOpen(true);
  };

  // 3. M·ªü Modal ·ªü ch·∫ø ƒë·ªô S·ª¨A
  const handleOpenEdit = (record: any) => {
    setEditingUser(record);
    // ƒê·ªï d·ªØ li·ªáu c≈© v√†o form
    form.setFieldsValue({
      username: record.username,
      fullName: record.fullName,
      role: record.role,
      // Map danh s√°ch object ph√≤ng ban th√†nh m·∫£ng ID: [1, 3]
      departmentIds: record.managedDepartments.map((d: any) => d.id),
      password: "", // M·∫≠t kh·∫©u ƒë·ªÉ tr·ªëng (ch·ªâ nh·∫≠p n·∫øu mu·ªën ƒë·ªïi)
    });
    setIsModalOpen(true);
  };

  // 4. X·ª≠ l√Ω L∆∞u (Chung cho c·∫£ Th√™m v√† S·ª≠a)
  const handleSubmit = async () => {
    try {
      const values = await form.validateFields();

      // N·∫øu l√† S·ª≠a -> PUT, N·∫øu l√† Th√™m -> POST
      const url = editingUser ? `/api/users/${editingUser.id}` : "/api/users";
      const method = editingUser ? "PUT" : "POST";

      const res = await fetch(url, {
        method: method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(values),
      });

      if (res.ok) {
        message.success(
          editingUser ? "C·∫≠p nh·∫≠t th√†nh c√¥ng!" : "T·∫°o t√†i kho·∫£n th√†nh c√¥ng!"
        );
        setIsModalOpen(false);
        fetchData(); // T·∫£i l·∫°i b·∫£ng
      } else {
        const err = await res.json();
        message.error(err.error || "C√≥ l·ªói x·∫£y ra");
      }
    } catch (error) {
      console.log(error);
    }
  };

  // 5. X·ª≠ l√Ω X√≥a
  const handleDelete = async (id: number) => {
    const res = await fetch(`/api/users/${id}`, { method: "DELETE" });
    if (res.ok) {
      message.success("ƒê√£ x√≥a user");
      fetchData();
    } else {
      const err = await res.json();
      message.error(err.error);
    }
  };

  const columns = [
    {
      title: "T√†i kho·∫£n",
      dataIndex: "username",
      key: "username",
      render: (text: string) => <b>{text}</b>,
    },
    {
      title: "H·ªç v√† t√™n",
      dataIndex: "fullName",
      key: "fullName",
    },
    {
      title: "Vai tr√≤",
      dataIndex: "role",
      key: "role",
      render: (role: string) => {
        const r = ROLES.find((i) => i.value === role);
        return <Tag color={r?.color}>{r?.label || role}</Tag>;
      },
    },
    {
      title: "Ph√≤ng ban qu·∫£n l√Ω",
      dataIndex: "managedDepartments",
      key: "depts",
      render: (depts: any[]) => (
        <div>
          {depts && depts.length > 0 ? (
            depts.map((d) => <Tag key={d.id}>{d.name}</Tag>)
          ) : (
            <span style={{ color: "#999" }}>-</span>
          )}
        </div>
      ),
    },
    {
      title: "H√†nh ƒë·ªông",
      key: "action",
      render: (_: any, record: any) => (
        <Space>
          {/* N√öT S·ª¨A */}
          <Tooltip title="S·ª≠a th√¥ng tin">
            <Button
              icon={<EditOutlined />}
              size="small"
              type="primary"
              ghost
              onClick={() => handleOpenEdit(record)}
              disabled={record.username === "admin"} // Kh√¥ng cho s·ª≠a admin g·ªëc (n·∫øu mu·ªën)
            />
          </Tooltip>

          {/* N√öT X√ìA */}
          <Popconfirm
            title="B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a?"
            onConfirm={() => handleDelete(record.id)}
            disabled={
              record.username === "admin" ||
              record.username === session?.user?.username
            }
          >
            <Button
              danger
              icon={<DeleteOutlined />}
              size="small"
              disabled={
                record.username === "admin" ||
                record.username === session?.user?.username
              }
            />
          </Popconfirm>
        </Space>
      ),
    },
  ];

  if (session?.user?.role !== "ADMIN") {
    return (
      <AdminLayout>
        <div>B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y.</div>
      </AdminLayout>
    );
  }

  return (
    <AdminLayout>
      <div
        style={{
          marginBottom: 16,
          display: "flex",
          justifyContent: "space-between",
        }}
      >
        <h2>Qu·∫£n l√Ω T√†i kho·∫£n h·ªá th·ªëng</h2>
        <Button
          type="primary"
          icon={<UserAddOutlined />}
          onClick={handleOpenAdd} // G·ªçi h√†m m·ªü modal th√™m m·ªõi
        >
          T·∫°o t√†i kho·∫£n m·ªõi
        </Button>
      </div>

      <Table
        dataSource={users}
        columns={columns}
        rowKey="id"
        loading={loading}
        bordered
      />

      <Modal
        title={editingUser ? "C·∫≠p nh·∫≠t t√†i kho·∫£n" : "T·∫°o t√†i kho·∫£n m·ªõi"}
        open={isModalOpen}
        onOk={handleSubmit}
        onCancel={() => setIsModalOpen(false)}
      >
        <Form form={form} layout="vertical">
          <Form.Item
            name="username"
            label="T√™n ƒëƒÉng nh·∫≠p"
            rules={[{ required: true }]}
          >
            {/* Khi s·ª≠a th√¨ kh√¥ng cho ƒë·ªïi Username ƒë·ªÉ tr√°nh l·ªói h·ªá th·ªëng */}
            <Input placeholder="VD: soi1_leader" disabled={!!editingUser} />
          </Form.Item>

          <Form.Item
            name="password"
            label={
              editingUser ? "M·∫≠t kh·∫©u m·ªõi (ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)" : "M·∫≠t kh·∫©u"
            }
            rules={[
              { required: !editingUser, message: "Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u" },
            ]}
          >
            <Input.Password
              placeholder={
                editingUser ? "Nh·∫≠p m·∫≠t kh·∫©u m·ªõi..." : "Nh·∫≠p m·∫≠t kh·∫©u"
              }
            />
          </Form.Item>

          <Form.Item
            name="fullName"
            label="H·ªç v√† t√™n hi·ªÉn th·ªã"
            rules={[{ required: true }]}
          >
            <Input placeholder="VD: Nguy·ªÖn VƒÉn A" />
          </Form.Item>

          <Form.Item name="role" label="Vai tr√≤" rules={[{ required: true }]}>
            <Select options={ROLES} />
          </Form.Item>

          {/* Ch·ªâ hi·ªán ch·ªçn ph√≤ng ban n·∫øu Role l√† TIMEKEEPER */}
          {selectedRole === "TIMEKEEPER" && (
            <Form.Item
              name="departmentIds"
              label="Ph√¢n quy·ªÅn ch·∫•m c√¥ng"
              rules={[
                {
                  required: true,
                  message: "Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 ph√≤ng ban",
                },
              ]}
            >
              <Select
                mode="multiple"
                placeholder="Ch·ªçn ph√≤ng ban..."
                optionFilterProp="children"
                allowClear
                style={{ width: "100%" }}
              >
                {departments.map((d) => (
                  <Select.Option key={d.id} value={d.id}>
                    {d.name} ({d.factory?.name})
                  </Select.Option>
                ))}
              </Select>
            </Form.Item>
          )}
        </Form>
      </Modal>
    </AdminLayout>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\admin\users\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\attendance-codes\route.ts
================================================================================
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

// --- L·∫•y danh s√°ch ----
export async function GET() {
  try {
    const codes = await prisma.attendanceCode.findMany({
      orderBy: { id: "asc" },
    });
    return NextResponse.json(codes);
  } catch (error) {
    return NextResponse.json(
      { error: "L·ªói t·∫£i d·ªØ li·ªáu: " + error },
      { status: 500 }
    );
  }
}

// --- Th√™m m·ªõi ---
export async function POST(request: Request) {
  try {
    const body = await request.json();
    const { code, name, category, color, factor, description } = body;

    const newCode = await prisma.attendanceCode.create({
      data: {
        code,
        name,
        category,
        color,
        factor: factor ? parseFloat(factor) : 1, // M·∫∑c ƒë·ªãnh h·ªá s·ªë 1 n·∫øu kh√¥ng nh·∫≠p
        description,
      },
    });

    return NextResponse.json(newCode);
  } catch (error) {
    return NextResponse.json(
      { error: "L·ªói th√™m m·ªõi: " + error },
      { status: 500 }
    );
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\attendance-codes\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\attendance-codes\[id]\route.ts
================================================================================
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

// --- C·∫¨P NH·∫¨T ---
export async function PATCH(
  request: Request,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const { id } = await params;
    const body = await request.json();

    // Lo·∫°i b·ªè id kh·ªèi body ƒë·ªÉ tr√°nh l·ªói update id
    const { id: _, ...dataToUpdate } = body;

    const updated = await prisma.attendanceCode.update({
      where: { id: parseInt(id) },
      data: dataToUpdate,
    });

    return NextResponse.json(updated);
  } catch (error) {
    return NextResponse.json(
      { error: "L·ªói c·∫≠p nh·∫≠t: " + error },
      { status: 500 }
    );
  }
}

// --- X√≥a ---
export async function DELETE(
  request: Request,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const { id } = await params;

    // Ki·ªÉm tra xem m√£ n√†y ƒë√£ ƒë∆∞·ª£c d√πng ch·∫•m c√¥ng ch∆∞a? N·∫øu d√πng r·ªìi th√¨ kh√¥ng cho x√≥a
    const count = await prisma.timesheet.count({
      where: { attendanceCodeId: parseInt(id) },
    });

    if (count > 0) {
      return NextResponse.json(
        { error: "Kh√¥ng th·ªÉ x√≥a v√¨ ƒë√£ c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng s·ª≠ d·ª•ng m√£ n√†y!" },
        { status: 400 }
      );
    }

    await prisma.attendanceCode.delete({
      where: { id: parseInt(id) },
    });

    return NextResponse.json({ message: "ƒê√£ x√≥a" });
  } catch (error) {
    return NextResponse.json(
      { error: "L·ªói khi x√≥a: " + error },
      { status: 500 }
    );
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\attendance-codes\[id]\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\auth\[...nextauth]\route.ts
================================================================================
import { handlers } from "@/auth"; // Import t·ª´ file auth.ts v·ª´a t·∫°o
export const { GET, POST } = handlers;


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\auth\[...nextauth]\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\dashboard\route.ts
================================================================================
// src/app/api/dashboard/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import dayjs from "dayjs";

export async function GET(request: Request) {
  try {
    const { searchParams } = new URL(request.url);
    const factoryId = searchParams.get("factoryId"); // L·ªçc theo nh√† m√°y (n·∫øu c√≥)
    const dateStr = searchParams.get("date");

    // M·∫∑c ƒë·ªãnh l√† h√¥m nay
    const date = dateStr ? new Date(dateStr) : new Date();

    // X√°c ƒë·ªãnh kho·∫£ng th·ªùi gian c·ªßa ng√†y ƒë√≥ (00:00 -> 23:59)
    const startOfDay = dayjs(date).startOf("day").toDate();
    const endOfDay = dayjs(date).endOf("day").toDate();

    // 1. Chu·∫©n b·ªã b·ªô l·ªçc ph√≤ng ban
    const whereDept: any = {};
    if (factoryId) {
      whereDept.factoryId = parseInt(factoryId);
    }

    const departments = await prisma.department.findMany({
      where: whereDept,
      include: { factory: true },
    });

    // 2. T√≠nh to√°n s·ªë li·ªáu
    // --- KHAI B√ÅO C√ÅC M√É C√îNG ƒê∆Ø·ª¢C COI L√Ä "V·∫ÆNG" T·∫†I ƒê√ÇY ---
    // B·∫°n h√£y li·ªát k√™ t·∫•t c·∫£ c√°c m√£ t∆∞∆°ng ·ª©ng v·ªõi √Ω b·∫°n:
    // P: Ph√©p, O: V√¥ l√Ω do, √î: ·ªêm, TS: Thai s·∫£n, TN: Tai n·∫°n, RO: Ngh·ªâ kh√¥ng l∆∞∆°ng...
    const absenceCodes = [
      "F",
      "L",
      "R",
      "B",
      "ƒêC",
      "√î",
      "C√î",
      "T",
      "DS",
      "CL",
      "TS",
      "RO",
      "O",
      "NB",
    ];

    const departmentStats = await Promise.all(
      departments.map(async (dept) => {
        // A. T·ªîNG NH√ÇN VI√äN (M·∫´u s·ªë)
        // Code s·∫Ω ƒë·∫øm t·∫•t c·∫£ nh√¢n vi√™n ƒëang c√≥ trong danh s√°ch ph√≤ng ban n√†y.
        const totalStaff = await prisma.employee.count({
          where: {
            departmentId: dept.id,
          },
        });

        // B. S·ªê NH√ÇN VI√äN V·∫ÆNG (T·ª≠ s·ªë)
        // Logic: ƒê·∫øm trong b·∫£ng Timesheet, ng√†y h√¥m ƒë√≥, c√≥ m√£ n·∫±m trong danh s√°ch "absenceCodes"
        const absentCount = await prisma.timesheet.count({
          where: {
            employee: { departmentId: dept.id }, // Thu·ªôc ph√≤ng ban n√†y
            date: {
              gte: startOfDay,
              lte: endOfDay,
            },
            attendanceCode: {
              code: { in: absenceCodes }, // <--- M·∫•u ch·ªët n·∫±m ·ªü ƒë√¢y
            },
          },
        });

        return {
          key: dept.id,
          departmentName: dept.name,
          factoryName: dept.factory?.name,
          totalStaff,
          absentCount,
          // T√≠nh % v·∫Øng
          absentRate:
            totalStaff > 0 ? ((absentCount / totalStaff) * 100).toFixed(1) : 0,
        };
      })
    );

    // S·∫Øp x·∫øp: ƒê∆∞a ph√≤ng n√†o v·∫Øng nhi·ªÅu nh·∫•t l√™n ƒë·∫ßu
    departmentStats.sort((a, b) => b.absentCount - a.absentCount);

    return NextResponse.json({ stats: departmentStats });
  } catch (error) {
    console.error("L·ªói Dashboard Detail:", error);
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\dashboard\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\departments\route.ts
================================================================================
// src/app/api/departments/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

// 1. H√†m GET, d√πng ƒë·ªÉ l·∫•y danh s√°ch ph√≤ng ban
export async function GET() {
  try {
    // G·ªçi prisma ƒë·ªÉ l·∫•y danh s√°ch ph√≤ng ban
    const departments = await prisma.department.findMany({
      orderBy: {
        id: "asc",
      },
      // T·ªêI ∆ØU: L·∫•y k√®m th√¥ng tin c·ªßa nh√† m√°y li√™n quan
      include: {
        factory: true,
      },
    });

    // Tr·∫£ k·∫øt qu·∫£ d·∫°ng JSON v·ªÅ cho giao di·ªán
    return NextResponse.json(departments);
  } catch (error) {
    return NextResponse.json(
      { error: "L·ªói khi l·∫•y danh s√°ch ph√≤ng ban: " + error },
      { status: 500 }
    );
  }
}

// 2. H√†m POST, d√πng ƒë·ªÉ th√™m ph√≤ng ban
export async function POST(request: Request) {
  try {
    // ƒê·ªçc d·ªØ li·ªáu g·ª≠i l√™n t·ª´ giao di·ªán
    // Chuy·ªÉn chu·ªói JSON t·ª´ tr√¨nh duy·ªát g·ª≠i l√™n th√†nh Object r·ªìi g√°n cho body
    const body = await request.json();
    const { name, code, factoryId } = body;

    if (!name || !code) {
      return NextResponse.json(
        { error: "M√£ v√† t√™n ph√≤ng ban l√† b·∫Øt bu·ªôc!" },
        { status: 400 }
      );
    }

    // L∆∞u v√†o database
    const newDepartment = await prisma.department.create({
      data: {
        name: name,
        code: code,
        factoryId: factoryId, // N·∫øu factoryId c√≥ gi√° tr·ªã th√¨ l∆∞u, n·∫øu null/undefined th√¨ Prisma t·ª± hi·ªÉu l√† null
      },
    });

    // Tr·∫£ v·ªÅ giao di·ªán th√¥ng tin b·∫£n ghi v·ª´a ƒë∆∞·ª£c th√™m
    return NextResponse.json(newDepartment);
  } catch (error) {
    return NextResponse.json(
      { error: "L·ªói khi th√™m ph√≤ng ban: " + error },
      { status: 400 }
    );
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\departments\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\departments\[id]\route.ts
================================================================================
// src/app/api/departments/[id]/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { message } from "antd";

// H√†m l·∫•y ID t·ª´ URL (V√≠ d·ª•: /api/departments/1 -> id = 1)
// params ch√≠nh l√† object ch·ª©a { id : '1' }

// --- API X√ìA PH√íNG BAN ---
export async function DELETE(
  request: Request,
  // S·ª≠a ki·ªÉu d·ªØ li·ªáu: params l√† Promise
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    // B∆Ø·ªöC QUAN TR·ªåNG: Ph·∫£i await params tr∆∞·ªõc
    const { id } = await params;
    const departmentId = parseInt(id);

    // X√≥a trong database
    await prisma.department.delete({
      where: { id: departmentId },
    });

    return NextResponse.json({ message: "X√≥a th√†nh c√¥ng!" });
  } catch (error) {
    return NextResponse.json(
      {
        error:
          "Kh√¥ng th·ªÉ x√≥a (C√≥ th·ªÉ do ph√≤ng ban n√†y ƒëang c√≥ nh√¢n vi√™n)," + error,
      },
      { status: 500 }
    );
  }
}

// --- API C·∫¨P NH·∫¨T PH√íNG BAN ---
export async function PATCH(
  request: Request,
  // S·ª≠a ki·ªÉu d·ªØ li·ªáu: params l√† Promise
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    // B∆Ø·ªöC QUAN TR·ªåNG: Ph·∫£i await params tr∆∞·ªõc khi d√πng
    const { id } = await params;
    const departmentId = parseInt(id);

    const body = await request.json(); // Chuy·ªÉn g√≥i h√†ng JSON t·ª´ client g·ª≠i l√™n th√†nh Object
    const { code, name, factoryId } = body;

    // C·∫≠p nh·∫≠t d·ªØ li·ªáu
    const updatedDepartment = await prisma.department.update({
      where: { id: departmentId },
      data: {
        code: code,
        name: name,
        factoryId: parseInt(factoryId),
      },
    });

    return NextResponse.json(updatedDepartment);
  } catch (error) {
    console.log(error); // In l·ªói ra terminal server ƒë·ªÉ xem chi ti·∫øt
    return NextResponse.json({ error: "L·ªói khi c·∫≠p nh·∫≠t, " }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\departments\[id]\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\employees\bulk-update\route.ts
================================================================================
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

export async function PUT(request: Request) {
  try {
    const body = await request.json();
    const { employeeIds, kipId } = body;

    // 1. Ki·ªÉm tra ƒë·∫ßu v√†o
    if (
      !employeeIds ||
      !Array.isArray(employeeIds) ||
      employeeIds.length === 0
    ) {
      return NextResponse.json(
        { error: "Danh s√°ch nh√¢n vi√™n kh√¥ng h·ª£p l·ªá" },
        { status: 400 }
      );
    }

    // 2. √âP KI·ªÇU AN TO√ÄN (Quan tr·ªçng nh·∫•t)
    // Chuy·ªÉn ƒë·ªïi m·∫£ng ["1", "5"] th√†nh [1, 5] ƒë·ªÉ Prisma hi·ªÉu
    const idsAsNumbers = employeeIds.map((id: any) => Number(id));

    // X·ª≠ l√Ω KipID:
    // - N·∫øu c√≥ gi√° tr·ªã (v√≠ d·ª• 5) -> chuy·ªÉn th√†nh s·ªë 5
    // - N·∫øu l√† null/undefined/0 -> chuy·ªÉn th√†nh null (ƒë·ªÉ g·ª° K√≠p)
    const finalKipId = kipId && Number(kipId) > 0 ? Number(kipId) : null;

    console.log("ƒêang c·∫≠p nh·∫≠t:", { ids: idsAsNumbers, kip: finalKipId }); // Log ƒë·ªÉ soi n·∫øu c√≤n l·ªói

    // 3. Th·ª±c hi·ªán Update
    const result = await prisma.employee.updateMany({
      where: {
        id: { in: idsAsNumbers }, // Prisma b·∫Øt bu·ªôc ph·∫£i nh·∫≠n m·∫£ng s·ªë nguy√™n ·ªü ƒë√¢y
      },
      data: {
        kipId: finalKipId,
      },
    });

    return NextResponse.json({
      message: "Th√†nh c√¥ng",
      count: result.count,
    });
  } catch (error: any) {
    // In l·ªói chi ti·∫øt ra Terminal c·ªßa VS Code ƒë·ªÉ b·∫°n ƒë·ªçc ƒë∆∞·ª£c
    console.error("‚ùå L·ªói Bulk Update:", error);

    return NextResponse.json(
      { error: "L·ªói server: " + (error.message || "") },
      { status: 500 }
    );
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\employees\bulk-update\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\employees\route.ts
================================================================================
// src/app/api/employees/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

// 1. H√†m GET, d√πng ƒë·ªÉ l·∫•y danh s√°ch nh√¢n vi√™n
export async function GET() {
  try {
    const employees = await prisma.employee.findMany({
      orderBy: {
        id: "desc", // Ng∆∞·ªùi m·ªõi th√™m hi·ªán l√™n ƒë·∫ßu
      },
      // K·ªπ thu·∫≠t l·ªìng gh√©p d·ªØ li·ªáu (Nested Include)
      include: {
        department: {
          include: {
            factory: true, // L·∫•y lu√¥n th√¥ng tin nh√† m√°y c·ªßa ph√≤ng ban ƒë√≥
          },
        },
        kip: true, // ƒê·ªÉ hi·ªÉn th·ªã k√≠p ra b·∫£ng
      },
    });

    // Tr·∫£ danh s√°ch nh√¢n vi√™n v·ªÅ cho tr√¨nh duy·ªát (Chu·ªói JSON)
    return NextResponse.json(employees);
  } catch (error) {
    NextResponse.json(
      { error: "L·ªói khi l·∫•y danh s√°ch nh√¢n vi√™n: " + error },
      { status: 500 }
    );
  }
}

// 2. H√†m POST: Th√™m nh√¢n vi√™n m·ªõi
export async function POST(request: Request) {
  try {
    // Chuy·ªÉn d·ªØ li·ªáu JSON g·ª≠i l√™n t·ª´ giao di·ªán r·ªìi g√°n cho bi·∫øn body
    const body = await request.json();
    // L·∫•y c√°c tr∆∞·ªùng d·ªØ li·ªáu t·ª´ body
    const {
      code,
      fullName,
      birthday,
      gender,
      address,
      phone,
      position,
      departmentId, // b·∫Øt bu·ªôc
      kipId,
    } = body;

    // Ki·ªÉm tra d·ªØ li·ªáu b·∫Øt bu·ªôc
    if (!code || !fullName || !departmentId) {
      return NextResponse.json(
        { error: "M√£, H·ªç t√™n v√† Ph√≤ng ban l√† b·∫Øt bu·ªôc!" },
        { status: 400 }
      );
    }

    // X·ª¨ L√ù NG√ÄY TH√ÅNG (Quan tr·ªçng)
    // N·∫øu c√≥ g·ª≠i ng√†y sinh th√¨ chuy·ªÉn t·ª´ String sang Date object, n·∫øu kh√¥ng th√¨ ƒë·ªÉ null
    const birthdayDate = birthday ? new Date(birthday) : null;

    // L∆∞u d·ªØ li·ªáu v√†o database
    const newEmployee = await prisma.employee.create({
      data: {
        code: code,
        fullName: fullName,
        birthday: birthdayDate,
        gender: gender,
        address: address,
        phone: phone,
        position: position,
        departmentId: Number(departmentId), // ƒê·∫£m b·∫£o Id l√† s·ªë
        kipId: kipId ? Number(kipId) : null,
      },
    });

    // B√°o v·ªÅ cho tr√¨nh duy·ªát
    return NextResponse.json(newEmployee);
  } catch (error) {
    NextResponse.json(
      { error: "L·ªói khi th√™m nh√¢n vi√™n, c√≥ th·ªÉ do tr√πng m√£: " + error },
      { status: 400 }
    );
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\employees\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\employees\[id]\route.ts
================================================================================
import { error } from "node:console";
// src/app/api/employees/[id]/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

// H√†m l·∫•y ID t·ª´ URL (V√≠ d·ª•: /api/employees/1 -> id = 1)
// params ch√≠nh l√† object ch·ª©a { id : '1' }

// --- API X√ìA TH√îNG TIN NH√ÇN VI√äN ---
export async function DELETE(
  request: Request,
  // params ph·∫£i l√† promise
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    // B∆∞·ªõc ƒë·∫ßu ti√™n, await params tr∆∞·ªõc
    const { id } = await params;
    const employeeId = parseInt(id);

    // X√≥a trong c∆° s·ªü d·ªØ li·ªáu
    await prisma.employee.delete({
      where: { id: employeeId },
    });

    // X√≥a xong th√¨ t·∫°o chu·ªói JSON b√°o v·ªÅ client
    return NextResponse.json({ message: "X√≥a th√†nh c√¥ng!" });
  } catch (error) {
    return NextResponse.json(
      { error: "L·ªói khi x√≥a: " + error },
      { status: 500 }
    );
  }
}

// --- API C·∫¨P NH·∫¨T TH√îNG TIN NH√ÇN VI√äN ---
export async function PATCH(
  request: Request,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    // G·ªçi await params
    const { id } = await params;
    const employeeId = parseInt(id);

    const body = await request.json(); // Chuy·ªÉn g√≥i h√†ng JSON t·ª´ client g·ª≠i l√™n th√†nh Object
    const {
      code,
      fullName,
      birthday,
      gender,
      address,
      phone,
      position,
      departmentId,
      kipId,
    } = body; // L·∫•y nh·ªØng th·ª© c·∫ßn thi·∫øt t·ª´ c·ª•c h√†ng body ra ƒë·ªÉ d√πng (c·∫≠p nh·∫≠t)

    // FIX: X·ª≠ l√Ω ng√†y sinh an to√†n h∆°n
    // N·∫øu birthday h·ª£p l·ªá th√¨ new Date, n·∫øu kh√¥ng th√¨ undefined
    const formatBirthday = birthday ? new Date(birthday) : undefined;

    // C·∫≠p nh·∫≠t v√†o c∆° s·ªü d·ªØ li·ªáu
    const updatedEmployee = await prisma.employee.update({
      where: { id: employeeId },
      data: {
        code: code,
        fullName: fullName,
        birthday: formatBirthday,
        gender: gender,
        address: address,
        phone: phone,
        position: position,
        // FIX: Th√™m ki·ªÉm tra departmentId tr∆∞·ªõc khi parse ƒë·ªÉ tr√°nh NaN n·∫øu l·ª° null
        departmentId: departmentId ? parseInt(departmentId) : undefined,
        kipId: kipId ? Number(kipId) : null,
      },
    });

    return NextResponse.json(updatedEmployee);
  } catch (error) {
    console.log(error); // In l·ªói ra terminal server ƒë·ªÉ xem chi ti·∫øt
    return NextResponse.json({ error: "L·ªói khi c·∫≠p nh·∫≠t, " }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\employees\[id]\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\factories\route.ts
================================================================================
// src/app/api/factories/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
// import { error } from "node:console";

// 1. H√†m GET: D√πng ƒë·ªÉ l·∫•y danh s√°ch nh√† m√°y
export async function GET() {
  try {
    // G·ªçi prisma ƒë·ªÉ l·∫•y to√†n b·ªô d·ªØ li·ªáu t·ª´ b·∫£ng Factory
    const factories = await prisma.factory.findMany({
      orderBy: {
        id: "asc", // S·∫Øp x·∫øp theo Id tƒÉng d·∫ßn
      },
    });

    // Tr·∫£ v·ªÅ k·∫øt qu·∫£ d·∫°ng JSON cho ph√≠a giao di·ªán
    return NextResponse.json(factories);
  } catch (error) {
    return NextResponse.json(
      { error: "Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu nh√† m√°y: " + error },
      { status: 500 }
    );
  }
}

// 2. H√†m POST: D√πng ƒë·ªÉ th√™m m·ªõi m·ªôt nh√† m√°y
export async function POST(request: Request) {
  try {
    // ƒê·ªçc d·ªØ li·ªáu g·ª≠i l√™n t·ª´ giao di·ªán
    // Chuy·ªÉn chu·ªói JSON t·ª´ tr√¨nh duy·ªát g·ª≠i l√™n th√†nh Object r·ªìi g√°n cho body
    const body = await request.json();
    const { code, name } = body;

    // Ki·ªÉm tra d·ªØ li·ªáu ƒë·∫ßu v√†o
    if (!code || !name) {
      return NextResponse.json(
        { error: "M√£ v√† t√™n nh√† m√°y l√† b·∫Øt bu·ªôc" },
        { status: 400 }
      );
    }

    // G·ªçi prisma ƒë·ªÉ t·∫°o b·∫£n ghi m·ªõi
    const newFactory = await prisma.factory.create({
      data: {
        code: code,
        name: name,
      },
    });
    return NextResponse.json(newFactory);
  } catch (error) {
    return NextResponse.json(
      { error: "L·ªói khi th√™m nh√† m√°y (c√≥ th·ªÉ do tr√πng m√£): " + error },
      { status: 500 }
    );
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\factories\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\factories\[id]\route.ts
================================================================================
// src/app/api/factories/[id]/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { auth } from "@/auth";

// --- QUAN TR·ªåNG: ƒê·ªãnh nghƒ©a ki·ªÉu Props cho Next.js 15 ---
type Props = {
  params: Promise<{ id: string }>;
};

// 1. L·∫§Y CHI TI·∫æT NH√Ä M√ÅY (GET)
export async function GET(request: Request, props: Props) {
  try {
    const params = await props.params; // <--- Await params
    const id = parseInt(params.id);

    if (isNaN(id))
      return NextResponse.json({ error: "ID kh√¥ng h·ª£p l·ªá" }, { status: 400 });

    const factory = await prisma.factory.findUnique({
      where: { id },
    });

    if (!factory)
      return NextResponse.json({ error: "Kh√¥ng t√¨m th·∫•y" }, { status: 404 });

    return NextResponse.json(factory);
  } catch (error) {
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}

// 2. C·∫¨P NH·∫¨T NH√Ä M√ÅY (PATCH) - ƒê√¢y l√† h√†m b·ªã b√°o l·ªói
export async function PATCH(request: Request, props: Props) {
  try {
    const session = await auth();
    if (session?.user?.role !== "ADMIN") {
      return NextResponse.json({ error: "Kh√¥ng c√≥ quy·ªÅn" }, { status: 403 });
    }

    const params = await props.params; // <--- S·ª¨A L·ªñI CH√çNH ·ªû ƒê√ÇY
    const id = parseInt(params.id);

    if (isNaN(id))
      return NextResponse.json({ error: "ID kh√¥ng h·ª£p l·ªá" }, { status: 400 });

    const body = await request.json();
    const { name, code } = body;

    const updatedFactory = await prisma.factory.update({
      where: { id },
      data: { name, code },
    });

    return NextResponse.json(updatedFactory);
  } catch (error) {
    console.error("L·ªói update factory:", error);
    return NextResponse.json({ error: "L·ªói c·∫≠p nh·∫≠t" }, { status: 500 });
  }
}

// 3. X√ìA NH√Ä M√ÅY (DELETE)
export async function DELETE(request: Request, props: Props) {
  try {
    const session = await auth();
    if (session?.user?.role !== "ADMIN") {
      return NextResponse.json({ error: "Kh√¥ng c√≥ quy·ªÅn" }, { status: 403 });
    }

    const params = await props.params; // <--- Await params
    const id = parseInt(params.id);

    if (isNaN(id))
      return NextResponse.json({ error: "ID kh√¥ng h·ª£p l·ªá" }, { status: 400 });

    // Ki·ªÉm tra r√†ng bu·ªôc tr∆∞·ªõc khi x√≥a (c√≥ ph√≤ng ban n√†o kh√¥ng)
    const departmentsCount = await prisma.department.count({
      where: { factoryId: id },
    });

    if (departmentsCount > 0) {
      return NextResponse.json(
        { error: "Kh√¥ng th·ªÉ x√≥a: Nh√† m√°y n√†y ƒëang c√≥ ph√≤ng ban tr·ª±c thu·ªôc." },
        { status: 400 }
      );
    }

    await prisma.factory.delete({
      where: { id },
    });

    return NextResponse.json({ message: "ƒê√£ x√≥a th√†nh c√¥ng" });
  } catch (error) {
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\factories\[id]\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\kips\route.ts
================================================================================
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

export async function GET() {
  try {
    const kips = await prisma.kip.findMany({
      orderBy: { name: "asc" },
      // --- B·∫ÆT BU·ªòC PH·∫¢I C√ì D√íNG N√ÄY ---
      include: {
        factory: true, // L·∫•y k√®m th√¥ng tin nh√† m√°y
      },
    });
    return NextResponse.json(kips);
  } catch (error) {
    return NextResponse.json(
      { error: "L·ªói t·∫£i danh s√°ch K√≠p" },
      { status: 500 }
    );
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\kips\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\stats\daily\route.ts
================================================================================
// src/app/api/stats/daily/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import dayjs from "dayjs";

export async function GET(request: Request) {
  try {
    const { searchParams } = new URL(request.url);
    const dateStr = searchParams.get("date"); // YYYY-MM-DD

    if (!dateStr) {
      return NextResponse.json({ error: "Thi·∫øu ng√†y" }, { status: 400 });
    }

    const targetDate = new Date(`${dateStr}T00:00:00.000Z`);

    // L·∫•y to√†n b·ªô nh√¢n vi√™n k√®m theo:
    // 1. Ph√≤ng ban -> Nh√† m√°y (ƒê·ªÉ ph√¢n lo·∫°i)
    // 2. Ch·∫•m c√¥ng c·ªßa ng√†y ƒë√≥ (ƒê·ªÉ ƒë·∫øm)
    const employees = await prisma.employee.findMany({
      include: {
        department: {
          include: {
            factory: true,
          },
        },
        timesheets: {
          where: { date: targetDate },
          include: { attendanceCode: true },
        },
      },
    });

    // Tr·∫£ v·ªÅ d·ªØ li·ªáu th√¥ ƒë·ªÉ Frontend t·ª± "x√†o n·∫•u"
    return NextResponse.json(employees);
  } catch (error) {
    console.log("L·ªói tr·∫£ v·ªÅ: ", error);
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\stats\daily\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\system\backup\route.ts
================================================================================
// src/app/api/system/backup/route.ts
import { NextResponse } from "next/server";
import { auth } from "@/auth";
import { exec } from "child_process";
import { promisify } from "util";

const execPromise = promisify(exec);

export async function GET() {
  try {
    // 1. KI·ªÇM TRA QUY·ªÄN
    const session = await auth();
    if (!session || session.user?.role !== "ADMIN") {
      return NextResponse.json(
        { error: "B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y" },
        { status: 403 }
      );
    }

    // 2. L·∫§Y & X·ª¨ L√ù DATABASE URL (QUAN TR·ªåNG)
    let dbUrl = process.env.DATABASE_URL;
    if (!dbUrl) {
      return NextResponse.json(
        { error: "Ch∆∞a c·∫•u h√¨nh DATABASE_URL" },
        { status: 500 }
      );
    }

    // --- S·ª¨A L·ªñI: C·∫ÆT B·ªé THAM S·ªê ?schema=public ---
    // pg_dump kh√¥ng ch·ªãu tham s·ªë n√†y, n√™n ta ph·∫£i b·ªè ƒëi
    if (dbUrl.includes("?")) {
      dbUrl = dbUrl.split("?")[0];
    }
    // ----------------------------------------------

    // 3. C·∫§U H√åNH ƒê∆Ø·ªúNG D·∫™N (C·∫¨P NH·∫¨T THEO LOG C·ª¶A B·∫†N: B·∫¢N 17)
    // Log c·ªßa b·∫°n cho th·∫•y b·∫°n ƒëang c√†i b·∫£n 17, h√£y s·ª≠a s·ªë 16 th√†nh 17
    const pgDumpPath = '"C:\\Program Files\\PostgreSQL\\17\\bin\\pg_dump.exe"';

    console.log("ƒêang b·∫Øt ƒë·∫ßu backup v·ªõi URL ƒë√£ l√†m s·∫°ch...");

    // 4. T·∫†O L·ªÜNH
    const command = `${pgDumpPath} "${dbUrl}" --no-owner --no-acl`;

    // 5. TH·ª∞C THI
    const { stdout, stderr } = await execPromise(command, {
      maxBuffer: 1024 * 1024 * 100, // 100MB buffer
      env: process.env,
    });

    if (stderr) {
      console.warn("Backup warning:", stderr);
    }

    // 6. TR·∫¢ V·ªÄ FILE
    const dateStr = new Date().toISOString().split("T")[0];
    const filename = `backup_phubai_${dateStr}.sql`;

    return new NextResponse(stdout, {
      headers: {
        "Content-Disposition": `attachment; filename="${filename}"`,
        "Content-Type": "application/sql",
      },
    });
  } catch (error: any) {
    console.error("L·ªñI BACKUP CHI TI·∫æT:", error);
    return NextResponse.json(
      { error: "L·ªói Server: " + (error.message || error.toString()) },
      { status: 500 }
    );
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\system\backup\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\timesheets\daily\route-old.ts
================================================================================
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { auth } from "@/auth";

// 1. L·∫§Y D·ªÆ LI·ªÜU CH·∫§M C√îNG
export async function GET(request: Request) {
  try {
    const { searchParams } = new URL(request.url);
    const departmentId = searchParams.get("departmentId");
    const dateStr = searchParams.get("date");
    const kipIdsStr = searchParams.get("kipIds");

    if (!dateStr) {
      return NextResponse.json(
        { error: "Thi·∫øu ng√†y ch·∫•m c√¥ng" },
        { status: 400 }
      );
    }

    const targetDate = new Date(`${dateStr}T00:00:00.000Z`);
    const whereCondition: any = {};

    // Logic l·ªçc:
    // 1. N·∫øu c√≥ departmentId -> L·ªçc theo Ph√≤ng (ƒê√¢y l√† ph√≤ng KH√îNG thu·ªôc K√≠p)
    if (departmentId && departmentId !== "null" && departmentId !== "") {
      whereCondition.departmentId = parseInt(departmentId);
    }

    // 2. N·∫øu c√≥ kipIds -> L·ªçc theo K√≠p (C√°c b·ªô ph·∫≠n s·∫£n xu·∫•t)
    if (kipIdsStr && kipIdsStr !== "") {
      const kipIds = kipIdsStr.split(",").map(Number);
      whereCondition.kipId = { in: kipIds };
    }

    // N·∫øu kh√¥ng ch·ªçn g√¨ c·∫£ -> Tr·∫£ v·ªÅ r·ªóng
    if (Object.keys(whereCondition).length === 0) {
      return NextResponse.json([]);
    }

    const employees = await prisma.employee.findMany({
      where: whereCondition,
      orderBy: [
        { kip: { name: "asc" } }, // ∆Øu ti√™n x·∫øp theo K√≠p
        { department: { name: "asc" } }, // Sau ƒë√≥ ƒë·∫øn t√™n b·ªô ph·∫≠n
        { fullName: "asc" }, // Cu·ªëi c√πng l√† t√™n
      ],
      include: {
        timesheets: {
          where: { date: targetDate },
          include: { attendanceCode: true },
        },
        kip: true,
        department: true,
      },
    });

    const data = employees.map((emp) => {
      const timesheet = emp.timesheets[0];
      return {
        employeeId: emp.id,
        employeeCode: emp.code,
        fullName: emp.fullName,
        departmentName: emp.department?.name,
        kipName: emp.kip?.name,
        attendanceCodeId: timesheet ? timesheet.attendanceCodeId : null,
        note: timesheet ? timesheet.note : "",
        updatedAt: timesheet ? timesheet.updatedAt : null,
      };
    });

    return NextResponse.json(data);
  } catch (error) {
    console.log("L·ªói l·∫•y d·ªØ li·ªáu: ", error);
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}

// 2. L∆ØU D·ªÆ LI·ªÜU
export async function POST(request: Request) {
  try {
    const session = await auth();
    if (!session || !session.user) {
      return NextResponse.json({ error: "Ch∆∞a ƒëƒÉng nh·∫≠p" }, { status: 401 });
    }

    const body = await request.json();
    const { date, departmentId, records } = body;

    if (!date || !records) {
      return NextResponse.json(
        { error: "Thi·∫øu th√¥ng tin b·∫Øt bu·ªôc" },
        { status: 400 }
      );
    }

    const targetDate = new Date(`${date}T00:00:00.000Z`);

    // --- KI·ªÇM TRA KH√ìA S·ªî ---
    // Ch·ªâ ki·ªÉm tra n·∫øu ng∆∞·ªùi d√πng ch·∫•m theo Ph√≤ng Ban c·ª• th·ªÉ (c√≥ departmentId)
    // N·∫øu ch·∫•m theo K√≠p (departmentId = null), t·∫°m th·ªùi b·ªè qua check kh√≥a s·ªï ph√≤ng ban
    // (Ho·∫∑c logic n√†y s·∫Ω ƒë∆∞·ª£c n√¢ng c·∫•p sau ƒë·ªÉ check kh√≥a s·ªï c·ªßa t·ª´ng ph√≤ng trong k√≠p)
    if (departmentId) {
      const dateObj = new Date(date);
      const month = dateObj.getMonth() + 1;
      const year = dateObj.getFullYear();

      const lockRecord = await prisma.timesheetLock.findUnique({
        where: {
          departmentId_month_year: {
            departmentId: Number(departmentId),
            month: month,
            year: year,
          },
        },
      });

      if (lockRecord?.isLocked) {
        if (session.user.role === "TIMEKEEPER") {
          return NextResponse.json(
            { error: `B·∫£ng c√¥ng th√°ng ${month}/${year} ƒë√£ b·ªã KH√ìA S·ªî.` },
            { status: 403 }
          );
        }
      }
    }

    await prisma.$transaction(
      records.map((rec: any) =>
        prisma.timesheet.upsert({
          where: {
            employeeId_date: {
              employeeId: rec.employeeId,
              date: targetDate,
            },
          },
          update: {
            attendanceCodeId: rec.attendanceCodeId,
            note: rec.note,
          },
          create: {
            date: targetDate,
            employeeId: rec.employeeId,
            attendanceCodeId: rec.attendanceCodeId,
            note: rec.note,
          },
        })
      )
    );

    return NextResponse.json({ message: "ƒê√£ l∆∞u th√†nh c√¥ng!" });
  } catch (error) {
    console.error("L·ªói l∆∞u ch·∫•m c√¥ng: ", error);
    return NextResponse.json({ error: "L·ªói khi l∆∞u d·ªØ li·ªáu" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\timesheets\daily\route-old.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\timesheets\daily\route.ts
================================================================================
// src/app/api/timesheets/daily/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { auth } from "@/auth";

// 1. L·∫§Y D·ªÆ LI·ªÜU CH·∫§M C√îNG
export async function GET(request: Request) {
  try {
    const { searchParams } = new URL(request.url);
    const departmentIdStr = searchParams.get("departmentId"); // Nh·∫≠n chu·ªói "1,2,3"
    const dateStr = searchParams.get("date");
    const kipIdsStr = searchParams.get("kipIds");

    if (!dateStr) {
      return NextResponse.json(
        { error: "Thi·∫øu ng√†y ch·∫•m c√¥ng" },
        { status: 400 }
      );
    }

    const targetDate = new Date(`${dateStr}T00:00:00.000Z`);
    const whereCondition: any = {};

    // --- [S·ª¨A ƒê·ªîI QUAN TR·ªåNG] ---
    // Logic l·ªçc: H·ªó tr·ª£ nhi·ªÅu Department ID c√πng l√∫c (Do ch·ªçn nhi·ªÅu K√≠p ho·∫∑c ch·ªçn T·ªï)
    if (
      departmentIdStr &&
      departmentIdStr !== "null" &&
      departmentIdStr !== ""
    ) {
      // T√°ch chu·ªói "15,16" th√†nh m·∫£ng s·ªë [15, 16]
      const deptIds = departmentIdStr
        .split(",")
        .map(Number)
        .filter((n) => !isNaN(n));

      if (deptIds.length > 0) {
        whereCondition.departmentId = { in: deptIds };
      }
    }
    // ----------------------------

    // 2. N·∫øu c√≥ kipIds -> L·ªçc theo K√≠p (D√†nh cho NM3 ho·∫∑c b·ªô l·ªçc b·ªï sung)
    if (kipIdsStr && kipIdsStr !== "") {
      const kipIds = kipIdsStr
        .split(",")
        .map(Number)
        .filter((n) => !isNaN(n));
      if (kipIds.length > 0) {
        // L∆∞u √Ω: N·∫øu ƒë√£ l·ªçc theo departmentId (NM2) th√¨ kipId l√† ƒëi·ªÅu ki·ªán giao (AND)
        // N·∫øu ch∆∞a c√≥ departmentId (NM3), n√≥ s·∫Ω l·ªçc nh√¢n vi√™n thu·ªôc c√°c k√≠p n√†y
        whereCondition.kipId = { in: kipIds };
      }
    }

    // N·∫øu kh√¥ng ch·ªçn g√¨ c·∫£ (c·∫£ Dept v√† K√≠p ƒë·ªÅu r·ªóng) -> Tr·∫£ v·ªÅ r·ªóng ƒë·ªÉ tr√°nh t·∫£i tr·ªôm b·ªô
    if (Object.keys(whereCondition).length === 0) {
      return NextResponse.json([]);
    }

    const employees = await prisma.employee.findMany({
      where: whereCondition,
      orderBy: [
        { kip: { name: "asc" } }, // ∆Øu ti√™n x·∫øp theo K√≠p
        { department: { name: "asc" } }, // Sau ƒë√≥ ƒë·∫øn t√™n b·ªô ph·∫≠n
        { fullName: "asc" }, // Cu·ªëi c√πng l√† t√™n
      ],
      include: {
        timesheets: {
          where: { date: targetDate },
          include: { attendanceCode: true },
        },
        kip: true,
        department: true,
      },
    });

    const data = employees.map((emp) => {
      const timesheet = emp.timesheets[0];
      return {
        employeeId: emp.id,
        employeeCode: emp.code,
        fullName: emp.fullName,
        departmentName: emp.department?.name,
        departmentCode: emp.department?.code, // Tr·∫£ th√™m code n·∫øu c·∫ßn debug
        kipName: emp.kip?.name,
        attendanceCodeId: timesheet ? timesheet.attendanceCodeId : null,
        note: timesheet ? timesheet.note : "",
        updatedAt: timesheet ? timesheet.updatedAt : null,
      };
    });

    return NextResponse.json(data);
  } catch (error) {
    console.log("L·ªói l·∫•y d·ªØ li·ªáu: ", error);
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}

// 2. L∆ØU D·ªÆ LI·ªÜU
export async function POST(request: Request) {
  try {
    const session = await auth();
    if (!session || !session.user) {
      return NextResponse.json({ error: "Ch∆∞a ƒëƒÉng nh·∫≠p" }, { status: 401 });
    }

    const body = await request.json();
    const { date, departmentId, records } = body;

    if (!date || !records) {
      return NextResponse.json(
        { error: "Thi·∫øu th√¥ng tin b·∫Øt bu·ªôc" },
        { status: 400 }
      );
    }

    const targetDate = new Date(`${date}T00:00:00.000Z`);

    // --- KI·ªÇM TRA KH√ìA S·ªî ---
    // Ch·ªâ ki·ªÉm tra n·∫øu ng∆∞·ªùi d√πng ch·∫•m theo 1 Ph√≤ng Ban c·ª• th·ªÉ (c√≥ departmentId)
    // N·∫øu ch·∫•m g·ªôp nhi·ªÅu ph√≤ng (departmentId = null), t·∫°m th·ªùi cho qua ƒë·ªÉ tr√°nh l·ªói logic
    if (departmentId) {
      const dateObj = new Date(date);
      const month = dateObj.getMonth() + 1;
      const year = dateObj.getFullYear();

      const lockRecord = await prisma.timesheetLock.findUnique({
        where: {
          departmentId_month_year: {
            departmentId: Number(departmentId),
            month: month,
            year: year,
          },
        },
      });

      if (lockRecord?.isLocked) {
        if (session.user.role === "TIMEKEEPER") {
          return NextResponse.json(
            { error: `B·∫£ng c√¥ng th√°ng ${month}/${year} ƒë√£ b·ªã KH√ìA S·ªî.` },
            { status: 403 }
          );
        }
      }
    }

    // Th·ª±c hi·ªán l∆∞u (Transaction ƒë·ªÉ ƒë·∫£m b·∫£o to√†n v·∫πn)
    await prisma.$transaction(
      records.map((rec: any) =>
        prisma.timesheet.upsert({
          where: {
            employeeId_date: {
              employeeId: rec.employeeId,
              date: targetDate,
            },
          },
          update: {
            attendanceCodeId: rec.attendanceCodeId,
            note: rec.note,
          },
          create: {
            date: targetDate,
            employeeId: rec.employeeId,
            attendanceCodeId: rec.attendanceCodeId,
            note: rec.note,
          },
        })
      )
    );

    return NextResponse.json({ message: "ƒê√£ l∆∞u th√†nh c√¥ng!" });
  } catch (error) {
    console.error("L·ªói l∆∞u ch·∫•m c√¥ng: ", error);
    return NextResponse.json({ error: "L·ªói khi l∆∞u d·ªØ li·ªáu" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\timesheets\daily\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\timesheets\lock\route.ts
================================================================================
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { auth } from "@/auth";

// 1. L·∫§Y TR·∫†NG TH√ÅI KH√ìA (ƒê·ªÉ hi·ªÉn th·ªã l√™n giao di·ªán: ·ªî kh√≥a ƒë√≥ng hay m·ªü)
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url);
  const departmentId = searchParams.get("departmentId");
  const month = searchParams.get("month");
  const year = searchParams.get("year");

  if (!departmentId || !month || !year) return NextResponse.json({});

  const lockRecord = await prisma.timesheetLock.findUnique({
    where: {
      departmentId_month_year: {
        departmentId: parseInt(departmentId),
        month: parseInt(month),
        year: parseInt(year),
      },
    },
  });

  return NextResponse.json({ isLocked: lockRecord?.isLocked || false });
}

// 2. TH·ª∞C HI·ªÜN KH√ìA / M·ªû KH√ìA
export async function POST(request: Request) {
  try {
    const session = await auth();
    // Ch·ªâ Admin ho·∫∑c HR m·ªõi ƒë∆∞·ª£c quy·ªÅn Kh√≥a/M·ªü
    if (!["ADMIN", "HR_MANAGER"].includes(session?.user?.role || "")) {
      return NextResponse.json({ error: "Kh√¥ng c√≥ quy·ªÅn" }, { status: 403 });
    }

    const body = await request.json();
    const { departmentId, month, year, isLocked } = body;

    const lockRecord = await prisma.timesheetLock.upsert({
      where: {
        departmentId_month_year: {
          departmentId: parseInt(departmentId),
          month: parseInt(month),
          year: parseInt(year),
        },
      },
      update: {
        isLocked: isLocked,
        lockedBy: session?.user?.username,
      },
      create: {
        departmentId: parseInt(departmentId),
        month: parseInt(month),
        year: parseInt(year),
        isLocked: isLocked,
        lockedBy: session?.user?.username,
      },
    });

    return NextResponse.json({
      message: isLocked ? "ƒê√£ kh√≥a s·ªï" : "ƒê√£ m·ªü kh√≥a",
      isLocked: lockRecord.isLocked,
    });
  } catch (error) {
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\timesheets\lock\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\timesheets\monthly\route.ts
================================================================================
// src/app/api/timesheets/monthly/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import dayjs from "dayjs";

export async function GET(request: Request) {
  try {
    const { searchParams } = new URL(request.url);
    const departmentIdStr = searchParams.get("departmentId"); // Nh·∫≠n chu·ªói "1,2,3"
    const kipIdsStr = searchParams.get("kipIds");
    const month = searchParams.get("month");
    const year = searchParams.get("year");

    if (!month || !year) {
      return NextResponse.json(
        { error: "Thi·∫øu th√¥ng tin th·ªùi gian" },
        { status: 400 }
      );
    }

    if (!departmentIdStr && !kipIdsStr) {
      return NextResponse.json(
        { error: "Vui l√≤ng ch·ªçn b·ªô l·ªçc" },
        { status: 400 }
      );
    }

    const whereCondition: any = {};

    // --- [S·ª¨A ƒê·ªîI QUAN TR·ªåNG: H·ªñ TR·ª¢ NHI·ªÄU PH√íNG BAN] ---
    if (departmentIdStr && departmentIdStr !== "null") {
      const deptIds = departmentIdStr
        .split(",")
        .map(Number)
        .filter((n) => !isNaN(n));
      if (deptIds.length > 0) {
        whereCondition.departmentId = { in: deptIds };
      }
    }
    // ----------------------------------------------------

    if (kipIdsStr) {
      const kipIds = kipIdsStr
        .split(",")
        .map(Number)
        .filter((n) => !isNaN(n));
      // N·∫øu ch∆∞a l·ªçc theo ph√≤ng (NM3) th√¨ l·ªçc theo K√≠p
      if (!whereCondition.departmentId && kipIds.length > 0) {
        whereCondition.kipId = { in: kipIds };
      }
    }

    // Th·ªùi gian
    const startDate = dayjs(`${year}-${month}-01`).startOf("month").toDate();
    const endDate = dayjs(`${year}-${month}-01`).endOf("month").toDate();

    const employees = await prisma.employee.findMany({
      where: whereCondition,
      orderBy: [
        { kip: { name: "asc" } },
        { department: { name: "asc" } },
        { code: "asc" },
      ],
      include: {
        timesheets: {
          where: {
            date: { gte: startDate, lte: endDate },
          },
          include: { attendanceCode: true },
        },
        department: true,
        kip: true,
      },
    });

    // Map l·∫°i c·∫•u tr√∫c d·ªØ li·ªáu tr·∫£ v·ªÅ cho g·ªçn
    const data = employees.map((emp) => ({
      id: emp.id,
      code: emp.code,
      fullName: emp.fullName,
      department: emp.department,
      kip: emp.kip,
      timesheets: emp.timesheets.map((t) => ({
        date: dayjs(t.date).format("YYYY-MM-DD"),
        attendanceCode: t.attendanceCode,
      })),
    }));

    return NextResponse.json(data);
  } catch (error) {
    console.error("L·ªói server: ", error);
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\timesheets\monthly\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\users\route.ts
================================================================================
// src/app/api/users/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import bcrypt from "bcryptjs";
import { auth } from "@/auth"; // ƒê·ªÉ ki·ªÉm tra quy·ªÅn Admin

export async function GET(request: Request) {
  try {
    // 1. Ki·ªÉm tra quy·ªÅn (Ch·ªâ Admin m·ªõi ƒë∆∞·ª£c xem danh s√°ch)
    const session = await auth();
    if (session?.user?.role !== "ADMIN") {
      return NextResponse.json(
        { error: "Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p" },
        { status: 403 }
      );
    }

    const users = await prisma.user.findMany({
      orderBy: { createdAt: "desc" },
      include: {
        managedDepartments: true, // L·∫•y danh s√°ch ph√≤ng ban h·ªç qu·∫£n l√Ω
      },
    });

    // Lo·∫°i b·ªè password tr∆∞·ªõc khi tr·∫£ v·ªÅ client ƒë·ªÉ b·∫£o m·∫≠t
    const safeUsers = users.map((u) => {
      const { password, ...rest } = u;
      return rest;
    });

    return NextResponse.json(safeUsers);
  } catch (error) {
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}

export async function POST(request: Request) {
  try {
    // 1. Ki·ªÉm tra quy·ªÅn Admin
    const session = await auth();
    if (session?.user?.role !== "ADMIN") {
      return NextResponse.json(
        { error: "Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p" },
        { status: 403 }
      );
    }

    const body = await request.json();
    const { username, password, fullName, role, departmentIds } = body;

    // 2. Validate c∆° b·∫£n
    if (!username || !password || !role) {
      return NextResponse.json(
        { error: "Thi·∫øu th√¥ng tin b·∫Øt bu·ªôc" },
        { status: 400 }
      );
    }

    // 3. Ki·ªÉm tra tr√πng username
    const existingUser = await prisma.user.findUnique({ where: { username } });
    if (existingUser) {
      return NextResponse.json(
        { error: "T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i" },
        { status: 400 }
      );
    }

    // 4. M√£ h√≥a m·∫≠t kh·∫©u
    const hashedPassword = await bcrypt.hash(password, 10);

    // 5. T·∫°o user v√† li√™n k·∫øt ph√≤ng ban (n·∫øu c√≥)
    const newUser = await prisma.user.create({
      data: {
        username,
        password: hashedPassword,
        fullName,
        role,
        // Logic connect Many-to-Many
        managedDepartments:
          departmentIds && departmentIds.length > 0
            ? {
                connect: departmentIds.map((id: number) => ({ id })),
              }
            : undefined,
      },
    });

    return NextResponse.json({
      message: "T·∫°o t√†i kho·∫£n th√†nh c√¥ng",
      user: newUser,
    });
  } catch (error) {
    console.error("L·ªói t·∫°o user:", error);
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\users\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\users\[id]\route.ts
================================================================================
// src/app/api/users/[id]/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { auth } from "@/auth";
import bcrypt from "bcryptjs";

// ƒê·ªãnh nghƒ©a ki·ªÉu cho params (B·∫Øt bu·ªôc v·ªõi Next.js 15)
type Props = {
  params: Promise<{ id: string }>;
};

// 1. H√ÄM X√ìA USER (DELETE)
export async function DELETE(request: Request, props: Props) {
  try {
    // --- QUAN TR·ªåNG: Ph·∫£i await params tr∆∞·ªõc ---
    const params = await props.params;
    const id = parseInt(params.id);

    if (isNaN(id))
      return NextResponse.json({ error: "ID kh√¥ng h·ª£p l·ªá" }, { status: 400 });

    const session = await auth();
    if (session?.user?.role !== "ADMIN") {
      return NextResponse.json({ error: "Kh√¥ng c√≥ quy·ªÅn" }, { status: 403 });
    }

    if (session.user.id === id.toString()) {
      return NextResponse.json(
        { error: "Kh√¥ng th·ªÉ t·ª± x√≥a t√†i kho·∫£n ƒëang ƒëƒÉng nh·∫≠p" },
        { status: 400 }
      );
    }

    // Ki·ªÉm tra v√† g·ª° k·∫øt n·ªëi ph√≤ng ban tr∆∞·ªõc khi x√≥a
    const existingUser = await prisma.user.findUnique({
      where: { id },
      include: { managedDepartments: true },
    });

    if (!existingUser)
      return NextResponse.json(
        { error: "User kh√¥ng t·ªìn t·∫°i" },
        { status: 404 }
      );

    if (existingUser.managedDepartments.length > 0) {
      await prisma.user.update({
        where: { id },
        data: { managedDepartments: { set: [] } },
      });
    }

    await prisma.user.delete({ where: { id } });

    return NextResponse.json({ message: "ƒê√£ x√≥a th√†nh c√¥ng" });
  } catch (error: any) {
    console.error("L·ªñI X√ìA:", error);
    return NextResponse.json(
      { error: "L·ªói server: " + error.message },
      { status: 500 }
    );
  }
}

// 2. H√ÄM S·ª¨A USER (PUT)
export async function PUT(request: Request, props: Props) {
  try {
    // --- QUAN TR·ªåNG: Ph·∫£i await params ·ªü ƒë√¢y n·ªØa ---
    const params = await props.params;
    const id = parseInt(params.id);

    if (isNaN(id))
      return NextResponse.json({ error: "ID kh√¥ng h·ª£p l·ªá" }, { status: 400 });

    const session = await auth();
    if (session?.user?.role !== "ADMIN") {
      return NextResponse.json({ error: "Kh√¥ng c√≥ quy·ªÅn" }, { status: 403 });
    }

    const body = await request.json();
    const { password, fullName, role, departmentIds } = body;

    const updateData: any = {
      fullName,
      role,
    };

    // Logic c·∫≠p nh·∫≠t m·∫≠t kh·∫©u
    if (password && password.trim() !== "") {
      updateData.password = await bcrypt.hash(password, 10);
    }

    // Logic c·∫≠p nh·∫≠t ph√≤ng ban (X·ª≠ l√Ω k·ªπ ki·ªÉu d·ªØ li·ªáu Number)
    if (Array.isArray(departmentIds)) {
      updateData.managedDepartments = {
        // √âp ki·ªÉu v·ªÅ Number ƒë·ªÉ tr√°nh l·ªói Prisma
        set: departmentIds.map((deptId: any) => ({ id: Number(deptId) })),
      };
    } else {
      // N·∫øu ƒë·ªïi sang vai tr√≤ kh√°c (kh√¥ng ph·∫£i Timekeeper), t·ª± ƒë·ªông x√≥a quy·ªÅn ch·∫•m c√¥ng c≈©
      if (role !== "TIMEKEEPER") {
        updateData.managedDepartments = { set: [] };
      }
    }

    const updatedUser = await prisma.user.update({
      where: { id },
      data: updateData,
    });

    return NextResponse.json({
      message: "C·∫≠p nh·∫≠t th√†nh c√¥ng",
      user: updatedUser,
    });
  } catch (error: any) {
    console.error("L·ªñI S·ª¨A:", error);
    return NextResponse.json(
      { error: "L·ªói c·∫≠p nh·∫≠t: " + error.message },
      { status: 500 }
    );
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\users\[id]\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\attendance-codes\page.tsx
================================================================================
"use client";

import React, { useEffect, useState } from "react";
import AdminLayout from "@/components/AdminLayout";
import { useSession } from "next-auth/react";
import {
  Table,
  Button,
  Modal,
  Form,
  Input,
  message,
  Select,
  ColorPicker, // Ch·ªçn m√†u
  InputNumber,
  Popconfirm,
  Tag,
  Space,
} from "antd";
import { PlusOutlined, DeleteOutlined, EditOutlined } from "@ant-design/icons";

// 1. ƒê·ªäNH NGHƒ®A INTERFACE (KHU√îN M·∫™U D·ªÆ LI·ªÜU)
interface AttendanceCode {
  id: number;
  code: string;
  name: string;
  category: string;
  factor?: number; // D·∫•u ? v√¨ c√≥ th·ªÉ null
  color: string;
  description?: string;
}

// ƒê·ªãnh nghƒ©a c√°c nh√≥m ch·∫ø ƒë·ªô ƒë·ªÉ hi·ªÉn th·ªã cho ƒë·∫πp
const CATEGORY_OPTIONS = [
  { value: "TIME_WORK", label: "L∆∞∆°ng th·ªùi gian (ƒêi l√†m)" },
  { value: "PAID_LEAVE", label: "Ngh·ªâ h∆∞·ªüng 100% l∆∞∆°ng" },
  { value: "SICK", label: "Ch·∫ø ƒë·ªô ·ªêm / Tai n·∫°n" },
  { value: "MATERNITY", label: "Ch·∫ø ƒë·ªô Thai s·∫£n" },
  { value: "UNPAID", label: "Ngh·ªâ kh√¥ng l∆∞∆°ng" },
  { value: "AWOL", label: "Ngh·ªâ v√¥ l√Ω do" },
];

export default function AttendanceCodePage() {
  const { data: session } = useSession();
  // 1. Bi·∫øn th·∫ßn th√°nh ki·ªÉm tra quy·ªÅn
  // LOGIC M·ªöI: C·∫£ LEADER v√† TIMEKEEPER ƒë·ªÅu kh√¥ng ƒë∆∞·ª£c s·ª≠a danh m·ª•c
  // (Ch·ªâ ADMIN v√† HR_MANAGER m·ªõi ƒë∆∞·ª£c s·ª≠a)
  const isViewOnly = !["ADMIN", "HR_MANAGER"].includes(
    session?.user?.role || ""
  );

  const [codes, setCodes] = useState<AttendanceCode[]>([]);
  const [loading, setLoading] = useState(false);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [form] = Form.useForm();
  const [editingId, setEditingId] = useState<number | null>(null);

  // 1. T·∫£i d·ªØ li·ªáu
  const fetchCodes = async () => {
    setLoading(true);
    try {
      const res = await fetch("/api/attendance-codes");
      const data = await res.json();
      setCodes(data);
    } catch (error) {
      message.error("L·ªói t·∫£i danh m·ª•c: " + error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchCodes();
  }, []);

  // 2. X·ª≠ l√Ω l∆∞u (Th√™m / S·ª≠a)
  const handleOK = async () => {
    try {
      const values = await form.validateFields();

      // X·ª≠ l√Ω m√†u s·∫Øc: ColorPicker tr·∫£ v·ªÅ object, c·∫ßn chuy·ªÉn sang string hex (#ffffff)
      let colorHex = values.color;
      if (typeof values.color === "object") {
        colorHex = values.color.toHexString();
      }

      const payload = { ...values, color: colorHex };
      const url = editingId
        ? `/api/attendance-codes/${editingId}`
        : "/api/attendance-codes";
      const method = editingId ? "PATCH" : "POST";

      const res = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (res.ok) {
        message.success("L∆∞u th√†nh c√¥ng!");
        setIsModalOpen(false);
        fetchCodes();
      } else {
        const err = await res.json();
        message.error(err.error || "C√≥ l·ªói x·∫£y ra");
      }
    } catch (error) {
      console.log("Validate Failed: ", error);
    }
  };

  // 3. X·ª≠ l√Ω X√≥a
  const handleDelete = async (id: number) => {
    const res = await fetch(`/api/attendance-codes/${id}`, {
      method: "DELETE",
    });
    if (res.ok) {
      message.success("ƒê√£ x√≥a!");
      fetchCodes();
    } else {
      const err = await res.json();
      message.error(err.error);
    }
  };

  // 4. M·ªü Modal S·ª≠a
  const handleEdit = (record: AttendanceCode) => {
    setEditingId(record.id);
    form.setFieldsValue(record);
    setIsModalOpen(true);
  };

  const columns = [
    {
      title: "M√£",
      dataIndex: "code",
      width: 80,
      render: (text: string, record: AttendanceCode) => (
        <Tag
          color={record.color}
          style={{ fontWeight: "bold", minWidth: 40, textAlign: "center" }}
        >
          {text}
        </Tag>
      ),
    },
    {
      title: "T√™n di·ªÖn gi·∫£i",
      dataIndex: "name",
      width: 200,
    },
    {
      title: "Nh√≥m ch·∫ø ƒë·ªô",
      dataIndex: "category",
      width: 200,
      render: (cat: string) => {
        const option = CATEGORY_OPTIONS.find((o) => o.value === cat);
        return option ? option.label : cat;
      },
    },
    {
      title: "H·ªá s·ªë",
      dataIndex: "factor",
      width: 80,
    },
    {
      title: "M√†u s·∫Øc",
      dataIndex: "color",
      width: 100,
      render: (color: string) => (
        <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
          <div
            style={{
              width: 20,
              height: 20,
              background: color,
              borderRadius: 4,
              border: "1px solid #ddd",
            }}
          ></div>
          <small>{color}</small>
        </div>
      ),
    },
    {
      title: "H√†nh ƒë·ªông",
      key: "action",
      render: (_: AttendanceCode, record: AttendanceCode) => (
        <Space>
          <Button
            icon={<EditOutlined />}
            type="text"
            style={{ color: "blue" }}
            onClick={() => handleEdit(record)}
          />
          <Popconfirm
            title="X√≥a k√Ω hi·ªáu n√†y?"
            onConfirm={() => handleDelete(record.id)}
          >
            <Button icon={<DeleteOutlined />} type="text" danger />
          </Popconfirm>
        </Space>
      ),
    },
  ].filter((col) => {
    // N·∫øu l√† Leader V√Ä c·ªôt l√† 'action' -> Lo·∫°i b·ªè (return false)
    if (isViewOnly && col.key === "action") return false;
    return true;
  });

  return (
    <AdminLayout>
      <div
        style={{
          marginBottom: 16,
          display: "flex",
          justifyContent: "space-between",
        }}
      >
        <h2>Danh m·ª•c K√Ω hi·ªáu ch·∫•m c√¥ng</h2>

        {/* 3. Ch·ªâ hi·ªán n√∫t Th√™m m·ªõi n·∫øu ƒë∆∞·ª£c ph√©p s·ª≠a */}
        {!isViewOnly && (
          <Button
            type="primary"
            icon={<PlusOutlined />}
            onClick={() => {
              setEditingId(null);
              form.resetFields();
              // M·∫∑c ƒë·ªãnh ch·ªçn m√†u xanh l√° cho ƒë·∫πp
              form.setFieldValue("color", "#1677ff");
              setIsModalOpen(true);
            }}
          >
            Th√™m k√Ω hi·ªáu m·ªõi
          </Button>
        )}
      </div>

      <Table
        dataSource={codes}
        columns={columns}
        rowKey="id"
        loading={loading}
        pagination={false} // √çt d·ªØ li·ªáu n√™n kh√¥ng c·∫ßn ph√¢n trang
        bordered
      />

      <Modal
        title={editingId ? "S·ª≠a k√Ω hi·ªáu" : "Th√™m k√Ω hi·ªáu m·ªõi"}
        open={isModalOpen}
        onOk={handleOK}
        onCancel={() => setIsModalOpen(false)}
      >
        <Form form={form} layout="vertical">
          <div style={{ display: "flex", gap: 16 }}>
            <Form.Item
              name="code"
              label="M√£ k√Ω hi·ªáu"
              rules={[{ required: true }]}
              style={{ flex: 1 }}
            >
              <Input placeholder="VD: WFH" />
            </Form.Item>
            <Form.Item name="factor" label="H·ªá s·ªë c√¥ng" style={{ width: 120 }}>
              <InputNumber min={0} step={0.5} style={{ width: "100%" }} />
            </Form.Item>
          </div>

          <Form.Item
            name="name"
            label="T√™n di·ªÖn gi·∫£i"
            rules={[{ required: true }]}
          >
            <Input placeholder="VD: L√†m vi·ªác t·∫°i nh√†" />
          </Form.Item>

          <Form.Item
            name="category"
            label="Thu·ªôc nh√≥m ch·∫ø ƒë·ªô"
            rules={[{ required: true }]}
          >
            <Select options={CATEGORY_OPTIONS} />
          </Form.Item>

          <Form.Item
            name="color"
            label="M√†u hi·ªÉn th·ªã"
            rules={[{ required: true }]}
            initialValue="#1677ff"
          >
            <ColorPicker showText />
          </Form.Item>

          <Form.Item name="description" label="M√¥ t·∫£ th√™m">
            <Input.TextArea rows={2} />
          </Form.Item>
        </Form>
      </Modal>
    </AdminLayout>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\attendance-codes\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\dashboard\departments\page.tsx
================================================================================
"use client";

import React, { useEffect, useState } from "react";
import AdminLayout from "@/components/AdminLayout";
import { Table, Tag, DatePicker, Select, Card, Button, Breadcrumb } from "antd";
import { ReloadOutlined, HomeOutlined } from "@ant-design/icons";
import dayjs from "dayjs";
import Link from "next/link";

// Ki·ªÉu d·ªØ li·ªáu (gi·ªëng API tr·∫£ v·ªÅ)
interface DeptStat {
  key: number;
  departmentName: string;
  factoryName: string;
  totalStaff: number;
  absentCount: number;
  absentRate: string;
}

export default function DepartmentDashboardPage() {
  const [loading, setLoading] = useState(false);
  const [data, setData] = useState<DeptStat[]>([]);

  // State b·ªô l·ªçc
  const [selectedFactory, setSelectedFactory] = useState<number | null>(null);
  const [selectedDate, setSelectedDate] = useState<dayjs.Dayjs>(dayjs());
  const [factories, setFactories] = useState<any[]>([]);

  // 1. Load danh s√°ch nh√† m√°y ƒë·ªÉ l√†m b·ªô l·ªçc
  useEffect(() => {
    fetch("/api/factories")
      .then((res) => res.json())
      .then(setFactories)
      .catch(console.error);
  }, []);

  // 2. H√†m l·∫•y d·ªØ li·ªáu th·ªëng k√™
  const fetchData = async () => {
    setLoading(true);
    try {
      const dateStr = selectedDate.format("YYYY-MM-DD");
      let url = `/api/dashboard?date=${dateStr}`; // G·ªçi v√†o API dashboard c≈©
      if (selectedFactory) url += `&factoryId=${selectedFactory}`;

      const res = await fetch(url);
      const result = await res.json();

      // API tr·∫£ v·ªÅ { stats: [...] }, ta l·∫•y ph·∫ßn stats
      if (result.stats) {
        setData(result.stats);
      }
    } catch (error) {
      console.error("L·ªói t·∫£i d·ªØ li·ªáu:", error);
    } finally {
      setLoading(false);
    }
  };

  // G·ªçi API khi thay ƒë·ªïi b·ªô l·ªçc
  useEffect(() => {
    fetchData();
  }, [selectedFactory, selectedDate]);

  // 3. C·∫•u h√¨nh c·ªôt b·∫£ng
  const columns = [
    {
      title: "STT",
      key: "index",
      width: 60,
      align: "center" as const,
      render: (_: any, __: any, index: number) => index + 1,
    },
    {
      title: "Ph√≤ng ban / T·ªï",
      dataIndex: "departmentName",
      key: "departmentName",
      render: (text: string, record: DeptStat) => (
        <div>
          <div style={{ fontWeight: 600, fontSize: 15 }}>{text}</div>
          <div style={{ fontSize: 12, color: "#888" }}>
            {record.factoryName}
          </div>
        </div>
      ),
    },
    {
      title: "T·ªïng ƒë·ªãnh bi√™n",
      dataIndex: "totalStaff",
      key: "totalStaff",
      align: "center" as const,
      render: (val: number) => <b style={{ fontSize: 15 }}>{val}</b>,
    },
    {
      title: "V·∫Øng m·∫∑t",
      dataIndex: "absentCount",
      key: "absentCount",
      align: "center" as const,
      render: (val: number) => {
        if (val === 0) return <span style={{ color: "#ccc" }}>-</span>;
        return (
          <Tag color="error" style={{ fontSize: 14, padding: "4px 10px" }}>
            {val} ng∆∞·ªùi
          </Tag>
        );
      },
    },
    {
      title: "T·ª∑ l·ªá v·∫Øng",
      dataIndex: "absentRate",
      key: "absentRate",
      align: "right" as const,
      render: (val: string) => {
        const rate = parseFloat(val);
        // Logic t√¥ m√†u: >10% l√† ƒê·ªè, >0% l√† Cam, 0% l√† Xanh
        let color = "green";
        if (rate > 0) color = "orange";
        if (rate > 10) color = "red";

        return <span style={{ color, fontWeight: "bold" }}>{val}%</span>;
      },
    },
  ];

  return (
    <AdminLayout>
      {/* Breadcrumb cho chuy√™n nghi·ªáp */}
      <Breadcrumb style={{ marginBottom: 16 }}>
        <Breadcrumb.Item href="/dashboard">
          <HomeOutlined /> T·ªïng quan
        </Breadcrumb.Item>
        <Breadcrumb.Item>Chi ti·∫øt theo Ph√≤ng ban</Breadcrumb.Item>
      </Breadcrumb>

      <Card title="T√¨nh h√¨nh nh√¢n s·ª± theo Ph√≤ng ban - B·ªô ph·∫≠n" bordered={false}>
        {/* THANH B·ªò L·ªåC */}
        <div
          style={{
            display: "flex",
            gap: 16,
            marginBottom: 24,
            flexWrap: "wrap",
          }}
        >
          <div>
            <div style={{ fontWeight: 500, marginBottom: 5 }}>Ch·ªçn ng√†y:</div>
            <DatePicker
              value={selectedDate}
              onChange={(val) => val && setSelectedDate(val)}
              allowClear={false}
              format="DD/MM/YYYY"
              style={{ width: 150 }}
            />
          </div>

          <div>
            <div style={{ fontWeight: 500, marginBottom: 5 }}>Nh√† m√°y:</div>
            <Select
              placeholder="T·∫•t c·∫£ nh√† m√°y"
              style={{ width: 200 }}
              allowClear
              options={factories.map((f) => ({ label: f.name, value: f.id }))}
              onChange={setSelectedFactory}
            />
          </div>

          <div style={{ display: "flex", alignItems: "end" }}>
            <Button icon={<ReloadOutlined />} onClick={fetchData}>
              L√†m m·ªõi
            </Button>
          </div>
        </div>

        {/* B·∫¢NG D·ªÆ LI·ªÜU */}
        <Table
          columns={columns}
          dataSource={data}
          loading={loading}
          pagination={false} // T·∫Øt ph√¢n trang ƒë·ªÉ xem to√†n b·ªô danh s√°ch (scannable)
          bordered
          rowKey="key"
          scroll={{ y: 600 }} // C·ªë ƒë·ªãnh chi·ªÅu cao, cu·ªôn n·∫øu d√†i
          summary={(pageData) => {
            // T√≠nh t·ªïng c·ªông ·ªü ch√¢n b·∫£ng (Footer)
            let totalStaff = 0;
            let totalAbsent = 0;
            pageData.forEach(({ totalStaff: t, absentCount: a }) => {
              totalStaff += t;
              totalAbsent += a;
            });

            return (
              <Table.Summary fixed>
                <Table.Summary.Row
                  style={{ background: "#fafafa", fontWeight: "bold" }}
                >
                  <Table.Summary.Cell index={0} colSpan={2} align="right">
                    T·ªîNG C·ªòNG TO√ÄN NH√Ä M√ÅY:
                  </Table.Summary.Cell>
                  <Table.Summary.Cell index={1} align="center">
                    {totalStaff}
                  </Table.Summary.Cell>
                  <Table.Summary.Cell index={2} align="center">
                    <span style={{ color: "red" }}>{totalAbsent} ng∆∞·ªùi</span>
                  </Table.Summary.Cell>
                  <Table.Summary.Cell index={3} align="right">
                    {totalStaff > 0
                      ? ((totalAbsent / totalStaff) * 100).toFixed(1)
                      : 0}
                    %
                  </Table.Summary.Cell>
                </Table.Summary.Row>
              </Table.Summary>
            );
          }}
        />
      </Card>
    </AdminLayout>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\dashboard\departments\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\dashboard\page.tsx
================================================================================
"use client";

import React, { useEffect, useState, useMemo } from "react";
import AdminLayout from "@/components/AdminLayout";
import {
  Card,
  DatePicker,
  Row,
  Col,
  Statistic,
  Spin,
  Typography,
  Select,
  Empty,
} from "antd";
import {
  UsergroupAddOutlined,
  CheckCircleOutlined,
  CloseCircleOutlined,
  ReloadOutlined,
} from "@ant-design/icons";
import dayjs from "dayjs";
import type { Dayjs } from "dayjs";
import {
  PieChart,
  Pie,
  Cell,
  Tooltip as ReTooltip,
  Legend,
  ResponsiveContainer,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
} from "recharts";

const { Title } = Typography;

// --- M√ÄU S·∫ÆC BI·ªÇU ƒê·ªí ---
const COLORS = {
  present: "#00C49F", // Xanh l√° (ƒêi l√†m)
  absent: "#FF8042", // Cam (V·∫Øng)
  missing: "#d9d9d9", // X√°m (Ch∆∞a ch·∫•m)
};

export default function DashboardPage() {
  const [selectedDate, setSelectedDate] = useState<Dayjs>(dayjs());
  const [rawData, setRawData] = useState<any[]>([]);
  const [loading, setLoading] = useState(false);

  // 1. T·∫£i d·ªØ li·ªáu
  const fetchData = async () => {
    setLoading(true);
    try {
      const dateStr = selectedDate.format("YYYY-MM-DD");
      const res = await fetch(`/api/stats/daily?date=${dateStr}`);
      const data = await res.json();
      setRawData(data);
    } catch (error) {
      console.error(error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
  }, [selectedDate]);

  // 2. X·ª≠ l√Ω d·ªØ li·ªáu t·ªïng h·ª£p (Logic c·ªët l√µi)
  const stats = useMemo(() => {
    // ƒê·ªãnh nghƒ©a c√°c nh√≥m code
    const WORK_CODES = ["X", "XD", "CT", "Lƒê", "XL", "LE", "LD"];
    // C√°c nh√≥m ngh·ªâ ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì chi ti·∫øt
    const LEAVE_TYPES = {
      "Ph√©p (100%)": ["F", "R", "L", "ƒêC"],
      "·ªêm/BHXH": ["√î", "C√î", "TS", "DS", "T", "CL"],
      "Kh√¥ng l∆∞∆°ng": ["RO"],
      "V√¥ l√Ω do": ["O"],
    };

    // Helper ƒë·∫øm
    const getStatus = (emp: any) => {
      if (!emp.timesheets || emp.timesheets.length === 0) return "MISSING"; // Ch∆∞a ch·∫•m
      const code = emp.timesheets[0].attendanceCode.code;
      if (WORK_CODES.includes(code)) return "PRESENT"; // ƒêi l√†m
      return "ABSENT"; // Ngh·ªâ
    };

    // A. T·ªïng h·ª£p theo Nh√† m√°y (Cho 3 c√°i Card)
    // L·∫•y danh s√°ch nh√† m√°y duy nh·∫•t
    const factoryMap = new Map();

    rawData.forEach((emp) => {
      const factoryId = emp.department?.factory?.id || 0;
      const factoryName = emp.department?.factory?.name || "Kh√°c";

      if (!factoryMap.has(factoryId)) {
        factoryMap.set(factoryId, {
          id: factoryId,
          name: factoryName,
          total: 0,
          present: 0,
          absent: 0,
          missing: 0,
        });
      }

      const stat = factoryMap.get(factoryId);
      stat.total++;
      const status = getStatus(emp);
      if (status === "PRESENT") stat.present++;
      else if (status === "ABSENT") stat.absent++;
      else stat.missing++;
    });

    const factoryStats = Array.from(factoryMap.values());

    // B. T·ªïng h·ª£p bi·ªÉu ƒë·ªì tr√≤n (To√†n c√¥ng ty)
    let totalPresent = 0;
    let totalAbsent = 0;
    let totalMissing = 0;

    // C. T·ªïng h·ª£p bi·ªÉu ƒë·ªì c·ªôt (Chi ti·∫øt l√Ω do ngh·ªâ)
    const absenceDetail: any = {
      "Ph√©p (100%)": 0,
      "·ªêm/BHXH": 0,
      "Kh√¥ng l∆∞∆°ng": 0,
      "V√¥ l√Ω do": 0,
    };

    rawData.forEach((emp) => {
      const status = getStatus(emp);
      if (status === "PRESENT") totalPresent++;
      else if (status === "ABSENT") {
        totalAbsent++;
        // Ph√¢n lo·∫°i ngh·ªâ
        const code = emp.timesheets[0].attendanceCode.code;
        for (const [key, codes] of Object.entries(LEAVE_TYPES)) {
          if (codes.includes(code)) {
            absenceDetail[key]++;
            break;
          }
        }
      } else {
        totalMissing++;
      }
    });

    const pieData = [
      { name: "ƒêi l√†m", value: totalPresent, color: COLORS.present },
      { name: "Ngh·ªâ", value: totalAbsent, color: COLORS.absent },
      { name: "Ch∆∞a ch·∫•m", value: totalMissing, color: COLORS.missing },
    ];

    // Chuy·ªÉn object absenceDetail th√†nh array cho Recharts
    const barData = Object.keys(absenceDetail).map((key) => ({
      name: key,
      value: absenceDetail[key],
    }));

    return { factoryStats, pieData, barData, totalEmployees: rawData.length };
  }, [rawData]);

  return (
    <AdminLayout>
      <div
        style={{
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center",
          marginBottom: 24,
        }}
      >
        <Title level={3} style={{ margin: 0 }}>
          Dashboard T·ªïng quan
        </Title>
        <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
          <span style={{ fontWeight: 600 }}>Ng√†y xem:</span>
          <DatePicker
            value={selectedDate}
            onChange={(d) => d && setSelectedDate(d)}
            format="DD/MM/YYYY"
            allowClear={false}
          />
        </div>
      </div>

      <Spin spinning={loading}>
        {/* 1. TOP CARDS - TH·ªêNG K√ä THEO NH√Ä M√ÅY */}
        <Row gutter={[16, 16]} style={{ marginBottom: 24 }}>
          {stats.factoryStats.map((f: any) => (
            <Col xs={24} sm={12} lg={8} key={f.id}>
              <Card
                title={f.name}
                headStyle={{ background: "#fafafa", fontWeight: "bold" }}
                hoverable
              >
                <Row gutter={16} style={{ textAlign: "center" }}>
                  <Col span={8}>
                    <Statistic
                      title="T·ªïng NV"
                      value={f.total}
                      valueStyle={{ fontSize: 18, fontWeight: "bold" }}
                      prefix={<UsergroupAddOutlined />}
                    />
                  </Col>
                  <Col span={8}>
                    <Statistic
                      title="ƒêi l√†m"
                      value={f.present}
                      valueStyle={{ color: "#3f8600", fontSize: 18 }}
                      prefix={<CheckCircleOutlined />}
                    />
                  </Col>
                  <Col span={8}>
                    <Statistic
                      title="V·∫Øng"
                      value={f.absent}
                      valueStyle={{ color: "#cf1322", fontSize: 18 }}
                      prefix={<CloseCircleOutlined />}
                    />
                  </Col>
                </Row>
                {f.missing > 0 && (
                  <div
                    style={{
                      marginTop: 10,
                      textAlign: "center",
                      color: "#999",
                      fontSize: 12,
                    }}
                  >
                    ‚ö†Ô∏è C√≤n {f.missing} ng∆∞·ªùi ch∆∞a c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng
                  </div>
                )}
              </Card>
            </Col>
          ))}
        </Row>

        {/* 2. CHARTS SECTION */}
        {stats.totalEmployees > 0 ? (
          <Row gutter={[24, 24]}>
            {/* BI·ªÇU ƒê·ªí TR√íN - T·ª∂ L·ªÜ ƒêI L√ÄM */}
            <Col xs={24} lg={12}>
              <Card title="T·ª∑ l·ªá chuy√™n c·∫ßn to√†n c√¥ng ty">
                <div style={{ width: "100%", height: 300 }}>
                  <ResponsiveContainer>
                    <PieChart>
                      <Pie
                        data={stats.pieData}
                        cx="50%"
                        cy="50%"
                        innerRadius={60}
                        outerRadius={100}
                        paddingAngle={5}
                        dataKey="value"
                        label={({ name, percent }) =>
                          // Th√™m ƒëo·∫°n (percent || 0) ƒë·ªÉ b·∫£o ƒë·∫£m lu√¥n l√† s·ªë
                          `${name} ${((percent || 0) * 100).toFixed(0)}%`
                        }
                      >
                        {stats.pieData.map((entry, index) => (
                          <Cell key={`cell-${index}`} fill={entry.color} />
                        ))}
                      </Pie>
                      <ReTooltip />
                      <Legend />
                    </PieChart>
                  </ResponsiveContainer>
                </div>
              </Card>
            </Col>

            {/* BI·ªÇU ƒê·ªí C·ªòT - PH√ÇN T√çCH L√ù DO NGH·ªà */}
            <Col xs={24} lg={12}>
              <Card title="Ph√¢n t√≠ch l√Ω do v·∫Øng m·∫∑t">
                <div style={{ width: "100%", height: 300 }}>
                  <ResponsiveContainer>
                    <BarChart
                      data={stats.barData}
                      layout="vertical"
                      margin={{ left: 20 }}
                    >
                      <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                      <XAxis type="number" allowDecimals={false} />
                      <YAxis dataKey="name" type="category" width={100} />
                      <ReTooltip />
                      <Bar
                        dataKey="value"
                        name="S·ªë ng∆∞·ªùi"
                        fill="#8884d8"
                        barSize={30}
                      >
                        {stats.barData.map((entry, index) => (
                          <Cell
                            key={`cell-${index}`}
                            fill={
                              ["#2563eb", "#ca8a04", "#dc2626", "#000"][
                                index % 4
                              ]
                            }
                          />
                        ))}
                      </Bar>
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </Card>
            </Col>
          </Row>
        ) : (
          <Empty description="Ch∆∞a c√≥ d·ªØ li·ªáu" />
        )}
      </Spin>
    </AdminLayout>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\dashboard\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\departments\page.tsx
================================================================================
// src/app/departments/pages.tsx
"use client";

import React, { useEffect, useState, useMemo } from "react"; // Th√™m useMemo
import AdminLayout from "@/components/AdminLayout";
import { useSession } from "next-auth/react";
import {
  Table,
  Button,
  Modal,
  Form,
  Input,
  message,
  Select,
  Tag,
  Popconfirm,
  Space, // Import th√™m Space ƒë·ªÉ cƒÉn ch·ªânh n√∫t v√† √¥ l·ªçc
  type TableProps,
} from "antd";
import {
  PlusOutlined,
  DeleteOutlined,
  EditOutlined,
  FilterOutlined,
} from "@ant-design/icons";

// ... (Gi·ªØ nguy√™n c√°c Interface Factory v√† Department nh∆∞ c≈©)
interface Factory {
  id: number;
  name: string;
  code: string;
}

interface Department {
  id: number;
  code: string;
  name: string;
  factoryId?: number;
  factory?: {
    name: string;
  };
}

export default function DepartmentPage() {
  const { data: session } = useSession();
  const isViewOnly = !["ADMIN", "HR_MANAGER"].includes(
    session?.user?.role || ""
  );

  const [departments, setDepartments] = useState<Department[]>([]);
  const [factories, setFactories] = useState<Factory[]>([]);

  // --- 1. STATE M·ªöI CHO B·ªò L·ªåC ---
  const [filterFactoryId, setFilterFactoryId] = useState<number | null>(null);
  // ------------------------------

  const [loading, setLoading] = useState(false);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [form] = Form.useForm();
  const [editingId, setEditingId] = useState<number | null>(null);

  // ... (Gi·ªØ nguy√™n h√†m fetchDepartment v√† useEffect nh∆∞ c≈©)
  const fetchDepartment = async () => {
    setLoading(true);
    try {
      const [deptRes, facRes] = await Promise.all([
        fetch("/api/departments"),
        fetch("/api/factories"),
      ]);
      const deptData = await deptRes.json();
      const factData = await facRes.json();
      setDepartments(deptData);
      setFactories(factData);
    } catch (error) {
      message.error("L·ªói t·∫£i d·ªØ li·ªáu");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchDepartment();
  }, []);

  // ... (Gi·ªØ nguy√™n h√†m handleDelete, handleEdit, openAddModal, handleOK)
  const handleDelete = async (id: number) => {
    try {
      const res = await fetch(`/api/departments/${id}`, { method: "DELETE" });
      if (res.ok) {
        message.success("ƒê√£ x√≥a th√†nh c√¥ng!");
        fetchDepartment();
      } else {
        const errorData = await res.json();
        message.error(errorData.error || "L·ªói khi x√≥a");
      }
    } catch (error) {
      message.error("L·ªói k·∫øt n·ªëi, " + error);
    }
  };

  const handleEdit = (record: Department) => {
    setEditingId(record.id);
    form.setFieldsValue(record);
    setIsModalOpen(true);
  };

  const openAddModal = () => {
    setEditingId(null);
    form.resetFields();
    setIsModalOpen(true);
  };

  const handleOK = async () => {
    try {
      const values = await form.validateFields();
      const url = editingId
        ? `/api/departments/${editingId}`
        : "/api/departments";
      const method = editingId ? "PATCH" : "POST";

      const res = await fetch(url, {
        method: method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(values),
      });

      if (res.ok) {
        message.success(
          editingId ? "C·∫≠p nh·∫≠t th√†nh c√¥ng!" : "Th√™m m·ªõi th√†nh c√¥ng!"
        );
        setIsModalOpen(false);
        form.resetFields();
        setEditingId(null);
        fetchDepartment();
      } else {
        message.error("C√≥ l·ªói x·∫£y ra");
      }
    } catch (error) {
      console.log("Validate Failed !!!", error);
    }
  };

  // --- 2. LOGIC L·ªåC D·ªÆ LI·ªÜU ---
  // T·∫°o danh s√°ch m·ªõi d·ª±a tr√™n filterFactoryId
  const filteredDepartments = useMemo(() => {
    if (!filterFactoryId) return departments; // N·∫øu kh√¥ng ch·ªçn g√¨ th√¨ tr·∫£ v·ªÅ h·∫øt
    return departments.filter((dept) => dept.factoryId === filterFactoryId);
  }, [departments, filterFactoryId]);
  // ---------------------------

  // ... (Gi·ªØ nguy√™n columns)
  const columns: TableProps<Department>["columns"] = [
    { title: "ID", dataIndex: "id", key: "id", width: 50 },
    {
      title: "M√£ Ph√≤ng",
      dataIndex: "code",
      key: "code",
      render: (text: string) => <b>{text}</b>,
    },
    { title: "T√™n Ph√≤ng Ban", dataIndex: "name", key: "name" },
    {
      title: "Thu·ªôc Nh√† M√°y",
      dataIndex: "factory",
      key: "factory",
      render: (factory: Factory) => {
        if (!factory) return null;
        let color = "default";
        if (factory.code === "HC") color = "red";
        else if (factory.code === "NM1") color = "blue";
        else if (factory.code === "NM2") color = "green";
        else if (factory.code === "NM3") color = "#faad14";
        return <Tag color={color}>{factory.name}</Tag>;
      },
    },
    {
      title: "H√†nh ƒë·ªông",
      key: "action",
      render: (_: any, record: any) => (
        <>
          <Button
            type="text"
            icon={<EditOutlined />}
            style={{ color: "blue" }}
            onClick={() => handleEdit(record)}
          />
          <Popconfirm
            title="X√≥a b·ªô ph·∫≠n n√†y?"
            onConfirm={() => handleDelete(record.id)}
            okText="X√≥a"
            cancelText="H·ªßy"
          >
            <Button type="text" icon={<DeleteOutlined />} danger />
          </Popconfirm>
        </>
      ),
    },
  ].filter((col) => {
    if (isViewOnly && col.key === "action") return false;
    return true;
  });

  return (
    <AdminLayout>
      <div
        style={{
          marginBottom: 16,
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center", // CƒÉn gi·ªØa theo chi·ªÅu d·ªçc
        }}
      >
        <h2>Qu·∫£n l√Ω Ph√≤ng Ban</h2>

        {/* --- 3. C·∫¨P NH·∫¨T THANH C√îNG C·ª§ (L·ªåC + N√öT TH√äM) --- */}
        <Space>
          {/* √î dropdown L·ªçc */}
          <Select
            placeholder="L·ªçc theo nh√† m√°y"
            style={{ width: 200 }}
            allowClear // Cho ph√©p x√≥a ch·ªçn
            value={filterFactoryId}
            onChange={(val) => setFilterFactoryId(val)}
            suffixIcon={<FilterOutlined />} // Icon c√°i ph·ªÖu cho ƒë·∫πp
          >
            {/* Th√™m option hi·ªÉn th·ªã T·∫•t c·∫£ n·∫øu c·∫ßn, ho·∫∑c d√πng allowClear l√† ƒë·ªß */}
            {factories.map((f) => (
              <Select.Option key={f.id} value={f.id}>
                {f.name}
              </Select.Option>
            ))}
          </Select>

          {!isViewOnly && (
            <Button
              type="primary"
              icon={<PlusOutlined />}
              onClick={openAddModal}
            >
              Th√™m B·ªô Ph·∫≠n
            </Button>
          )}
        </Space>
        {/* ----------------------------------------------- */}
      </div>

      <Table
        // S·ª¨A: Thay departments b·∫±ng filteredDepartments
        dataSource={filteredDepartments}
        columns={columns}
        rowKey="id"
        loading={loading}
        bordered
      />

      {/* Modal gi·ªØ nguy√™n */}
      <Modal
        title={editingId ? "C·∫≠p nh·∫≠t b·ªô ph·∫≠n" : "Th√™m m·ªõi b·ªô ph·∫≠n"}
        open={isModalOpen}
        onOk={handleOK}
        onCancel={() => setIsModalOpen(false)}
      >
        <Form form={form} layout="vertical">
          <Form.Item name="code" label="M√£ Ph√≤ng" rules={[{ required: true }]}>
            <Input />
          </Form.Item>
          <Form.Item name="name" label="T√™n Ph√≤ng" rules={[{ required: true }]}>
            <Input />
          </Form.Item>
          <Form.Item name="factoryId" label="Thu·ªôc Nh√† M√°y">
            <Select placeholder="Ch·ªçn nh√† m√°y" allowClear>
              {factories.map((factory) => (
                <Select.Option key={factory.id} value={factory.id}>
                  {factory.name} ({factory.code})
                </Select.Option>
              ))}
            </Select>
          </Form.Item>
        </Form>
      </Modal>
    </AdminLayout>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\departments\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\employees\page.tsx
================================================================================
"use client";

import React, { useEffect, useState, useMemo } from "react";
import AdminLayout from "@/components/AdminLayout";
import { useSession } from "next-auth/react";
import {
  Table,
  Button,
  Modal,
  Form,
  Input,
  message,
  Select,
  DatePicker,
  Tag,
  Popconfirm,
  Card,
  Space,
  type TableProps,
} from "antd";
import {
  PlusOutlined,
  DeleteOutlined,
  EditOutlined,
  FilterOutlined,
  CheckCircleOutlined,
  CloseCircleOutlined,
  PhoneOutlined,
  SearchOutlined, // <--- 1. IMPORT TH√äM ICON T√åM KI·∫æM
} from "@ant-design/icons";
import dayjs from "dayjs";

// --- 1. DEFINITIONS (INTERFACES) ---
interface Factory {
  id: number;
  code: string;
  name: string;
}

interface Department {
  id: number;
  name: string;
  factory?: Factory;
}

interface Kip {
  id: number;
  name: string;
  factoryId: number;
  factory?: Factory;
}

interface Employee {
  id: number;
  code: string;
  fullName: string;
  birthday?: string;
  gender?: string;
  phone: string;
  department?: Department;
  kip?: Kip;
  position?: string;
  address?: string;
}

export default function EmployeePage() {
  const { data: session } = useSession();

  const isViewOnly = !["ADMIN", "HR_MANAGER"].includes(
    session?.user?.role || ""
  );

  // --- STATE ---
  const [employees, setEmployees] = useState<Employee[]>([]);
  const [departments, setDepartments] = useState<Department[]>([]);
  const [kips, setKips] = useState<Kip[]>([]);
  const [loading, setLoading] = useState(false);

  // State Modal
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [form] = Form.useForm();
  const [editingId, setEditingId] = useState<number | null>(null);

  // State B·ªô l·ªçc
  const [selectedFactoryId, setSelectedFactoryId] = useState<number | null>(
    null
  );
  const [selectedDeptId, setSelectedDeptId] = useState<number | null>(null);

  // --- 2. STATE M·ªöI CHO T√åM KI·∫æM ---
  const [searchText, setSearchText] = useState("");
  // -------------------------------

  // State Bulk Update
  const [selectedRowKeys, setSelectedRowKeys] = useState<React.Key[]>([]);
  const [bulkKipId, setBulkKipId] = useState<number | null>(null);

  // --- FETCH DATA ---
  const fetchEmployees = async () => {
    setLoading(true);
    try {
      const [empRes, deptRes, kipRes] = await Promise.all([
        fetch("/api/employees"),
        fetch("/api/departments"),
        fetch("/api/kips"),
      ]);

      setEmployees(await empRes.json());
      setDepartments(await deptRes.json());
      setKips(await kipRes.json());
    } catch (error) {
      message.error("L·ªói t·∫£i d·ªØ li·ªáu: " + error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchEmployees();
  }, []);

  // --- MEMOIZED DATA ---

  const factories = useMemo(() => {
    const map = new Map();
    departments.forEach((d) => {
      if (d.factory) map.set(d.factory.id, d.factory);
    });
    return Array.from(map.values()) as Factory[];
  }, [departments]);

  const availableDepartments = useMemo(() => {
    if (!selectedFactoryId) return departments;
    return departments.filter((d) => d.factory?.id === selectedFactoryId);
  }, [departments, selectedFactoryId]);

  const availableKips = useMemo(() => {
    if (!selectedFactoryId) return kips;
    return kips.filter((k) => k.factoryId === selectedFactoryId);
  }, [kips, selectedFactoryId]);

  // --- 3. C·∫¨P NH·∫¨T LOGIC L·ªåC (FILTER) ---
  const filteredEmployees = useMemo(() => {
    return employees.filter((emp) => {
      // L·ªçc theo Nh√† m√°y
      const matchFactory = selectedFactoryId
        ? emp.department?.factory?.id === selectedFactoryId
        : true;

      // L·ªçc theo Ph√≤ng ban
      const matchDept = selectedDeptId
        ? emp.department?.id === selectedDeptId
        : true;

      // [M·ªöI] L·ªçc theo T√™n (Kh√¥ng ph√¢n bi·ªát hoa th∆∞·ªùng)
      // Logic: Chuy·ªÉn c·∫£ t√™n trong data v√† t·ª´ kh√≥a t√¨m ki·∫øm v·ªÅ ch·ªØ th∆∞·ªùng (toLowerCase) r·ªìi so s√°nh
      const matchName = searchText
        ? emp.fullName.toLowerCase().includes(searchText.toLowerCase()) ||
          emp.code.toLowerCase().includes(searchText.toLowerCase()) // Bonus: T√¨m lu√¥n c·∫£ theo M√£ NV
        : true;

      return matchFactory && matchDept && matchName;
    });
  }, [employees, selectedFactoryId, selectedDeptId, searchText]); // Nh·ªõ th√™m searchText v√†o dependencies
  // -------------------------------------

  // --- ACTIONS ---
  const handleBulkUpdate = async () => {
    if (selectedRowKeys.length === 0) {
      message.warning("Ch∆∞a ch·ªçn nh√¢n vi√™n n√†o!");
      return;
    }

    setLoading(true);
    try {
      const res = await fetch("/api/employees/bulk-update", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          employeeIds: selectedRowKeys,
          kipId: bulkKipId,
        }),
      });

      if (res.ok) {
        message.success("C·∫≠p nh·∫≠t th√†nh c√¥ng!");
        setSelectedRowKeys([]);
        setBulkKipId(null);
        const empRes = await fetch("/api/employees");
        setEmployees(await empRes.json());
      } else {
        const errorData = await res.json();
        message.error("L·ªói: " + (errorData.error || "Kh√¥ng x√°c ƒë·ªãnh"));
      }
    } catch (error) {
      message.error("L·ªói k·∫øt n·ªëi server");
    } finally {
      setLoading(false);
    }
  };

  const handleDelete = async (id: number) => {
    try {
      const res = await fetch(`/api/employees/${id}`, { method: "DELETE" });
      if (res.ok) {
        message.success("ƒê√£ x√≥a!");
        fetchEmployees();
      } else {
        message.error("L·ªói khi x√≥a");
      }
    } catch (error) {
      message.error("L·ªói k·∫øt n·ªëi");
    }
  };

  const handleEdit = (record: Employee) => {
    setEditingId(record.id);
    form.setFieldsValue({
      ...record,
      birthday: record.birthday ? dayjs(record.birthday) : null,
      departmentId: record.department?.id,
      kipId: record.kip?.id,
    });
    setIsModalOpen(true);
  };

  const openAddModal = () => {
    setEditingId(null);
    form.resetFields();
    setIsModalOpen(true);
  };

  const handleOK = async () => {
    try {
      const values = await form.validateFields();
      const payload = {
        ...values,
        birthday: values.birthday
          ? values.birthday.format("YYYY-MM-DD") + "T00:00:00.000Z"
          : null,
      };

      const url = editingId ? `/api/employees/${editingId}` : "/api/employees";
      const method = editingId ? "PATCH" : "POST";

      const res = await fetch(url, {
        method: method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (res.ok) {
        message.success(editingId ? "C·∫≠p nh·∫≠t xong!" : "Th√™m m·ªõi xong!");
        setIsModalOpen(false);
        form.resetFields();
        setEditingId(null);
        fetchEmployees();
      } else {
        message.error("C√≥ l·ªói x·∫£y ra");
      }
    } catch (error) {
      console.log("Validate Failed", error);
    }
  };

  const rowSelection = {
    selectedRowKeys,
    onChange: (newSelectedRowKeys: React.Key[]) => {
      setSelectedRowKeys(newSelectedRowKeys);
    },
  };

  // --- COLUMNS ---
  const columns: TableProps<Employee>["columns"] = [
    {
      title: "M√£ NV",
      dataIndex: "code",
      key: "code",
      width: 90,
      render: (text: string) => <b>{text}</b>,
    },
    {
      title: "H·ªç t√™n",
      dataIndex: "fullName",
      key: "fullName",
      width: 180,
    },
    {
      title: "K√≠p / T·ªï",
      dataIndex: "kip",
      key: "kip",
      width: 130,
      render: (kip: Kip | null) => (
        <Tag color={kip ? "geekblue" : "default"}>
          {kip ? kip.name : "HC/Kh√°c"}
        </Tag>
      ),
    },
    {
      title: "B·ªô ph·∫≠n",
      dataIndex: "department",
      key: "department",
      width: 200,
      render: (dept: Department) => (
        <div>
          <div>{dept?.name}</div>
          {dept?.factory && (
            <small style={{ color: "#888" }}>({dept.factory.name})</small>
          )}
        </div>
      ),
    },
    {
      title: "Ch·ª©c v·ª•",
      dataIndex: "position",
      key: "position",
    },
    {
      title: "H√†nh ƒë·ªông",
      key: "action",
      width: 100,
      render: (_: any, record: any) => (
        <Space>
          <Button
            type="text"
            icon={<EditOutlined />}
            style={{ color: "blue" }}
            onClick={() => handleEdit(record)}
          />
          <Popconfirm
            title="X√≥a nh√¢n vi√™n n√†y?"
            onConfirm={() => handleDelete(record.id)}
            okText="X√≥a"
            cancelText="H·ªßy"
          >
            <Button type="text" icon={<DeleteOutlined />} danger />
          </Popconfirm>
        </Space>
      ),
    },
  ].filter((col) => {
    if (isViewOnly && col.key === "action") return false;
    return true;
  });

  // --- RENDER UI ---
  return (
    <AdminLayout>
      <div
        style={{
          marginBottom: 16,
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center",
        }}
      >
        <h2 className="text-2xl font-bold">
          {/* Hi·ªÉn th·ªã s·ªë l∆∞·ª£ng sau khi l·ªçc */}
          Qu·∫£n l√Ω nh√¢n s·ª± ({filteredEmployees.length})
        </h2>
        {!isViewOnly && (
          <Button type="primary" icon={<PlusOutlined />} onClick={openAddModal}>
            Th√™m nh√¢n vi√™n
          </Button>
        )}
      </div>

      {/* --- CARD B·ªò L·ªåC --- */}
      <Card size="small" style={{ marginBottom: 16, background: "#f5f5f5" }}>
        <div
          style={{
            display: "flex",
            gap: 12,
            alignItems: "center",
            flexWrap: "wrap",
          }}
        >
          <span style={{ fontWeight: 600 }}>
            <FilterOutlined /> B·ªô l·ªçc:
          </span>

          {/* --- 4. √î T√åM KI·∫æM M·ªöI --- */}
          <Input
            placeholder="T√¨m t√™n ho·∫∑c m√£ NV..."
            prefix={<SearchOutlined style={{ color: "#bfbfbf" }} />}
            style={{ width: 200 }}
            value={searchText}
            onChange={(e) => setSearchText(e.target.value)}
            allowClear
          />
          {/* ------------------------- */}

          <Select
            style={{ width: 220 }}
            placeholder="T·∫•t c·∫£ Nh√† m√°y"
            allowClear
            value={selectedFactoryId}
            onChange={(val) => {
              setSelectedFactoryId(val);
              setSelectedDeptId(null);
            }}
          >
            {factories.map((f) => (
              <Select.Option key={f.id} value={f.id}>
                {f.name}
              </Select.Option>
            ))}
          </Select>

          <Select
            style={{ width: 220 }}
            placeholder="T·∫•t c·∫£ Ph√≤ng ban"
            allowClear
            value={selectedDeptId}
            onChange={(val) => setSelectedDeptId(val)}
            disabled={!selectedFactoryId && departments.length > 50}
          >
            {availableDepartments.map((d) => (
              <Select.Option key={d.id} value={d.id}>
                {d.name}
              </Select.Option>
            ))}
          </Select>

          {(selectedFactoryId || selectedDeptId || searchText) && (
            <Button
              type="link"
              onClick={() => {
                setSelectedFactoryId(null);
                setSelectedDeptId(null);
                setSearchText(""); // Reset √¥ t√¨m ki·∫øm
              }}
            >
              X√≥a l·ªçc
            </Button>
          )}
        </div>
      </Card>

      {/* --- THANH C√îNG C·ª§ C·∫¨P NH·∫¨T H√ÄNG LO·∫†T --- */}
      {selectedRowKeys.length > 0 && !isViewOnly && (
        <div
          style={{
            marginBottom: 16,
            padding: "12px 24px",
            background: "#e6f7ff",
            border: "1px solid #91d5ff",
            borderRadius: 8,
            display: "flex",
            alignItems: "center",
            justifyContent: "space-between",
            boxShadow: "0 2px 8px rgba(0,0,0,0.1)",
          }}
        >
          <Space>
            <CheckCircleOutlined style={{ color: "#1890ff", fontSize: 20 }} />
            <span style={{ fontWeight: 600, fontSize: 16 }}>
              ƒêang ch·ªçn {selectedRowKeys.length} nh√¢n vi√™n
            </span>
          </Space>

          <Space>
            <span>G√°n v√†o:</span>
            <Select
              style={{ width: 250 }}
              placeholder="Ch·ªçn K√≠p / T·ªï..."
              value={bulkKipId}
              onChange={setBulkKipId}
              allowClear
            >
              {kips.map((k) => (
                <Select.Option key={k.id} value={k.id}>
                  {k.name} - {k.factory?.name}
                </Select.Option>
              ))}
            </Select>

            <Button
              type="primary"
              onClick={handleBulkUpdate}
              loading={loading}
              disabled={bulkKipId === undefined}
            >
              C·∫≠p nh·∫≠t ngay
            </Button>
            <Button
              icon={<CloseCircleOutlined />}
              onClick={() => setSelectedRowKeys([])}
            >
              H·ªßy
            </Button>
          </Space>
        </div>
      )}

      {/* --- B·∫¢NG D·ªÆ LI·ªÜU --- */}
      <Table
        rowSelection={!isViewOnly ? rowSelection : undefined}
        columns={columns}
        dataSource={filteredEmployees} // D√πng danh s√°ch ƒë√£ l·ªçc
        rowKey="id"
        loading={loading}
        bordered
        scroll={{ x: 900 }}
        pagination={{ pageSize: 20, showSizeChanger: true }}
      />

      {/* --- MODAL FORM GI·ªÆ NGUY√äN --- */}
      <Modal
        title={editingId ? "C·∫≠p nh·∫≠t th√¥ng tin" : "Th√™m m·ªõi nh√¢n vi√™n"}
        open={isModalOpen}
        onOk={handleOK}
        onCancel={() => setIsModalOpen(false)}
        width={700}
        confirmLoading={loading}
      >
        <Form form={form} layout="vertical">
          <div style={{ display: "flex", gap: 16 }}>
            <Form.Item
              name="code"
              label="M√£ NV"
              style={{ flex: 1 }}
              rules={[{ required: true, message: "B·∫Øt bu·ªôc" }]}
            >
              <Input placeholder="NV..." />
            </Form.Item>
            <Form.Item
              name="fullName"
              label="H·ªç v√† t√™n"
              style={{ flex: 2 }}
              rules={[{ required: true, message: "B·∫Øt bu·ªôc" }]}
            >
              <Input placeholder="Nh·∫≠p t√™n..." />
            </Form.Item>
          </div>

          <div style={{ display: "flex", gap: 16 }}>
            <Form.Item
              name="departmentId"
              label="Ph√≤ng ban / C√¥ng ƒëo·∫°n"
              style={{ flex: 1 }}
              rules={[{ required: true }]}
            >
              <Select
                placeholder="Ch·ªçn ph√≤ng ban"
                showSearch
                optionFilterProp="children"
              >
                {departments.map((dept) => (
                  <Select.Option key={dept.id} value={dept.id}>
                    {dept.name} - {dept.factory?.name}
                  </Select.Option>
                ))}
              </Select>
            </Form.Item>

            <Form.Item
              name="kipId"
              label="K√≠p / T·ªï (T√πy ch·ªçn)"
              style={{ flex: 1 }}
            >
              <Select placeholder="Ch·ªçn K√≠p (ho·∫∑c ƒë·ªÉ tr·ªëng)" allowClear>
                {kips.map((k) => (
                  <Select.Option key={k.id} value={k.id}>
                    {k.name} - {k.factory?.name}
                  </Select.Option>
                ))}
              </Select>
            </Form.Item>
          </div>

          <div style={{ display: "flex", gap: 16 }}>
            <Form.Item name="position" label="Ch·ª©c v·ª•" style={{ flex: 1 }}>
              <Input />
            </Form.Item>
            <Form.Item name="phone" label="S·ªë ƒëi·ªán tho·∫°i" style={{ flex: 1 }}>
              <Input prefix={<PhoneOutlined />} />
            </Form.Item>
          </div>

          <div style={{ display: "flex", gap: 16 }}>
            <Form.Item name="birthday" label="Ng√†y sinh" style={{ flex: 1 }}>
              <DatePicker
                style={{ width: "100%" }}
                format="DD/MM/YYYY"
                placeholder="Ch·ªçn ng√†y"
              />
            </Form.Item>
            <Form.Item name="gender" label="Gi·ªõi t√≠nh" style={{ width: 120 }}>
              <Select>
                <Select.Option value="Nam">Nam</Select.Option>
                <Select.Option value="N·ªØ">N·ªØ</Select.Option>
              </Select>
            </Form.Item>
          </div>

          <Form.Item name="address" label="ƒê·ªãa ch·ªâ th∆∞·ªùng tr√∫">
            <Input.TextArea rows={2} />
          </Form.Item>
        </Form>
      </Modal>
    </AdminLayout>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\employees\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\factories\page.tsx
================================================================================
// src/app/factories/page.tsx
"use client"; // B·∫Øt bu·ªôc v√¨ c√≥ t∆∞∆°ng t√°c (click, nh·∫≠p li·ªáu)

import React, { useEffect, useState } from "react";
import AdminLayout from "@/components/AdminLayout";
import { useSession } from "next-auth/react";
import {
  Table,
  Button,
  Modal,
  Form,
  Input,
  message,
  Space,
  Popconfirm,
} from "antd";
import { PlusOutlined, DeleteOutlined, EditOutlined } from "@ant-design/icons";

// 1. ƒê·ªãnh nghƒ©a ki·ªÉu d·ªØ li·ªáu cho Nh√† m√°y (gi√∫p code g·ª£i √Ω th√¥ng minh)
interface Factory {
  id: number;
  code: string;
  name: string;
}

export default function FactoryPage() {
  const { data: session } = useSession();
  // ƒê·ªãnh nghƒ©a ch·∫ø ƒë·ªô CH·ªà XEM
  // 1. Bi·∫øn th·∫ßn th√°nh ki·ªÉm tra quy·ªÅn
  // LOGIC M·ªöI: C·∫£ LEADER v√† TIMEKEEPER ƒë·ªÅu kh√¥ng ƒë∆∞·ª£c s·ª≠a danh m·ª•c
  // (Ch·ªâ ADMIN v√† HR_MANAGER m·ªõi ƒë∆∞·ª£c s·ª≠a)
  const isViewOnly = !["ADMIN", "HR_MANAGER"].includes(
    session?.user?.role || ""
  );

  // --- PH·∫¶N 1: QU·∫¢N L√ù TR·∫†NG TH√ÅI (STATE) ---
  const [factories, setFactories] = useState<Factory[]>([]); // Ch·ª©a danh s√°ch nh√† m√°y
  const [loading, setLoading] = useState(false); // Tr·∫°ng th√°i ƒëang t·∫£i xoay v√≤ng v√≤ng
  const [isModalOpen, setIsModalOpen] = useState(false); // Tr·∫°ng th√°i m·ªü/ƒë√≥ng Modal
  const [form] = Form.useForm(); // Hook ƒë·ªÉ qu·∫£n l√Ω Form c·ªßa AntD
  // State m·ªõi, l∆∞u ID c·ªßa d√≤ng ƒëang s·ª≠a (n·∫øu null nghƒ©a l√† ƒëang th√™m m·ªõi)
  const [editingId, setEditingId] = useState<number | null>(null);

  // --- PH·∫¶N 2: T∆Ø∆†NG T√ÅC V·ªöI API (BACKEND) ---
  // --- H√ÄM L·∫§Y DANH S√ÅCH T·ª™ API GET ---
  const fetchFactories = async () => {
    setLoading(true);
    try {
      const res = await fetch("/api/factories");
      const data = await res.json();
      setFactories(data);
    } catch (error) {
      message.error("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu: " + error);
    } finally {
      setLoading(false);
    }
  };

  // G·ªçi h√†m l·∫•y d·ªØ li·ªáu ngay khi trang v·ª´a m·ªü l√™n
  useEffect(() => {
    fetchFactories();
  }, []);

  // --- H√ÄM X·ª¨ L√ù X√ìA ---
  const handleDelete = async (id: number) => {
    try {
      const res = await fetch(`/api/factories/${id}`, {
        method: "DELETE",
      });

      if (res.ok) {
        message.success("ƒê√£ x√≥a th√†nh c√¥ng!");
        fetchFactories(); // Load l·∫°i b·∫£ng
      } else {
        const errorData = await res.json();
        message.error(errorData.error || "L·ªói khi x√≥a");
      }
    } catch (error) {
      message.error("L·ªói k·∫øt n·ªëi" + error);
    }
  };

  // --- H√ÄM M·ªû MODAL ƒê·ªÇ S·ª¨A
  const handleEdit = (record: Factory) => {
    setEditingId(record.id); // ƒê√°nh d·∫•u l√† ƒëang s·ª≠a ID n√†y
    form.setFieldsValue(record); // ƒêi·ªÅn d·ªØ li·ªáu c≈© v√†o form
    setIsModalOpen(true); // M·ªü Modal l√™n
  };

  // --- H√ÄM M·ªû MODAL ƒê·ªÇ TH√äM M·ªöI ---
  const openAddModal = () => {
    setEditingId(null); // ƒê√°nh d·∫•u l√† th√™m m·ªõi
    form.resetFields(); // X√≥a tr·∫Øng form
    setIsModalOpen(true); // M·ªü Modal
  };

  // --- H√ÄM KHI NH·∫§N N√öT L∆ØU TR√äN FORM (API POST) ---
  const handleOk = async () => {
    try {
      const values = await form.validateFields();

      // LOGIC PH√ÇN LU·ªíNG
      // N·∫øu editingId c√≥ gi√° tr·ªã th√¨ g·ªçi API s·ª≠a (PATCH)
      // N·∫øu editingID l√† null th√¨ g·ªçi API th√™m m·ªõi (POST)

      const url = editingId ? `/api/factories/${editingId}` : "/api/factories";
      const method = editingId ? "PATCH" : "POST";

      const res = await fetch(url, {
        method: method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(values),
      });

      if (res.ok) {
        message.success(
          editingId ? "C·∫≠p nh·∫≠t th√†nh c√¥ng!" : "Th√™m m·ªõi th√†nh c√¥ng!"
        );
        setIsModalOpen(false); // ƒê√≥ng Modal
        form.resetFields(); // X√≥a tr·∫Øng form
        setEditingId(null); // Reset tr·∫°ng th√°i
        fetchFactories(); // Load l·∫°i d·ªØ li·ªáu
      } else {
        message.error("C√≥ l·ªói x·∫£y ra...");
      }
    } catch (error) {
      console.log("Validation Failed: ", error);
    }
  };

  // --- PH·∫¶N 3: C·∫§U H√åNH B·∫¢NG (TABLE COLUMNS) ---
  const columns = [
    {
      title: "ID",
      dataIndex: "id",
      key: "id",
      width: 80,
    },
    {
      title: "M√£ Nh√† M√°y",
      dataIndex: "code",
      key: "code",
      render: (text: string) => <b>{text}</b>, // T√πy ch·ªânh CSS n·∫øu mu·ªën
    },
    {
      title: "T√™n Nh√† M√°y",
      dataIndex: "name",
      key: "name",
    },
    {
      title: "H√†nh ƒë·ªông",
      key: "action",
      render: (_: any, record: Factory) => (
        <Space size="middle">
          {/* N√öT S·ª¨A */}
          <Button
            type="text"
            icon={<EditOutlined />}
            style={{ color: "blue" }}
            onClick={() => handleEdit(record)}
          />
          {/* N√öT X√ìA C√ì X√ÅC NH·∫¨N */}
          <Popconfirm
            title="X√≥a nh√† m√°y n√†y?"
            description="H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c"
            onConfirm={() => handleDelete(record.id)}
            okText="X√≥a"
            cancelText="H·ªßy"
          >
            <Button type="text" icon={<DeleteOutlined />} danger />
          </Popconfirm>
        </Space>
      ),
    },
  ].filter((col) => {
    // N·∫øu l√† Leader V√Ä c·ªôt l√† 'action' -> Lo·∫°i b·ªè (return false)
    if (isViewOnly && col.key === "action") return false;
    return true;
  });

  // --- PH·∫¶N 4: GIAO DI·ªÜN NG∆Ø·ªúI D√ôNG (UI) ---
  return (
    <AdminLayout>
      <div
        style={{
          marginBottom: 16,
          display: "flex",
          justifyContent: "space-between",
        }}
      >
        <h2>Qu·∫£n l√Ω Nh√† m√°y</h2>
        {/* G·ªçi h√†m openAddModal thay v√¨ set tr·ª±c ti·∫øp */}

        {/* 3. Ch·ªâ hi·ªán n√∫t Th√™m m·ªõi n·∫øu ƒë∆∞·ª£c ph√©p s·ª≠a */}
        {!isViewOnly && (
          <Button type="primary" icon={<PlusOutlined />} onClick={openAddModal}>
            Th√™m Nh√† m√°y
          </Button>
        )}
      </div>

      {/* B·∫£ng d·ªØ li·ªáu */}
      <Table
        columns={columns}
        dataSource={factories}
        rowKey="id"
        loading={loading}
        bordered
      />

      {/* Modal nh·∫≠p li·ªáu */}
      <Modal
        title={editingId ? "C·∫≠p nh·∫≠t nh√† m√°y" : "Th√™m nh√† m√°y m·ªõi"}
        open={isModalOpen}
        onOk={handleOk}
        onCancel={() => setIsModalOpen(false)}
      >
        <Form form={form} layout="vertical" name="form_factory">
          <Form.Item
            name="code"
            label="M√£ Nh√† M√°y"
            rules={[{ required: true, message: "Vui l√≤ng nh·∫≠p m√£ nh√† m√°y!" }]}
          >
            <Input placeholder="V√≠ d·ª•: NM1" />
          </Form.Item>

          <Form.Item
            name="name"
            label="T√™n Nh√† M√°y"
            rules={[{ required: true, message: "Vui l√≤ng nh·∫≠p t√™n nh√† m√°y!" }]}
          >
            <Input placeholder="V√≠ d·ª•: Nh√† m√°y S·ª£i" />
          </Form.Item>
        </Form>
      </Modal>
    </AdminLayout>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\factories\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\globals.css
================================================================================
@import "tailwindcss";

:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\globals.css ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\help\page.tsx
================================================================================
"use client";

import React from "react";
import AdminLayout from "@/components/AdminLayout";
import { Typography, Card, Divider, Image } from "antd";

const { Title, Paragraph, Text } = Typography;

export default function ManualPage() {
  return (
    <AdminLayout>
      <div style={{ maxWidth: 800, margin: "0 auto" }}>
        <Card>
          <Typography>
            <Title level={2}>üìñ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng Ph·∫ßn m·ªÅm Ch·∫•m c√¥ng</Title>
            <Paragraph>
              Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi h·ªá th·ªëng HRM (Qu·∫£n l√Ω nh√¢n s·ª±), phi√™n b·∫£n
              V.1.0.0. Ph√°t tri·ªÉn b·ªüi Nguy·ªÖn Thi·ªán Minh Tr√≠. D∆∞·ªõi ƒë√¢y l√† c√°c
              b∆∞·ªõc c∆° b·∫£n ƒë·ªÉ s·ª≠ d·ª•ng ph·∫ßn m·ªÅm.
              <p>
                Click v√†o{" "}
                <a
                  href="https://drive.google.com/file/d/1JmZaeR7wq4_abRDmTU5nbUJz55K87JgB/view?usp=sharing"
                  target="_blank"
                >
                  ƒë∆∞·ªùng link n√†y
                </a>{" "}
                ƒë·ªÉ xem file h∆∞·ªõng d·∫´n chi ti·∫øt
              </p>
            </Paragraph>

            <Divider />

            {/* PH·∫¶N 1 */}
            <Title level={3}>1. C√°ch xem ch·∫•m c√¥ng h√†ng ng√†y</Title>
            <Paragraph>
              ƒê·ªÉ xem ch·∫•m c√¥ng, b·∫°n h√£y truy c·∫≠p v√†o menu{" "}
              <Text strong>T·ªïng h·ª£p c√¥ng</Text>
            </Paragraph>
            <Paragraph>
              <ul>
                <li>
                  Ch·ªçn <Text code>Th√°ng</Text> ƒë·∫øn <Text code>Nh√† m√°y</Text> v√†{" "}
                  <Text code>Ph√≤ng ban</Text>.
                </li>
                <li>H·ªá th·ªëng s·∫Ω hi·ªÉn th·ªã danh s√°ch nh√¢n vi√™n.</li>
                <li>Nh·ªØng √¥ m√†u xanh l√† ƒë√£ ƒëi l√†m, m√†u ƒë·ªè l√† v·∫Øng.</li>
              </ul>
            </Paragraph>

            {/* N·∫øu b·∫°n mu·ªën ch√®n ·∫£nh h∆∞·ªõng d·∫´n (b·ªè ·∫£nh v√†o th∆∞ m·ª•c public/images) */}
            {/* <Image src="/images/huong-dan-1.png" alt="·∫¢nh minh h·ªça" /> */}

            <Divider />

            {/* PH·∫¶N 2 */}
            <Title level={3}>2. Quy ƒë·ªãnh v·ªÅ c√°c k√Ω hi·ªáu</Title>
            <Paragraph>
              <ul>
                <li>
                  <Text strong>X:</Text> ƒêi l√†m c·∫£ ng√†y (C√¥ng 1.0)
                </li>
                <li>
                  <Text strong>X/2:</Text> ƒêi l√†m n·ª≠a ng√†y (C√¥ng 0.5)
                </li>
                <li>
                  <Text strong>P:</Text> Ngh·ªâ ph√©p nƒÉm
                </li>
                <li>
                  <Text strong>KL:</Text> Ngh·ªâ kh√¥ng l∆∞∆°ng
                </li>
                <Text italic>Xem th√™m ·ªü danh m·ª•c k√Ω hi·ªáu ch·∫•m c√¥ng</Text>
              </ul>
            </Paragraph>

            <Divider />

            {/* PH·∫¶N 3 */}
            <Paragraph>
              <Title level={3}>3. Th·ª±c hi·ªán ch·∫•m c√¥ng</Title>
              <Paragraph>
                ƒê·ªÉ th·ª±c hi·ªán ch·∫•m c√¥ng, b·∫°n h√£y truy c·∫≠p v√†o menu{" "}
                <Text strong>Ch·∫•m c√¥ng</Text>
              </Paragraph>
              <Paragraph>
                <ul>
                  <li>
                    Ch·ªçn <Text code>Ng√†y</Text> r·ªìi ch·ªçn{" "}
                    <Text code>Nh√† m√°y</Text> sau ƒë√≥ <Text code>Ph√≤ng ban</Text>
                    . N·∫øu kh√¥ng ch·ªçn ng√†y th√¨ m·∫∑c ƒë·ªãnh l·∫•y ng√†y h√¥m nay
                  </li>
                  <li>
                    H·ªá th·ªëng s·∫Ω hi·ªÉn th·ªã danh s√°ch nh√¢n vi√™n c·ªßa ph√≤ng ban ƒë∆∞·ª£c
                    ch·ªçn.
                  </li>
                  <li>
                    C√≥ th·ªÉ b·∫•m n√∫t t·∫•t c·∫£ ƒëi l√†m ƒë·ªÉ ch·∫•m nhanh, sau ƒë√≥ s·ª≠a l·∫°i
                    cho ph√π h·ª£p v·ªõi t·ª´ng ng∆∞·ªùi nh∆∞ l√†: ngh·ªâ ph√©p, ngh·ªâ ·ªëm,vv...
                    cho ph√π h·ª£p
                  </li>
                  <li>Sau ƒë√≥ nh·∫•n n√∫t L∆ØU B·∫¢NG C√îNG l√† xong.</li>
                </ul>
              </Paragraph>
            </Paragraph>

            <Divider />

            <Paragraph>
              <Text italic style={{ color: "red" }}>
                N·∫øu g·∫∑p l·ªói trong qu√° tr√¨nh s·ª≠ d·ª•ng, vui l√≤ng li√™n h·ªá b·ªô ph·∫≠n
                IT: Mr Tr√≠: 0984 857 190
              </Text>
            </Paragraph>
          </Typography>
        </Card>
      </div>
    </AdminLayout>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\help\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\layout.tsx
================================================================================
// src/app/layout.tsx
import React from "react";
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";
import StyledComponentsRegistry from "@/lib/AntdRegistry"; // Import v√†o
import { ConfigProvider } from "antd"; // C·∫•u h√¨nh thi·∫øt k·∫ø b·∫£ng d·ªØ li·ªáu

// 1. IMPORT C√ÅI N√ÄY V√ÄO
import SessionProviderWrapper from "@/components/SessionProviderWrapper";

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "HR Management App",
  description: "·ª®ng d·ª•ng qu·∫£n l√Ω nh√¢n s·ª±",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body className={inter.className}>
        {/* B·ªçc Registry ·ªü ƒë√¢y ƒë·ªÉ Ant Design ho·∫°t ƒë·ªông m∆∞·ª£t m√† */}
        <StyledComponentsRegistry>
          <SessionProviderWrapper>
            <ConfigProvider
              theme={{
                components: {
                  Table: {
                    // --- C·∫§U H√åNH M√ÄU S·∫ÆC B·∫¢NG ·ªû ƒê√ÇY ---
                    headerBg: "#12174A", // M√†u n·ªÅn Header (V√≠ d·ª•: Xanh ƒëen)
                    headerColor: "#ffffff", // M√†u ch·ªØ Header (Tr·∫Øng)
                    headerSortActiveBg: "#002140", // M√†u n·ªÅn khi c·ªôt ƒëang ƒë∆∞·ª£c sort
                    headerSortHoverBg: "#002140", // M√†u n·ªÅn khi di chu·ªôt v√†o header
                    rowHoverBg: "#A1E0FF", // M√†u n·ªÅn d√≤ng khi di chu·ªôt v√†o (t√πy ch·ªçn)
                  },
                },
              }}
            >
              {children}
            </ConfigProvider>
          </SessionProviderWrapper>
        </StyledComponentsRegistry>
      </body>
    </html>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\layout.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\login\page.tsx
================================================================================
"use client";

import React, { useState } from "react";
import { Form, Input, Button, Card, message, Typography } from "antd";
import { UserOutlined, LockOutlined } from "@ant-design/icons";
import { signIn } from "next-auth/react"; // H√†m ƒëƒÉng nh·∫≠p c·ªßa client
import { useRouter } from "next/navigation";
import Image from "next/image";

const { Title } = Typography;

export default function LoginPage() {
  const [loading, setLoading] = useState(false);
  const router = useRouter();

  const onFinish = async (values: any) => {
    setLoading(true);
    try {
      // G·ªçi h√†m ƒëƒÉng nh·∫≠p c·ªßa NextAuth
      const result = await signIn("credentials", {
        username: values.username,
        password: values.password,
        redirect: false, // Kh√¥ng t·ª± chuy·ªÉn trang ƒë·ªÉ m√¨nh t·ª± x·ª≠ l√Ω
      });

      if (result?.error) {
        message.error("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u");
      } else {
        message.success("ƒêƒÉng nh·∫≠p th√†nh c√¥ng!");
        router.push("/dashboard"); // Chuy·ªÉn h∆∞·ªõng v√†o trong
        router.refresh();
      }
    } catch (error) {
      message.error("L·ªói h·ªá th·ªëng");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div
      style={{
        height: "100vh",
        display: "flex",
        justifyContent: "center",
        alignItems: "center",
        background: "linear-gradient(135deg, #1890ff 0%, #001529 100%)", // M√†u xanh c√¥ng nghi·ªáp
      }}
    >
      <Card
        style={{
          width: 400,
          borderRadius: 10,
          boxShadow: "0 4px 12px rgba(0,0,0,0.2)",
        }}
      >
        <div
          style={{
            display: "flex", // 1. K√≠ch ho·∫°t Flexbox
            flexDirection: "column", // 2. X·∫øp c√°c ph·∫ßn t·ª≠ theo chi·ªÅu d·ªçc
            alignItems: "center", // 3. CƒÉn gi·ªØa theo chi·ªÅu ngang (Quan tr·ªçng!)
            marginBottom: 24,
          }}
        >
          <Image
            src="/image/logo/LogoSPB.png"
            alt="Logo"
            width={60} // Ch·ªânh ƒë·ªô r·ªông t√πy √Ω
            height={60} // Ch·ªânh ƒë·ªô cao t√πy √Ω
            style={{
              objectFit: "contain",
              marginBottom: 16, // Kho·∫£ng c√°ch v·ªõi d√≤ng ch·ªØ d∆∞·ªõi
            }}
            priority
          />
          <Title level={3} style={{ margin: 0 }}>
            QU·∫¢N L√ù CH·∫§M C√îNG
          </Title>
          <div style={{ color: "#888" }}>C√¥ng ty C·ªï ph·∫ßn S·ª£i Ph√∫ B√†i</div>
        </div>

        <Form name="login" onFinish={onFinish} layout="vertical" size="large">
          <Form.Item
            name="username"
            rules={[{ required: true, message: "Vui l√≤ng nh·∫≠p t√†i kho·∫£n!" }]}
          >
            <Input prefix={<UserOutlined />} placeholder="T√†i kho·∫£n" />
          </Form.Item>

          <Form.Item
            name="password"
            rules={[{ required: true, message: "Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u!" }]}
          >
            <Input.Password prefix={<LockOutlined />} placeholder="M·∫≠t kh·∫©u" />
          </Form.Item>

          <Form.Item>
            <Button type="primary" htmlType="submit" block loading={loading}>
              ƒêƒÇNG NH·∫¨P
            </Button>
          </Form.Item>
        </Form>
        <div style={{ textAlign: "center", fontSize: 12, color: "#999" }}>
          ¬© 2025 Phu Bai Spinning. Designed by Mr.Tri
        </div>
      </Card>
    </div>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\login\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\page.tsx
================================================================================
// src/app/page.tsx
"use client";
import AdminLayout from "@/components/AdminLayout";

export default function Home() {
  return (
    <AdminLayout>
      <h1 className="text-3xl font-bold">
        Ch√†o m·ª´ng ƒë·∫øn v·ªõi h·ªá th·ªëng qu·∫£n l√Ω nh√¢n s·ª± c√¥ng ty CP S·ª£i Ph√∫ B√†i
      </h1>
      <p style={{ fontSize: "22px" }}>
        Vui l√≤ng ch·ªçn ch·ª©c nƒÉng ·ªü menu b√™n tr√°i.
      </p>
    </AdminLayout>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\timesheets\daily\page-old.tsx
================================================================================
"use client";

import React, { useEffect, useState, useMemo } from "react";
import AdminLayout from "@/components/AdminLayout";
import { useSession } from "next-auth/react";
import {
  Table,
  Select,
  Button,
  DatePicker,
  message,
  Card,
  Input,
  Tag,
  Space,
  Typography,
  Alert,
} from "antd";
import {
  SaveOutlined,
  ReloadOutlined,
  FilterOutlined,
} from "@ant-design/icons";
import dayjs from "dayjs";
import type { Dayjs } from "dayjs";

const { Title } = Typography;

// --- INTERFACES ---
interface AttendanceCode {
  id: number;
  code: string;
  name: string;
  color: string;
}

interface Factory {
  id: number;
  name: string;
  code: string;
}

interface Department {
  id: number;
  name: string;
  factory?: Factory;
  isKip: boolean;
}

interface TimesheetRow {
  employeeId: number;
  employeeCode: string;
  fullName: string;
  attendanceCodeId: number | null;
  note: string;
  updatedAt?: string;
}

interface Kip {
  id: number;
  name: string;
  factoryId: number;
  factory?: { name: string };
}

export default function DailyTimesheetPage() {
  const { data: session } = useSession();
  const isViewOnly = session?.user?.role === "LEADER";

  // --- STATE ---
  const [departments, setDepartments] = useState<Department[]>([]);
  const [attendanceCodes, setAttendanceCodes] = useState<AttendanceCode[]>([]);
  const [employees, setEmployees] = useState<TimesheetRow[]>([]);
  const [kips, setKips] = useState<Kip[]>([]);

  // --- FILTER STATE ---
  const [selectedDate, setSelectedDate] = useState<Dayjs>(dayjs());
  const [selectedFactoryId, setSelectedFactoryId] = useState<number | null>(
    null
  );
  const [selectedDeptId, setSelectedDeptId] = useState<number | null>(null);
  const [selectedKipIds, setSelectedKipIds] = useState<number[]>([]);

  const [loading, setLoading] = useState(false);
  const [saving, setSaving] = useState(false);

  // 1. T·∫£i danh m·ª•c h·ªá th·ªëng
  useEffect(() => {
    const fetchInitData = async () => {
      try {
        const [deptRes, codeRes, kipRes] = await Promise.all([
          fetch("/api/departments"),
          fetch("/api/attendance-codes"),
          fetch("/api/kips"),
        ]);
        setDepartments(await deptRes.json());
        setKips(await kipRes.json());

        // --- X·ª¨ L√ù S·∫ÆP X·∫æP M√É C√îNG ---
        const codes: AttendanceCode[] = await codeRes.json();

        // ƒê·ªãnh nghƒ©a th·ª© t·ª± ∆∞u ti√™n (Nh·ªØng m√£ hay d√πng nh·∫•t ƒë·ªÉ l√™n ƒë·∫ßu)
        // B·∫°n c√≥ th·ªÉ th√™m b·ªõt t√πy √Ω v√†o danh s√°ch n√†y
        const PRIORITY_ORDER = [
          "X",
          "XD",
          "ƒêC",
          "X/2",
          "F",
          "NB",
          "√î",
          "XL",
          "L",
          "TS",
        ];

        codes.sort((a, b) => {
          const indexA = PRIORITY_ORDER.indexOf(a.code);
          const indexB = PRIORITY_ORDER.indexOf(b.code);

          // 1. N·∫øu c·∫£ 2 ƒë·ªÅu n·∫±m trong danh s√°ch ∆∞u ti√™n -> S·∫Øp theo th·ª© t·ª± trong danh s√°ch
          if (indexA !== -1 && indexB !== -1) {
            return indexA - indexB;
          }

          // 2. N·∫øu ch·ªâ c√≥ A n·∫±m trong danh s√°ch -> A l√™n tr∆∞·ªõc
          if (indexA !== -1) return -1;

          // 3. N·∫øu ch·ªâ c√≥ B n·∫±m trong danh s√°ch -> B l√™n tr∆∞·ªõc
          if (indexB !== -1) return 1;

          // 4. C√°c m√£ c√≤n l·∫°i (√≠t d√πng) -> S·∫Øp x·∫øp Alphabet cho d·ªÖ t√¨m
          return a.code.localeCompare(b.code);
        });

        setAttendanceCodes(codes);
        // -----------------------------
      } catch (error) {
        message.error("L·ªói t·∫£i danh m·ª•c h·ªá th·ªëng");
      }
    };
    fetchInitData();
  }, []);

  // --- LOGIC PH√ÇN QUY·ªÄN ---

  // A. L·ªçc danh s√°ch ƒë∆∞·ª£c ph√©p qu·∫£n l√Ω
  const availableDepartments = useMemo(() => {
    if (departments.length === 0 || !session) return [];
    const user = session.user;

    if (["ADMIN", "HR_MANAGER", "LEADER"].includes(user.role)) {
      return departments;
    }
    if (user.role === "TIMEKEEPER") {
      const allowedIds = user.managedDeptIds || [];
      return departments.filter((d) => allowedIds.includes(d.id));
    }
    return [];
  }, [departments, session]);

  // B. KI·ªÇM TRA: User n√†y c√≥ quy·ªÅn xem K√≠p hay kh√¥ng?
  const hasKipPermission = useMemo(() => {
    if (availableDepartments.length === 0) return false;
    return availableDepartments.some((d) => d.isKip === true);
  }, [availableDepartments]);

  // C. List Nh√† m√°y
  const factories = useMemo(() => {
    const map = new Map();
    availableDepartments.forEach((dept) => {
      if (dept.factory) map.set(dept.factory.id, dept.factory);
    });
    return Array.from(map.values()) as Factory[];
  }, [availableDepartments]);

  // --- C·∫§U H√åNH NH√Ä M√ÅY D√ôNG K√çP ---
  const SHIFT_FACTORY_IDS = [3, 2];

  // --- LOGIC T·ª∞ ƒê·ªòNG PH√ÅT HI·ªÜN ---
  const isShiftFactory = useMemo(() => {
    if (!selectedFactoryId) return false;
    return SHIFT_FACTORY_IDS.includes(selectedFactoryId);
  }, [selectedFactoryId]);

  // D. L·ªçc Ph√≤ng ban hi·ªÉn th·ªã v√†o Dropdown
  const filteredDepartments = useMemo(() => {
    if (!selectedFactoryId) return [];

    let depts = availableDepartments.filter(
      (d) => d.factory?.id === selectedFactoryId
    );

    if (isShiftFactory) {
      depts = depts.filter((d) => d.isKip === false);
    }

    return depts;
  }, [availableDepartments, selectedFactoryId, isShiftFactory]);

  // --- FETCH DATA (ƒê√É S·ª¨A ƒê·ªÇ T·ª∞ X√ìA D·ªÆ LI·ªÜU) ---
  const fetchTimesheetData = async () => {
    // [LOGIC M·ªöI] N·∫øu ch∆∞a ch·ªçn g√¨ c·∫£ -> X√≥a s·∫°ch d·ªØ li·ªáu c≈© v√† return
    if (!selectedDeptId && selectedKipIds.length === 0) {
      setEmployees([]); // <--- D√≤ng n√†y gi√∫p b·∫£ng bi·∫øn m·∫•t khi x√≥a √¥ ch·ªçn
      return;
    }

    setLoading(true);
    try {
      const dateStr = selectedDate.format("YYYY-MM-DD");
      const kipIdsParam =
        selectedKipIds.length > 0 ? selectedKipIds.join(",") : "";

      const url = `/api/timesheets/daily?date=${dateStr}&departmentId=${
        selectedDeptId || ""
      }&kipIds=${kipIdsParam}`;

      const res = await fetch(url);
      if (!res.ok) throw new Error("L·ªói t·∫£i");
      const data = await res.json();
      setEmployees(data);
    } catch (error) {
      console.error(error);
      message.error("L·ªói t·∫£i d·ªØ li·ªáu");
      setEmployees([]);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchTimesheetData();
  }, [selectedDeptId, selectedDate, selectedKipIds]);

  // --- HANDLERS ---
  const handleRowChange = (empId: number, field: string, value: any) => {
    const newData = [...employees];
    const index = newData.findIndex((item) => item.employeeId === empId);
    if (index > -1) {
      newData[index] = { ...newData[index], [field]: value };
      setEmployees(newData);
    }
  };

  const setAllStatus = (codeStr: string) => {
    const targetCode = attendanceCodes.find((c) => c.code === codeStr);
    if (!targetCode) return;
    const newEmployees = employees.map((emp) => ({
      ...emp,
      attendanceCodeId: targetCode.id,
    }));
    setEmployees(newEmployees);
    message.success(`ƒê√£ thi·∫øt l·∫≠p to√†n b·ªô l√† ${codeStr}`);
  };

  // H√†m l∆∞u d·ªØ li·ªáu ch·∫•m c√¥ng ng√†y
  const handleSave = async () => {
    // B∆Ø·ªöC 1: L·ªçc d·ªØ li·ªáu "s·∫°ch"
    // Ch·ªâ l·∫•y nh·ªØng nh√¢n vi√™n m√† attendanceCodeId c√≥ gi√° tr·ªã (kh√°c null v√† undefined)
    const validRecords = employees.filter(
      (e) => e.attendanceCodeId !== null && e.attendanceCodeId !== undefined
    );

    // B∆Ø·ªöC 2: Ki·ªÉm tra n·∫øu kh√¥ng c√≥ ai ƒë∆∞·ª£c ch·ªçn th√¨ d·ª´ng lu√¥n
    if (validRecords.length === 0) {
      message.warning(
        "Vui l√≤ng ch·ªçn c√¥ng cho √≠t nh·∫•t 1 nh√¢n vi√™n tr∆∞·ªõc khi l∆∞u!"
      );
      return;
    }

    setSaving(true);
    try {
      const payload = {
        date: selectedDate.format("YYYY-MM-DD"),
        departmentId: selectedDeptId,
        // B∆Ø·ªöC 3: Ch·ªâ map nh·ªØng b·∫£n ghi h·ª£p l·ªá ƒë√£ l·ªçc ·ªü tr√™n
        records: validRecords.map((e) => ({
          employeeId: e.employeeId,
          attendanceCodeId: e.attendanceCodeId,
          note: e.note,
        })),
      };

      const res = await fetch("/api/timesheets/daily", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (res.ok) {
        message.success(`ƒê√£ l∆∞u th√†nh c√¥ng ${validRecords.length} nh√¢n vi√™n!`);
        // G·ªçi h√†m t·∫£i l·∫°i d·ªØ li·ªáu ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i m·ªõi nh·∫•t t·ª´ server
        fetchTimesheetData();
      } else {
        const err = await res.json();
        message.error(err.error || "L·ªói khi l∆∞u");
      }
    } catch (error) {
      message.error("L·ªói k·∫øt n·ªëi server");
    } finally {
      setSaving(false);
    }
  };

  const timesheetStatus = useMemo(() => {
    if (employees.length === 0) return null;
    const hasData = employees.some((e) => e.attendanceCodeId !== null);
    const lastUpdate = employees.find((e) => e.updatedAt)?.updatedAt;
    return {
      isSubmitted: hasData,
      lastUpdate: lastUpdate
        ? dayjs(lastUpdate).format("HH:mm - DD/MM/YYYY")
        : null,
    };
  }, [employees]);

  // --- TABLE COLUMNS ---
  const columns = [
    {
      title: "STT",
      key: "index",
      width: 50,
      align: "center" as const,
      render: (_: any, __: any, index: number) => (
        <span style={{ color: "#888" }}>{index + 1}</span>
      ),
    },
    { title: "H·ªç v√† t√™n", dataIndex: "fullName", width: 220 },
    {
      title: "B·ªô ph·∫≠n",
      key: "deptInfo",
      width: 150,
      render: (_: any, record: TimesheetRow) => (
        <div style={{ fontSize: 12 }}>
          {(record as any).kipName ? (
            <Tag color="blue">{(record as any).kipName}</Tag>
          ) : (
            <Tag>{(record as any).departmentName}</Tag>
          )}
        </div>
      ),
    },
    {
      title: "Tr·∫°ng th√°i",
      dataIndex: "attendanceCodeId",
      width: 200,
      render: (value: number, record: TimesheetRow) => (
        <Select
          value={value}
          allowClear
          style={{ width: "100%" }}
          placeholder="Ch·ªçn c√¥ng"
          onChange={(val) =>
            handleRowChange(record.employeeId, "attendanceCodeId", val)
          }
          // 1. Truy·ªÅn ƒë·∫ßy ƒë·ªß d·ªØ li·ªáu (item) v√†o options
          options={attendanceCodes.map((c) => ({
            value: c.id,
            label: `${c.code} - ${c.name}`,
            item: c, // <--- QUAN TR·ªåNG: ƒê·ªÉ l·∫•y ƒë∆∞·ª£c m√†u ·ªü b∆∞·ªõc sau
          }))}
          // 2. Hi·ªÉn th·ªã m√†u trong danh s√°ch th·∫£ xu·ªëng
          optionRender={(option) => {
            const code = option.data.item;
            return (
              <Space>
                <Tag
                  color={code.color}
                  style={{
                    fontWeight: "bold",
                    minWidth: 40,
                    textAlign: "center",
                  }}
                >
                  {code.code}
                </Tag>
                {code.name}
              </Space>
            );
          }}
          // 3. Hi·ªÉn th·ªã m√†u khi ƒë√£ ch·ªçn xong (trong √¥ input)
          labelRender={(props) => {
            const code = attendanceCodes.find((c) => c.id === props.value);
            if (!code) return props.label;
            return (
              <Tag
                color={code.color}
                style={{
                  fontWeight: "bold",
                  width: "100%",
                  textAlign: "center",
                  margin: 0,
                }}
              >
                {code.code} - {code.name}
              </Tag>
            );
          }}
        />
      ),
    },
    {
      title: "Ghi ch√∫",
      dataIndex: "note",
      render: (text: string, record: TimesheetRow) => (
        <Input
          value={text}
          onChange={(e) =>
            handleRowChange(record.employeeId, "note", e.target.value)
          }
          placeholder="..."
        />
      ),
    },
  ];

  // --- LOGIC HI·ªÇN TH·ªä UI ---
  const showKipSelect = isShiftFactory && !selectedDeptId && hasKipPermission;
  const showDeptSelect = !isShiftFactory || selectedKipIds.length === 0;

  return (
    <AdminLayout>
      <div style={{ marginBottom: 24 }}>
        <Title level={3}>Ch·∫•m c√¥ng h√†ng ng√†y</Title>
      </div>

      <Card style={{ marginBottom: 16, background: "#f5f5f5" }} size="small">
        <div
          style={{
            display: "flex",
            gap: 16,
            alignItems: "center",
            flexWrap: "wrap",
          }}
        >
          {/* 1. NG√ÄY */}
          <div>
            <div style={{ fontWeight: 600, marginBottom: 4 }}>Ng√†y:</div>
            <DatePicker
              value={selectedDate}
              onChange={(date) => date && setSelectedDate(date)}
              format="DD/MM/YYYY"
              allowClear={false}
              style={{ width: 130 }}
            />
          </div>

          {/* 2. NH√Ä M√ÅY */}
          <div>
            <div style={{ fontWeight: 600, marginBottom: 4 }}>Nh√† m√°y:</div>
            <Select
              style={{ width: 180 }}
              placeholder="Ch·ªçn Nh√† m√°y"
              value={selectedFactoryId}
              onChange={(val) => {
                setSelectedFactoryId(val);
                setSelectedDeptId(null);
                setSelectedKipIds([]);
                setEmployees([]); // X√≥a b·∫£ng khi ƒë·ªïi nh√† m√°y
              }}
            >
              {factories.map((f) => (
                <Select.Option key={f.id} value={f.id}>
                  {f.name}
                </Select.Option>
              ))}
            </Select>
          </div>

          {/* 3. √î CH·ªåN K√çP */}
          {showKipSelect && (
            <div>
              <div style={{ fontWeight: 600, marginBottom: 4 }}>
                K√≠p (S·∫£n xu·∫•t):
              </div>
              <Select
                mode="multiple"
                style={{ width: 220 }}
                placeholder="Ch·ªçn K√≠p..."
                allowClear
                value={selectedKipIds}
                onChange={(val) => {
                  setSelectedKipIds(val);
                  if (val.length > 0) setSelectedDeptId(null);
                }}
                disabled={!selectedFactoryId}
              >
                {kips
                  .filter((k) => k.factoryId === selectedFactoryId)
                  .map((k) => (
                    <Select.Option key={k.id} value={k.id}>
                      {k.name}
                    </Select.Option>
                  ))}
              </Select>
            </div>
          )}

          {/* 4. √î CH·ªåN PH√íNG BAN */}
          {showDeptSelect && (
            <div>
              <div style={{ fontWeight: 600, marginBottom: 4 }}>
                {isShiftFactory ? "Ph√≤ng (H√†nh ch√≠nh/Kh√°c):" : "Ph√≤ng ban:"}
              </div>
              <Select
                style={{ width: 220 }}
                placeholder="Ch·ªçn Ph√≤ng ban"
                allowClear
                value={selectedDeptId}
                onChange={(val) => {
                  setSelectedDeptId(val);
                  if (val) setSelectedKipIds([]);
                }}
                disabled={!selectedFactoryId}
                showSearch
                optionFilterProp="children"
              >
                {filteredDepartments.map((d) => (
                  <Select.Option key={d.id} value={d.id}>
                    {d.name}
                  </Select.Option>
                ))}
              </Select>
            </div>
          )}

          <div style={{ marginTop: 24 }}>
            <Button
              icon={<ReloadOutlined />}
              onClick={fetchTimesheetData}
              disabled={!selectedDeptId && selectedKipIds.length === 0}
            >
              T·∫£i l·∫°i
            </Button>
          </div>
        </div>
      </Card>

      {/* HI·ªÇN TH·ªä C·∫¢NH B√ÅO */}
      {employees.length > 0 && (
        <div style={{ marginBottom: 16 }}>
          {timesheetStatus?.isSubmitted ? (
            <Alert
              message={`ƒê√£ ch·∫•m c√¥ng (C·∫≠p nh·∫≠t: ${timesheetStatus.lastUpdate})`}
              type="success"
              showIcon
            />
          ) : (
            <Alert
              message="Ch∆∞a c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng ng√†y n√†y."
              type="info"
              showIcon
            />
          )}
        </div>
      )}

      {/* B·∫¢NG D·ªÆ LI·ªÜU */}
      {employees.length > 0 ? (
        <>
          <div
            style={{
              marginBottom: 16,
              display: "flex",
              justifyContent: "space-between",
            }}
          >
            <Space>
              <span style={{ fontWeight: 600 }}>Thao t√°c nhanh:</span>
              <Button size="small" onClick={() => setAllStatus("X")}>
                ƒêi l√†m (X)
              </Button>
              <Button size="small" onClick={() => setAllStatus("L")}>
                Ngh·ªâ L·ªÖ (L)
              </Button>
            </Space>
            {!isViewOnly && (
              <Button
                type="primary"
                icon={<SaveOutlined />}
                onClick={handleSave}
                loading={saving}
              >
                L∆ØU D·ªÆ LI·ªÜU
              </Button>
            )}
          </div>

          <Table
            bordered
            dataSource={employees}
            columns={columns}
            rowKey="employeeId"
            loading={loading}
            pagination={false}
            scroll={{ y: 600 }}
            size="middle"
          />
        </>
      ) : (
        <div
          style={{
            textAlign: "center",
            padding: "50px",
            color: "#999",
            background: "#fff",
            border: "1px dashed #ddd",
          }}
        >
          Vui l√≤ng ch·ªçn <b>Nh√† m√°y</b> v√† b·ªô ph·∫≠n c·∫ßn ch·∫•m c√¥ng.
        </div>
      )}
    </AdminLayout>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\timesheets\daily\page-old.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\timesheets\daily\page.tsx
================================================================================
"use client";

import React, { useEffect, useState, useMemo } from "react";
import AdminLayout from "@/components/AdminLayout";
import { useSession } from "next-auth/react";
import {
  Table,
  Select,
  Button,
  DatePicker,
  message,
  Card,
  Input,
  Tag,
  Space,
  Typography,
  Alert,
} from "antd";
import { SaveOutlined, ReloadOutlined } from "@ant-design/icons";
import dayjs from "dayjs";
import type { Dayjs } from "dayjs";

const { Title } = Typography;

// --- INTERFACES ---
interface AttendanceCode {
  id: number;
  code: string;
  name: string;
  color: string;
}
interface Factory {
  id: number;
  name: string;
  code: string;
}
interface Department {
  id: number;
  code: string; // B·∫Øt bu·ªôc c√≥ m√£ code
  name: string;
  factory?: Factory;
  isKip: boolean;
}
interface TimesheetRow {
  employeeId: number;
  employeeCode: string;
  fullName: string;
  attendanceCodeId: number | null;
  note: string;
  updatedAt?: string;
}
interface Kip {
  id: number;
  name: string;
  factoryId: number;
  factory?: { name: string };
}

// Helper Interface cho Dropdown g·ªôp
interface DeptOption {
  value: string; // Format: "SECTION:GT" ho·∫∑c "DEPT:15"
  label: string;
  type: "SECTION" | "DEPT";
  code?: string; // M√£ t·ªï (GT) n·∫øu l√† Section
  id?: number; // ID th·∫≠t n·∫øu l√† Dept
}

export default function DailyTimesheetPage() {
  const { data: session } = useSession();
  const isViewOnly = session?.user?.role === "LEADER";

  // --- STATE ---
  const [departments, setDepartments] = useState<Department[]>([]);
  const [attendanceCodes, setAttendanceCodes] = useState<AttendanceCode[]>([]);
  const [employees, setEmployees] = useState<TimesheetRow[]>([]);
  const [kips, setKips] = useState<Kip[]>([]);

  // --- FILTER STATE ---
  const [selectedDate, setSelectedDate] = useState<Dayjs>(dayjs());
  const [selectedFactoryId, setSelectedFactoryId] = useState<number | null>(
    null
  );

  // State qu·∫£n l√Ω l·ª±a ch·ªçn Dropdown g·ªôp
  // Gi√° tr·ªã s·∫Ω l√† "SECTION:GT" ho·∫∑c "DEPT:123"
  const [mixedDeptValue, setMixedDeptValue] = useState<string | null>(null);

  // State K√≠p (cho NM2 v√† NM3)
  const [selectedKipIds, setSelectedKipIds] = useState<number[]>([]);

  const [loading, setLoading] = useState(false);
  const [saving, setSaving] = useState(false);

  // --- CONFIG ---
  const EXCLUSIVE_FACTORY_IDS = [3]; // NM3: Ch·ªçn K√≠p HO·∫∂C Ph√≤ng
  const MATRIX_FACTORY_IDS = [2]; // NM2: Ma tr·∫≠n

  // 1. Load Data
  useEffect(() => {
    const fetchInitData = async () => {
      try {
        const [deptRes, codeRes, kipRes] = await Promise.all([
          fetch("/api/departments"),
          fetch("/api/attendance-codes"),
          fetch("/api/kips"),
        ]);
        setDepartments(await deptRes.json());
        setKips(await kipRes.json());

        const codes: AttendanceCode[] = await codeRes.json();
        const PRIORITY = [
          "X",
          "XD",
          "ƒêC",
          "X/2",
          "F",
          "NB",
          "√î",
          "XL",
          "L",
          "TS",
        ];
        codes.sort((a, b) => {
          const iA = PRIORITY.indexOf(a.code),
            iB = PRIORITY.indexOf(b.code);
          if (iA !== -1 && iB !== -1) return iA - iB;
          if (iA !== -1) return -1;
          if (iB !== -1) return 1;
          return a.code.localeCompare(b.code);
        });
        setAttendanceCodes(codes);
      } catch (error) {
        message.error("L·ªói t·∫£i danh m·ª•c");
      }
    };
    fetchInitData();
  }, []);

  // --- LOGIC ---
  const availableDepartments = useMemo(() => {
    if (departments.length === 0 || !session) return [];
    const user = session.user;
    if (["ADMIN", "HR_MANAGER", "LEADER"].includes(user.role))
      return departments;
    if (user.role === "TIMEKEEPER") {
      const allowedIds = user.managedDeptIds || [];
      return departments.filter((d) => allowedIds.includes(d.id));
    }
    return [];
  }, [departments, session]);

  const hasKipPermission = useMemo(
    () => availableDepartments.some((d) => d.isKip === true),
    [availableDepartments]
  );

  const factories = useMemo(() => {
    const map = new Map();
    availableDepartments.forEach((d) => {
      if (d.factory) map.set(d.factory.id, d.factory);
    });
    return Array.from(map.values()) as Factory[];
  }, [availableDepartments]);

  const isExclusive = useMemo(
    () =>
      selectedFactoryId
        ? EXCLUSIVE_FACTORY_IDS.includes(selectedFactoryId)
        : false,
    [selectedFactoryId]
  );
  const isMatrix = useMemo(
    () =>
      selectedFactoryId
        ? MATRIX_FACTORY_IDS.includes(selectedFactoryId)
        : false,
    [selectedFactoryId]
  );

  // --- LOGIC T·∫†O DANH S√ÅCH DROPDOWN G·ªòP (QUAN TR·ªåNG) ---
  const mixedDeptOptions = useMemo<DeptOption[]>(() => {
    if (!selectedFactoryId) return [];
    const currentDepts = availableDepartments.filter(
      (d) => d.factory?.id === selectedFactoryId
    );
    const options: DeptOption[] = [];
    const processedSections = new Set<string>(); // ƒê·ªÉ tr√°nh tr√πng l·∫∑p Section

    currentDepts.forEach((d) => {
      // Check xem c√≥ ph·∫£i l√† Ph√≤ng thu·ªôc K√≠p (Ma tr·∫≠n) kh√¥ng? D·ª±a v√†o Regex M√£ Code
      // Regex: B·∫Øt ƒë·∫ßu b·∫±ng ID nh√† m√°y, Ch·ªØ c√°i ·ªü gi·ªØa, K·∫øt th√∫c s·ªë
      const matrixRegex = new RegExp(`^${selectedFactoryId}([a-zA-Z]+)(\\d+)$`);
      const match = d.code?.match(matrixRegex);

      if (isMatrix && match) {
        // --- TR∆Ø·ªúNG H·ª¢P 1: L√Ä T·ªî S·∫¢N XU·∫§T (Ma tr·∫≠n) ---
        const sectionCode = match[1]; // VD: GT
        if (!processedSections.has(sectionCode)) {
          // T·∫°o t√™n hi·ªÉn th·ªã ƒë·∫πp (C·∫Øt b·ªè ch·ªØ K√≠p)
          let displayName = d.name
            .replace(/(k√≠p|ca)\s*\d+.*$/gi, "")
            .trim()
            .replace(/-+.*$/gi, "")
            .trim();

          options.push({
            value: `SECTION:${sectionCode}`,
            label: displayName, // VD: "T·ªï Gh√©p th√¥"
            type: "SECTION",
            code: sectionCode,
          });
          processedSections.add(sectionCode);
        }
      } else {
        // --- TR∆Ø·ªúNG H·ª¢P 2: L√Ä PH√íNG BAN B√åNH TH∆Ø·ªúNG (Ho·∫∑c NM3 HC) ---
        // V·ªõi NM3 Exclusive: ·∫®n c√°c ph√≤ng SX (isKip=true) ƒë·ªÉ ch·ªçn b√™n √¥ K√≠p ri√™ng
        if (isExclusive && d.isKip) return;

        options.push({
          value: `DEPT:${d.id}`,
          label: d.name,
          type: "DEPT",
          id: d.id,
        });
      }
    });

    return options.sort((a, b) => a.label.localeCompare(b.label));
  }, [availableDepartments, selectedFactoryId, isMatrix, isExclusive]);

  // --- X·ª¨ L√ù S·ª∞ KI·ªÜN ---
  const handleFactoryChange = (val: number) => {
    setSelectedFactoryId(val);
    setMixedDeptValue(null);
    setSelectedKipIds([]);
    setEmployees([]); // X√≥a b·∫£ng khi ƒë·ªïi nh√† m√°y
  };

  const handleMixedDeptChange = (val: string) => {
    setMixedDeptValue(val);
    // N·∫øu ch·ªçn lo·∫°i DEPT (Ph√≤ng th∆∞·ªùng) th√¨ x√≥a ch·ªçn K√≠p ƒëi cho s·∫°ch
    if (val && val.startsWith("DEPT")) {
      setSelectedKipIds([]);
    }
    // N·∫øu l√† NM3 (Exclusive), ch·ªçn Ph√≤ng th√¨ x√≥a K√≠p
    if (isExclusive && val) setSelectedKipIds([]);
  };

  const handleKipChange = (val: number[]) => {
    setSelectedKipIds(val);
    // NM3: Ch·ªçn K√≠p th√¨ x√≥a ch·ªçn Ph√≤ng
    if (isExclusive && val.length > 0) setMixedDeptValue(null);
  };

  // --- H√ÄM T√çNH TO√ÅN ID PH√íNG BAN TH·ª∞C T·∫æ ---
  const resolveRealDepartmentIds = (): number[] => {
    if (!selectedFactoryId) return [];

    // TH1: Ch·ªçn Ph√≤ng ban c·ª• th·ªÉ (DEPT)
    if (mixedDeptValue && mixedDeptValue.startsWith("DEPT")) {
      const id = parseInt(mixedDeptValue.split(":")[1]);
      return [id];
    }

    // TH2: Ch·ªçn T·ªï S·∫£n Xu·∫•t (SECTION) - Logic Ma tr·∫≠n
    if (mixedDeptValue && mixedDeptValue.startsWith("SECTION")) {
      const sectionCode = mixedDeptValue.split(":")[1]; // GT

      // L·∫•y danh s√°ch s·ªë K√≠p t·ª´ c√°c K√≠p ƒë√£ ch·ªçn
      // N·∫øu kh√¥ng ch·ªçn K√≠p n√†o -> L·∫•y H·∫æT c√°c K√≠p (Logic: Xem c·∫£ t·ªï)
      let targetKipNumbers: string[] = [];

      if (selectedKipIds.length > 0) {
        // L·∫•y s·ªë t·ª´ t√™n K√≠p ƒë√£ ch·ªçn (K√≠p 1 -> "1")
        const selectedKipNames = kips
          .filter((k) => selectedKipIds.includes(k.id))
          .map((k) => k.name);
        targetKipNumbers = selectedKipNames
          .map((name) => name.match(/\d+/)?.[0] || "")
          .filter((n) => n);
      } else {
        // Kh√¥ng ch·ªçn k√≠p -> Kh√¥ng l·ªçc -> L·∫•y t·∫•t c·∫£ ph√≤ng c√≥ m√£ sectionCode
        // Tuy nhi√™n ƒë·ªÉ an to√†n, ta s·∫Ω duy·ªát qua department list
      }

      const realIds: number[] = [];
      availableDepartments.forEach((d) => {
        if (d.factory?.id !== selectedFactoryId) return;
        // Check Code: Ph·∫£i kh·ªõp Section (2GT...)
        const regex = new RegExp(`^${selectedFactoryId}${sectionCode}(\\d+)$`);
        const match = d.code?.match(regex);

        if (match) {
          const deptKipNum = match[1]; // S·ªë k√≠p trong m√£ ph√≤ng
          // N·∫øu c√≥ ch·ªçn K√≠p c·ª• th·ªÉ -> Ph·∫£i kh·ªõp s·ªë K√≠p
          if (targetKipNumbers.length > 0) {
            if (targetKipNumbers.includes(deptKipNum)) {
              realIds.push(d.id);
            }
          } else {
            // Kh√¥ng ch·ªçn K√≠p -> L·∫•y h·∫øt
            realIds.push(d.id);
          }
        }
      });
      return realIds;
    }

    return [];
  };

  // --- FETCH DATA ---
  const fetchTimesheetData = async () => {
    // 1. Ki·ªÉm tra ƒëi·ªÅu ki·ªán & X√≥a b·∫£ng n·∫øu kh√¥ng ch·ªçn g√¨
    // NM3: Ph·∫£i ch·ªçn Ph√≤ng HO·∫∂C K√≠p
    // NM2/1: Ph·∫£i ch·ªçn Ph√≤ng/T·ªï
    if (isExclusive) {
      if (!mixedDeptValue && selectedKipIds.length === 0) {
        setEmployees([]);
        return;
      }
    } else {
      if (!mixedDeptValue) {
        setEmployees([]);
        return;
      }
    }

    setLoading(true);
    try {
      const dateStr = selectedDate.format("YYYY-MM-DD");
      let url = `/api/timesheets/daily?date=${dateStr}`;

      if (isExclusive && selectedKipIds.length > 0 && !mixedDeptValue) {
        // NM3 tr∆∞·ªùng h·ª£p ch·ªâ ch·ªçn K√≠p (kh√¥ng ch·ªçn ph√≤ng)
        url += `&kipIds=${selectedKipIds.join(",")}`;
      } else {
        // C√°c tr∆∞·ªùng h·ª£p c√≤n l·∫°i: Ph·∫£i ph√¢n gi·∫£i ra Department IDs
        const realIds = resolveRealDepartmentIds();
        if (realIds.length === 0) {
          message.warning("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ph√≤ng ban t∆∞∆°ng ·ª©ng.");
          setEmployees([]);
          setLoading(false);
          return;
        }
        url += `&departmentId=${realIds.join(",")}`; // G·ª≠i chu·ªói "15,16"
      }

      const res = await fetch(url);
      if (!res.ok) throw new Error("L·ªói t·∫£i");
      const data = await res.json();
      setEmployees(data);
    } catch (error) {
      console.error(error);
      message.error("L·ªói t·∫£i d·ªØ li·ªáu");
      setEmployees([]);
    } finally {
      setLoading(false);
    }
  };

  // Auto load
  useEffect(() => {
    fetchTimesheetData();
  }, [selectedDate, selectedFactoryId, mixedDeptValue, selectedKipIds]);

  // --- SAVE ---
  const handleSave = async () => {
    const validRecords = employees.filter(
      (e) => e.attendanceCodeId !== null && e.attendanceCodeId !== undefined
    );
    if (validRecords.length === 0) {
      message.warning("Ch∆∞a ch·ªçn c√¥ng!");
      return;
    }

    setSaving(true);
    try {
      // V√¨ l∆∞u nhi·ªÅu ph√≤ng ban c√πng l√∫c, ta kh√¥ng g·ª≠i departmentId c·ª• th·ªÉ ·ªü c·∫•p cao nh·∫•t
      // M√† API daily c·ªßa ta ·ªü POST n√≥ t·ª± suy ra Department t·ª´ EmployeeID (ho·∫∑c ta g·ª≠i null)
      // *L∆∞u √Ω*: API daily POST c≈© c·ªßa b·∫°n c√≥ th·ªÉ ƒëang c·∫ßn departmentId ƒë·ªÉ check kh√≥a s·ªï.
      // N·∫øu ta g·ª≠i null, logic check kh√≥a s·ªï ph·∫£i d·ª±a v√†o employee list (nh∆∞ ta ƒë√£ s·ª≠a ·ªü c√°c b∆∞·ªõc tr∆∞·ªõc cho K√≠p).

      // Tuy nhi√™n, ƒë·ªÉ an to√†n, n·∫øu ch·ªâ c√≥ 1 dept th√¨ g·ª≠i, nhi·ªÅu th√¨ g·ª≠i null
      const realIds = resolveRealDepartmentIds();
      const payloadDeptId = realIds.length === 1 ? realIds[0] : null;

      const payload = {
        date: selectedDate.format("YYYY-MM-DD"),
        departmentId: payloadDeptId,
        records: validRecords.map((e) => ({
          employeeId: e.employeeId,
          attendanceCodeId: e.attendanceCodeId,
          note: e.note,
        })),
      };

      const res = await fetch("/api/timesheets/daily", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (res.ok) {
        message.success(`L∆∞u th√†nh c√¥ng ${validRecords.length} NV!`);
        fetchTimesheetData();
      } else {
        const err = await res.json();
        message.error(
          res.status === 403 ? `KH√ìA S·ªî: ${err.error}` : err.error || "L·ªói l∆∞u"
        );
      }
    } catch (error) {
      message.error("L·ªói k·∫øt n·ªëi");
    } finally {
      setSaving(false);
    }
  };

  // Helpers
  const handleRowChange = (empId: number, field: string, value: any) => {
    const newData = [...employees];
    const index = newData.findIndex((i) => i.employeeId === empId);
    if (index > -1) {
      newData[index] = { ...newData[index], [field]: value };
      setEmployees(newData);
    }
  };
  const setAllStatus = (codeStr: string) => {
    const targetCode = attendanceCodes.find((c) => c.code === codeStr);
    if (!targetCode) return;
    setEmployees(
      employees.map((e) => ({ ...e, attendanceCodeId: targetCode.id }))
    );
  };
  const timesheetStatus = useMemo(() => {
    if (employees.length === 0) return null;
    const hasData = employees.some((e) => e.attendanceCodeId !== null);
    const lastUpdate = employees.find((e) => e.updatedAt)?.updatedAt;
    return {
      isSubmitted: hasData,
      lastUpdate: lastUpdate
        ? dayjs(lastUpdate).format("HH:mm - DD/MM/YYYY")
        : null,
    };
  }, [employees]);

  // UI VARS
  // Show Kip if: (Matrix AND selected Section) OR (Exclusive AND has permission AND not selected Dept)
  const isSectionSelected = mixedDeptValue?.startsWith("SECTION");
  const showKipSelect =
    (isMatrix && isSectionSelected) ||
    (isExclusive && hasKipPermission && !mixedDeptValue);

  // Show Dept if: Not Exclusive OR (Exclusive AND not selected Kip)
  const showDeptSelect =
    !isExclusive || (isExclusive && selectedKipIds.length === 0);

  // COLUMNS (Gi·ªØ nguy√™n)
  const columns = [
    {
      title: "STT",
      key: "index",
      width: 50,
      align: "center" as const,
      render: (_: any, __: any, index: number) => (
        <span style={{ color: "#888" }}>{index + 1}</span>
      ),
    },
    { title: "H·ªç v√† t√™n", dataIndex: "fullName", width: 220 },
    {
      title: "B·ªô ph·∫≠n",
      key: "deptInfo",
      width: 150,
      render: (_: any, record: TimesheetRow) => (
        <div style={{ fontSize: 12 }}>
          {(record as any).kipName ? (
            <Tag color="blue">{(record as any).kipName}</Tag>
          ) : (
            <Tag>{(record as any).departmentName}</Tag>
          )}
        </div>
      ),
    },
    {
      title: "Tr·∫°ng th√°i",
      dataIndex: "attendanceCodeId",
      width: 200,
      render: (value: number, record: TimesheetRow) => (
        <Select
          value={value}
          allowClear
          style={{ width: "100%" }}
          placeholder="Ch·ªçn"
          onChange={(val) =>
            handleRowChange(record.employeeId, "attendanceCodeId", val)
          }
          options={attendanceCodes.map((c) => ({
            value: c.id,
            label: `${c.code} - ${c.name}`,
            item: c,
          }))}
          optionRender={(opt) => (
            <Space>
              <Tag
                color={opt.data.item.color}
                style={{
                  fontWeight: "bold",
                  minWidth: 40,
                  textAlign: "center",
                }}
              >
                {opt.data.item.code}
              </Tag>
              {opt.data.item.name}
            </Space>
          )}
          labelRender={(props) => {
            const c = attendanceCodes.find((x) => x.id === props.value);
            return c ? (
              <Tag
                color={c.color}
                style={{
                  fontWeight: "bold",
                  width: "100%",
                  textAlign: "center",
                }}
              >
                {c.code} - {c.name}
              </Tag>
            ) : (
              props.label
            );
          }}
        />
      ),
    },
    {
      title: "Ghi ch√∫",
      dataIndex: "note",
      render: (txt: string, rec: TimesheetRow) => (
        <Input
          value={txt}
          onChange={(e) =>
            handleRowChange(rec.employeeId, "note", e.target.value)
          }
          placeholder="..."
        />
      ),
    },
  ];

  return (
    <AdminLayout>
      <div style={{ marginBottom: 24 }}>
        <Title level={3}>Ch·∫•m c√¥ng h√†ng ng√†y</Title>
      </div>
      <Card style={{ marginBottom: 16, background: "#f5f5f5" }} size="small">
        <div
          style={{
            display: "flex",
            gap: 16,
            alignItems: "center",
            flexWrap: "wrap",
          }}
        >
          <div>
            <div style={{ fontWeight: 600, marginBottom: 4 }}>Ng√†y:</div>
            <DatePicker
              value={selectedDate}
              onChange={(d) => d && setSelectedDate(d)}
              format="DD/MM/YYYY"
              allowClear={false}
              style={{ width: 130 }}
            />
          </div>

          <div>
            <div style={{ fontWeight: 600, marginBottom: 4 }}>Nh√† m√°y:</div>
            <Select
              style={{ width: 180 }}
              placeholder="Ch·ªçn Nh√† m√°y"
              value={selectedFactoryId}
              onChange={handleFactoryChange}
            >
              {factories.map((f) => (
                <Select.Option key={f.id} value={f.id}>
                  {f.name}
                </Select.Option>
              ))}
            </Select>
          </div>

          {showDeptSelect && (
            <div>
              <div style={{ fontWeight: 600, marginBottom: 4 }}>
                {isMatrix ? "Ch·ªçn T·ªï / B·ªô ph·∫≠n:" : "Ph√≤ng ban:"}
              </div>
              <Select
                style={{ width: 220 }}
                placeholder="Ch·ªçn..."
                allowClear
                value={mixedDeptValue}
                onChange={handleMixedDeptChange}
                disabled={!selectedFactoryId}
                showSearch
                optionFilterProp="children"
              >
                {mixedDeptOptions.map((opt) => (
                  <Select.Option key={opt.value} value={opt.value}>
                    {opt.label}
                  </Select.Option>
                ))}
              </Select>
            </div>
          )}

          {showKipSelect && (
            <div>
              <div style={{ fontWeight: 600, marginBottom: 4 }}>
                {isMatrix ? "L·ªçc theo K√≠p (Ch·ªçn nhi·ªÅu):" : "Ch·ªçn K√≠p:"}
              </div>
              <Select
                mode="multiple"
                style={{ width: 220 }}
                placeholder="T·∫•t c·∫£ K√≠p"
                allowClear
                value={selectedKipIds}
                onChange={handleKipChange}
                disabled={!selectedFactoryId}
              >
                {kips
                  .filter((k) => k.factoryId === selectedFactoryId)
                  .map((k) => (
                    <Select.Option key={k.id} value={k.id}>
                      {k.name}
                    </Select.Option>
                  ))}
              </Select>
            </div>
          )}

          <div style={{ marginTop: 24 }}>
            <Button
              icon={<ReloadOutlined />}
              onClick={fetchTimesheetData}
              disabled={!mixedDeptValue && selectedKipIds.length === 0}
            >
              T·∫£i l·∫°i
            </Button>
          </div>
        </div>
      </Card>

      {employees.length > 0 && (
        <div style={{ marginBottom: 16 }}>
          {timesheetStatus?.isSubmitted ? (
            <Alert
              message={`ƒê√£ ch·∫•m c√¥ng (C·∫≠p nh·∫≠t: ${timesheetStatus.lastUpdate})`}
              type="success"
              showIcon
            />
          ) : (
            <Alert message="Ch∆∞a c√≥ d·ªØ li·ªáu." type="info" showIcon />
          )}
        </div>
      )}

      {employees.length > 0 ? (
        <>
          <div
            style={{
              marginBottom: 16,
              display: "flex",
              justifyContent: "space-between",
            }}
          >
            <Space>
              <span style={{ fontWeight: 600 }}>Thao t√°c nhanh:</span>
              <Button size="small" onClick={() => setAllStatus("X")}>
                ƒêi l√†m (X)
              </Button>
              <Button size="small" onClick={() => setAllStatus("L")}>
                Ngh·ªâ L·ªÖ (L)
              </Button>
            </Space>
            {!isViewOnly && (
              <Button
                type="primary"
                icon={<SaveOutlined />}
                onClick={handleSave}
                loading={saving}
              >
                L∆ØU D·ªÆ LI·ªÜU
              </Button>
            )}
          </div>
          <Table
            bordered
            dataSource={employees}
            columns={columns}
            rowKey="employeeId"
            loading={loading}
            pagination={false}
            scroll={{ y: 600 }}
            size="middle"
          />
        </>
      ) : (
        <div
          style={{
            textAlign: "center",
            padding: "50px",
            color: "#999",
            background: "#fff",
            border: "1px dashed #ddd",
          }}
        >
          Vui l√≤ng ch·ªçn <b>Nh√† m√°y</b> v√† b·ªô ph·∫≠n c·∫ßn ch·∫•m c√¥ng.
        </div>
      )}
    </AdminLayout>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\timesheets\daily\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\timesheets\monthly\page.tsx
================================================================================
"use client";

import ExcelJS from "exceljs";
import { saveAs } from "file-saver";
import React, { useEffect, useState, useMemo } from "react";
import AdminLayout from "@/components/AdminLayout";
import { useSession } from "next-auth/react";
import {
  Table,
  Select,
  Button,
  DatePicker,
  message,
  Card,
  Typography,
  Tooltip,
  Tag,
} from "antd";
import {
  ReloadOutlined,
  FileExcelOutlined,
  LockOutlined,
  UnlockOutlined,
} from "@ant-design/icons";
import dayjs from "dayjs";
import type { Dayjs } from "dayjs";

const { Title } = Typography;

// --- INTERFACES ---
interface AttendanceCode {
  id: number;
  code: string;
  name: string;
  color: string;
}
interface MonthlyEmployeeData {
  id: number;
  code: string;
  fullName: string;
  department?: { name: string };
  kip?: { name: string };
  timesheets: { date: string; attendanceCode: AttendanceCode }[];
}
interface Factory {
  id: number;
  name: string;
}
interface Department {
  id: number;
  code: string; // C·∫ßn tr∆∞·ªùng code
  name: string;
  factory?: Factory;
  isKip: boolean;
}
interface Kip {
  id: number;
  name: string;
  factoryId: number;
}
interface DeptOption {
  value: string;
  label: string;
  type: "SECTION" | "DEPT";
  code?: string;
  id?: number;
}

export default function MonthlyTimesheetPage() {
  const { data: session } = useSession();

  // --- STATE ---
  const [departments, setDepartments] = useState<Department[]>([]);
  const [kips, setKips] = useState<Kip[]>([]);
  const [employees, setEmployees] = useState<MonthlyEmployeeData[]>([]);

  // Filter State
  const [selectedMonth, setSelectedMonth] = useState<Dayjs>(dayjs());
  const [selectedFactoryId, setSelectedFactoryId] = useState<number | null>(
    null
  );
  const [mixedDeptValue, setMixedDeptValue] = useState<string | null>(null); // State dropdown g·ªôp
  const [selectedKipIds, setSelectedKipIds] = useState<number[]>([]);

  const [loading, setLoading] = useState(false);
  const [isLocked, setIsLocked] = useState(false);

  // --- CONFIG ---
  const EXCLUSIVE_FACTORY_IDS = [3];
  const MATRIX_FACTORY_IDS = [2];

  // 1. Load Data
  useEffect(() => {
    const fetchData = async () => {
      try {
        const [deptRes, kipRes] = await Promise.all([
          fetch("/api/departments"),
          fetch("/api/kips"),
        ]);
        setDepartments(await deptRes.json());
        setKips(await kipRes.json());
      } catch (error) {
        message.error("L·ªói t·∫£i danh m·ª•c");
      }
    };
    fetchData();
  }, []);

  // --- LOGIC ---
  const availableDepartments = useMemo(() => {
    if (departments.length === 0 || !session) return [];
    const user = session.user;
    if (["ADMIN", "HR_MANAGER", "LEADER"].includes(user.role))
      return departments;
    if (user.role === "TIMEKEEPER") {
      const allowedIds = user.managedDeptIds || [];
      return departments.filter((d) => allowedIds.includes(d.id));
    }
    return [];
  }, [departments, session]);

  const hasKipPermission = useMemo(
    () => availableDepartments.some((d) => d.isKip === true),
    [availableDepartments]
  );

  const isExclusive = useMemo(
    () =>
      selectedFactoryId
        ? EXCLUSIVE_FACTORY_IDS.includes(selectedFactoryId)
        : false,
    [selectedFactoryId]
  );
  const isMatrix = useMemo(
    () =>
      selectedFactoryId
        ? MATRIX_FACTORY_IDS.includes(selectedFactoryId)
        : false,
    [selectedFactoryId]
  );

  // --- LOGIC DROPDOWN G·ªòP (Section + Dept) ---
  const mixedDeptOptions = useMemo<DeptOption[]>(() => {
    if (!selectedFactoryId) return [];
    const currentDepts = availableDepartments.filter(
      (d) => d.factory?.id === selectedFactoryId
    );
    const options: DeptOption[] = [];
    const processedSections = new Set<string>();

    currentDepts.forEach((d) => {
      const matrixRegex = new RegExp(`^${selectedFactoryId}([a-zA-Z]+)(\\d+)$`);
      const match = d.code?.match(matrixRegex);

      if (isMatrix && match) {
        const sectionCode = match[1]; // GT
        if (!processedSections.has(sectionCode)) {
          const displayName = d.name
            .replace(/(k√≠p|ca)\s*\d+.*$/gi, "")
            .trim()
            .replace(/-+.*$/gi, "")
            .trim();
          options.push({
            value: `SECTION:${sectionCode}`,
            label: displayName,
            type: "SECTION",
            code: sectionCode,
          });
          processedSections.add(sectionCode);
        }
      } else {
        if (isExclusive && d.isKip) return; // NM3: ·∫®n ph√≤ng SX
        options.push({
          value: `DEPT:${d.id}`,
          label: d.name,
          type: "DEPT",
          id: d.id,
        });
      }
    });
    return options.sort((a, b) => a.label.localeCompare(b.label));
  }, [availableDepartments, selectedFactoryId, isMatrix, isExclusive]);

  // --- RESOLVE ID ---
  const resolveRealDepartmentIds = (): number[] => {
    if (!selectedFactoryId) return [];
    if (mixedDeptValue && mixedDeptValue.startsWith("DEPT")) {
      return [parseInt(mixedDeptValue.split(":")[1])];
    }
    if (mixedDeptValue && mixedDeptValue.startsWith("SECTION")) {
      const sectionCode = mixedDeptValue.split(":")[1];
      let targetKipNumbers: string[] = [];
      if (selectedKipIds.length > 0) {
        const names = kips
          .filter((k) => selectedKipIds.includes(k.id))
          .map((k) => k.name);
        targetKipNumbers = names
          .map((name) => name.match(/\d+/)?.[0] || "")
          .filter((n) => n);
      }
      const realIds: number[] = [];
      availableDepartments.forEach((d) => {
        if (d.factory?.id !== selectedFactoryId) return;
        const regex = new RegExp(`^${selectedFactoryId}${sectionCode}(\\d+)$`);
        const match = d.code?.match(regex);
        if (match) {
          const deptKipNum = match[1];
          if (
            targetKipNumbers.length === 0 ||
            targetKipNumbers.includes(deptKipNum)
          ) {
            realIds.push(d.id);
          }
        }
      });
      return realIds;
    }
    return [];
  };

  // --- HANDLERS ---
  const handleFactoryChange = (val: number) => {
    setSelectedFactoryId(val);
    setMixedDeptValue(null);
    setSelectedKipIds([]);
    setEmployees([]);
  };
  const handleMixedDeptChange = (val: string) => {
    setMixedDeptValue(val);
    if (val?.startsWith("DEPT") || isExclusive) setSelectedKipIds([]);
  };
  const handleKipChange = (val: number[]) => {
    setSelectedKipIds(val);
    if (isExclusive && val.length > 0) setMixedDeptValue(null);
  };

  // --- FETCH DATA ---
  const fetchMonthlyData = async () => {
    if (isExclusive) {
      if (!mixedDeptValue && selectedKipIds.length === 0) {
        setEmployees([]);
        return;
      }
    } else {
      if (!mixedDeptValue) {
        setEmployees([]);
        return;
      }
    }

    setLoading(true);
    try {
      const month = selectedMonth.month() + 1;
      const year = selectedMonth.year();
      let url = `/api/timesheets/monthly?month=${month}&year=${year}`;

      if (isExclusive && selectedKipIds.length > 0 && !mixedDeptValue) {
        url += `&kipIds=${selectedKipIds.join(",")}`;
      } else {
        const realIds = resolveRealDepartmentIds();
        if (realIds.length === 0) {
          message.warning("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ph√≤ng ban.");
          setEmployees([]);
          setLoading(false);
          return;
        }
        url += `&departmentId=${realIds.join(",")}`;
      }

      const res = await fetch(url);
      const data = await res.json();
      if (data.error) {
        message.error(data.error);
        setEmployees([]);
      } else {
        setEmployees(data);
      }
    } catch (error) {
      message.error("L·ªói t·∫£i d·ªØ li·ªáu");
      setEmployees([]);
    } finally {
      setLoading(false);
    }
  };

  // ... (sau h√†m fetchMonthlyData) ...

  // --- [M·ªöI] T·ª∞ ƒê·ªòNG T·∫¢I D·ªÆ LI·ªÜU KHI THAY ƒê·ªîI B·ªò L·ªåC ---
  useEffect(() => {
    // Ch·ªâ ch·∫°y khi ƒë√£ ch·ªçn Nh√† m√°y
    if (!selectedFactoryId) return;

    // Logic ki·ªÉm tra ƒëi·ªÅu ki·ªán h·ª£p l·ªá ƒë·ªÉ t·∫£i:
    let shouldFetch = false;

    if (isExclusive) {
      // NM3: Ch·ªçn (Ph√≤ng) HO·∫∂C (K√≠p) l√† ƒë∆∞·ª£c
      if (mixedDeptValue || selectedKipIds.length > 0) shouldFetch = true;
    } else {
      // NM1, NM2: B·∫Øt bu·ªôc ph·∫£i c√≥ Ph√≤ng/T·ªï (mixedDeptValue)
      // (V·ªõi NM2, n·∫øu ch∆∞a ch·ªçn K√≠p th√¨ n√≥ s·∫Ω t·ª± hi·ªÉu l√† l·∫•y c·∫£ T·ªï)
      if (mixedDeptValue) shouldFetch = true;
    }

    if (shouldFetch) {
      fetchMonthlyData();
    } else {
      // N·∫øu b·ªè ch·ªçn h·∫øt th√¨ x√≥a b·∫£ng cho s·∫°ch
      setEmployees([]);
    }
  }, [selectedFactoryId, selectedMonth, mixedDeptValue, selectedKipIds]); // <-- Khi 4 c√°i n√†y thay ƒë·ªïi, h√†m s·∫Ω t·ª± ch·∫°y l·∫°i

  // ... (ph·∫ßn checkLockStatus v√† return gi·ªØ nguy√™n) ...

  // Check Lock Status (Check for the first resolved ID)
  const checkLockStatus = async () => {
    let targetId: number | null = null;
    const realIds = resolveRealDepartmentIds();
    if (realIds.length > 0) targetId = realIds[0];
    else if (!isMatrix && mixedDeptValue?.startsWith("DEPT"))
      targetId = parseInt(mixedDeptValue.split(":")[1]);

    if (!targetId || !selectedMonth) {
      setIsLocked(false);
      return;
    }

    try {
      const m = selectedMonth.month() + 1;
      const y = selectedMonth.year();
      const res = await fetch(
        `/api/timesheets/lock?departmentId=${targetId}&month=${m}&year=${y}`
      );
      const data = await res.json();
      setIsLocked(data.isLocked);
    } catch (e) {
      console.error(e);
    }
  };

  useEffect(() => {
    if (employees.length > 0) checkLockStatus();
  }, [employees]); // Check lock when data loaded

  const handleToggleLock = async () => {
    const realIds = resolveRealDepartmentIds();
    if (realIds.length === 0) return;
    // Kh√≥a s·ªï cho t·∫•t c·∫£ ID t√¨m ƒë∆∞·ª£c (v√≠ d·ª• kh√≥a c·∫£ t·ªï S·ª£i con 3 k√≠p)
    try {
      const m = selectedMonth.month() + 1;
      const y = selectedMonth.year();
      let successCount = 0;

      // Loop lock all found departments
      await Promise.all(
        realIds.map(async (id) => {
          const res = await fetch("/api/timesheets/lock", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              departmentId: id,
              month: m,
              year: y,
              isLocked: !isLocked,
            }),
          });
          if (res.ok) successCount++;
        })
      );

      if (successCount > 0) {
        setIsLocked(!isLocked);
        message.success(`ƒê√£ ${!isLocked ? "kh√≥a" : "m·ªü"} s·ªï th√†nh c√¥ng!`);
      }
    } catch (e) {
      message.error("L·ªói k·∫øt n·ªëi");
    }
  };

  // --- COLUMNS (Gi·ªØ nguy√™n logic c≈©) ---
  const columns = useMemo(() => {
    const fixedColumns: any[] = [
      {
        title: "STT",
        key: "index",
        width: 50,
        fixed: "left",
        align: "center",
        render: (_: any, __: any, index: number) => (
          <span style={{ color: "#888", fontWeight: 600 }}>{index + 1}</span>
        ),
      },
      {
        title: "H·ªç t√™n",
        dataIndex: "fullName",
        width: 160,
        fixed: "left",
        render: (text: string, record: MonthlyEmployeeData) => (
          <div>
            <div style={{ fontWeight: 500 }}>{text}</div>
            <div style={{ fontSize: 11, color: "#888" }}>
              {record.kip
                ? `(${record.kip.name})`
                : record.department
                ? record.department.name
                : ""}
            </div>
          </div>
        ),
      },
    ];
    const daysInMonth = selectedMonth.daysInMonth();
    const dayColumns = [];
    for (let i = 1; i <= daysInMonth; i++) {
      const currentDay = dayjs(
        `${selectedMonth.year()}-${selectedMonth.month() + 1}-${i}`
      );
      const isWeekend = currentDay.day() === 0;
      const dateStr = currentDay.format("YYYY-MM-DD");
      dayColumns.push({
        title: (
          <div
            style={{
              textAlign: "center",
              color: isWeekend ? "#ff4d4f" : "inherit",
            }}
          >
            <div>{i}</div>
            <div style={{ fontSize: 10, color: "#999" }}>
              {["CN", "T2", "T3", "T4", "T5", "T6", "T7"][currentDay.day()]}
            </div>
          </div>
        ),
        width: 40,
        align: "center",
        render: (_: any, record: MonthlyEmployeeData) => {
          const log = record.timesheets.find((t) => t.date.startsWith(dateStr));
          if (log)
            return (
              <Tooltip title={log.attendanceCode.name}>
                <div
                  style={{
                    background: log.attendanceCode.color,
                    color: "#fff",
                    fontSize: 11,
                    fontWeight: "bold",
                    borderRadius: 2,
                    height: 22,
                    lineHeight: "22px",
                    cursor: "default",
                  }}
                >
                  {log.attendanceCode.code}
                </div>
              </Tooltip>
            );
          return null;
        },
      });
    }

    const countCodes = (
      record: MonthlyEmployeeData,
      fullCodes: string[],
      halfCodes: string[] = []
    ) => {
      return record.timesheets.reduce((total, t) => {
        const code = t.attendanceCode.code;
        if (fullCodes.includes(code)) return total + 1;
        if (halfCodes.includes(code)) return total + 0.5;
        return total;
      }, 0);
    };

    const summaryColumns = [
      {
        title: <span style={{ color: "#05FA46", fontSize: 12 }}>T.C√¥ng</span>,
        width: 60,
        align: "center",
        fixed: "right",
        className: "bg-green-50",
        render: (_: any, r: MonthlyEmployeeData) => {
          const total = countCodes(
            r,
            ["X", "XD", "CT", "Lƒê", "XL", "LE", "LD"],
            ["X/2"]
          );
          return total > 0 ? <b style={{ color: "#16a34a" }}>{total}</b> : "-";
        },
      },
      {
        title: <span style={{ fontSize: 12 }}>Ca 3</span>,
        width: 50,
        align: "center",
        fixed: "right",
        render: (_: any, r: MonthlyEmployeeData) => {
          const total = countCodes(r, ["XD", "LD"]);
          return total > 0 ? <b>{total}</b> : "-";
        },
      },
      {
        title: <span style={{ color: "#ff78cf", fontSize: 12 }}>100%</span>,
        width: 50,
        align: "center",
        fixed: "right",
        render: (_: any, r: MonthlyEmployeeData) => {
          const total = countCodes(r, ["F", "R", "L", "ƒêC"]);
          return total > 0 ? <b style={{ color: "#2563eb" }}>{total}</b> : "-";
        },
      },
      {
        title: <span style={{ color: "#F8FF3B", fontSize: 12 }}>BHXH</span>,
        width: 50,
        align: "center",
        fixed: "right",
        render: (_: any, r: MonthlyEmployeeData) => {
          const total = countCodes(r, ["√î", "C√î", "TS", "DS", "T", "CL"]);
          return total > 0 ? <b style={{ color: "#ca8a04" }}>{total}</b> : "-";
        },
      },
      {
        title: <span style={{ color: "#FF4545", fontSize: 12 }}>K.L∆∞∆°ng</span>,
        width: 60,
        align: "center",
        fixed: "right",
        render: (_: any, r: MonthlyEmployeeData) => {
          const total = countCodes(r, ["RO"]);
          return total > 0 ? <b style={{ color: "#dc2626" }}>{total}</b> : "-";
        },
      },
      {
        title: <span style={{ fontSize: 12 }}>V√¥ LD</span>,
        width: 50,
        align: "center",
        fixed: "right",
        render: (_: any, r: MonthlyEmployeeData) => {
          const total = countCodes(r, ["O"]);
          return total > 0 ? (
            <b style={{ color: "red", textDecoration: "underline" }}>{total}</b>
          ) : (
            "-"
          );
        },
      },
      {
        title: <span style={{ fontSize: 12 }}>B√£o</span>,
        width: 50,
        align: "center",
        fixed: "right",
        render: (_: any, r: MonthlyEmployeeData) => {
          const total = countCodes(r, ["B"]);
          return total > 0 ? <b>{total}</b> : "-";
        },
      },
    ];
    return [...fixedColumns, ...dayColumns, ...summaryColumns];
  }, [selectedMonth, employees]);

  // --- EXPORT EXCEL (Update Title Logic) ---
  const handleExportExcel = async () => {
    if (employees.length === 0) return;
    setLoading(true);
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet("BangCong");
    worksheet.pageSetup = {
      paperSize: 9,
      orientation: "landscape",
      fitToPage: true,
      fitToWidth: 1,
      fitToHeight: 0,
    };

    const row1 = worksheet.getCell("A1");
    row1.value = "C√îNG TY C·ªî PH·∫¶N S·ª¢I PH√ö B√ÄI";
    row1.font = { name: "Times New Roman", size: 14, bold: true };
    const row2 = worksheet.getCell("A2");
    row2.value = `B·∫¢NG CH·∫§M C√îNG TH√ÅNG ${selectedMonth.format("MM/YYYY")}`;
    row2.font = { name: "Times New Roman", size: 16, bold: true };
    row2.alignment = { horizontal: "center" };

    // LOGIC T√äN B·ªò PH·∫¨N CHO EXCEL
    let deptName = "";
    if (mixedDeptValue) {
      if (mixedDeptValue.startsWith("SECTION")) {
        const label =
          mixedDeptOptions.find((o) => o.value === mixedDeptValue)?.label || "";
        const kNames = kips
          .filter((k) => selectedKipIds.includes(k.id))
          .map((k) => k.name)
          .join(", ");
        deptName = `${label} ${kNames ? ` - ${kNames}` : ""}`;
      } else {
        deptName =
          mixedDeptOptions.find((o) => o.value === mixedDeptValue)?.label || "";
      }
    } else if (selectedKipIds.length > 0) {
      const names = kips
        .filter((k) => selectedKipIds.includes(k.id))
        .map((k) => k.name)
        .join(", ");
      deptName = `C√°c K√≠p: ${names}`;
    }
    // ... (Ph·∫ßn c√≤n l·∫°i c·ªßa Export Excel gi·ªØ nguy√™n nh∆∞ code c≈©, t√¥i ƒë√£ c·∫Øt b·ªõt ƒë·ªÉ t·∫≠p trung v√†o logic)
    // B·∫°n copy ph·∫ßn loop data v√† style t·ª´ code c≈© v√†o ƒë√¢y nh√©
    const row3 = worksheet.getCell("A3");
    row3.value = `B·ªô ph·∫≠n: ${deptName}`;
    row3.font = { name: "Times New Roman", size: 12, bold: true, italic: true };
    row3.alignment = { horizontal: "center" };

    const headerRow = ["STT", "M√£ NV", "H·ªç v√† t√™n"];
    const daysInMonth = selectedMonth.daysInMonth();
    for (let i = 1; i <= daysInMonth; i++) headerRow.push(`${i}`);
    headerRow.push("T.C√¥ng", "Ca 3", "100%", "BHXH", "K.L∆∞∆°ng", "V√¥ LD", "B√£o");

    const headerRowExcel = worksheet.addRow(headerRow);
    headerRowExcel.eachCell((cell) => {
      cell.font = { name: "Times New Roman", bold: true };
      cell.alignment = { vertical: "middle", horizontal: "center" };
      cell.border = {
        top: { style: "thin" },
        left: { style: "thin" },
        bottom: { style: "thin" },
        right: { style: "thin" },
      };
      cell.fill = {
        type: "pattern",
        pattern: "solid",
        fgColor: { argb: "FFE0E0E0" },
      };
    });

    employees.forEach((emp, index) => {
      const rowData: any[] = [index + 1, emp.code, emp.fullName];
      for (let i = 1; i <= daysInMonth; i++) {
        const dateStr = dayjs(
          `${selectedMonth.year()}-${selectedMonth.month() + 1}-${i}`
        ).format("YYYY-MM-DD");
        const log = emp.timesheets.find((t) => t.date.startsWith(dateStr));
        rowData.push(log ? log.attendanceCode.code : "");
      }
      // Count codes logic
      const countCodes = (fullCodes: string[], halfCodes: string[] = []) =>
        emp.timesheets.reduce((total, t) => {
          const code = t.attendanceCode.code;
          if (fullCodes.includes(code)) return total + 1;
          if (halfCodes.includes(code)) return total + 0.5;
          return total;
        }, 0);

      rowData.push(
        countCodes(["X", "XD", "CT", "Lƒê", "XL", "LE", "LD"], ["X/2"]) || ""
      );
      rowData.push(countCodes(["XD", "LD"]) || "");
      rowData.push(countCodes(["F", "R", "L", "ƒêC"]) || "");
      rowData.push(countCodes(["√î", "C√î", "TS", "DS", "T", "CL"]) || "");
      rowData.push(countCodes(["RO"]) || "");
      rowData.push(countCodes(["O"]) || "");
      rowData.push(countCodes(["B"]) || "");

      const row = worksheet.addRow(rowData);
      row.eachCell((cell, colNumber) => {
        cell.font = { name: "Times New Roman", color: { argb: "FF000000" } };
        cell.border = {
          top: { style: "thin" },
          left: { style: "thin" },
          bottom: { style: "thin" },
          right: { style: "thin" },
        };
        if (colNumber === 3) cell.alignment = { horizontal: "left", indent: 1 };
        else cell.alignment = { horizontal: "center" };
        if (colNumber > 3 && colNumber <= 3 + daysInMonth && cell.value)
          cell.font = { name: "Times New Roman", bold: true };
        if (colNumber > 3 + daysInMonth && cell.value)
          cell.font = { name: "Times New Roman", bold: true };
      });
    });

    // Footer
    worksheet.getColumn(1).width = 5;
    worksheet.getColumn(2).width = 10;
    worksheet.getColumn(3).width = 25;
    for (let i = 4; i <= 3 + daysInMonth; i++) worksheet.getColumn(i).width = 4;

    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], {
      type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
    });
    saveAs(
      blob,
      `BangCong_${selectedMonth.format("MM-YYYY")}_${deptName}.xlsx`
    );
    setLoading(false);
  };

  // UI Vars
  const isSectionSelected = mixedDeptValue?.startsWith("SECTION");
  const showKipSelect =
    (isMatrix && isSectionSelected) ||
    (isExclusive && hasKipPermission && !mixedDeptValue);
  const showDeptSelect =
    !isExclusive || (isExclusive && selectedKipIds.length === 0);

  return (
    <AdminLayout>
      <div style={{ marginBottom: 24 }}>
        <Title level={3}>T·ªïng h·ª£p ch·∫•m c√¥ng th√°ng</Title>
      </div>
      <Card style={{ marginBottom: 16 }} size="small">
        <div
          style={{
            display: "flex",
            gap: 16,
            flexWrap: "wrap",
            alignItems: "center",
          }}
        >
          <div>
            <div style={{ fontWeight: 600 }}>Th√°ng:</div>
            <DatePicker
              picker="month"
              value={selectedMonth}
              onChange={(val) => val && setSelectedMonth(val)}
              allowClear={false}
              format="MM/YYYY"
              style={{ width: 120 }}
            />
          </div>

          <div>
            <div style={{ fontWeight: 600 }}>Nh√† m√°y:</div>
            <Select
              style={{ width: 180 }}
              placeholder="Ch·ªçn nh√† m√°y"
              value={selectedFactoryId}
              onChange={handleFactoryChange}
            >
              {availableDepartments
                .reduce((acc: Factory[], curr) => {
                  if (
                    curr.factory &&
                    !acc.find((f) => f.id === curr.factory!.id)
                  )
                    acc.push(curr.factory!);
                  return acc;
                }, [])
                .map((f) => (
                  <Select.Option key={f.id} value={f.id}>
                    {f.name}
                  </Select.Option>
                ))}
            </Select>
          </div>

          {showDeptSelect && (
            <div>
              <div style={{ fontWeight: 600 }}>
                {isMatrix ? "Ch·ªçn T·ªï / B·ªô ph·∫≠n:" : "Ph√≤ng ban:"}
              </div>
              <Select
                style={{ width: 220 }}
                placeholder="Ch·ªçn..."
                value={mixedDeptValue}
                onChange={handleMixedDeptChange}
                allowClear
                disabled={!selectedFactoryId}
                showSearch
                optionFilterProp="children"
              >
                {mixedDeptOptions.map((opt) => (
                  <Select.Option key={opt.value} value={opt.value}>
                    {opt.label}
                  </Select.Option>
                ))}
              </Select>
            </div>
          )}

          {showKipSelect && (
            <div>
              <div style={{ fontWeight: 600 }}>
                {isMatrix ? "L·ªçc theo K√≠p:" : "Ch·ªçn K√≠p:"}
              </div>
              <Select
                mode="multiple"
                style={{ width: 200 }}
                placeholder="Ch·ªçn K√≠p"
                value={selectedKipIds}
                onChange={handleKipChange}
                allowClear
                disabled={!selectedFactoryId}
              >
                {kips
                  .filter((k) => k.factoryId === selectedFactoryId)
                  .map((k) => (
                    <Select.Option key={k.id} value={k.id}>
                      {k.name}
                    </Select.Option>
                  ))}
              </Select>
            </div>
          )}

          <div style={{ marginTop: 20 }}>
            <Button
              icon={<ReloadOutlined />}
              onClick={fetchMonthlyData}
              disabled={!mixedDeptValue && selectedKipIds.length === 0}
            >
              Xem
            </Button>
          </div>

          {/* LOCK & EXCEL BUTTONS */}
          {(mixedDeptValue || selectedKipIds.length > 0) && (
            <div style={{ marginTop: 20, marginLeft: 10 }}>
              {["ADMIN", "HR_MANAGER"].includes(session?.user?.role || "") && (
                <Button
                  type={isLocked ? "default" : "primary"}
                  danger={!isLocked}
                  icon={isLocked ? <UnlockOutlined /> : <LockOutlined />}
                  onClick={handleToggleLock}
                >
                  {isLocked ? "M·ªü kh√≥a s·ªï" : "Kh√≥a s·ªï"}
                </Button>
              )}
            </div>
          )}
          <div style={{ marginTop: 20, marginLeft: "auto" }}>
            <Button
              type="primary"
              style={{ background: "#217346" }}
              icon={<FileExcelOutlined />}
              onClick={handleExportExcel}
              disabled={employees.length === 0}
              loading={loading}
            >
              Xu·∫•t Excel
            </Button>
          </div>
        </div>
      </Card>

      <Table
        bordered
        dataSource={employees}
        columns={columns}
        rowKey="id"
        loading={loading}
        pagination={false}
        scroll={{ x: "max-content", y: 600 }}
        size="small"
      />
    </AdminLayout>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\timesheets\monthly\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\auth.config.ts
================================================================================
import type { NextAuthConfig } from "next-auth";

// C·∫•u h√¨nh n√†y an to√†n ƒë·ªÉ ch·∫°y tr√™n Edge (Middleware)
export const authConfig = {
  pages: {
    signIn: "/login", // Trang ƒëƒÉng nh·∫≠p t√πy ch·ªânh
  },
  callbacks: {
    // Logic ki·ªÉm tra quy·ªÅn truy c·∫≠p (Authorized)
    authorized({ auth, request: { nextUrl } }) {
      const isLoggedIn = !!auth?.user;

      // Danh s√°ch c√°c trang c·∫ßn b·∫£o v·ªá
      const protectedRoutes = [
        "/",
        "/dashboard",
        "/timesheets",
        "/employees",
        "/departments",
      ];

      // Ki·ªÉm tra xem trang hi·ªán t·∫°i c√≥ n·∫±m trong danh s√°ch b·∫£o v·ªá kh√¥ng
      const isProtectedRoute = protectedRoutes.some(
        (route) =>
          nextUrl.pathname === route || nextUrl.pathname.startsWith(route + "/")
      );

      if (isProtectedRoute) {
        if (isLoggedIn) return true;
        return false; // Ch∆∞a ƒëƒÉng nh·∫≠p -> T·ª± ƒë·ªông ƒë√° v·ªÅ Login
      } else if (isLoggedIn && nextUrl.pathname.startsWith("/login")) {
        // ƒê√£ ƒëƒÉng nh·∫≠p m√† v√†o trang login -> ƒê√° v·ªÅ Dashboard
        return Response.redirect(new URL("/dashboard", nextUrl));
      }

      return true;
    },
    // Chuy·ªÉn d·ªØ li·ªáu t·ª´ Token sang Session (ƒê·ªÉ Client d√πng)
    async session({ session, token }: any) {
      if (session.user) {
        session.user.id = token.sub;
        session.user.role = token.role;
        session.user.managedDeptIds = token.managedDeptIds;
        session.user.username = token.username;
      }
      return session;
    },
    async jwt({ token, user }: any) {
      if (user) {
        token.role = user.role;
        token.managedDeptIds = user.managedDeptIds;
        token.username = user.username;
      }
      return token;
    },
  },
  providers: [], // ƒê·ªÉ tr·ªëng ·ªü ƒë√¢y, s·∫Ω n·∫°p Provider ·ªü file auth.ts
} satisfies NextAuthConfig;


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\auth.config.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\auth.ts
================================================================================
import NextAuth from "next-auth";
import Credentials from "next-auth/providers/credentials";
import { prisma } from "@/lib/prisma";
import bcrypt from "bcryptjs";
import { z } from "zod";
import { authConfig } from "./auth.config"; // Import c·∫•u h√¨nh nh·∫π

const loginSchema = z.object({
  username: z.string().min(1, "Vui l√≤ng nh·∫≠p t√†i kho·∫£n"),
  password: z.string().min(1, "Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u"),
});

// G·ªôp c·∫•u h√¨nh nh·∫π + Provider n·∫∑ng
export const { handlers, signIn, signOut, auth } = NextAuth({
  ...authConfig, // K·∫ø th·ª´a c·∫•u h√¨nh
  providers: [
    Credentials({
      credentials: {
        username: { label: "T√†i kho·∫£n", type: "text" },
        password: { label: "M·∫≠t kh·∫©u", type: "password" },
      },
      authorize: async (credentials) => {
        const { username, password } = await loginSchema.parseAsync(
          credentials
        );

        const user = await prisma.user.findUnique({
          where: { username },
          include: { managedDepartments: true },
        });

        if (!user) throw new Error("T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i");

        const isMatch = await bcrypt.compare(password, user.password);
        if (!isMatch) throw new Error("Sai m·∫≠t kh·∫©u");

        return {
          id: user.id.toString(),
          name: user.fullName,
          username: user.username,
          role: user.role,
          managedDeptIds: user.managedDepartments.map((d) => d.id),
        };
      },
    }),
  ],
});


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\auth.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\components\AdminLayout.tsx
================================================================================
"use client"; // ƒê·∫£m b·∫£o d√≤ng n√†y ·ªü ƒë·∫ßu

import React, { useState } from "react";
import {
  Layout,
  Menu,
  theme,
  Dropdown,
  Button,
  Avatar,
  Typography,
  message,
  Tooltip,
} from "antd";
import {
  ApartmentOutlined,
  TeamOutlined,
  BankOutlined,
  UnorderedListOutlined,
  FormOutlined,
  LogoutOutlined, // <--- Import icon Logout
  TableOutlined,
  DashboardOutlined,
  UserOutlined,
  MenuUnfoldOutlined,
  MenuFoldOutlined,
  DownOutlined,
  QuestionCircleOutlined,
  AppstoreOutlined, // <-- Th√™m c√°i n√†y (bi·ªÉu t∆∞·ª£ng 4 √¥ vu√¥ng)
  CloudDownloadOutlined, // N√∫t backup database
} from "@ant-design/icons";
import saveAs from "file-saver";
import Link from "next/link";
import { usePathname } from "next/navigation";
import { signOut, useSession } from "next-auth/react"; // <--- Import t·ª´ next-auth

const { Header, Sider, Content, Footer } = Layout;
const { Text } = Typography;

export default function AdminLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const [collapsed, setCollapsed] = useState(false);
  const pathname = usePathname();
  const { data: session } = useSession(); // <--- L·∫•y th√¥ng tin user ƒëang ƒëƒÉng nh·∫≠p

  const {
    token: { colorBgContainer, borderRadiusLG },
  } = theme.useToken();

  // X·ª≠ l√Ω ƒêƒÉng xu·∫•t
  const handleLogout = () => {
    // callbackUrl: '/login' -> ƒêƒÉng xu·∫•t xong ƒë√° v·ªÅ trang Login
    signOut({ callbackUrl: "/login" });
  };

  // 2. H√†m x·ª≠ l√Ω Backup
  const handleDownloadBackup = async () => {
    const hide = message.loading("ƒêang t·∫°o b·∫£n backup...", 0);
    try {
      const res = await fetch("/api/system/backup");

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "L·ªói server");
      }

      // Nh·∫≠n Blob t·ª´ server v√† t·∫£i v·ªÅ
      const blob = await res.blob();
      const dateStr = new Date().toISOString().slice(0, 10);
      saveAs(blob, `backup_phubai_hrm_${dateStr}.sql`);

      message.success("T·∫£i backup th√†nh c√¥ng!");
    } catch (error: any) {
      message.error(error.message);
    } finally {
      hide();
    }
  };

  // Menu x·ªï xu·ªëng khi b·∫•m v√†o Avatar
  const userMenuItems = [
    {
      key: "1",
      label: (
        <div style={{ padding: "4px 8px" }}>
          <div style={{ fontWeight: "bold" }}>
            {session?.user?.name || session?.user?.username}
          </div>
          <div style={{ fontSize: 12, color: "#666" }}>
            {session?.user?.role}
          </div>
        </div>
      ),
    },
    {
      type: "divider" as const,
    },
    {
      key: "2",
      danger: true, // M√†u ƒë·ªè c·∫£nh b√°o
      icon: <LogoutOutlined />,
      label: "ƒêƒÉng xu·∫•t",
      onClick: handleLogout, // G·∫Øn h√†m logout v√†o ƒë√¢y
    },
  ];

  return (
    <Layout style={{ minHeight: "100vh" }}>
      <Sider trigger={null} collapsible collapsed={collapsed}>
        <div
          className="demo-logo-vertical"
          style={{
            height: 32,
            margin: 16,
            background: "rgba(255, 255, 255, 0.2)",
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
            color: "#fff",
            fontWeight: "bold",
          }}
        >
          {collapsed ? "PB" : "PHU BAI HRM"}
        </div>

        {/* MENU B√äN TR√ÅI GI·ªÆ NGUY√äN (T√¥i ch·ªâ vi·∫øt g·ªçn l·∫°i ƒë·ªÉ b·∫°n d·ªÖ nh√¨n) */}
        <Menu
          theme="dark"
          mode="inline"
          defaultSelectedKeys={[pathname]}
          items={[
            // 2. NH√ìM QU·∫¢N L√ù DANH M·ª§C
            {
              key: "catalog-management", // Key n√†y t√™n t√πy √Ω
              icon: <AppstoreOutlined />, // Icon cho menu cha
              label: "Danh m·ª•c", // T√™n hi·ªÉn th·ªã menu cha
              children: [
                {
                  key: "/factories",
                  icon: <BankOutlined />,
                  label: <Link href="/factories">Nh√† m√°y</Link>,
                },
                {
                  key: "/departments",
                  icon: <ApartmentOutlined />,
                  label: <Link href="/departments">Ph√≤ng ban</Link>,
                },
                {
                  key: "/employees",
                  icon: <TeamOutlined />,
                  label: <Link href="/employees">Nh√¢n vi√™n</Link>,
                },
                {
                  key: "/attendance-codes",
                  icon: <UnorderedListOutlined />,
                  label: <Link href="/attendance-codes">K√Ω hi·ªáu</Link>,
                },
              ],
            },
            {
              key: "/timesheets/daily",
              icon: <FormOutlined />,
              label: <Link href="/timesheets/daily">Ch·∫•m c√¥ng</Link>,
            },
            {
              key: "/timesheets/monthly",
              icon: <TableOutlined />,
              label: <Link href="/timesheets/monthly">T·ªïng h·ª£p c√¥ng</Link>,
            },
            {
              key: "/dashboard",
              icon: <DashboardOutlined />,
              label: <Link href="/dashboard">T·ªïng quan</Link>,
            },
            {
              key: "/dashboard/departments",
              icon: <UnorderedListOutlined />, // Icon d·∫°ng danh s√°ch
              label: (
                <Link href="/dashboard/departments">Chi ti·∫øt b·ªô ph·∫≠n</Link>
              ),
            },
            // Ch·ªâ hi·ªán User n·∫øu l√† ADMIN
            ...(session?.user?.role === "ADMIN"
              ? [
                  {
                    key: "/admin/users",
                    icon: <UserOutlined />,
                    label: <Link href="/admin/users">Ng∆∞·ªùi d√πng</Link>,
                  },
                ]
              : []),
            {
              key: "/help", // ƒê∆∞·ªùng d·∫´n kh·ªõp v·ªõi folder b·∫°n v·ª´a t·∫°o
              icon: <QuestionCircleOutlined />,
              label: <Link href="/help">H∆∞·ªõng d·∫´n</Link>,
            },
          ]}
        />
      </Sider>

      <Layout>
        <Header
          style={{
            padding: 0,
            background: colorBgContainer,
            display: "flex",
            justifyContent: "space-between",
            alignItems: "center",
            paddingRight: 24,
          }}
        >
          {/* N√∫t Toggle Menu */}
          <div
            onClick={() => setCollapsed(!collapsed)}
            style={{
              fontSize: "16px",
              width: 64,
              height: 64,
              display: "flex",
              alignItems: "center",
              justifyContent: "center",
              cursor: "pointer",
            }}
          >
            {collapsed ? <MenuUnfoldOutlined /> : <MenuFoldOutlined />}
          </div>

          {/* // 3. HI·ªÇN TH·ªä N√öT (Ch√®n v√†o n∆°i b·∫°n mu·ªën, v√≠ d·ª• trong Header) */}
          {/* Ch·ªâ hi·ªán n·∫øu l√† ADMIN */}
          {session?.user?.role === "ADMIN" && (
            <Tooltip title="Sao l∆∞u D·ªØ li·ªáu">
              <Button
                type="text"
                icon={
                  <CloudDownloadOutlined
                    style={{ fontSize: 20, color: "#1890ff" }}
                  />
                }
                onClick={handleDownloadBackup}
                style={{ marginRight: 15 }}
              >
                Backup DB
              </Button>
            </Tooltip>
          )}
          {/* --- PH·∫¶N USER INFO & LOGOUT ·ªû G√ìC PH·∫¢I --- */}
          <Dropdown menu={{ items: userMenuItems }} trigger={["click"]}>
            <div
              style={{
                cursor: "pointer",
                display: "flex",
                alignItems: "center",
                gap: 10,
              }}
            >
              <Avatar
                style={{ backgroundColor: "#1677ff" }}
                icon={<UserOutlined />}
              />
              <span style={{ fontWeight: 500 }}>
                {session?.user?.name || "Ng∆∞·ªùi d√πng"}{" "}
                <DownOutlined style={{ fontSize: 10 }} />
              </span>
            </div>
          </Dropdown>
        </Header>

        <Content
          style={{
            margin: "24px 16px",
            padding: 24,
            minHeight: 280,
            background: colorBgContainer,
            borderRadius: borderRadiusLG,
          }}
        >
          {children}
        </Content>
        <Footer style={{ textAlign: "center" }}>
          Qu·∫£n l√Ω nh√¢n s·ª± ¬©2026 Thi·∫øt k·∫ø b·ªüi Nguy·ªÖn Thi·ªán Minh Tr√≠
        </Footer>
      </Layout>
    </Layout>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\components\AdminLayout.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\components\SessionProviderWrapper.tsx
================================================================================
"use client"; // B·∫Øt bu·ªôc ph·∫£i c√≥ d√≤ng n√†y

import { SessionProvider } from "next-auth/react";

export default function SessionProviderWrapper({
  children,
}: {
  children: React.ReactNode;
}) {
  return <SessionProvider>{children}</SessionProvider>;
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\components\SessionProviderWrapper.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\lib\AntdRegistry.tsx
================================================================================
// src/lib/AntdRegistry.tsx
"use client";

import React from "react";
import { createCache, extractStyle, StyleProvider } from "@ant-design/cssinjs";
import type Entity from "@ant-design/cssinjs/es/Cache";
import { useServerInsertedHTML } from "next/navigation";

const StyledComponentsRegistry = ({ children }: React.PropsWithChildren) => {
  const cache = React.useMemo<Entity>(() => createCache(), []);
  useServerInsertedHTML(() => (
    <style
      id="antd"
      dangerouslySetInnerHTML={{ __html: extractStyle(cache, true) }}
    />
  ));
  return <StyleProvider cache={cache}>{children}</StyleProvider>;
};

export default StyledComponentsRegistry;


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\lib\AntdRegistry.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\lib\prisma.ts
================================================================================
// src/lib/prisma.ts
import { PrismaClient } from "@prisma/client";

const globalForPrisma = global as unknown as { prisma: PrismaClient };

export const prisma =
  globalForPrisma.prisma ||
  new PrismaClient({
    log: ["query"], // D√≤ng n√†y gi√∫p in ra c√¢u l·ªánh SQL ƒë·ªÉ b·∫°n d·ªÖ theo d√µi
  });

if (process.env.NODE_ENV !== "production") globalForPrisma.prisma = prisma;


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\lib\prisma.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\middleware.ts
================================================================================
import NextAuth from "next-auth";
import { authConfig } from "./auth.config";

// T·∫°o m·ªôt b·∫£n auth nh·∫π d√†nh ri√™ng cho Middleware
export default NextAuth(authConfig).auth;

export const config = {
  // Ch·∫°y tr√™n t·∫•t c·∫£ c√°c route tr·ª´ file tƒ©nh
  matcher: ["/((?!api|_next/static|_next/image|favicon.ico).*)"],
};


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\middleware.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\types\next-auth.d.ts
================================================================================
import NextAuth, { DefaultSession } from "next-auth";
import { JWT } from "next-auth/jwt";

// ƒê·ªãnh nghƒ©a l·∫°i c√°c tr∆∞·ªùng m·ªü r·ªông
declare module "next-auth" {
  /**
   * M·ªü r·ªông ki·ªÉu Session (ƒë∆∞·ª£c tr·∫£ v·ªÅ t·ª´ useSession, auth())
   */
  interface Session {
    user: {
      id: string;
      username: string;
      role: "ADMIN" | "HR_MANAGER" | "LEADER" | "TIMEKEEPER"; // Ho·∫∑c ƒë·ªÉ string n·∫øu mu·ªën linh ho·∫°t
      managedDeptIds: number[];
    } & DefaultSession["user"];
  }

  /**
   * M·ªü r·ªông ki·ªÉu User (ƒë∆∞·ª£c tr·∫£ v·ªÅ l√∫c login)
   */
  interface User {
    id: string;
    username: string;
    role: "ADMIN" | "HR_MANAGER" | "LEADER" | "TIMEKEEPER";
    managedDeptIds: number[];
  }
}

declare module "next-auth/jwt" {
  /**
   * M·ªü r·ªông ki·ªÉu JWT (token)
   */
  interface JWT {
    id: string;
    username: string;
    role: "ADMIN" | "HR_MANAGER" | "LEADER" | "TIMEKEEPER";
    managedDeptIds: number[];
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\types\next-auth.d.ts ---
