--- PROJECT SOURCE CODE ---



================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\package.json
================================================================================
{
  "name": "phubai-hrm",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "prisma": {
    "seed": "ts-node --compiler-options {\"module\":\"CommonJS\"} prisma/seed.ts"
  },
  "dependencies": {
    "@ant-design/cssinjs": "^2.0.1",
    "@ant-design/icons": "^6.1.0",
    "@prisma/client": "^5.22.0",
    "antd": "^6.1.1",
    "bcryptjs": "^3.0.3",
    "dayjs": "^1.11.19",
    "exceljs": "^4.4.0",
    "file-saver": "^2.0.5",
    "next": "16.0.10",
    "next-auth": "^5.0.0-beta.30",
    "react": "19.2.1",
    "react-dom": "19.2.1",
    "recharts": "^3.6.0"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/bcryptjs": "^2.4.6",
    "@types/file-saver": "^2.0.7",
    "@types/node": "^20.19.27",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.0.10",
    "prisma": "^5.22.0",
    "tailwindcss": "^4",
    "ts-node": "^10.9.2",
    "typescript": "^5.9.3"
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\package.json ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\prisma\schema.prisma
================================================================================
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. B·∫£ng Nh√† M√°y
model Factory {
  id          Int          @id @default(autoincrement())
  code        String       @unique
  name        String
  departments Department[] // Quan h·ªá ng∆∞·ª£c: 1 nh√† m√°y c√≥ nhi·ªÅu ph√≤ng

  // --- B·ªî SUNG D√íNG N√ÄY V√ÄO ---
  kips        Kip[]        // Quan h·ªá ng∆∞·ª£c: 1 nh√† m√°y c√≥ nhi·ªÅu K√≠p
  lockRules   LockRule[] // Li√™n k·∫øt v·ªõi b·∫£ng kh√≥a s·ªï ƒë·ªÉ ch·ªçn nh√† m√°y c·∫ßn kh√≥a
}

// 2. K√≠p (B·∫¢NG M·ªöI - ƒê·ªãnh nghƒ©a K√≠p 1 -> K√≠p 10)
model Kip {
  id   Int    @id @default(autoincrement())
  name String // "K√≠p 1", "K√≠p 2", ..., "K√≠p 10"
  
  // Li√™n k·∫øt v·ªõi Nh√† m√°y (V√¨ K√≠p 1 nh√† m√°y 2 kh√°c K√≠p 1 nh√† m√°y 3)
  factoryId Int
  factory   Factory @relation(fields: [factoryId], references: [id])
  
  employees Employee[] // 1 K√≠p c√≥ nhi·ªÅu nh√¢n vi√™n
}

// 2. B·∫£ng Ph√≤ng Ban - C√¥ng ƒëo·∫°n
model Department {
  id        Int        @id @default(autoincrement())
  code      String     @unique
  name      String     // T√™n hi·ªÉn th·ªã: "S·ª£i con", "B√¥ng ch·∫£i"

  // --- TH√äM C·ªòT N√ÄY ---
  // true: L√† b·ªô ph·∫≠n s·∫£n xu·∫•t theo K√≠p (K√≠p 1, K√≠p 2...)
  // false: L√† b·ªô ph·∫≠n h√†nh ch√≠nh/ph·ª• tr·ª£ (B·∫£o tr√¨, Kho...)
  isKip     Boolean  @default(false) 
  // --------------------
  
  // Kh√≥a ngo·∫°i li√™n k·∫øt nh√† m√°y
  factoryId Int      
  factory   Factory   @relation(fields: [factoryId], references: [id])
  employees Employee[] // Quan h·ªá ng∆∞·ª£c: 1 ph√≤ng c√≥ nhi·ªÅu nh√¢n vi√™n
  // Quan h·ªá 1: Nh·ªØng user QU·∫¢N L√ù ph√≤ng n√†y (Many-to-Many)
  // [S·ª¨A L·ªñI] B·ªï sung @relation("ManagedDepartments") v√†o ƒë√¢y ƒë·ªÉ kh·ªõp v·ªõi b√™n User
  managers User[] @relation("ManagedDepartments")

  // --- [B·ªî SUNG] Quan h·ªá 2: Nh·ªØng user THU·ªòC V·ªÄ ph√≤ng n√†y (One-to-Many) ---
  staffUsers User[] @relation("UserBelongsTo")
}

// 3. B·∫£ng Nh√¢n Vi√™n
model Employee {
  id         Int        @id @default(autoincrement())
  code       String     @unique // M√£ NV nh·∫≠p tay/import
  fullName   String
  birthday   DateTime?
  gender     String?
  address    String?
  phone      String?
  position   String?    // Nh·∫≠p tay tho·∫£i m√°i

  // --- [M·ªöI] C√ÅC TR∆Ø·ªúNG B·ªî SUNG ---
  startDate     DateTime? // Ng√†y v√†o l√†m
  idCardNumber  String?   // S·ªë CCCD
  idCardDate    DateTime? // Ng√†y c·∫•p
  idCardPlace   String?   // N∆°i c·∫•p
  bankAccount   String?   // S·ªë t√†i kho·∫£n
  taxCode       String?   // M√£ s·ªë thu·∫ø
  // -------------------------------
  
  // Kh√≥a ngo·∫°i li√™n k·∫øt ph√≤ng ban
  departmentId Int
  department   Department @relation(fields: [departmentId], references: [id])

  // --- M·ªöI: TH√äM C√ÅI N√ÄY ƒê·ªÇ L·ªåC ---
  kipId        Int?     // Cho ph√©p NULL (ƒë·ªÉ √¥ng B·∫£o tr√¨/VƒÉn ph√≤ng kh√¥ng c·∫ßn ƒëi·ªÅn)
  kip          Kip?     @relation(fields: [kipId], references: [id])
  // --------------------------------
  timesheets Timesheet[]

  evaluations MonthlyEvaluation[] // Truy v·∫•n x·∫øp lo·∫°i
  
  // --- Li√™n k·∫øt ƒë·∫øn b·∫£ng l√†m th√™m ---
  overtimeRecords OvertimeRecord[]
}

// 1. B·∫£ng ƒë·ªãnh nghƒ©a c√°c lo·∫°i c√¥ng (X, F, √î...)
model AttendanceCode {
  id          Int      @id @default(autoincrement())
  code        String   @unique // V√≠ d·ª•: X, F, XD
  name        String   // V√≠ d·ª•: ƒêi l√†m, Ngh·ªâ ph√©p
  
  // Nh√≥m ch·∫ø ƒë·ªô (L∆∞∆°ng th·ªùi gian, ·ªêm, Thai s·∫£n...)
  category    String   
  
  // H·ªá s·ªë: Th√™m d·∫•u ? ƒë·ªÉ kh√¥ng b·∫Øt bu·ªôc nh·∫≠p l√∫c n√†y
  factor      Float?   
  
  color       String?  // M√†u s·∫Øc (ƒë·ªÉ ? lu√¥n cho tho·∫£i m√°i, nh·∫≠p sau c≈©ng ƒë∆∞·ª£c)
  description String?  
  
  // M·ªëi quan h·ªá ng∆∞·ª£c: M·ªôt lo·∫°i c√¥ng link t·ªõi NHI·ªÄU d√≤ng ch·∫•m c√¥ng
  timesheets  Timesheet[]
}

// 2. B·∫£ng ch·∫•m c√¥ng h√†ng ng√†y
model Timesheet {
  id               Int      @id @default(autoincrement())
  date             DateTime // Ng√†y ch·∫•m c√¥ng
  
  // Li√™n k·∫øt v·ªõi Nh√¢n vi√™n
  employeeId       Int
  employee         Employee @relation(fields: [employeeId], references: [id])
  
  // Li√™n k·∫øt v·ªõi Lo·∫°i c√¥ng
  attendanceCodeId Int
  attendanceCode   AttendanceCode @relation(fields: [attendanceCodeId], references: [id])
  
  note             String? // Ghi ch√∫ (VD: ƒêi mu·ªôn 30p)
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // ƒê·∫£m b·∫£o 1 nh√¢n vi√™n trong 1 ng√†y ch·ªâ c√≥ 1 d√≤ng ch·∫•m c√¥ng
  @@unique([employeeId, date], name: "employeeId_date")
}

// 1. Th√™m Enum cho c√°c Vai tr√≤ (Role)
enum Role {
  ADMIN       // Qu·∫£n tr·ªã h·ªá th·ªëng cao nh·∫•t
  HR_MANAGER  // Qu·∫£n l√Ω nh√¢n s·ª± (S·ª≠a danh m·ª•c, xem t·∫•t c·∫£)
  LEADER      // L√£nh ƒë·∫°o (Ch·ªâ xem)
  TIMEKEEPER  // Ng∆∞·ªùi ch·∫•m c√¥ng (Ch·ªâ ƒë∆∞·ª£c ch·∫•m c√°c ph√≤ng ƒë∆∞·ª£c giao)
  STAFF       // Nh√¢n vi√™n b√¨nh th∆∞·ªùng, ch·ªâ xem v√† s·ª≠a b·∫£ng l√†m th√™m
}

// 2. Th√™m b·∫£ng User
model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique // D√πng t√™n ƒëƒÉng nh·∫≠p (vd: to1, admin) thay v√¨ email
  password  String   // M·∫≠t kh·∫©u ƒë√£ m√£ h√≥a
  fullName  String?
  role      Role     @default(TIMEKEEPER)

  // --- [B·ªî SUNG C√ÅC TR∆Ø·ªúNG M·ªöI] ---
  employeeCode String?  // M√£ nh√¢n vi√™n (ƒê·ªÉ li√™n k·∫øt v·ªõi b·∫£ng l∆∞∆°ng/nh√¢n s·ª± sau n√†y)

  // Ph√≤ng ban tr·ª±c thu·ªôc (User n√†y thu·ªôc ph√≤ng n√†o?)
  userDepartmentId Int? 
  userDepartment   Department? @relation("UserBelongsTo", fields: [userDepartmentId], references: [id])
  // -------------------------------
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Quan h·ªá c≈©: User qu·∫£n l√Ω nh·ªØng ph√≤ng n√†o (Cho Timekeeper/Manager)
  managedDepartments Department[] @relation("ManagedDepartments")

}

// B·∫£ng qu·∫£n l√Ω lu·∫≠t kh√≥a s·ªï ch·∫•m c√¥ng
model LockRule {
  id        Int      @id @default(autoincrement())
  factoryId Int?     // N·∫øu null -> Kh√≥a TO√ÄN B·ªò h·ªá th·ªëng. N·∫øu c√≥ ID -> Kh√≥a ri√™ng Nh√† m√°y ƒë√≥.
  fromDate  DateTime // Ng√†y b·∫Øt ƒë·∫ßu kh√≥a
  toDate    DateTime // Ng√†y k·∫øt th√∫c kh√≥a
  reason    String?  // L√Ω do (VD: Ch·ªët l∆∞∆°ng th√°ng 1)
  createdAt DateTime @default(now())
  
  // Thi·∫øt l·∫≠p quan h·ªá (N·∫øu b·∫°n ƒë√£ c√≥ model Factory)
  factory   Factory? @relation(fields: [factoryId], references: [id])
}

// B·∫£ng l∆∞u k·∫øt qu·∫£ x·∫øp lo·∫°i th√°ng
model MonthlyEvaluation {
  id          Int      @id @default(autoincrement())
  
  // Li√™n k·∫øt nh√¢n vi√™n
  employeeId  Int
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  month       Int      // V√≠ d·ª•: 1
  year        Int      // V√≠ d·ª•: 2026
  
  grade       String   // Gi√° tr·ªã: "A", "B", "C", "A+"...
  note        String?  // Ghi ch√∫ l√Ω do (n·∫øu c·∫ßn)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // R√†ng bu·ªôc: M·ªói nh√¢n vi√™n ch·ªâ c√≥ 1 k·∫øt qu·∫£ x·∫øp lo·∫°i trong 1 th√°ng
  @@unique([employeeId, month, year])
}

// Th√™m v√†o cu·ªëi file schema.prisma

model OvertimeRecord {
  id           Int      @id @default(autoincrement())
  
  employeeId   Int
  employee     Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  content      String   // N·ªôi dung c√¥ng vi·ªác
  startTime    DateTime // Gi·ªù v√†o (VD: 2026-01-22 17:00:00)
  endTime      DateTime // Gi·ªù ra  (VD: 2026-01-22 19:30:00)
  totalMinutes Int      // T·ªïng th·ªùi gian (t√≠nh b·∫±ng ph√∫t ƒë·ªÉ d·ªÖ c·ªông tr·ª´)
  createdAt    DateTime @default(now())

  // [M·ªöI] L∆∞u username ng∆∞·ªùi t·∫°o (V√≠ d·ª•: "admin", "to1", "bao_tri")
  createdBy    String?
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\prisma\schema.prisma ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\prisma\seed.ts
================================================================================
// prisma/seed.ts
import { PrismaClient, Role } from "@prisma/client";
import * as bcrypt from "bcryptjs"; // Import th∆∞ vi·ªán m√£ h√≥a

const prisma = new PrismaClient();

// ƒê·ªãnh nghƒ©a d·ªØ li·ªáu c√°c lo·∫°i c√¥ng
const attendanceCodes = [
  // --- NH√ìM 1: L∆Ø∆†NG TH·ªúI GIAN (ƒêi l√†m, C√¥ng t√°c...) ---
  {
    code: "X",
    name: "ƒêi l√†m b√¨nh th∆∞·ªùng",
    category: "TIME_WORK",
    color: "#22c55e",
  }, // Xanh l√°
  { code: "XD", name: "L√†m ca 3", category: "TIME_WORK", color: "#15803d" }, // Xanh ƒë·∫≠m
  {
    code: "Lƒê",
    name: "Lao ƒë·ªông nghƒ©a v·ª•",
    category: "TIME_WORK",
    color: "#0ea5e9",
  }, // Xanh d∆∞∆°ng ƒë·∫≠m (ƒê√£ s·ª≠a Lƒê)
  {
    code: "LD",
    name: "L√†m ca 3 ng√†y l·ªÖ",
    category: "TIME_WORK",
    color: "#7e22ce",
  }, // T√≠m ƒë·∫≠m (ƒê√£ s·ª≠a LD)
  {
    code: "XL",
    name: "ƒêi l√†m ng√†y l·ªÖ",
    category: "TIME_WORK",
    color: "#a855f7",
  }, // T√≠m
  {
    code: "LE",
    name: "C√¥ng ƒëi l√†m ng√†y l·ªÖ",
    category: "TIME_WORK",
    color: "#9333ea",
  }, // T√≠m
  { code: "CT", name: "ƒêi c√¥ng t√°c", category: "TIME_WORK", color: "#06b6d4" }, // Cyan

  // --- NH√ìM 2: NGH·ªà H∆Ø·ªûNG 100% L∆Ø∆†NG (Ph√©p, L·ªÖ...) ---
  {
    code: "F",
    name: "Ngh·ªâ ph√©p nƒÉm",
    category: "PAID_LEAVE",
    color: "#3b82f6",
  }, // Xanh d∆∞∆°ng
  { code: "L", name: "Ngh·ªâ l·ªÖ", category: "PAID_LEAVE", color: "#f97316" }, // Cam
  {
    code: "R",
    name: "Ngh·ªâ ch·∫ø ƒë·ªô (Hi·∫øu/H·ªâ)",
    category: "PAID_LEAVE",
    color: "#60a5fa",
  }, // Xanh d∆∞∆°ng nh·∫°t
  { code: "B", name: "Ngh·ªâ b√£o l≈©", category: "PAID_LEAVE", color: "#64748b" }, // X√°m xanh
  { code: "ƒêC", name: "Ngh·ªâ ƒë·∫£o ca", category: "PAID_LEAVE", color: "#94a3b8" }, // X√°m nh·∫°t

  // --- NH√ìM 3: CH·∫æ ƒê·ªò ·ªêM / TAI N·∫†N (BHXH chi tr·∫£ ho·∫∑c L∆∞∆°ng cty) ---
  { code: "√î", name: "Ngh·ªâ ·ªëm", category: "SICK", color: "#eab308" }, // V√†ng
  { code: "C√î", name: "Ngh·ªâ con ·ªëm", category: "SICK", color: "#fbbf24" }, // V√†ng cam
  { code: "T", name: "Tai n·∫°n lao ƒë·ªông", category: "SICK", color: "#ef4444" }, // ƒê·ªè
  { code: "DS", name: "Ngh·ªâ d∆∞·ª°ng s·ª©c", category: "SICK", color: "#facc15" }, // V√†ng chanh
  { code: "CL", name: "Ngh·ªâ c√°ch ly", category: "SICK", color: "#84cc16" }, // Xanh n√µn chu·ªëi

  // --- NH√ìM 4: THAI S·∫¢N ---
  {
    code: "TS",
    name: "Ngh·ªâ thai s·∫£n",
    category: "MATERNITY",
    color: "#ec4899",
  }, // H·ªìng

  // --- NH√ìM 5: KH√îNG L∆Ø∆†NG ---
  {
    code: "RO",
    name: "Ngh·ªâ kh√¥ng l∆∞∆°ng",
    category: "UNPAID",
    color: "#d1d5db",
  }, // X√°m tr·∫Øng

  // --- NH√ìM 6: NGH·ªà V√î L√ù DO (K·ª∑ lu·∫≠t) ---
  { code: "O", name: "Ngh·ªâ v√¥ l√Ω do", category: "AWOL", color: "#000000" }, // ƒêen
];

async function main() {
  console.log("üå± B·∫Øt ƒë·∫ßu n·∫°p d·ªØ li·ªáu k√Ω hi·ªáu ch·∫•m c√¥ng...");

  for (const item of attendanceCodes) {
    // D√πng upsert: N·∫øu c√≥ code r·ªìi th√¨ update, ch∆∞a c√≥ th√¨ create (Tr√°nh l·ªói tr√πng)
    await prisma.attendanceCode.upsert({
      where: { code: item.code },
      update: item,
      create: item,
    });
  }

  // T·∫†O USER ADMIN
  const hashedPassword = await bcrypt.hash("150489", 10); // M·∫≠t kh·∫©u l√† 150489

  const admin = await prisma.user.upsert({
    where: { username: "admin" },
    update: {},
    create: {
      username: "admin",
      password: hashedPassword,
      fullName: "Qu·∫£n tr·ªã vi√™n",
      role: Role.ADMIN,
    },
  });

  console.log("‚úÖ ƒê√£ n·∫°p xong danh m·ª•c ch·∫•m c√¥ng!");
  console.log({ admin });
}

main()
  .then(async () => {
    await prisma.$disconnect();
  })
  .catch(async (e) => {
    console.error(e);
    await prisma.$disconnect();
    process.exit(1);
  });


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\prisma\seed.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\admin\employees\import\page.tsx
================================================================================
"use client";
import React, { useState, useEffect } from "react";
import AdminLayout from "@/components/AdminLayout";
import { useSession } from "next-auth/react";
import { useRouter } from "next/navigation"; // D√πng ƒë·ªÉ chuy·ªÉn trang
import { Upload, Button, message, Card, Typography, Result } from "antd";
import { UploadOutlined, FileExcelOutlined } from "@ant-design/icons";

const { Title, Text } = Typography;

export default function ImportEmployeeInfoPage() {
  const { data: session, status } = useSession();
  const router = useRouter();
  const [loading, setLoading] = useState(false);

  // --- [M·ªöI] KI·ªÇM TRA QUY·ªÄN ADMIN ---
  if (status === "loading") return <p>ƒêang t·∫£i...</p>;
  
  // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p ho·∫∑c kh√¥ng ph·∫£i ADMIN -> Ch·∫∑n ngay
  if (!session || session.user.role !== "ADMIN") {
      return (
        <AdminLayout>
           <Result
              status="403"
              title="403"
              subTitle="Xin l·ªói, ch·ªâ Qu·∫£n tr·ªã vi√™n (Admin) m·ªõi c√≥ quy·ªÅn truy c·∫≠p trang n√†y."
              extra={<Button type="primary" onClick={() => router.push("/")}>V·ªÅ trang ch·ªß</Button>}
           />
        </AdminLayout>
      );
  }
  // ----------------------------------

  const handleUpload = async (options: any) => {
    const { file, onSuccess, onError } = options;
    setLoading(true);

    const formData = new FormData();
    formData.append("file", file);

    try {
      const res = await fetch("/api/employees/import-info", {
        method: "POST",
        body: formData,
      });
      const data = await res.json();

      if (res.ok) {
        message.success(data.message);
        onSuccess("Ok");
      } else {
        message.error(data.error);
        onError({ error: data.error });
      }
    } catch (err) {
      message.error("L·ªói k·∫øt n·ªëi server");
      onError({ error: err });
    } finally {
      setLoading(false);
    }
  };

  return (
    <AdminLayout>
      <Title level={3}>C·∫≠p nh·∫≠t th√¥ng tin b·ªï sung</Title>
      <Card style={{ maxWidth: 600, margin: "0 auto" }}>
        <div style={{ textAlign: "center", padding: 20 }}>
          <div style={{ marginBottom: 20 }}>
            <FileExcelOutlined style={{ fontSize: 48, color: "#217346" }} />
          </div>
          <Text type="secondary" style={{ display: "block", marginBottom: 20 }}>
            Upload file Excel ch·ª©a th√¥ng tin b·ªï sung (Ng√†y v√†o, CCCD, S·ªë TK...).
            <br />H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t d·ª±a tr√™n <b>M√£ Nh√¢n Vi√™n</b>.
          </Text>

          <Upload
            customRequest={handleUpload}
            showUploadList={false}
            accept=".xlsx, .xls"
          >
            <Button 
                type="primary" 
                icon={<UploadOutlined />} 
                loading={loading}
                size="large"
            >
              Ch·ªçn file Excel ƒë·ªÉ c·∫≠p nh·∫≠t
            </Button>
          </Upload>
        </div>
        
        <div style={{marginTop: 20, background: "#f5f5f5", padding: 10, borderRadius: 4}}>
            <b>L∆∞u √Ω c·∫•u tr√∫c file Excel:</b>
            <ul>
                <li>C·ªôt A: M√£ Nh√¢n Vi√™n (B·∫Øt bu·ªôc ƒë·ªÉ ƒë·ªëi chi·∫øu)</li>
                <li>C·ªôt B: T√™n (Ch·ªâ ƒë·ªÉ nh√¨n, kh√¥ng c·∫≠p nh·∫≠t)</li>
                <li>C·ªôt C: Ng√†y v√†o l√†m</li>
                <li>C·ªôt D: S·ªë CCCD</li>
                <li>C·ªôt E: Ng√†y c·∫•p</li>
                <li>C·ªôt F: N∆°i c·∫•p</li>
                <li>C·ªôt G: S·ªë t√†i kho·∫£n</li>
                <li>C·ªôt H: M√£ s·ªë thu·∫ø</li>
            </ul>
        </div>
      </Card>
    </AdminLayout>
  );
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\admin\employees\import\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\admin\lock-rules\page.tsx
================================================================================
"use client";

import React, { useEffect, useState } from "react";
import AdminLayout from "@/components/AdminLayout";
import {
  Table,
  Button,
  Modal,
  Form,
  Select,
  DatePicker,
  Input,
  Tag,
  message,
  Card,
  Typography,
  Space,
} from "antd";
import {
  DeleteOutlined,
  PlusOutlined,
  LockOutlined,
  EditOutlined,
} from "@ant-design/icons";
import dayjs from "dayjs";

const { Title, Text } = Typography;
const { RangePicker } = DatePicker;

export default function LockRulesPage() {
  const [rules, setRules] = useState([]);
  const [factories, setFactories] = useState<any[]>([]);
  const [loading, setLoading] = useState(false);

  // State qu·∫£n l√Ω Modal
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingRule, setEditingRule] = useState<any>(null); // L∆∞u b·∫£n ghi ƒëang s·ª≠a

  const [form] = Form.useForm();

  // Load d·ªØ li·ªáu
  const fetchData = async () => {
    setLoading(true);
    try {
      const [rulesRes, factRes] = await Promise.all([
        fetch("/api/admin/lock-rules"),
        fetch("/api/factories"),
      ]);
      if (rulesRes.ok) setRules(await rulesRes.json());
      if (factRes.ok) setFactories(await factRes.json());
    } catch (error) {
      message.error("L·ªói t·∫£i d·ªØ li·ªáu");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
  }, []);

  // M·ªü Modal ƒë·ªÉ T·∫†O M·ªöI
  const openCreateModal = () => {
    setEditingRule(null); // X√≥a tr·∫°ng th√°i s·ª≠a
    form.resetFields(); // X√≥a form
    setIsModalOpen(true);
  };

  // M·ªü Modal ƒë·ªÉ S·ª¨A
  const openEditModal = (record: any) => {
    setEditingRule(record); // L∆∞u b·∫£n ghi ƒëang s·ª≠a
    // ƒêi·ªÅn d·ªØ li·ªáu c≈© v√†o form
    form.setFieldsValue({
      factoryId: record.factoryId ? record.factoryId : "ALL",
      dateRange: [dayjs(record.fromDate), dayjs(record.toDate)],
      reason: record.reason,
    });
    setIsModalOpen(true);
  };

  // X·ª≠ l√Ω chung cho c·∫£ T·∫†O v√† S·ª¨A
  const handleFinish = async (values: any) => {
    try {
      const payload = {
        factoryId: values.factoryId === "ALL" ? null : values.factoryId,
        fromDate: values.dateRange[0].format("YYYY-MM-DD"),
        toDate: values.dateRange[1].format("YYYY-MM-DD"),
        reason: values.reason,
        id: editingRule ? editingRule.id : undefined, // N·∫øu ƒëang s·ª≠a th√¨ g·ª≠i k√®m ID
      };

      // Quy·∫øt ƒë·ªãnh g·ªçi API n√†o (POST hay PUT)
      const method = editingRule ? "PUT" : "POST";
      const url = "/api/admin/lock-rules";

      const res = await fetch(url, {
        method: method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (res.ok) {
        message.success(
          editingRule ? "ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng!" : "ƒê√£ t·∫°o l·ªánh kh√≥a m·ªõi!"
        );
        setIsModalOpen(false);
        form.resetFields();
        setEditingRule(null);
        fetchData(); // Load l·∫°i b·∫£ng
      } else {
        message.error("L·ªói khi l∆∞u d·ªØ li·ªáu");
      }
    } catch (e) {
      message.error("L·ªói k·∫øt n·ªëi");
    }
  };

  const handleDelete = async (id: number) => {
    if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA lu·∫≠t n√†y kh√¥ng?")) return;
    try {
      const res = await fetch(`/api/admin/lock-rules?id=${id}`, {
        method: "DELETE",
      });
      if (res.ok) {
        message.success("ƒê√£ x√≥a th√†nh c√¥ng");
        fetchData();
      } else {
        message.error("Kh√¥ng th·ªÉ x√≥a");
      }
    } catch (e) {
      message.error("L·ªói k·∫øt n·ªëi");
    }
  };

  const columns = [
    {
      title: "Ph·∫°m vi √°p d·ª•ng",
      dataIndex: "factory",
      render: (factory: any) =>
        factory ? (
          <Tag color="blue">{factory.name}</Tag>
        ) : (
          <Tag color="red">TO√ÄN C√îNG TY</Tag>
        ),
    },
    {
      title: "T·ª´ ng√†y",
      dataIndex: "fromDate",
      render: (d: string) => dayjs(d).format("DD/MM/YYYY"),
    },
    {
      title: "ƒê·∫øn ng√†y",
      dataIndex: "toDate",
      render: (d: string) => dayjs(d).format("DD/MM/YYYY"),
    },
    {
      title: "L√Ω do / Ghi ch√∫",
      dataIndex: "reason",
    },
    {
      title: "H√†nh ƒë·ªông",
      key: "action",
      render: (_: any, record: any) => (
        <Space>
          {/* N√∫t S·ª≠a */}
          <Button
            type="primary"
            ghost
            icon={<EditOutlined />}
            onClick={() => openEditModal(record)}
          >
            S·ª≠a
          </Button>

          {/* N√∫t X√≥a */}
          <Button
            danger
            icon={<DeleteOutlined />}
            onClick={() => handleDelete(record.id)}
          >
            X√≥a
          </Button>
        </Space>
      ),
    },
  ];

  return (
    <AdminLayout>
      <div
        style={{
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center",
          marginBottom: 20,
        }}
      >
        <Title level={3}>Qu·∫£n l√Ω Kh√≥a s·ªï & K·ª≥ l∆∞∆°ng</Title>
        <Button
          type="primary"
          icon={<PlusOutlined />}
          onClick={openCreateModal}
        >
          T·∫°o l·ªánh kh√≥a m·ªõi
        </Button>
      </div>

      <Card>
        <div style={{ marginBottom: 16 }}>
          <Text type="secondary">
            <LockOutlined /> Qu·∫£n l√Ω c√°c quy t·∫Øc ch·∫∑n s·ª≠a d·ªØ li·ªáu ch·∫•m c√¥ng.
          </Text>
        </div>
        <Table
          rowKey="id"
          dataSource={rules}
          columns={columns}
          loading={loading}
          pagination={false}
        />
      </Card>

      {/* MODAL (D√πng chung cho T·∫°o v√† S·ª≠a) */}
      <Modal
        title={editingRule ? "C·∫≠p nh·∫≠t L·ªánh kh√≥a" : "Thi·∫øt l·∫≠p Kh√≥a s·ªï m·ªõi"}
        open={isModalOpen}
        onCancel={() => setIsModalOpen(false)}
        footer={null}
      >
        <Form form={form} layout="vertical" onFinish={handleFinish}>
          {/* Ch·ªâ cho ph√©p s·ª≠a Nh√† m√°y khi t·∫°o m·ªõi (ƒë·ªÉ tr√°nh l·ªói logic khi s·ª≠a). 
              N·∫øu b·∫°n mu·ªën cho s·ª≠a c·∫£ nh√† m√°y th√¨ b·ªè prop disabled ƒëi */}
          <Form.Item
            name="factoryId"
            label="Ph·∫°m vi kh√≥a"
            initialValue="ALL"
            rules={[{ required: true }]}
          >
            <Select disabled={!!editingRule}>
              <Select.Option value="ALL">
                üö´ KH√ìA TO√ÄN B·ªò H·ªÜ TH·ªêNG
              </Select.Option>
              {factories.map((f) => (
                <Select.Option key={f.id} value={f.id}>
                  {f.name}
                </Select.Option>
              ))}
            </Select>
          </Form.Item>

          <Form.Item
            name="dateRange"
            label="Kho·∫£ng th·ªùi gian c·∫•m s·ª≠a"
            rules={[{ required: true, message: "Vui l√≤ng ch·ªçn ng√†y" }]}
          >
            <RangePicker style={{ width: "100%" }} format="DD/MM/YYYY" />
          </Form.Item>

          <Form.Item name="reason" label="L√Ω do / Ghi ch√∫">
            <Input placeholder="V√≠ d·ª•: Ch·ªët c√¥ng th√°ng 1" />
          </Form.Item>

          <div style={{ textAlign: "right", marginTop: 20 }}>
            <Button
              onClick={() => setIsModalOpen(false)}
              style={{ marginRight: 8 }}
            >
              H·ªßy
            </Button>
            <Button type="primary" htmlType="submit">
              {editingRule ? "L∆∞u thay ƒë·ªïi" : "X√°c nh·∫≠n Kh√≥a"}
            </Button>
          </div>
        </Form>
      </Modal>
    </AdminLayout>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\admin\lock-rules\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\admin\users\page.tsx
================================================================================
"use client";

import React, { useEffect, useState } from "react";
import AdminLayout from "@/components/AdminLayout";
import {
  Table,
  Button,
  Modal,
  Form,
  Input,
  Select,
  Tag,
  message,
  Popconfirm,
  Space,
  Tooltip,
} from "antd";
import {
  UserAddOutlined,
  DeleteOutlined,
  EditOutlined,
} from "@ant-design/icons";
import { useSession } from "next-auth/react";

const ROLES = [
  { value: "ADMIN", label: "Qu·∫£n tr·ªã h·ªá th·ªëng (Admin)", color: "red" },
  { value: "HR_MANAGER", label: "Qu·∫£n l√Ω nh√¢n s·ª±", color: "blue" },
  { value: "LEADER", label: "Xem b√°o c√°o", color: "purple" },
  { value: "TIMEKEEPER", label: "Ng∆∞·ªùi ch·∫•m c√¥ng", color: "green" },
  { value: "STAFF", label: "Nh√¢n vi√™n", color: "brown" },
];

export default function UserManagementPage() {
  const { data: session } = useSession();
  const [users, setUsers] = useState<any[]>([]);
  const [departments, setDepartments] = useState<any[]>([]);
  const [loading, setLoading] = useState(false);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingUser, setEditingUser] = useState<any>(null);
  const [employees, setEmployees] = useState<any[]>([]);

  const [form] = Form.useForm();
  const selectedRole = Form.useWatch("role", form);

  const fetchData = async () => {
    setLoading(true);
    try {
      const [userRes, deptRes, empRes] = await Promise.all([
        fetch("/api/users"),
        fetch("/api/departments"),
        fetch("/api/employees/list"),
      ]);

      if (userRes.ok) setUsers(await userRes.json());
      if (deptRes.ok) setDepartments(await deptRes.json());
      if (empRes.ok) setEmployees(await empRes.json());

    } catch (error) {
      message.error("L·ªói t·∫£i d·ªØ li·ªáu");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
  }, []);

  const handleOpenAdd = () => {
    setEditingUser(null);
    form.resetFields();
    form.setFieldValue("role", "STAFF");
    setIsModalOpen(true);
  };

  const handleOpenEdit = (record: any) => {
    setEditingUser(record);
    form.setFieldsValue({
      username: record.username,
      fullName: record.fullName,
      role: record.role,
      departmentIds: record.managedDepartments.map((d: any) => d.id),
      password: "",
      employeeCode: record.employeeCode,
      userDepartmentId: record.userDepartmentId,
    });
    setIsModalOpen(true);
  };

  const handleSubmit = async () => {
    try {
      const values = await form.validateFields();
      const url = editingUser ? `/api/users/${editingUser.id}` : "/api/users";
      const method = editingUser ? "PUT" : "POST";

      const res = await fetch(url, {
        method: method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(values),
      });

      if (res.ok) {
        message.success(editingUser ? "C·∫≠p nh·∫≠t th√†nh c√¥ng!" : "T·∫°o t√†i kho·∫£n th√†nh c√¥ng!");
        setIsModalOpen(false);
        fetchData();
      } else {
        const err = await res.json();
        message.error(err.error || "C√≥ l·ªói x·∫£y ra");
      }
    } catch (error) {
      console.log(error);
    }
  };

  const handleSelectEmployee = (value: string) => {
    const selectedEmp = employees.find(e => e.code === value);
    if (selectedEmp) {
      form.setFieldsValue({
        fullName: selectedEmp.fullName,
        userDepartmentId: selectedEmp.departmentId,
      });
      message.info(`ƒê√£ ch·ªçn: ${selectedEmp.fullName}`);
    }
  };

  const handleDelete = async (id: number) => {
    const res = await fetch(`/api/users/${id}`, { method: "DELETE" });
    if (res.ok) {
      message.success("ƒê√£ x√≥a user");
      fetchData();
    } else {
      const err = await res.json();
      message.error(err.error);
    }
  };

  const columns = [
    {
      title: "T√†i kho·∫£n",
      dataIndex: "username",
      key: "username",
      render: (text: string) => <b>{text}</b>,
    },
    {
      title: "M√£ NV",
      dataIndex: "employeeCode",
      key: "employeeCode",
      render: (text: string) => text ? <Tag>{text}</Tag> : <span style={{ color: '#ccc' }}>-</span>,
    },
    {
      title: "H·ªç v√† t√™n",
      dataIndex: "fullName",
      key: "fullName",
    },
    {
      title: "Ph√≤ng tr·ª±c thu·ªôc",
      dataIndex: "userDepartment",
      key: "userDepartment",
      render: (dept: any) => dept ? <Tag color="cyan">{dept.name}</Tag> : <span style={{ color: '#ccc' }}>-</span>,
    },
    {
      title: "Vai tr√≤",
      dataIndex: "role",
      key: "role",
      render: (role: string) => {
        const r = ROLES.find((i) => i.value === role);
        return <Tag color={r?.color}>{r?.label || role}</Tag>;
      },
    },
    {
      title: "Ph√≤ng ban ph·ª• tr√°ch",
      dataIndex: "managedDepartments",
      key: "depts",
      render: (depts: any[]) => (
        <div>
          {depts && depts.length > 0 ? (
            depts.map((d) => <Tag key={d.id}>{d.name}</Tag>)
          ) : (
            <span style={{ color: "#999" }}>-</span>
          )}
        </div>
      ),
    },
    {
      title: "H√†nh ƒë·ªông",
      key: "action",
      render: (_: any, record: any) => (
        <Space>
          <Tooltip title="S·ª≠a th√¥ng tin">
            <Button
              icon={<EditOutlined />}
              size="small"
              type="primary"
              ghost
              onClick={() => handleOpenEdit(record)}
              disabled={record.username === "admin"}
            />
          </Tooltip>

          <Popconfirm
            title="B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a?"
            onConfirm={() => handleDelete(record.id)}
            disabled={record.username === "admin" || record.username === session?.user?.username}
          >
            <Button
              danger
              icon={<DeleteOutlined />}
              size="small"
              disabled={record.username === "admin" || record.username === session?.user?.username}
            />
          </Popconfirm>
        </Space>
      ),
    },
  ];

  if (session?.user?.role !== "ADMIN") {
    return (
      <AdminLayout>
        <div>B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y.</div>
      </AdminLayout>
    );
  };

  return (
    <AdminLayout>
      <div style={{ marginBottom: 16, display: "flex", justifyContent: "space-between" }}>
        <h2>Qu·∫£n l√Ω T√†i kho·∫£n h·ªá th·ªëng</h2>
        <Button type="primary" icon={<UserAddOutlined />} onClick={handleOpenAdd}>
          T·∫°o t√†i kho·∫£n m·ªõi
        </Button>
      </div>

      <Table dataSource={users} columns={columns} rowKey="id" loading={loading} bordered />

      <Modal
        title={editingUser ? "C·∫≠p nh·∫≠t t√†i kho·∫£n" : "T·∫°o t√†i kho·∫£n m·ªõi"}
        open={isModalOpen}
        onOk={handleSubmit}
        onCancel={() => setIsModalOpen(false)}
        width={700}
      >
        <Form form={form} layout="vertical">
          <div style={{ display: 'flex', gap: 16 }}>
            <Form.Item name="username" label="T√™n ƒëƒÉng nh·∫≠p" rules={[{ required: true }]} style={{ flex: 1 }}>
              <Input placeholder="VD: nv_to1" disabled={!!editingUser} />
            </Form.Item>

            <Form.Item
              name="employeeCode"
              label="Li√™n k·∫øt Nh√¢n Vi√™n"
              style={{ flex: 1.5 }}
              help="G√µ t√™n ho·∫∑c m√£ ƒë·ªÉ t√¨m ki·∫øm"
            >
              <Select
                placeholder="Ch·ªçn nh√¢n vi√™n..."
                showSearch
                allowClear
                onChange={handleSelectEmployee}
                options={employees.map((emp) => ({
                  value: emp.code,
                  label: `${emp.code} - ${emp.fullName}`,
                  dept: emp.department?.name,
                }))}
                // @ts-ignore - filterOption is still fully supported in Ant Design
                filterOption={(input, option) => {
                  const label = option?.label?.toString().toLowerCase() || '';
                  return label.includes(input.toLowerCase());
                }}
                optionRender={(option) => (
                  <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                    <span>{option.label}</span>
                    <span style={{ color: '#999', fontSize: 12 }}>
                      {option.data.dept}
                    </span>
                  </div>
                )}
              />
            </Form.Item>
          </div>

          <Form.Item name="fullName" label="H·ªç v√† t√™n hi·ªÉn th·ªã" rules={[{ required: true }]}>
            <Input placeholder="VD: Nguy·ªÖn VƒÉn A" />
          </Form.Item>

          <div style={{ display: 'flex', gap: 16 }}>
            <Form.Item name="role" label="Vai tr√≤" rules={[{ required: true }]} style={{ flex: 1 }}>
              <Select options={ROLES} />
            </Form.Item>

            <Form.Item name="userDepartmentId" label="Ph√≤ng ban tr·ª±c thu·ªôc" style={{ flex: 1 }}>
              <Select
                placeholder="Ch·ªçn ph√≤ng ban..."
                showSearch
                allowClear
                options={departments.map((d) => ({
                  value: d.id,
                  label: `${d.name} - ${d.factory?.name}`,
                }))}
                // @ts-ignore
                filterOption={(input, option) => {
                  const label = option?.label?.toString().toLowerCase() || '';
                  return label.includes(input.toLowerCase());
                }}
              />
            </Form.Item>
          </div>

          <Form.Item
            name="password"
            label={editingUser ? "M·∫≠t kh·∫©u m·ªõi (ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)" : "M·∫≠t kh·∫©u"}
            rules={[{ required: !editingUser, message: "Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u" }]}
          >
            <Input.Password placeholder={editingUser ? "Nh·∫≠p m·∫≠t kh·∫©u m·ªõi..." : "Nh·∫≠p m·∫≠t kh·∫©u"} />
          </Form.Item>

          {["TIMEKEEPER", "STAFF"].includes(selectedRole) && (
            <Form.Item
              name="departmentIds"
              label={selectedRole === "TIMEKEEPER" ? "ƒê∆∞·ª£c ph√¢n quy·ªÅn ch·∫•m c√¥ng t·∫°i:" : "ƒê∆∞·ª£c xem d·ªØ li·ªáu t·∫°i:"}
              rules={[{ required: true, message: "Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 ph√≤ng ban" }]}
              style={{ background: '#f5f5f5', padding: 10, borderRadius: 6 }}
            >
              <Select
                mode="multiple"
                placeholder="Ch·ªçn danh s√°ch ph√≤ng..."
                allowClear
                showSearch
                style={{ width: "100%" }}
                options={departments.map((d) => ({
                  value: d.id,
                  label: `${d.name} (${d.factory?.name})`,
                }))}
                //@ts-ignore
                filterOption={(input, option) => {
                  const label = option?.label?.toString().toLowerCase() || '';
                  return label.includes(input.toLowerCase());
                }}
              />
            </Form.Item>
          )}
        </Form>
      </Modal>
    </AdminLayout>
  );
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\admin\users\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\admin\lock-rules\route.ts
================================================================================
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { auth } from "@/auth";

// 1. L·∫§Y DANH S√ÅCH LU·∫¨T
export async function GET(request: Request) {
  try {
    const session = await auth();
    // ƒê√£ c√≥ s·∫µn ADMIN v√† HR_MANAGER
    if (!["ADMIN", "HR_MANAGER"].includes(session?.user?.role || "")) {
      return NextResponse.json({ error: "Kh√¥ng c√≥ quy·ªÅn" }, { status: 403 });
    }

    const rules = await prisma.lockRule.findMany({
      orderBy: { createdAt: "desc" },
      include: { factory: true },
    });

    return NextResponse.json(rules);
  } catch (error) {
    console.error(error);
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}

// 2. T·∫†O LU·∫¨T M·ªöI (KH√ìA S·ªî)
export async function POST(request: Request) {
  try {
    const session = await auth();
    // [ƒê√É S·ª¨A] Cho ph√©p c·∫£ HR_MANAGER
    if (!["ADMIN", "HR_MANAGER"].includes(session?.user?.role || "")) {
      return NextResponse.json(
        { error: "Ch·ªâ Admin ho·∫∑c HR Manager m·ªõi ƒë∆∞·ª£c kh√≥a s·ªï" },
        { status: 403 },
      );
    }

    const body = await request.json();
    const { factoryId, fromDate, toDate, reason } = body;

    if (!fromDate || !toDate) {
      return NextResponse.json(
        { error: "Thi·∫øu th·ªùi gian kh√≥a" },
        { status: 400 },
      );
    }

    const from = new Date(new Date(fromDate).setHours(0, 0, 0, 0));
    const to = new Date(new Date(toDate).setHours(23, 59, 59, 999));

    await prisma.lockRule.create({
      data: {
        factoryId: factoryId ? Number(factoryId) : null,
        fromDate: from,
        toDate: to,
        reason: reason,
      },
    });

    return NextResponse.json({ message: "ƒê√£ t·∫°o l·ªánh kh√≥a th√†nh c√¥ng!" });
  } catch (error) {
    console.error(error);
    return NextResponse.json({ error: "L·ªói khi t·∫°o kh√≥a" }, { status: 500 });
  }
}

// 3. X√ìA LU·∫¨T (M·ªû KH√ìA)
export async function DELETE(request: Request) {
  try {
    const session = await auth();
    // [ƒê√É S·ª¨A] Cho ph√©p c·∫£ HR_MANAGER
    if (!["ADMIN", "HR_MANAGER"].includes(session?.user?.role || "")) {
      return NextResponse.json({ error: "Kh√¥ng c√≥ quy·ªÅn" }, { status: 403 });
    }

    const { searchParams } = new URL(request.url);
    const id = searchParams.get("id");

    if (!id) return NextResponse.json({ error: "Thi·∫øu ID" }, { status: 400 });

    await prisma.lockRule.delete({
      where: { id: Number(id) },
    });

    return NextResponse.json({ message: "ƒê√£ m·ªü kh√≥a (x√≥a lu·∫≠t) th√†nh c√¥ng!" });
  } catch (error) {
    console.error(error);
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}

// 4. C·∫¨P NH·∫¨T LU·∫¨T (S·ª¨A)
export async function PUT(request: Request) {
  try {
    const session = await auth();
    // [ƒê√É S·ª¨A] Cho ph√©p c·∫£ HR_MANAGER
    if (!["ADMIN", "HR_MANAGER"].includes(session?.user?.role || "")) {
      return NextResponse.json({ error: "Kh√¥ng c√≥ quy·ªÅn" }, { status: 403 });
    }

    const body = await request.json();
    const { id, fromDate, toDate, reason } = body;

    if (!id || !fromDate || !toDate) {
      return NextResponse.json({ error: "Thi·∫øu th√¥ng tin" }, { status: 400 });
    }

    const from = new Date(new Date(fromDate).setHours(0, 0, 0, 0));
    const to = new Date(new Date(toDate).setHours(23, 59, 59, 999));

    await prisma.lockRule.update({
      where: { id: Number(id) },
      data: {
        fromDate: from,
        toDate: to,
        reason: reason,
      },
    });

    return NextResponse.json({ message: "ƒê√£ c·∫≠p nh·∫≠t l·ªánh kh√≥a th√†nh c√¥ng!" });
  } catch (error) {
    console.error(error);
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\admin\lock-rules\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\attendance-codes\route.ts
================================================================================
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

// --- L·∫•y danh s√°ch ----
export async function GET() {
  try {
    const codes = await prisma.attendanceCode.findMany({
      orderBy: { id: "asc" },
    });
    return NextResponse.json(codes);
  } catch (error) {
    return NextResponse.json(
      { error: "L·ªói t·∫£i d·ªØ li·ªáu: " + error },
      { status: 500 }
    );
  }
}

// --- Th√™m m·ªõi ---
export async function POST(request: Request) {
  try {
    const body = await request.json();
    const { code, name, category, color, factor, description } = body;

    const newCode = await prisma.attendanceCode.create({
      data: {
        code,
        name,
        category,
        color,
        factor: factor ? parseFloat(factor) : 1, // M·∫∑c ƒë·ªãnh h·ªá s·ªë 1 n·∫øu kh√¥ng nh·∫≠p
        description,
      },
    });

    return NextResponse.json(newCode);
  } catch (error) {
    return NextResponse.json(
      { error: "L·ªói th√™m m·ªõi: " + error },
      { status: 500 }
    );
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\attendance-codes\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\attendance-codes\[id]\route.ts
================================================================================
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

// --- C·∫¨P NH·∫¨T ---
export async function PATCH(
  request: Request,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const { id } = await params;
    const body = await request.json();

    // Lo·∫°i b·ªè id kh·ªèi body ƒë·ªÉ tr√°nh l·ªói update id
    const { id: _, ...dataToUpdate } = body;

    const updated = await prisma.attendanceCode.update({
      where: { id: parseInt(id) },
      data: dataToUpdate,
    });

    return NextResponse.json(updated);
  } catch (error) {
    return NextResponse.json(
      { error: "L·ªói c·∫≠p nh·∫≠t: " + error },
      { status: 500 }
    );
  }
}

// --- X√≥a ---
export async function DELETE(
  request: Request,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const { id } = await params;

    // Ki·ªÉm tra xem m√£ n√†y ƒë√£ ƒë∆∞·ª£c d√πng ch·∫•m c√¥ng ch∆∞a? N·∫øu d√πng r·ªìi th√¨ kh√¥ng cho x√≥a
    const count = await prisma.timesheet.count({
      where: { attendanceCodeId: parseInt(id) },
    });

    if (count > 0) {
      return NextResponse.json(
        { error: "Kh√¥ng th·ªÉ x√≥a v√¨ ƒë√£ c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng s·ª≠ d·ª•ng m√£ n√†y!" },
        { status: 400 }
      );
    }

    await prisma.attendanceCode.delete({
      where: { id: parseInt(id) },
    });

    return NextResponse.json({ message: "ƒê√£ x√≥a" });
  } catch (error) {
    return NextResponse.json(
      { error: "L·ªói khi x√≥a: " + error },
      { status: 500 }
    );
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\attendance-codes\[id]\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\auth\[...nextauth]\route.ts
================================================================================
// src/app/api/auth/[...nextauth]/route.ts
import { handlers } from "@/auth"; // Import t·ª´ file auth.ts ·ªü b∆∞·ªõc 2

export const { GET, POST } = handlers;

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\auth\[...nextauth]\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\bravo-data\bravo\route.ts
================================================================================
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import dayjs from "dayjs";

// √Ånh x·∫° Category sang Ti·∫øng Vi·ªát
const CATEGORY_MAP: Record<string, string> = {
  TIME_WORK: "L∆∞∆°ng th·ªùi gian",
  PAID_LEAVE: "Ngh·ªâ h∆∞·ªüng 100% l∆∞∆°ng",
  SICK: "Ch·∫ø ƒë·ªô ·ªêm / Tai n·∫°n",
  MATERNITY: "Ch·∫ø ƒë·ªô Thai s·∫£n",
  UNPAID: "Ngh·ªâ kh√¥ng l∆∞∆°ng",
  AWOL: "Ngh·ªâ v√¥ l√Ω do",
};

export async function GET(request: Request) {
  try {
    const { searchParams } = new URL(request.url);
    const month = parseInt(searchParams.get("month") || "");
    const year = parseInt(searchParams.get("year") || "");
    const factoryIdStr = searchParams.get("factoryId");
    const departmentIdStr = searchParams.get("departmentId");
    const kipIdsStr = searchParams.get("kipIds");

    if (!month || !year) {
      return NextResponse.json({ error: "Thi·∫øu th√°ng/nƒÉm" }, { status: 400 });
    }

    const whereCondition: any = {};

    if (factoryIdStr && factoryIdStr !== "null") {
      whereCondition.department = { factoryId: Number(factoryIdStr) };
    }
    if (
      departmentIdStr &&
      departmentIdStr !== "null" &&
      departmentIdStr !== ""
    ) {
      const ids = departmentIdStr.split(",").map(Number);
      if (ids.length > 0) whereCondition.departmentId = { in: ids };
    }
    if (kipIdsStr && kipIdsStr !== "null" && kipIdsStr !== "") {
      const ids = kipIdsStr.split(",").map(Number);
      if (ids.length > 0) whereCondition.kipId = { in: ids };
    }

    const startDate = dayjs(`${year}-${month}-01`).startOf("month").toDate();
    const endDate = dayjs(`${year}-${month}-01`).endOf("month").toDate();
    const daysInMonth = dayjs(`${year}-${month}-01`).daysInMonth();

    // 1. L·∫•y d·ªØ li·ªáu (Prisma s·∫Ω t·ª± ƒë·ªông gom nh√≥m nh√¢n vi√™n theo b·ªô ph·∫≠n nh·ªù orderBy)
    const employees = await prisma.employee.findMany({
      where: whereCondition,
      include: {
        department: true,
        timesheets: {
          where: { date: { gte: startDate, lte: endDate } },
          include: { attendanceCode: true },
        },
      },
      orderBy: [
        { department: { factoryId: "asc" } }, // S·∫Øp x·∫øp theo nh√† m√°y tr∆∞·ªõc
        { departmentId: "asc" }, // C√πng nh√† m√°y th√¨ gom theo B·ªô ph·∫≠n
        { code: "asc" }, // C√πng b·ªô ph·∫≠n th√¨ x·∫øp theo M√£ NV
      ],
    });

    const flatData = [];

    // 2. [THAY ƒê·ªîI QUAN TR·ªåNG ·ªû ƒê√ÇY] V√≤ng l·∫∑p Ng√†y n·∫±m b√™n ngo√†i
    for (let d = 1; d <= daysInMonth; d++) {
      const currentDay = dayjs(`${year}-${month}-${d}`);
      const dateStrExport = currentDay.format("DD/MM/YY");
      const dateStrQuery = currentDay.format("YYYY-MM-DD");

      // V√≤ng l·∫∑p Nh√¢n vi√™n n·∫±m b√™n trong (L√∫c n√†y danh s√°ch NV ƒë√£ ƒë∆∞·ª£c gom theo B·ªô ph·∫≠n ·ªü tr√™n)
      for (const emp of employees) {
        // T√¨m xem ng√†y n√†y nh√¢n vi√™n c√≥ ch·∫•m c√¥ng kh√¥ng
        const log = emp.timesheets.find(
          (t) => dayjs(t.date).format("YYYY-MM-DD") === dateStrQuery,
        );

        let attCode = "";
        let attCategory = "";

        if (log && log.attendanceCode) {
          attCode = log.attendanceCode.code;
          attCategory =
            CATEGORY_MAP[log.attendanceCode.category] ||
            log.attendanceCode.category;
        }

        // ƒê·∫©y d√≤ng d·ªØ li·ªáu v√†o m·∫£ng
        flatData.push({
          ngay: dateStrExport,
          nvNhap: "H0030",
          boPhan: emp.department?.code || "",
          maCongThoiGian: "+",
          maNv: emp.code,
          tenNv: emp.fullName,
          maCong: attCode,
          loaiCong: attCategory,
        });
      }
    }

    return NextResponse.json(flatData);
  } catch (error) {
    console.error("L·ªói Export BRAVO:", error);
    return NextResponse.json({ error: "L·ªói Server" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\bravo-data\bravo\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\dashboard\route.ts
================================================================================
// src/app/api/dashboard/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import dayjs from "dayjs";

export async function GET(request: Request) {
  try {
    const { searchParams } = new URL(request.url);
    const factoryId = searchParams.get("factoryId");
    const dateStr = searchParams.get("date");

    // M·∫∑c ƒë·ªãnh l√† h√¥m nay
    const date = dateStr ? new Date(dateStr) : new Date();

    // X√°c ƒë·ªãnh kho·∫£ng th·ªùi gian c·ªßa ng√†y ƒë√≥
    const startOfDay = dayjs(date).startOf("day").toDate();
    const endOfDay = dayjs(date).endOf("day").toDate();

    // 1. Chu·∫©n b·ªã b·ªô l·ªçc ph√≤ng ban
    const whereDept: any = {};
    if (factoryId) {
      whereDept.factoryId = parseInt(factoryId);
    }

    // 2. TRUY V·∫§N T·ªêI ∆ØU (L·∫•y ph√≤ng ban + Nh√¢n vi√™n + Timesheet trong 1 l·∫ßn g·ªçi)
    const departments = await prisma.department.findMany({
      where: whereDept,
      include: {
        factory: true,
        employees: {
          select: {
            id: true,
            // L·∫•y timesheet c·ªßa nh√¢n vi√™n trong ng√†y ƒë√≥
            timesheets: {
              where: {
                date: {
                  gte: startOfDay,
                  lte: endOfDay,
                },
              },
              include: {
                attendanceCode: true, // L·∫•y m√£ c√¥ng ƒë·ªÉ check v·∫Øng
              },
            },
          },
        },
      },
    });

    // 3. Danh s√°ch c√°c m√£ ƒë∆∞·ª£c coi l√† "V·∫ÆNG"
    const absenceCodes = [
      "F",
      "L",
      "R",
      "B",
      "ƒêC",
      "√î",
      "C√î",
      "T",
      "DS",
      "CL",
      "TS",
      "RO",
      "O",
      "NB",
    ];

    // 4. T√≠nh to√°n s·ªë li·ªáu
    const departmentStats = departments.map((dept) => {
      const totalStaff = dept.employees.length;

      // Bi·∫øn ƒë·∫øm
      let timekeepingCount = 0; // S·ªë ng∆∞·ªùi ƒê√É c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng
      let absentCount = 0; // S·ªë ng∆∞·ªùi V·∫Øng

      dept.employees.forEach((emp) => {
        // Ki·ªÉm tra xem nh√¢n vi√™n c√≥ b·∫£n ghi ch·∫•m c√¥ng n√†o kh√¥ng
        if (emp.timesheets.length > 0) {
          timekeepingCount++; // ƒê√£ ch·∫•m c√¥ng

          // Ki·ªÉm tra xem m√£ c√¥ng c√≥ thu·ªôc nh√≥m V·∫Øng kh√¥ng
          const code = emp.timesheets[0].attendanceCode.code;
          if (absenceCodes.includes(code)) {
            absentCount++;
          }
        }
      });

      // --- [LOGIC M·ªöI] X√ÅC ƒê·ªäNH TR·∫†NG TH√ÅI ---
      let status = "PENDING"; // M·∫∑c ƒë·ªãnh: Ch∆∞a ch·∫•m (X√°m)
      if (timekeepingCount > 0) {
        if (timekeepingCount >= totalStaff && totalStaff > 0) {
          status = "DONE"; // ƒê√£ ch·∫•m ƒë·ªß 100% (Xanh l√°)
        } else {
          status = "PROCESSING"; // ƒêang ch·∫•m d·ªü (Xanh d∆∞∆°ng/Cam)
        }
      }
      // ---------------------------------------

      return {
        key: dept.id,
        id: dept.id, // Th√™m id ƒë·ªÉ frontend d√πng n·∫øu c·∫ßn
        departmentName: dept.name,
        factoryName: dept.factory?.name,
        totalStaff,
        absentCount,
        timekeepingCount, // Tr·∫£ v·ªÅ s·ªë l∆∞·ª£ng ng∆∞·ªùi ƒë√£ ch·∫•m
        status, // Tr·∫£ v·ªÅ tr·∫°ng th√°i (PENDING | PROCESSING | DONE)
        percent:
          totalStaff > 0
            ? Math.round((timekeepingCount / totalStaff) * 100)
            : 0, // % Ti·∫øn ƒë·ªô
        absentRate:
          totalStaff > 0 ? ((absentCount / totalStaff) * 100).toFixed(1) : 0, // % V·∫Øng
      };
    });

    // S·∫Øp x·∫øp:
    // ∆Øu ti√™n 1: ƒê∆∞a ph√≤ng ƒëang ch·∫•m (PROCESSING) l√™n ƒë·∫ßu ƒë·ªÉ nh·∫Øc nh·ªü
    // ∆Øu ti√™n 2: Ph√≤ng v·∫Øng nhi·ªÅu l√™n tr√™n
    departmentStats.sort((a, b) => {
      if (a.status === "PROCESSING" && b.status !== "PROCESSING") return -1;
      if (b.status === "PROCESSING" && a.status !== "PROCESSING") return 1;
      return Number(b.absentCount) - Number(a.absentCount);
    });

    return NextResponse.json({ stats: departmentStats });
  } catch (error) {
    console.error("L·ªói Dashboard Detail:", error);
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\dashboard\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\departments\route.ts
================================================================================
// src/app/api/departments/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

// 1. H√†m GET, d√πng ƒë·ªÉ l·∫•y danh s√°ch ph√≤ng ban
export async function GET() {
  try {
    // G·ªçi prisma ƒë·ªÉ l·∫•y danh s√°ch ph√≤ng ban
    const departments = await prisma.department.findMany({
      orderBy: {
        id: "asc",
      },
      // T·ªêI ∆ØU: L·∫•y k√®m th√¥ng tin c·ªßa nh√† m√°y li√™n quan
      include: {
        factory: true,
      },
    });

    // Tr·∫£ k·∫øt qu·∫£ d·∫°ng JSON v·ªÅ cho giao di·ªán
    return NextResponse.json(departments);
  } catch (error) {
    return NextResponse.json(
      { error: "L·ªói khi l·∫•y danh s√°ch ph√≤ng ban: " + error },
      { status: 500 }
    );
  }
}

// 2. H√†m POST, d√πng ƒë·ªÉ th√™m ph√≤ng ban
export async function POST(request: Request) {
  try {
    // ƒê·ªçc d·ªØ li·ªáu g·ª≠i l√™n t·ª´ giao di·ªán
    // Chuy·ªÉn chu·ªói JSON t·ª´ tr√¨nh duy·ªát g·ª≠i l√™n th√†nh Object r·ªìi g√°n cho body
    const body = await request.json();
    const { name, code, factoryId } = body;

    if (!name || !code) {
      return NextResponse.json(
        { error: "M√£ v√† t√™n ph√≤ng ban l√† b·∫Øt bu·ªôc!" },
        { status: 400 }
      );
    }

    // L∆∞u v√†o database
    const newDepartment = await prisma.department.create({
      data: {
        name: name,
        code: code,
        factoryId: factoryId, // N·∫øu factoryId c√≥ gi√° tr·ªã th√¨ l∆∞u, n·∫øu null/undefined th√¨ Prisma t·ª± hi·ªÉu l√† null
      },
    });

    // Tr·∫£ v·ªÅ giao di·ªán th√¥ng tin b·∫£n ghi v·ª´a ƒë∆∞·ª£c th√™m
    return NextResponse.json(newDepartment);
  } catch (error) {
    return NextResponse.json(
      { error: "L·ªói khi th√™m ph√≤ng ban: " + error },
      { status: 400 }
    );
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\departments\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\departments\[id]\route.ts
================================================================================
// src/app/api/departments/[id]/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { message } from "antd";

// H√†m l·∫•y ID t·ª´ URL (V√≠ d·ª•: /api/departments/1 -> id = 1)
// params ch√≠nh l√† object ch·ª©a { id : '1' }

// --- API X√ìA PH√íNG BAN ---
export async function DELETE(
  request: Request,
  // S·ª≠a ki·ªÉu d·ªØ li·ªáu: params l√† Promise
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    // B∆Ø·ªöC QUAN TR·ªåNG: Ph·∫£i await params tr∆∞·ªõc
    const { id } = await params;
    const departmentId = parseInt(id);

    // X√≥a trong database
    await prisma.department.delete({
      where: { id: departmentId },
    });

    return NextResponse.json({ message: "X√≥a th√†nh c√¥ng!" });
  } catch (error) {
    return NextResponse.json(
      {
        error:
          "Kh√¥ng th·ªÉ x√≥a (C√≥ th·ªÉ do ph√≤ng ban n√†y ƒëang c√≥ nh√¢n vi√™n)," + error,
      },
      { status: 500 }
    );
  }
}

// --- API C·∫¨P NH·∫¨T PH√íNG BAN ---
export async function PATCH(
  request: Request,
  // S·ª≠a ki·ªÉu d·ªØ li·ªáu: params l√† Promise
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    // B∆Ø·ªöC QUAN TR·ªåNG: Ph·∫£i await params tr∆∞·ªõc khi d√πng
    const { id } = await params;
    const departmentId = parseInt(id);

    const body = await request.json(); // Chuy·ªÉn g√≥i h√†ng JSON t·ª´ client g·ª≠i l√™n th√†nh Object
    const { code, name, factoryId } = body;

    // C·∫≠p nh·∫≠t d·ªØ li·ªáu
    const updatedDepartment = await prisma.department.update({
      where: { id: departmentId },
      data: {
        code: code,
        name: name,
        factoryId: parseInt(factoryId),
      },
    });

    return NextResponse.json(updatedDepartment);
  } catch (error) {
    console.log(error); // In l·ªói ra terminal server ƒë·ªÉ xem chi ti·∫øt
    return NextResponse.json({ error: "L·ªói khi c·∫≠p nh·∫≠t, " }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\departments\[id]\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\employees\import-info\route.ts
================================================================================
// src/app/api/employees/import-info/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import ExcelJS from "exceljs";

export async function POST(request: Request) {
  try {
    const formData = await request.formData();
    const file = formData.get("file") as File;

    if (!file) {
      return NextResponse.json({ error: "Kh√¥ng c√≥ file n√†o ƒë∆∞·ª£c t·∫£i l√™n" }, { status: 400 });
    }

    const buffer = await file.arrayBuffer();
    const workbook = new ExcelJS.Workbook();
    await workbook.xlsx.load(buffer);

    const worksheet = workbook.getWorksheet(1); // L·∫•y sheet ƒë·∫ßu ti√™n
    if (!worksheet) {
        return NextResponse.json({ error: "File Excel r·ªóng" }, { status: 400 });
    }

    const updates: Promise<any>[] = [];
    
    // Gi·∫£ s·ª≠ File Excel c√≥ c·∫•u tr√∫c c·ªôt nh∆∞ sau (B·∫Øt ƒë·∫ßu t·ª´ d√≤ng 2):
    // A: M√£ NV | B: T√™n (B·ªè qua) | C: Ng√†y v√†o | D: S·ªë CCCD | E: Ng√†y c·∫•p | F: N∆°i c·∫•p | G: S·ªë TK | H: MST

    worksheet.eachRow((row, rowNumber) => {
      if (rowNumber === 1) return; // B·ªè qua d√≤ng ti√™u ƒë·ªÅ

      const code = row.getCell(1).text?.toString().trim(); // C·ªôt A: M√£ NV
      
      // N·∫øu kh√¥ng c√≥ m√£ NV th√¨ b·ªè qua
      if (!code) return;

      // H√†m helper ƒë·ªÉ l·∫•y ng√†y th√°ng t·ª´ Excel an to√†n
      const getDate = (cellIndex: number) => {
          const val = row.getCell(cellIndex).value;
          if (!val) return null;
          // ExcelJS ƒë√¥i khi tr·∫£ v·ªÅ object Date, ƒë√¥i khi tr·∫£ v·ªÅ string
          return new Date(val as string | number | Date);
      };

      const startDate = getDate(3);        // C·ªôt C
      const idCardNumber = row.getCell(4).text?.toString().trim(); // C·ªôt D
      const idCardDate = getDate(5);       // C·ªôt E
      const idCardPlace = row.getCell(6).text?.toString().trim();  // C·ªôt F
      const bankAccount = row.getCell(7).text?.toString().trim();  // C·ªôt G
      const taxCode = row.getCell(8).text?.toString().trim();      // C·ªôt H

      // ƒê·∫©y v√†o m·∫£ng Promise ƒë·ªÉ ch·∫°y c·∫≠p nh·∫≠t
      // S·ª≠ d·ª•ng prisma.update v·ªõi ƒëi·ªÅu ki·ªán where code
      updates.push(
        prisma.employee.update({
          where: { code: code }, // <--- M·∫•u ch·ªët l√† ƒë√¢y: T√¨m theo M√£ NV
          data: {
            startDate,
            idCardNumber,
            idCardDate,
            idCardPlace,
            bankAccount,
            taxCode
          }
        }).catch(err => {
            console.log(`Kh√¥ng t√¨m th·∫•y ho·∫∑c l·ªói update NV m√£ ${code}:`, err.message);
            return null; 
        })
      );
    });

    // Th·ª±c hi·ªán c·∫≠p nh·∫≠t song song (nhanh h∆°n v√≤ng l·∫∑p th∆∞·ªùng)
    await Promise.all(updates);

    return NextResponse.json({ message: `ƒê√£ x·ª≠ l√Ω c·∫≠p nh·∫≠t ${updates.length} nh√¢n vi√™n` });

  } catch (error) {
    console.error("L·ªói import:", error);
    return NextResponse.json({ error: "L·ªói x·ª≠ l√Ω file" }, { status: 500 });
  }
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\employees\import-info\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\employees\list\route.ts
================================================================================
// src/app/api/employees/list/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { auth } from "@/auth";

export async function GET(request: Request) {
  try {
    const session = await auth();
    if (!session)
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

    // L·∫•y danh s√°ch nh√¢n vi√™n r√∫t g·ªçn ƒë·ªÉ l√†m dropdown
    const employees = await prisma.employee.findMany({
      select: {
        id: true,
        code: true,
        fullName: true,
        departmentId: true, // L·∫•y ID ph√≤ng ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn
        department: {
          select: { name: true, factory: { select: { name: true } } },
        },
      },
      orderBy: { code: "asc" },
    });

    return NextResponse.json(employees);
  } catch (error) {
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\employees\list\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\employees\route.ts
================================================================================
// src/app/api/employees/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

// 1. H√†m GET: L·∫•y danh s√°ch (ƒê√£ n√¢ng c·∫•p ƒë·ªÉ h·ªó tr·ª£ l·ªçc)
export async function GET(request: Request) {
  try {
    // [M·ªöI] L·∫•y tham s·ªë t·ª´ URL g·ª≠i l√™n (v√≠ d·ª•: ?departmentId=5)
    const { searchParams } = new URL(request.url);
    const departmentIdStr = searchParams.get("departmentId");
    const factoryIdStr = searchParams.get("factoryId");

    // [M·ªöI] T·∫°o ƒëi·ªÅu ki·ªán l·ªçc (Where Condition)
    const whereCondition: any = {};

    // N·∫øu c√≥ departmentId -> L·ªçc theo ph√≤ng
    if (departmentIdStr && departmentIdStr !== "null") {
      whereCondition.departmentId = Number(departmentIdStr);
    }

    // N·∫øu c√≥ factoryId -> L·ªçc theo nh√† m√°y (d·ª± ph√≤ng)
    if (factoryIdStr && factoryIdStr !== "null") {
      whereCondition.department = {
        factoryId: Number(factoryIdStr),
      };
    }

    const employees = await prisma.employee.findMany({
      // [M·ªöI] ƒê∆∞a ƒëi·ªÅu ki·ªán l·ªçc v√†o ƒë√¢y
      where: whereCondition,
      
      orderBy: {
        code: "asc", // [G·ª¢I √ù] N√™n s·∫Øp x·∫øp theo M√£ ho·∫∑c T√™n ƒë·ªÉ d·ªÖ t√¨m trong dropdown
      },
      
      // K·ªπ thu·∫≠t l·ªìng gh√©p d·ªØ li·ªáu (Gi·ªØ nguy√™n nh∆∞ c≈©)
      include: {
        department: {
          include: {
            factory: true,
          },
        },
        kip: true,
      },
    });

    return NextResponse.json(employees);
  } catch (error) {
    return NextResponse.json(
      { error: "L·ªói khi l·∫•y danh s√°ch nh√¢n vi√™n: " + error },
      { status: 500 }
    );
  }
}

// 2. H√†m POST: Th√™m nh√¢n vi√™n m·ªõi (GI·ªÆ NGUY√äN CODE C·ª¶A B·∫†N)
export async function POST(request: Request) {
  try {
    const body = await request.json();
    const {
      code,
      fullName,
      birthday,
      gender,
      address,
      phone,
      position,
      departmentId,
      kipId,
      startDate,
      idCardNumber,
      idCardDate,
      idCardPlace,
      bankAccount,
      taxCode
    } = body;

    if (!code || !fullName || !departmentId) {
      return NextResponse.json(
        { error: "M√£, H·ªç t√™n v√† Ph√≤ng ban l√† b·∫Øt bu·ªôc!" },
        { status: 400 }
      );
    }

    const birthdayDate = birthday ? new Date(birthday) : null;
    const startDateDate = startDate ? new Date(startDate) : null;
    const idCardDateDate = idCardDate ? new Date(idCardDate) : null;

    const newEmployee = await prisma.employee.create({
      data: {
        code: code,
        fullName: fullName,
        birthday: birthdayDate,
        gender: gender,
        address: address,
        phone: phone,
        position: position,
        departmentId: Number(departmentId),
        kipId: kipId ? Number(kipId) : null,
        startDate: startDateDate,
        idCardNumber,
        idCardDate: idCardDateDate,
        idCardPlace,
        bankAccount,
        taxCode
      },
    });

    return NextResponse.json(newEmployee);
  } catch (error) {
    return NextResponse.json(
      { error: "L·ªói khi th√™m nh√¢n vi√™n, c√≥ th·ªÉ do tr√πng m√£: " + error },
      { status: 400 }
    );
  }
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\employees\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\employees\[id]\route.ts
================================================================================
import { error } from "node:console";
// src/app/api/employees/[id]/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

// H√†m l·∫•y ID t·ª´ URL (V√≠ d·ª•: /api/employees/1 -> id = 1)
// params ch√≠nh l√† object ch·ª©a { id : '1' }

// --- API X√ìA TH√îNG TIN NH√ÇN VI√äN ---
export async function DELETE(
  request: Request,
  // params ph·∫£i l√† promise
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    // B∆∞·ªõc ƒë·∫ßu ti√™n, await params tr∆∞·ªõc
    const { id } = await params;
    const employeeId = parseInt(id);

    // X√≥a trong c∆° s·ªü d·ªØ li·ªáu
    await prisma.employee.delete({
      where: { id: employeeId },
    });

    // X√≥a xong th√¨ t·∫°o chu·ªói JSON b√°o v·ªÅ client
    return NextResponse.json({ message: "X√≥a th√†nh c√¥ng!" });
  } catch (error) {
    return NextResponse.json(
      { error: "L·ªói khi x√≥a: " + error },
      { status: 500 }
    );
  }
}

// --- API C·∫¨P NH·∫¨T TH√îNG TIN NH√ÇN VI√äN ---
export async function PATCH(
  request: Request,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    // G·ªçi await params
    const { id } = await params;
    const employeeId = parseInt(id);

    const body = await request.json(); // Chuy·ªÉn g√≥i h√†ng JSON t·ª´ client g·ª≠i l√™n th√†nh Object
    const {
      code,
      fullName,
      birthday,
      gender,
      address,
      phone,
      position,
      departmentId,
      kipId,
      startDate, idCardNumber, idCardDate, idCardPlace, bankAccount, taxCode
    } = body; // L·∫•y nh·ªØng th·ª© c·∫ßn thi·∫øt t·ª´ c·ª•c h√†ng body ra ƒë·ªÉ d√πng (c·∫≠p nh·∫≠t)

    // FIX: X·ª≠ l√Ω ng√†y sinh an to√†n h∆°n
    // N·∫øu birthday h·ª£p l·ªá th√¨ new Date, n·∫øu kh√¥ng th√¨ undefined
    const formatBirthday = birthday ? new Date(birthday) : undefined;
    const formatStartDate = startDate ? new Date(startDate) : null;     // [M·ªöI]
    const formatIdCardDate = idCardDate ? new Date(idCardDate) : null; // [M·ªöI]

    // C·∫≠p nh·∫≠t v√†o c∆° s·ªü d·ªØ li·ªáu
    const updatedEmployee = await prisma.employee.update({
      where: { id: employeeId },
      data: {
        code: code,
        fullName: fullName,
        birthday: formatBirthday,
        gender: gender,
        address: address,
        phone: phone,
        position: position,
        // FIX: Th√™m ki·ªÉm tra departmentId tr∆∞·ªõc khi parse ƒë·ªÉ tr√°nh NaN n·∫øu l·ª° null
        departmentId: departmentId ? parseInt(departmentId) : undefined,
        kipId: kipId ? Number(kipId) : null,
        startDate: formatStartDate,
        idCardNumber,
        idCardDate: formatIdCardDate,
        idCardPlace,
        bankAccount,
        taxCode
      },
    });

    return NextResponse.json(updatedEmployee);
  } catch (error) {
    console.log(error); // In l·ªói ra terminal server ƒë·ªÉ xem chi ti·∫øt
    return NextResponse.json({ error: "L·ªói khi c·∫≠p nh·∫≠t, " }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\employees\[id]\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\evaluations\bulk\route.ts
================================================================================
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

export async function POST(request: Request) {
  try {
    const body = await request.json();
    const { month, year, evaluations } = body; 
    // evaluations l√† m·∫£ng: [{ employeeId: 1, grade: "A" }, { employeeId: 2, grade: "B" }]

    if (!month || !year || !evaluations) {
      return NextResponse.json({ error: "Thi·∫øu d·ªØ li·ªáu" }, { status: 400 });
    }

    // D√πng transaction ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n
    const operations = evaluations.map((item: any) => {
        return prisma.monthlyEvaluation.upsert({
            where: {
                employeeId_month_year: {
                    employeeId: item.employeeId,
                    month: Number(month),
                    year: Number(year)
                }
            },
            update: { grade: item.grade, note: item.note },
            create: {
                employeeId: item.employeeId,
                month: Number(month),
                year: Number(year),
                grade: item.grade,
                note: item.note
            }
        });
    });

    await prisma.$transaction(operations);

    return NextResponse.json({ message: "ƒê√£ l∆∞u x·∫øp lo·∫°i th√†nh c√¥ng!" });
  } catch (error) {
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\evaluations\bulk\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\evaluations\monthly\route.ts
================================================================================
// src/app/api/evaluations/monthly/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

export async function GET(request: Request) {
  try {
    const { searchParams } = new URL(request.url);
    const month = parseInt(searchParams.get("month") || "");
    const year = parseInt(searchParams.get("year") || "");
    const factoryId = searchParams.get("factoryId");
    const departmentId = searchParams.get("departmentId"); // Chu·ªói "1,2,3"
    const kipIds = searchParams.get("kipIds"); // Chu·ªói "1,2"

    if (!month || !year) {
      return NextResponse.json({ error: "Thi·∫øu th√°ng/nƒÉm" }, { status: 400 });
    }

    // X√¢y d·ª±ng b·ªô l·ªçc (Gi·ªëng h·ªát trang ch·∫•m c√¥ng)
    const whereCondition: any = {
       // Ch·ªâ l·∫•y nh√¢n vi√™n ƒëang l√†m vi·ªác (n·∫øu c√≥ c·ªôt status)
    };

    if (factoryId) {
        whereCondition.department = { factoryId: Number(factoryId) };
    }

    if (departmentId) {
        const ids = departmentId.split(",").map(Number);
        whereCondition.departmentId = { in: ids };
    }

    if (kipIds) {
        const ids = kipIds.split(",").map(Number);
        whereCondition.kipId = { in: ids };
    }

    // L·∫•y danh s√°ch nh√¢n vi√™n + K·∫øt qu·∫£ x·∫øp lo·∫°i c·ªßa th√°ng ƒë√≥ (n·∫øu c√≥)
    const employees = await prisma.employee.findMany({
      where: whereCondition,
      orderBy: [
        { kip: { name: "asc" } },
        { department: { name: "asc" } },
        { code: "asc" }
      ],
      include: {
        department: true,
        kip: true,
        // K√®m theo k·∫øt qu·∫£ ƒë√°nh gi√° c·ªßa th√°ng/nƒÉm ƒëang ch·ªçn
        evaluations: {
          where: {
            month: month,
            year: year
          }
        }
      }
    });

    // L√†m ph·∫≥ng d·ªØ li·ªáu ƒë·ªÉ Frontend d·ªÖ d√πng
    const data = employees.map(emp => ({
        id: emp.id,
        code: emp.code,
        fullName: emp.fullName,
        departmentName: emp.department.name,
        kipName: emp.kip?.name || "",
        // N·∫øu c√≥ ƒë√°nh gi√° th√¨ l·∫•y c√°i ƒë·∫ßu ti√™n (v√¨ quan h·ªá 1-n nh∆∞ng ƒë√£ filter unique), ko th√¨ null
        grade: emp.evaluations.length > 0 ? emp.evaluations[0].grade : null,
        note: emp.evaluations.length > 0 ? emp.evaluations[0].note : "",
    }));

    return NextResponse.json(data);

  } catch (error) {
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\evaluations\monthly\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\evaluations\yearly\route.ts
================================================================================
// src/app/api/evaluations/yearly/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

export async function GET(request: Request) {
  try {
    const { searchParams } = new URL(request.url);
    const departmentIdStr = searchParams.get("departmentId");
    const kipIdsStr = searchParams.get("kipIds");
    const factoryIdStr = searchParams.get("factoryId");
    const yearStr = searchParams.get("year");

    if (!yearStr) {
      return NextResponse.json({ error: "Thi·∫øu th√¥ng tin nƒÉm" }, { status: 400 });
    }

    const year = parseInt(yearStr);
    const hasDeptFilter = !!departmentIdStr || !!kipIdsStr;
    
    // Logic ch·∫∑n n·∫øu kh√¥ng l·ªçc (ƒë·ªÉ tr√°nh t·∫£i qu√° n·∫∑ng)
    if (!hasDeptFilter) {
      return NextResponse.json({ error: "Vui l√≤ng ch·ªçn Ph√≤ng ban" }, { status: 400 });
    }

    const whereCondition: any = {};

    // 1. L·ªåC NH√Ä M√ÅY
    if (factoryIdStr && factoryIdStr !== "null") {
      whereCondition.department = {
        ...(whereCondition.department || {}),
        factoryId: Number(factoryIdStr),
      };
    }

    // 2. L·ªåC PH√íNG BAN
    if (departmentIdStr && departmentIdStr !== "null") {
      const deptIds = departmentIdStr.split(",").map(Number).filter((n) => !isNaN(n));
      if (deptIds.length > 0) {
        whereCondition.departmentId = { in: deptIds };
      }
    }

    // 3. L·ªåC K√çP
    if (kipIdsStr) {
      const kipIds = kipIdsStr.split(",").map(Number).filter((n) => !isNaN(n));
      if (kipIds.length > 0) {
        whereCondition.kipId = { in: kipIds };
      }
    }

    // === TRUY V·∫§N ===
    const employees = await prisma.employee.findMany({
      where: whereCondition,
      orderBy: [
        { department: { factoryId: "asc" } },
        { department: { name: "asc" } },
        { kip: { name: "asc" } },
        { code: "asc" },
      ],
      include: {
        department: true,
        kip: true,
        // L·∫•y t·∫•t c·∫£ ƒë√°nh gi√° trong nƒÉm ƒë√≥
        evaluations: {
          where: { year: year },
        },
      },
    });

    // === X·ª¨ L√ù D·ªÆ LI·ªÜU TR·∫¢ V·ªÄ ===
    const data = employees.map((emp) => {
      // T·∫°o m·∫£ng 12 th√°ng r·ªóng
      const monthlyGrades = Array(12).fill(null);
      
      let countA = 0;
      let countB = 0;
      let countC = 0;

      emp.evaluations.forEach((eva) => {
        // eva.month ch·∫°y t·ª´ 1-12, index ch·∫°y t·ª´ 0-11
        if (eva.month >= 1 && eva.month <= 12) {
            monthlyGrades[eva.month - 1] = eva.grade;
            
            // T√≠nh t·ªïng (Logic ƒë∆°n gi·∫£n, b·∫°n c√≥ th·ªÉ custom th√™m A+, B-...)
            const g = eva.grade.toUpperCase();
            if (g.startsWith("A")) countA++;
            else if (g.startsWith("B")) countB++;
            else if (g.startsWith("C")) countC++;
        }
      });

      return {
        id: emp.id,
        code: emp.code,
        fullName: emp.fullName,
        departmentName: emp.department.name,
        kipName: emp.kip ? emp.kip.name : "",
        monthlyGrades, // M·∫£ng ["A", null, "B", ...]
        summary: { A: countA, B: countB, C: countC }
      };
    });

    return NextResponse.json(data);
  } catch (error) {
    console.error("L·ªói server API Yearly Eval: ", error);
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\evaluations\yearly\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\factories\route.ts
================================================================================
// src/app/api/factories/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
// import { error } from "node:console";

// 1. H√†m GET: D√πng ƒë·ªÉ l·∫•y danh s√°ch nh√† m√°y
export async function GET() {
  try {
    // G·ªçi prisma ƒë·ªÉ l·∫•y to√†n b·ªô d·ªØ li·ªáu t·ª´ b·∫£ng Factory
    const factories = await prisma.factory.findMany({
      orderBy: {
        id: "asc", // S·∫Øp x·∫øp theo Id tƒÉng d·∫ßn
      },
    });

    // Tr·∫£ v·ªÅ k·∫øt qu·∫£ d·∫°ng JSON cho ph√≠a giao di·ªán
    return NextResponse.json(factories);
  } catch (error) {
    return NextResponse.json(
      { error: "Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu nh√† m√°y: " + error },
      { status: 500 }
    );
  }
}

// 2. H√†m POST: D√πng ƒë·ªÉ th√™m m·ªõi m·ªôt nh√† m√°y
export async function POST(request: Request) {
  try {
    // ƒê·ªçc d·ªØ li·ªáu g·ª≠i l√™n t·ª´ giao di·ªán
    // Chuy·ªÉn chu·ªói JSON t·ª´ tr√¨nh duy·ªát g·ª≠i l√™n th√†nh Object r·ªìi g√°n cho body
    const body = await request.json();
    const { code, name } = body;

    // Ki·ªÉm tra d·ªØ li·ªáu ƒë·∫ßu v√†o
    if (!code || !name) {
      return NextResponse.json(
        { error: "M√£ v√† t√™n nh√† m√°y l√† b·∫Øt bu·ªôc" },
        { status: 400 }
      );
    }

    // G·ªçi prisma ƒë·ªÉ t·∫°o b·∫£n ghi m·ªõi
    const newFactory = await prisma.factory.create({
      data: {
        code: code,
        name: name,
      },
    });
    return NextResponse.json(newFactory);
  } catch (error) {
    return NextResponse.json(
      { error: "L·ªói khi th√™m nh√† m√°y (c√≥ th·ªÉ do tr√πng m√£): " + error },
      { status: 500 }
    );
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\factories\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\factories\[id]\route.ts
================================================================================
// src/app/api/factories/[id]/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { auth } from "@/auth";

// --- QUAN TR·ªåNG: ƒê·ªãnh nghƒ©a ki·ªÉu Props cho Next.js 15 ---
type Props = {
  params: Promise<{ id: string }>;
};

// 1. L·∫§Y CHI TI·∫æT NH√Ä M√ÅY (GET)
export async function GET(request: Request, props: Props) {
  try {
    const params = await props.params; // <--- Await params
    const id = parseInt(params.id);

    if (isNaN(id))
      return NextResponse.json({ error: "ID kh√¥ng h·ª£p l·ªá" }, { status: 400 });

    const factory = await prisma.factory.findUnique({
      where: { id },
    });

    if (!factory)
      return NextResponse.json({ error: "Kh√¥ng t√¨m th·∫•y" }, { status: 404 });

    return NextResponse.json(factory);
  } catch (error) {
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}

// 2. C·∫¨P NH·∫¨T NH√Ä M√ÅY (PATCH) - ƒê√¢y l√† h√†m b·ªã b√°o l·ªói
export async function PATCH(request: Request, props: Props) {
  try {
    const session = await auth();
    if (session?.user?.role !== "ADMIN") {
      return NextResponse.json({ error: "Kh√¥ng c√≥ quy·ªÅn" }, { status: 403 });
    }

    const params = await props.params; // <--- S·ª¨A L·ªñI CH√çNH ·ªû ƒê√ÇY
    const id = parseInt(params.id);

    if (isNaN(id))
      return NextResponse.json({ error: "ID kh√¥ng h·ª£p l·ªá" }, { status: 400 });

    const body = await request.json();
    const { name, code } = body;

    const updatedFactory = await prisma.factory.update({
      where: { id },
      data: { name, code },
    });

    return NextResponse.json(updatedFactory);
  } catch (error) {
    console.error("L·ªói update factory:", error);
    return NextResponse.json({ error: "L·ªói c·∫≠p nh·∫≠t" }, { status: 500 });
  }
}

// 3. X√ìA NH√Ä M√ÅY (DELETE)
export async function DELETE(request: Request, props: Props) {
  try {
    const session = await auth();
    if (session?.user?.role !== "ADMIN") {
      return NextResponse.json({ error: "Kh√¥ng c√≥ quy·ªÅn" }, { status: 403 });
    }

    const params = await props.params; // <--- Await params
    const id = parseInt(params.id);

    if (isNaN(id))
      return NextResponse.json({ error: "ID kh√¥ng h·ª£p l·ªá" }, { status: 400 });

    // Ki·ªÉm tra r√†ng bu·ªôc tr∆∞·ªõc khi x√≥a (c√≥ ph√≤ng ban n√†o kh√¥ng)
    const departmentsCount = await prisma.department.count({
      where: { factoryId: id },
    });

    if (departmentsCount > 0) {
      return NextResponse.json(
        { error: "Kh√¥ng th·ªÉ x√≥a: Nh√† m√°y n√†y ƒëang c√≥ ph√≤ng ban tr·ª±c thu·ªôc." },
        { status: 400 }
      );
    }

    await prisma.factory.delete({
      where: { id },
    });

    return NextResponse.json({ message: "ƒê√£ x√≥a th√†nh c√¥ng" });
  } catch (error) {
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\factories\[id]\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\kips\route.ts
================================================================================
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

export async function GET() {
  try {
    const kips = await prisma.kip.findMany({
      orderBy: { name: "asc" },
      // --- B·∫ÆT BU·ªòC PH·∫¢I C√ì D√íNG N√ÄY ---
      include: {
        factory: true, // L·∫•y k√®m th√¥ng tin nh√† m√°y
      },
    });
    return NextResponse.json(kips);
  } catch (error) {
    return NextResponse.json(
      { error: "L·ªói t·∫£i danh s√°ch K√≠p" },
      { status: 500 }
    );
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\kips\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\overtime\route.ts
================================================================================
// src/app/api/overtime/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import dayjs from "dayjs";

// 1. GET: L·∫•y danh s√°ch (C√≥ l·ªçc theo Th√°ng + Ph√≤ng ban)
export async function GET(request: Request) {
  try {
    const { searchParams } = new URL(request.url);
    const departmentId = searchParams.get("departmentId");
    const monthStr = searchParams.get("month");
    const yearStr = searchParams.get("year");
    
    const whereCondition: any = {};
    
    // L·ªçc theo Ph√≤ng ban
    if (departmentId) {
      whereCondition.employee = { departmentId: Number(departmentId) };
    }

    // L·ªçc theo Th√°ng (N·∫øu c√≥ ch·ªçn)
    if (monthStr && yearStr) {
      const startOfMonth = dayjs(`${yearStr}-${monthStr}-01`).startOf('month').toDate();
      const endOfMonth = dayjs(`${yearStr}-${monthStr}-01`).endOf('month').toDate();
      whereCondition.startTime = {
        gte: startOfMonth,
        lte: endOfMonth,
      };
    }

    const records = await prisma.overtimeRecord.findMany({
      where: whereCondition,
      orderBy: { startTime: "desc" }, // M·ªõi nh·∫•t l√™n ƒë·∫ßu
      include: {
        employee: {
          include: { department: { include: { factory: true } } } // Include s√¢u ƒë·ªÉ l·∫•y t√™n nh√† m√°y
        }
      }
    });

    return NextResponse.json(records);
  } catch (error) {
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}

// 2. POST: Th√™m m·ªõi
export async function POST(request: Request) {
  try {
    const body = await request.json();
    // [M·ªöI] Nh·∫≠n th√™m createdBy t·ª´ frontend g·ª≠i l√™n
    const { employeeId, content, startTime, endTime, createdBy } = body;

    const start = dayjs(startTime);
    const end = dayjs(endTime);
    const diffMinutes = end.diff(start, "minute");

    if (diffMinutes <= 0) return NextResponse.json({ error: "Gi·ªù ra ph·∫£i l·ªõn h∆°n gi·ªù v√†o" }, { status: 400 });

    const newRecord = await prisma.overtimeRecord.create({
      data: {
        employeeId: Number(employeeId),
        content,
        startTime: start.toDate(),
        endTime: end.toDate(),
        totalMinutes: diffMinutes,
        createdBy: createdBy,  // L∆∞u ng∆∞·ªùi t·∫°o
      },
      include: { employee: { include: { department: { include: { factory: true } } } } }
    });

    return NextResponse.json(newRecord);
  } catch (error) {
    return NextResponse.json({ error: "L·ªói l∆∞u d·ªØ li·ªáu" }, { status: 500 });
  }
}

// 3. PUT: C·∫≠p nh·∫≠t (S·ª≠a)
export async function PUT(request: Request) {
  try {
    const body = await request.json();
    const { id, content, startTime, endTime } = body;

    const start = dayjs(startTime);
    const end = dayjs(endTime);
    const diffMinutes = end.diff(start, "minute");

    if (diffMinutes <= 0) return NextResponse.json({ error: "Gi·ªù ra ph·∫£i l·ªõn h∆°n gi·ªù v√†o" }, { status: 400 });

    const updatedRecord = await prisma.overtimeRecord.update({
      where: { id: Number(id) },
      data: {
        content,
        startTime: start.toDate(),
        endTime: end.toDate(),
        totalMinutes: diffMinutes,
      },
      include: { employee: { include: { department: { include: { factory: true } } } } }
    });

    return NextResponse.json(updatedRecord);
  } catch (error) {
    return NextResponse.json({ error: "L·ªói c·∫≠p nh·∫≠t" }, { status: 500 });
  }
}

// 4. DELETE: X√≥a
export async function DELETE(request: Request) {
  try {
    const { searchParams } = new URL(request.url);
    const id = searchParams.get("id");

    if (!id) return NextResponse.json({ error: "Thi·∫øu ID" }, { status: 400 });

    await prisma.overtimeRecord.delete({
      where: { id: Number(id) },
    });

    return NextResponse.json({ success: true });
  } catch (error) {
    return NextResponse.json({ error: "L·ªói x√≥a d·ªØ li·ªáu" }, { status: 500 });
  }
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\overtime\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\reports\yearly\route.ts
================================================================================
// src/app/api/reports/yearly/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

export async function GET(request: Request) {
  const { searchParams } = new URL(request.url);
  const year = parseInt(
    searchParams.get("year") || new Date().getFullYear().toString(),
  );
  const factoryId = searchParams.get("factoryId");
  const departmentIds = searchParams
    .get("departmentId")
    ?.split(",")
    .map(Number);
  const kipIds = searchParams.get("kipIds")?.split(",").map(Number);
  const type = searchParams.get("type") || "evaluation"; // evaluation | workday | leave

  try {
    // 1. L·ªçc nh√¢n vi√™n (Logic gi·ªØ nguy√™n)
    const whereEmployee: any = {};
    if (departmentIds) whereEmployee.departmentId = { in: departmentIds };
    if (kipIds) whereEmployee.kipId = { in: kipIds };
    if (factoryId && !departmentIds) {
      whereEmployee.department = { factoryId: parseInt(factoryId) };
    }

    const employees = await prisma.employee.findMany({
      where: whereEmployee,
      select: {
        id: true,
        code: true,
        fullName: true,
        department: { select: { name: true } },
        kip: { select: { name: true } },
      },
      orderBy: { code: "asc" },
    });

    const employeeIds = employees.map((e) => e.id);
    const startDate = new Date(year, 0, 1);
    const endDate = new Date(year, 11, 31);

    // --- LOGIC 1: X·∫æP LO·∫†I (D√πng model MonthlyEvaluation) ---
    if (type === "evaluation") {
      // [ƒê√É S·ª¨A] D√πng monthlyEvaluation thay v√¨ evaluation
      const evaluations = await prisma.monthlyEvaluation.findMany({
        where: {
          employeeId: { in: employeeIds },
          year: year,
        },
      });

      const result = employees.map((emp) => {
        const empEvals = evaluations.filter((ev) => ev.employeeId === emp.id);
        const monthlyGrades = Array(12).fill(null);
        let countA = 0,
          countB = 0,
          countC = 0;

        empEvals.forEach((ev) => {
          const monthIdx = ev.month - 1;
          if (monthIdx >= 0 && monthIdx < 12) {
            monthlyGrades[monthIdx] = ev.grade;
            // Logic ƒë·∫øm t·ªïng h·ª£p
            if (ev.grade?.startsWith("A")) countA++;
            else if (ev.grade?.startsWith("B")) countB++;
            else if (ev.grade?.startsWith("C")) countC++;
          }
        });

        return {
          ...emp,
          departmentName: emp.department?.name,
          kipName: emp.kip?.name,
          data: monthlyGrades,
          summary: { col1: countA, col2: countB, col3: countC },
        };
      });
      return NextResponse.json(result);
    }

    // --- LOGIC 2 & 3: ƒê·∫æM C√îNG / PH√âP (D√πng model Timesheet) ---
    // Gi·∫£ s·ª≠ model Timesheet c√≥ quan h·ªá: date, attendanceCode (code)
    let targetCodes: string[] = [];
    if (type === "workday") targetCodes = ["+", "XD"];
    if (type === "leave") targetCodes = ["F"];

    const timesheets = await prisma.timesheet.findMany({
      where: {
        employeeId: { in: employeeIds },
        date: { gte: startDate, lte: endDate },
        attendanceCode: { code: { in: targetCodes } },
      },
      select: {
        employeeId: true,
        date: true,
        attendanceCode: { select: { code: true } },
      },
    });

    const result = employees.map((emp) => {
      const empLogs = timesheets.filter((t) => t.employeeId === emp.id);
      const monthlyCounts = Array(12).fill(0);
      let totalCount = 0;

      empLogs.forEach((log) => {
        const monthIdx = new Date(log.date).getMonth();
        monthlyCounts[monthIdx] += 1;
        totalCount += 1;
      });

      let summaryData;
      if (type === "workday") {
        summaryData = { col1: totalCount };
      } else {
        // T·ªïng ph√©p chu·∫©n l√† 14
        summaryData = { col1: totalCount, col2: 14 - totalCount };
      }

      return {
        ...emp,
        departmentName: emp.department?.name,
        kipName: emp.kip?.name,
        data: monthlyCounts,
        summary: summaryData,
      };
    });

    return NextResponse.json(result);
  } catch (error: any) {
    console.error(error);
    return NextResponse.json(
      { error: "L·ªói server: " + error.message },
      { status: 500 },
    );
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\reports\yearly\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\stats\daily\route.ts
================================================================================
// src/app/api/stats/daily/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import dayjs from "dayjs";

export async function GET(request: Request) {
  try {
    const { searchParams } = new URL(request.url);
    const dateStr = searchParams.get("date"); // YYYY-MM-DD

    if (!dateStr) {
      return NextResponse.json({ error: "Thi·∫øu ng√†y" }, { status: 400 });
    }

    const targetDate = new Date(`${dateStr}T00:00:00.000Z`);

    // L·∫•y to√†n b·ªô nh√¢n vi√™n k√®m theo:
    // 1. Ph√≤ng ban -> Nh√† m√°y (ƒê·ªÉ ph√¢n lo·∫°i)
    // 2. Ch·∫•m c√¥ng c·ªßa ng√†y ƒë√≥ (ƒê·ªÉ ƒë·∫øm)
    const employees = await prisma.employee.findMany({
      include: {
        department: {
          include: {
            factory: true,
          },
        },
        timesheets: {
          where: { date: targetDate },
          include: { attendanceCode: true },
        },
      },
    });

    // Tr·∫£ v·ªÅ d·ªØ li·ªáu th√¥ ƒë·ªÉ Frontend t·ª± "x√†o n·∫•u"
    return NextResponse.json(employees);
  } catch (error) {
    console.log("L·ªói tr·∫£ v·ªÅ: ", error);
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\stats\daily\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\system\backup\route.ts
================================================================================
// src/app/api/system/backup/route.ts
import { NextResponse } from "next/server";
import { auth } from "@/auth";
import { exec } from "child_process";
import { promisify } from "util";

const execPromise = promisify(exec);

export async function GET() {
  try {
    // 1. KI·ªÇM TRA QUY·ªÄN
    const session = await auth();
    if (!session || session.user?.role !== "ADMIN") {
      return NextResponse.json(
        { error: "B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y" },
        { status: 403 }
      );
    }

    // 2. L·∫§Y & X·ª¨ L√ù DATABASE URL (QUAN TR·ªåNG)
    let dbUrl = process.env.DATABASE_URL;
    if (!dbUrl) {
      return NextResponse.json(
        { error: "Ch∆∞a c·∫•u h√¨nh DATABASE_URL" },
        { status: 500 }
      );
    }

    // --- S·ª¨A L·ªñI: C·∫ÆT B·ªé THAM S·ªê ?schema=public ---
    // pg_dump kh√¥ng ch·ªãu tham s·ªë n√†y, n√™n ta ph·∫£i b·ªè ƒëi
    if (dbUrl.includes("?")) {
      dbUrl = dbUrl.split("?")[0];
    }
    // ----------------------------------------------

    // 3. C·∫§U H√åNH ƒê∆Ø·ªúNG D·∫™N (C·∫¨P NH·∫¨T THEO LOG C·ª¶A B·∫†N: B·∫¢N 17)
    // Log c·ªßa b·∫°n cho th·∫•y b·∫°n ƒëang c√†i b·∫£n 17, h√£y s·ª≠a s·ªë 16 th√†nh 17
    const pgDumpPath = '"C:\\Program Files\\PostgreSQL\\17\\bin\\pg_dump.exe"';

    console.log("ƒêang b·∫Øt ƒë·∫ßu backup v·ªõi URL ƒë√£ l√†m s·∫°ch...");

    // 4. T·∫†O L·ªÜNH
    const command = `${pgDumpPath} "${dbUrl}" --no-owner --no-acl`;

    // 5. TH·ª∞C THI
    const { stdout, stderr } = await execPromise(command, {
      maxBuffer: 1024 * 1024 * 100, // 100MB buffer
      env: process.env,
    });

    if (stderr) {
      console.warn("Backup warning:", stderr);
    }

    // 6. TR·∫¢ V·ªÄ FILE
    const dateStr = new Date().toISOString().split("T")[0];
    const filename = `backup_phubai_${dateStr}.sql`;

    return new NextResponse(stdout, {
      headers: {
        "Content-Disposition": `attachment; filename="${filename}"`,
        "Content-Type": "application/sql",
      },
    });
  } catch (error: any) {
    console.error("L·ªñI BACKUP CHI TI·∫æT:", error);
    return NextResponse.json(
      { error: "L·ªói Server: " + (error.message || error.toString()) },
      { status: 500 }
    );
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\system\backup\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\timesheets\daily\route.ts
================================================================================
// src/app/api/timesheets/daily/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { auth } from "@/auth";

// 1. L·∫§Y D·ªÆ LI·ªÜU CH·∫§M C√îNG
export async function GET(request: Request) {
  try {
    const { searchParams } = new URL(request.url);
    const departmentIdStr = searchParams.get("departmentId");
    const dateStr = searchParams.get("date");
    const kipIdsStr = searchParams.get("kipIds");

    if (!dateStr) {
      return NextResponse.json(
        { error: "Thi·∫øu ng√†y ch·∫•m c√¥ng" },
        { status: 400 },
      );
    }

    const targetDate = new Date(`${dateStr}T00:00:00.000Z`);
    const whereCondition: any = {};

    // Logic l·ªçc: H·ªó tr·ª£ nhi·ªÅu Department ID (NM2, NM1)
    if (
      departmentIdStr &&
      departmentIdStr !== "null" &&
      departmentIdStr !== ""
    ) {
      const deptIds = departmentIdStr
        .split(",")
        .map(Number)
        .filter((n) => !isNaN(n));

      if (deptIds.length > 0) {
        whereCondition.departmentId = { in: deptIds };
      }
    }

    // Logic l·ªçc: H·ªó tr·ª£ K√≠p (NM3 ho·∫∑c l·ªçc th√™m)
    if (kipIdsStr && kipIdsStr !== "") {
      const kipIds = kipIdsStr
        .split(",")
        .map(Number)
        .filter((n) => !isNaN(n));
      if (kipIds.length > 0) {
        whereCondition.kipId = { in: kipIds };
      }
    }

    if (Object.keys(whereCondition).length === 0) {
      return NextResponse.json([]);
    }

    const employees = await prisma.employee.findMany({
      where: whereCondition,
      orderBy: [
        { kip: { name: "asc" } },
        { department: { name: "asc" } },
        { fullName: "asc" },
      ],
      include: {
        timesheets: {
          where: { date: targetDate },
          include: { attendanceCode: true },
        },
        kip: true,
        department: true,
      },
    });

    const data = employees.map((emp) => {
      const timesheet = emp.timesheets[0];
      return {
        employeeId: emp.id,
        employeeCode: emp.code,
        fullName: emp.fullName,
        departmentName: emp.department?.name,
        departmentCode: emp.department?.code,
        kipName: emp.kip?.name,
        attendanceCodeId: timesheet ? timesheet.attendanceCodeId : null,
        note: timesheet ? timesheet.note : "",
        updatedAt: timesheet ? timesheet.updatedAt : null,
      };
    });

    return NextResponse.json(data);
  } catch (error) {
    console.log("L·ªói l·∫•y d·ªØ li·ªáu: ", error);
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}

// 2. L∆ØU D·ªÆ LI·ªÜU (ƒê√É B·ªî SUNG LOGIC KH√ìA S·ªî M·ªöI)
export async function POST(request: Request) {
  try {
    const session = await auth();
    if (!session || !session.user) {
      return NextResponse.json({ error: "Ch∆∞a ƒëƒÉng nh·∫≠p" }, { status: 401 });
    }

    const body = await request.json();
    const { date, records } = body;

    if (!date || !records || records.length === 0) {
      return NextResponse.json(
        { error: "D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá ho·∫∑c danh s√°ch r·ªóng" },
        { status: 400 },
      );
    }

    const targetDate = new Date(`${date}T00:00:00.000Z`);

    // --- [B·∫ÆT ƒê·∫¶U] LOGIC KI·ªÇM TRA KH√ìA S·ªî (LOCK RULE) ---

    // 1. X√°c ƒë·ªãnh Nh√† m√°y c·ªßa nh√¢n vi√™n ƒëang ƒë∆∞·ª£c ch·∫•m
    // L·∫•y th√¥ng tin c·ªßa nh√¢n vi√™n ƒë·∫ßu ti√™n trong danh s√°ch ƒë·ªÉ t√¨m Nh√† m√°y
    const firstEmpId = records[0].employeeId;
    const employeeInfo = await prisma.employee.findUnique({
      where: { id: firstEmpId },
      include: { department: { include: { factory: true } } },
    });

    const factoryId = employeeInfo?.department?.factory?.id;

    // 2. T√¨m lu·∫≠t kh√≥a ƒëang hi·ªáu l·ª±c
    const activeLock = await prisma.lockRule.findFirst({
      where: {
        fromDate: { lte: targetDate }, // Ng√†y ch·∫•m >= Ng√†y b·∫Øt ƒë·∫ßu kh√≥a
        toDate: { gte: targetDate }, // Ng√†y ch·∫•m <= Ng√†y k·∫øt th√∫c kh√≥a
        OR: [
          { factoryId: null }, // Kh√≥a to√†n b·ªô h·ªá th·ªëng
          { factoryId: factoryId ? factoryId : undefined }, // Kh√≥a ri√™ng nh√† m√°y n√†y
        ],
      },
    });

    // 3. N·∫øu t√¨m th·∫•y lu·∫≠t kh√≥a -> CH·∫∂N
    if (activeLock) {
      // Cho ph√©p Admin s·ª≠a b·∫•t ch·∫•p kh√≥a (n·∫øu mu·ªën ch·∫∑n c·∫£ Admin th√¨ x√≥a d√≤ng if n√†y)
      if (session.user.role !== "ADMIN") {
        return NextResponse.json(
          {
            error: `ƒê√É KH√ìA S·ªî! D·ªØ li·ªáu b·ªã kh√≥a t·ª´ ${activeLock.fromDate.toLocaleDateString(
              "vi-VN",
            )} ƒë·∫øn ${activeLock.toDate.toLocaleDateString("vi-VN")} (${
              activeLock.reason || "Kh√¥ng c√≥ l√Ω do"
            }).`,
          },
          { status: 403 },
        );
      }
    }
    // --- [K·∫æT TH√öC] LOGIC KI·ªÇM TRA KH√ìA S·ªî ---

    // Th·ª±c hi·ªán l∆∞u: Nh·∫≠n to√†n b·ªô danh s√°ch, n·∫øu c√≥ m√£ th√¨ Upsert, n·∫øu ƒë·ªÉ tr·ªëng th√¨ Delete
    const operations = records.map((rec: any) => {
      // N·∫øu ng∆∞·ªùi d√πng x√≥a tr·∫Øng (null ho·∫∑c undefined)
      if (!rec.attendanceCodeId) {
        return prisma.timesheet.deleteMany({
          where: {
            employeeId: rec.employeeId,
            date: targetDate,
          },
        });
      } else {
        // N·∫øu c√≥ m√£ ch·∫•m c√¥ng th√¨ Th√™m m·ªõi ho·∫∑c C·∫≠p nh·∫≠t (Upsert)
        return prisma.timesheet.upsert({
          where: {
            employeeId_date: {
              employeeId: rec.employeeId,
              date: targetDate,
            },
          },
          update: {
            attendanceCodeId: rec.attendanceCodeId,
            note: rec.note,
          },
          create: {
            date: targetDate,
            employeeId: rec.employeeId,
            attendanceCodeId: rec.attendanceCodeId,
            note: rec.note,
          },
        });
      }
    });

    // Ch·∫°y t·∫•t c·∫£ c√°c thao t√°c (Th√™m/S·ª≠a/X√≥a) trong 1 Transaction ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n
    await prisma.$transaction(operations);

    return NextResponse.json({ message: "ƒê√£ l∆∞u th√†nh c√¥ng!" });
  } catch (error) {
    console.error("L·ªói l∆∞u ch·∫•m c√¥ng: ", error);
    return NextResponse.json({ error: "L·ªói khi l∆∞u d·ªØ li·ªáu" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\timesheets\daily\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\timesheets\monthly\route.tsx
================================================================================
// src/app/api/timesheets/monthly/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import dayjs from "dayjs";

export async function GET(request: Request) {
    try {
        const { searchParams } = new URL(request.url);
        const departmentIdStr = searchParams.get("departmentId");
        const kipIdsStr = searchParams.get("kipIds");
        const factoryIdStr = searchParams.get("factoryId");
        const nameStr = searchParams.get("name");
        const month = searchParams.get("month");
        const year = searchParams.get("year");

        // [M·ªöI] L·∫•y th√™m tham s·ªë view
        const viewMode = searchParams.get("view");

        // Validate th·ªùi gian
        if (!month || !year) {
            return NextResponse.json(
                { error: "Thi·∫øu th√¥ng tin th·ªùi gian (th√°ng/nƒÉm)" },
                { status: 400 }
            );
        }

        // ƒêi·ªÅu ki·ªán validation b·ªô l·ªçc
        const hasDeptFilter = !!departmentIdStr || !!kipIdsStr;
        const hasNameFilter = !!nameStr && nameStr.trim() !== "";
        // [M·ªöI] Ki·ªÉm tra th√™m ƒëi·ªÅu ki·ªán viewMode
        const isViewAll = viewMode === "all";

        // Logic ch·∫∑n t·∫£i n·∫∑ng: N·∫øu KH√îNG l·ªçc V√Ä KH√îNG ph·∫£i xem t·∫•t c·∫£ -> Ch·∫∑n
        if (!hasDeptFilter && !hasNameFilter && !isViewAll) {
            return NextResponse.json(
                { error: "Vui l√≤ng ch·ªçn Ph√≤ng ban ho·∫∑c nh·∫•n n√∫t 'Xem t·∫•t c·∫£'" },
                { status: 400 }
            );
        }
        const whereCondition: any = {};

        // 1. L·ªåC THEO T√äN
        if (nameStr && nameStr.trim() !== "") {
            const keyword = nameStr.trim();
            whereCondition.OR = [
                { fullName: { contains: keyword, mode: "insensitive" } },
                { code: { contains: keyword, mode: "insensitive" } },
            ];
        }

        // 2. L·ªåC THEO NH√Ä M√ÅY
        if (factoryIdStr && factoryIdStr !== "null") {
            whereCondition.department = {
                ...(whereCondition.department || {}),
                factoryId: Number(factoryIdStr),
            };
        }

        // 3. L·ªåC THEO PH√íNG BAN
        if (departmentIdStr && departmentIdStr !== "null") {
            const deptIds = departmentIdStr
                .split(",")
                .map(Number)
                .filter((n) => !isNaN(n));
            if (deptIds.length > 0) {
                whereCondition.departmentId = { in: deptIds };
            }
        }

        // 4. L·ªåC THEO K√çP
        if (kipIdsStr) {
            const kipIds = kipIdsStr
                .split(",")
                .map(Number)
                .filter((n) => !isNaN(n));
            if (kipIds.length > 0) {
                whereCondition.kipId = { in: kipIds };
            }
        }

        if (!isViewAll) {
            if (departmentIdStr && departmentIdStr !== "null") {
                const deptIds = departmentIdStr.split(",").map(Number).filter((n) => !isNaN(n));
                if (deptIds.length > 0) whereCondition.departmentId = { in: deptIds };
            }
            if (kipIdsStr) {
                const kipIds = kipIdsStr.split(",").map(Number).filter((n) => !isNaN(n));
                if (kipIds.length > 0) whereCondition.kipId = { in: kipIds };
            }
        }

        // Th·ªùi gian cho query Timesheet
        const startDate = dayjs(`${year}-${month}-01`).startOf("month").toDate();
        const endDate = dayjs(`${year}-${month}-01`).endOf("month").toDate();

        // === TRUY V·∫§N DATABASE ===
        const employees = await prisma.employee.findMany({
            where: whereCondition,
            orderBy: [
                { department: { factoryId: "asc" } },
                { department: { name: "asc" } },
                { kip: { name: "asc" } },
                { code: "asc" },
            ],
            include: {
                // L·∫•y d·ªØ li·ªáu ch·∫•m c√¥ng trong th√°ng
                timesheets: {
                    where: { date: { gte: startDate, lte: endDate } },
                    include: { attendanceCode: true },
                },
                // L·∫•y th√¥ng tin ph√≤ng ban & nh√† m√°y
                department: { include: { factory: true } },
                // L·∫•y th√¥ng tin K√≠p
                kip: true,

                // [QUAN TR·ªåNG] L·∫•y d·ªØ li·ªáu X·∫øp lo·∫°i (MonthlyEvaluation)
                evaluations: {
                    where: {
                        month: Number(month),
                        year: Number(year),
                    },
                    take: 1, // L·∫•y 1 b·∫£n ghi duy nh·∫•t kh·ªõp th√°ng/nƒÉm
                },
            },
        });

        // === MAP D·ªÆ LI·ªÜU TR·∫¢ V·ªÄ ===
        const data = employees.map((emp) => {
            // L·∫•y b·∫£n ghi x·∫øp lo·∫°i (n·∫øu c√≥)
            const evaluationRecord = emp.evaluations[0];

            return {
                id: emp.id,
                code: emp.code,
                fullName: emp.fullName,
                department: emp.department,
                kip: emp.kip,

                // Tr·∫£ v·ªÅ gi√° tr·ªã grade (A, B, C) cho Frontend
                // N·∫øu ch∆∞a c√≥ x·∫øp lo·∫°i th√¨ tr·∫£ v·ªÅ null ho·∫∑c chu·ªói r·ªóng
                classification: evaluationRecord ? evaluationRecord.grade : null,

                timesheets: emp.timesheets.map((t) => ({
                    date: dayjs(t.date).format("YYYY-MM-DD"),
                    attendanceCode: t.attendanceCode,
                })),
            };
        });

        return NextResponse.json(data);
    } catch (error) {
        console.error("L·ªói server API Monthly Timesheet: ", error);
        return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
    }
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\timesheets\monthly\route.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\users\change-password\route.ts
================================================================================
// src/app/api/users/change-password/route.ts (L∆∞u √Ω ƒë∆∞·ªùng d·∫´n folder users hay user t√πy d·ª± √°n c·ªßa b·∫°n)

import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { auth } from "@/auth"; // <--- D√πng h√†m auth() c·ªßa v5
import bcrypt from "bcryptjs";

export async function POST(request: Request) {
  try {
    // Truy·ªÅn authOptions v√†o getServerSession
    const session = await auth(); // <--- G·ªçi h√†m auth()

    if (!session || !session.user?.username) {
      return NextResponse.json({ error: "Ch∆∞a ƒëƒÉng nh·∫≠p" }, { status: 401 });
    }

    const body = await request.json();
    const { oldPassword, newPassword } = body;
    // L·∫•y username t·ª´ session (√©p ki·ªÉu v√¨ TypeScript m·∫∑c ƒë·ªãnh ch∆∞a bi·∫øt field n√†y)
    const username = (session.user as any).username;

    if (!oldPassword || !newPassword) {
      return NextResponse.json({ error: "Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin" }, { status: 400 });
    }

    if (newPassword.length < 6) {
        return NextResponse.json({ error: "M·∫≠t kh·∫©u m·ªõi qu√° ng·∫Øn" }, { status: 400 });
    }

    // 1. T√¨m user trong DB
    const user = await prisma.user.findUnique({
      where: { username: session.user.username },
    });

    if (!user) {
      return NextResponse.json({ error: "Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n" }, { status: 404 });
    }

    // 2. Ki·ªÉm tra m·∫≠t kh·∫©u c≈©
    const isMatch = await bcrypt.compare(oldPassword, user.password);
    if (!isMatch) {
      return NextResponse.json({ error: "M·∫≠t kh·∫©u c≈© kh√¥ng ƒë√∫ng" }, { status: 400 });
    }

    // 3. M√£ h√≥a m·∫≠t kh·∫©u m·ªõi
    const hashedPassword = await bcrypt.hash(newPassword, 10);

    // 4. C·∫≠p nh·∫≠t v√†o DB
    await prisma.user.update({
      where: { username: session.user.username },
      data: { password: hashedPassword },
    });

    return NextResponse.json({ message: "ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng" });
  } catch (error) {
    console.error(error);
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\users\change-password\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\users\route.ts
================================================================================
// src/app/api/users/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import bcrypt from "bcryptjs";
import { auth } from "@/auth"; // ƒê·ªÉ ki·ªÉm tra quy·ªÅn Admin

export async function GET(request: Request) {
  try {
    // 1. Ki·ªÉm tra quy·ªÅn (Ch·ªâ Admin m·ªõi ƒë∆∞·ª£c xem danh s√°ch)
    const session = await auth();
    if (session?.user?.role !== "ADMIN") {
      return NextResponse.json(
        { error: "Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p" },
        { status: 403 }
      );
    }

    const users = await prisma.user.findMany({
      orderBy: { createdAt: "desc" },
      include: {
        managedDepartments: true, // L·∫•y danh s√°ch ph√≤ng ban h·ªç qu·∫£n l√Ω
        userDepartment: true, // [M·ªöI] Ph√≤ng ban tr·ª±c thu·ªôc
      },
    });

    // Lo·∫°i b·ªè password tr∆∞·ªõc khi tr·∫£ v·ªÅ client ƒë·ªÉ b·∫£o m·∫≠t
    const safeUsers = users.map((u) => {
      const { password, ...rest } = u;
      return rest;
    });

    return NextResponse.json(safeUsers);
  } catch (error) {
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}

export async function POST(request: Request) {
  try {
    // 1. Ki·ªÉm tra quy·ªÅn Admin
    const session = await auth();
    if (session?.user?.role !== "ADMIN") {
      return NextResponse.json(
        { error: "Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p" },
        { status: 403 }
      );
    }

    const body = await request.json();

    const {
      username,
      password,
      fullName,
      role,
      departmentIds,
      employeeCode,
      userDepartmentId,
    } = body;

    // 2. Validate c∆° b·∫£n
    if (!username || !password || !role) {
      return NextResponse.json(
        { error: "Thi·∫øu th√¥ng tin b·∫Øt bu·ªôc" },
        { status: 400 }
      );
    }

    // 3. Ki·ªÉm tra tr√πng username
    const existingUser = await prisma.user.findUnique({ where: { username } });
    if (existingUser) {
      return NextResponse.json(
        { error: "T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i" },
        { status: 400 }
      );
    }

    // 4. M√£ h√≥a m·∫≠t kh·∫©u
    const hashedPassword = await bcrypt.hash(password, 10);

    const newUser = await prisma.user.create({
      data: {
        username,
        password: hashedPassword,
        fullName,
        role,
        // [M·ªöI] L∆∞u th√¥ng tin b·ªï sung
        employeeCode: employeeCode || null,
        userDepartmentId: userDepartmentId ? Number(userDepartmentId) : null,

        // Logic connect managedDepartments (Gi·ªØ nguy√™n)
        managedDepartments:
          departmentIds && departmentIds.length > 0
            ? { connect: departmentIds.map((id: number) => ({ id })) }
            : undefined,
      },
    });

    return NextResponse.json({
      message: "T·∫°o t√†i kho·∫£n th√†nh c√¥ng",
      user: newUser,
    });
  } catch (error) {
    console.error("L·ªói t·∫°o user:", error);
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\users\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\users\[id]\route.ts
================================================================================
// src/app/api/users/[id]/route.ts

import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { auth } from "@/auth";
import bcrypt from "bcryptjs";

interface Props {
  params: Promise<{ id: string }>;
}

export async function PUT(request: Request, props: Props) {
  try {
    // --- QUAN TR·ªåNG: Ph·∫£i await params ·ªü ƒë√¢y n·ªØa (Next.js 15) ---
    const params = await props.params;
    const id = parseInt(params.id);

    if (isNaN(id))
      return NextResponse.json({ error: "ID kh√¥ng h·ª£p l·ªá" }, { status: 400 });

    const session = await auth();
    if (session?.user?.role !== "ADMIN") {
      return NextResponse.json({ error: "Kh√¥ng c√≥ quy·ªÅn" }, { status: 403 });
    }

    const body = await request.json();
    // [M·ªöI] L·∫•y th√™m employeeCode v√† userDepartmentId t·ª´ body g·ª≠i l√™n
    const {
      password,
      fullName,
      role,
      departmentIds,
      employeeCode,
      userDepartmentId,
    } = body;

    // Kh·ªüi t·∫°o object d·ªØ li·ªáu c·∫ßn update
    const updateData: any = {
      fullName,
      role,
      // [M·ªöI] C·∫≠p nh·∫≠t M√£ NV (n·∫øu r·ªóng th√¨ set null)
      employeeCode: employeeCode || null,
      // [M·ªöI] C·∫≠p nh·∫≠t Ph√≤ng tr·ª±c thu·ªôc (n·∫øu c√≥ gi√° tr·ªã th√¨ √©p ki·ªÉu s·ªë, kh√¥ng th√¨ null)
      userDepartmentId: userDepartmentId ? Number(userDepartmentId) : null,
    };

    // 1. Logic c·∫≠p nh·∫≠t m·∫≠t kh·∫©u (Admin Reset)
    // Ch·ªâ hash v√† update n·∫øu Admin c√≥ nh·∫≠p g√¨ ƒë√≥ v√†o √¥ m·∫≠t kh·∫©u
    if (password && password.trim() !== "") {
      updateData.password = await bcrypt.hash(password, 10);
    }

    // 2. Logic c·∫≠p nh·∫≠t ph√≤ng ban PH·ª§ TR√ÅCH (managedDepartments)
    if (Array.isArray(departmentIds)) {
      // Tr∆∞·ªùng h·ª£p c√≥ g·ª≠i danh s√°ch ph√≤ng ban l√™n (d√π l√† r·ªóng [])
      updateData.managedDepartments = {
        // √âp ki·ªÉu v·ªÅ Number ƒë·ªÉ tr√°nh l·ªói Prisma
        set: departmentIds.map((deptId: any) => ({ id: Number(deptId) })),
      };
    } else {
      // Tr∆∞·ªùng h·ª£p kh√¥ng g·ª≠i departmentIds l√™n (v√≠ d·ª• ch·ªâ s·ª≠a t√™n/m√£ NV)
      // Ta ki·ªÉm tra: N·∫øu Role m·ªõi kh√¥ng c·∫ßn ph√≤ng ban -> X√≥a s·∫°ch li√™n k·∫øt c≈© cho s·∫°ch DB
      // C√°c role c·∫ßn ph√≤ng ban l√†: TIMEKEEPER v√† STAFF
      if (role !== "TIMEKEEPER" && role !== "STAFF") {
        updateData.managedDepartments = { set: [] };
      }
    }

    const updatedUser = await prisma.user.update({
      where: { id },
      data: updateData,
    });

    return NextResponse.json({
      message: "C·∫≠p nh·∫≠t th√†nh c√¥ng",
      user: updatedUser,
    });
  } catch (error: any) {
    console.error("L·ªñI S·ª¨A:", error);
    return NextResponse.json(
      { error: "L·ªói c·∫≠p nh·∫≠t: " + error.message },
      { status: 500 }
    );
  }
}

// B·ªï sung th√™m h√†m DELETE (n·∫øu file c≈© c·ªßa b·∫°n ch∆∞a c√≥ ho·∫∑c b·∫°n mu·ªën x√≥a User chu·∫©n)
export async function DELETE(request: Request, props: Props) {
  try {
    const params = await props.params;
    const id = parseInt(params.id);

    const session = await auth();
    if (session?.user?.role !== "ADMIN") {
      return NextResponse.json({ error: "Kh√¥ng c√≥ quy·ªÅn" }, { status: 403 });
    }

    // Ki·ªÉm tra xem c√≥ x√≥a ch√≠nh m√¨nh kh√¥ng
    // (T√πy ch·ªçn: d√πng session.user.id ƒë·ªÉ so s√°nh n·∫øu mu·ªën ch·∫∑n)

    await prisma.user.delete({
      where: { id },
    });

    return NextResponse.json({ message: "ƒê√£ x√≥a user th√†nh c√¥ng" });
  } catch (error: any) {
    return NextResponse.json({ error: "L·ªói x√≥a user" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\api\users\[id]\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\attendance-codes\page.tsx
================================================================================
"use client";

import React, { useEffect, useState } from "react";
import AdminLayout from "@/components/AdminLayout";
import { useSession } from "next-auth/react";
import {
  Table,
  Button,
  Modal,
  Form,
  Input,
  message,
  Select,
  ColorPicker, // Ch·ªçn m√†u
  InputNumber,
  Popconfirm,
  Tag,
  Space,
} from "antd";
import { PlusOutlined, DeleteOutlined, EditOutlined } from "@ant-design/icons";

// 1. ƒê·ªäNH NGHƒ®A INTERFACE (KHU√îN M·∫™U D·ªÆ LI·ªÜU)
interface AttendanceCode {
  id: number;
  code: string;
  name: string;
  category: string;
  factor?: number; // D·∫•u ? v√¨ c√≥ th·ªÉ null
  color: string;
  description?: string;
}

// ƒê·ªãnh nghƒ©a c√°c nh√≥m ch·∫ø ƒë·ªô ƒë·ªÉ hi·ªÉn th·ªã cho ƒë·∫πp
const CATEGORY_OPTIONS = [
  { value: "TIME_WORK", label: "L∆∞∆°ng th·ªùi gian" },
  { value: "PAID_LEAVE", label: "Ngh·ªâ h∆∞·ªüng 100% l∆∞∆°ng" },
  { value: "SICK", label: "Ch·∫ø ƒë·ªô ·ªêm / Tai n·∫°n" },
  { value: "MATERNITY", label: "Ch·∫ø ƒë·ªô Thai s·∫£n" },
  { value: "UNPAID", label: "Ngh·ªâ kh√¥ng l∆∞∆°ng" },
  { value: "AWOL", label: "Ngh·ªâ v√¥ l√Ω do" },
];

export default function AttendanceCodePage() {
  const { data: session } = useSession();
  // 1. Bi·∫øn th·∫ßn th√°nh ki·ªÉm tra quy·ªÅn
  // LOGIC M·ªöI: C·∫£ LEADER v√† TIMEKEEPER ƒë·ªÅu kh√¥ng ƒë∆∞·ª£c s·ª≠a danh m·ª•c
  // (Ch·ªâ ADMIN v√† HR_MANAGER m·ªõi ƒë∆∞·ª£c s·ª≠a)
  const isViewOnly = !["ADMIN", "HR_MANAGER"].includes(
    session?.user?.role || ""
  );

  const [codes, setCodes] = useState<AttendanceCode[]>([]);
  const [loading, setLoading] = useState(false);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [form] = Form.useForm();
  const [editingId, setEditingId] = useState<number | null>(null);

  // 1. T·∫£i d·ªØ li·ªáu
  const fetchCodes = async () => {
    setLoading(true);
    try {
      const res = await fetch("/api/attendance-codes");
      const data = await res.json();
      setCodes(data);
    } catch (error) {
      message.error("L·ªói t·∫£i danh m·ª•c: " + error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchCodes();
  }, []);

  // 2. X·ª≠ l√Ω l∆∞u (Th√™m / S·ª≠a)
  const handleOK = async () => {
    try {
      const values = await form.validateFields();

      // X·ª≠ l√Ω m√†u s·∫Øc: ColorPicker tr·∫£ v·ªÅ object, c·∫ßn chuy·ªÉn sang string hex (#ffffff)
      let colorHex = values.color;
      if (typeof values.color === "object") {
        colorHex = values.color.toHexString();
      }

      const payload = { ...values, color: colorHex };
      const url = editingId
        ? `/api/attendance-codes/${editingId}`
        : "/api/attendance-codes";
      const method = editingId ? "PATCH" : "POST";

      const res = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (res.ok) {
        message.success("L∆∞u th√†nh c√¥ng!");
        setIsModalOpen(false);
        fetchCodes();
      } else {
        const err = await res.json();
        message.error(err.error || "C√≥ l·ªói x·∫£y ra");
      }
    } catch (error) {
      console.log("Validate Failed: ", error);
    }
  };

  // 3. X·ª≠ l√Ω X√≥a
  const handleDelete = async (id: number) => {
    const res = await fetch(`/api/attendance-codes/${id}`, {
      method: "DELETE",
    });
    if (res.ok) {
      message.success("ƒê√£ x√≥a!");
      fetchCodes();
    } else {
      const err = await res.json();
      message.error(err.error);
    }
  };

  // 4. M·ªü Modal S·ª≠a
  const handleEdit = (record: AttendanceCode) => {
    setEditingId(record.id);
    form.setFieldsValue(record);
    setIsModalOpen(true);
  };

  const columns = [
    {
      title: "M√£",
      dataIndex: "code",
      width: 80,
      render: (text: string, record: AttendanceCode) => (
        <Tag
          color={record.color}
          style={{ fontWeight: "bold", minWidth: 40, textAlign: "center" }}
        >
          {text}
        </Tag>
      ),
    },
    {
      title: "T√™n di·ªÖn gi·∫£i",
      dataIndex: "name",
      width: 200,
    },
    {
      title: "Nh√≥m ch·∫ø ƒë·ªô",
      dataIndex: "category",
      width: 200,
      render: (cat: string) => {
        const option = CATEGORY_OPTIONS.find((o) => o.value === cat);
        return option ? option.label : cat;
      },
    },
    {
      title: "H·ªá s·ªë",
      dataIndex: "factor",
      width: 80,
    },
    {
      title: "M√†u s·∫Øc",
      dataIndex: "color",
      width: 100,
      render: (color: string) => (
        <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
          <div
            style={{
              width: 20,
              height: 20,
              background: color,
              borderRadius: 4,
              border: "1px solid #ddd",
            }}
          ></div>
          <small>{color}</small>
        </div>
      ),
    },
    {
      title: "H√†nh ƒë·ªông",
      key: "action",
      render: (_: AttendanceCode, record: AttendanceCode) => (
        <Space>
          <Button
            icon={<EditOutlined />}
            type="text"
            style={{ color: "blue" }}
            onClick={() => handleEdit(record)}
          />
          <Popconfirm
            title="X√≥a k√Ω hi·ªáu n√†y?"
            onConfirm={() => handleDelete(record.id)}
          >
            <Button icon={<DeleteOutlined />} type="text" danger />
          </Popconfirm>
        </Space>
      ),
    },
  ].filter((col) => {
    // N·∫øu l√† Leader V√Ä c·ªôt l√† 'action' -> Lo·∫°i b·ªè (return false)
    if (isViewOnly && col.key === "action") return false;
    return true;
  });

  return (
    <AdminLayout>
      <div
        style={{
          marginBottom: 16,
          display: "flex",
          justifyContent: "space-between",
        }}
      >
        <h2>Danh m·ª•c K√Ω hi·ªáu ch·∫•m c√¥ng</h2>

        {/* 3. Ch·ªâ hi·ªán n√∫t Th√™m m·ªõi n·∫øu ƒë∆∞·ª£c ph√©p s·ª≠a */}
        {!isViewOnly && (
          <Button
            type="primary"
            icon={<PlusOutlined />}
            onClick={() => {
              setEditingId(null);
              form.resetFields();
              // M·∫∑c ƒë·ªãnh ch·ªçn m√†u xanh l√° cho ƒë·∫πp
              form.setFieldValue("color", "#1677ff");
              setIsModalOpen(true);
            }}
          >
            Th√™m k√Ω hi·ªáu m·ªõi
          </Button>
        )}
      </div>

      <Table
        dataSource={codes}
        columns={columns}
        rowKey="id"
        loading={loading}
        pagination={false} // √çt d·ªØ li·ªáu n√™n kh√¥ng c·∫ßn ph√¢n trang
        bordered
      />

      <Modal
        title={editingId ? "S·ª≠a k√Ω hi·ªáu" : "Th√™m k√Ω hi·ªáu m·ªõi"}
        open={isModalOpen}
        onOk={handleOK}
        onCancel={() => setIsModalOpen(false)}
      >
        <Form form={form} layout="vertical">
          <div style={{ display: "flex", gap: 16 }}>
            <Form.Item
              name="code"
              label="M√£ k√Ω hi·ªáu"
              rules={[{ required: true }]}
              style={{ flex: 1 }}
            >
              <Input placeholder="VD: WFH" />
            </Form.Item>
            <Form.Item name="factor" label="H·ªá s·ªë c√¥ng" style={{ width: 120 }}>
              <InputNumber min={0} step={0.5} style={{ width: "100%" }} />
            </Form.Item>
          </div>

          <Form.Item
            name="name"
            label="T√™n di·ªÖn gi·∫£i"
            rules={[{ required: true }]}
          >
            <Input placeholder="VD: L√†m vi·ªác t·∫°i nh√†" />
          </Form.Item>

          <Form.Item
            name="category"
            label="Thu·ªôc nh√≥m ch·∫ø ƒë·ªô"
            rules={[{ required: true }]}
          >
            <Select options={CATEGORY_OPTIONS} />
          </Form.Item>

          <Form.Item
            name="color"
            label="M√†u hi·ªÉn th·ªã"
            rules={[{ required: true }]}
            initialValue="#1677ff"
          >
            <ColorPicker showText />
          </Form.Item>

          <Form.Item name="description" label="M√¥ t·∫£ th√™m">
            <Input.TextArea rows={2} />
          </Form.Item>
        </Form>
      </Modal>
    </AdminLayout>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\attendance-codes\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\bravo-data\page.tsx
================================================================================
"use client";

import React, { useState } from "react";
import AdminLayout from "@/components/AdminLayout";
import CommonFilter, { FilterResult } from "@/components/CommonFilter";
import { Button, Card, Typography, message, Table, Alert } from "antd";
import { DownloadOutlined, SyncOutlined } from "@ant-design/icons";
import dayjs from "dayjs";
import ExcelJS from "exceljs";
import { saveAs } from "file-saver";

const { Title, Text } = Typography;

export default function ExportBravoPage() {
    const [loading, setLoading] = useState(false);
    const [currentFilter, setCurrentFilter] = useState<FilterResult | null>(null);

    // L∆∞u preview data ƒë·ªÉ user y√™n t√¢m l√† c√≥ d·ªØ li·ªáu
    const [previewData, setPreviewData] = useState<any[]>([]);

    // B·∫Øt s·ª± ki·ªán khi ƒë·ªïi b·ªô l·ªçc
    const handleFilterChange = (result: FilterResult) => {
        setCurrentFilter(result);
        setPreviewData([]); // Clear preview khi ƒë·ªïi ƒëi·ªÅu ki·ªán
    };

    // H√†m g·ªçi API v√† T·∫°o file Excel
    const handleExport = async () => {
        if (!currentFilter) return;

        setLoading(true);
        message.loading({ content: "ƒêang t·ªïng h·ª£p d·ªØ li·ªáu, vui l√≤ng ƒë·ª£i...", key: "export" });

        try {
            const month = currentFilter.date.month() + 1;
            const year = currentFilter.date.year();

            let url = `/api/bravo-data/bravo?month=${month}&year=${year}`;

            // N·∫øu c√≥ ch·ªçn ph√≤ng ban / nh√† m√°y th√¨ th√™m v√†o URL (Kh√¥ng ch·ªçn = Xu·∫•t t·∫•t c·∫£)
            if (currentFilter.factoryId) url += `&factoryId=${currentFilter.factoryId}`;
            if (currentFilter.realDepartmentIds.length > 0) {
                url += `&departmentId=${currentFilter.realDepartmentIds.join(",")}`;
            }
            if (currentFilter.selectedKipIds.length > 0) {
                url += `&kipIds=${currentFilter.selectedKipIds.join(",")}`;
            }

            // 1. Fetch D·ªØ li·ªáu ph·∫≥ng
            const res = await fetch(url);
            const data = await res.json();

            if (data.error) throw new Error(data.error);
            if (data.length === 0) {
                message.warning({ content: "Kh√¥ng c√≥ d·ªØ li·ªáu trong kho·∫£ng th·ªùi gian n√†y.", key: "export" });
                setLoading(false);
                return;
            }

            // L∆∞u 10 d√≤ng ƒë·∫ßu ƒë·ªÉ Preview
            setPreviewData(data.slice(0, 10));

            // 2. T·∫°o File Excel
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet("DuLieuBravo");

            // Khai b√°o c·ªôt Header ch√≠nh x√°c
            worksheet.columns = [
                { header: "Ng√†y", key: "ngay", width: 12 },
                { header: "Nh√¢n vi√™n nh·∫≠p c√¥ng", key: "nvNhap", width: 20 },
                { header: "B·ªô ph·∫≠n", key: "boPhan", width: 15 },
                { header: "M√£ c√¥ng th·ªùi gian", key: "maCongThoiGian", width: 18 },
                { header: "M√£ nh√¢n vi√™n", key: "maNv", width: 15 },
                { header: "T√™n nh√¢n vi√™n", key: "tenNv", width: 25 },
                { header: "M√£ c√¥ng", key: "maCong", width: 12 },
                { header: "Lo·∫°i c√¥ng", key: "loaiCong", width: 25 },
            ];

            // ƒê·∫©y d·ªØ li·ªáu v√†o Sheet
            worksheet.addRows(data);

            // (T√πy ch·ªçn) ƒê·ªãnh d·∫°ng nh·∫π cho Header (In ƒë·∫≠m)
            worksheet.getRow(1).font = { bold: true };

            // 3. T·∫£i file v·ªÅ
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
            saveAs(blob, `DuLieu_BRAVO_T${month}_${year}.xlsx`);

            message.success({ content: `Xu·∫•t th√†nh c√¥ng ${data.length} d√≤ng d·ªØ li·ªáu!`, key: "export" });

        } catch (error: any) {
            console.error(error);
            message.error({ content: "L·ªói k·∫øt xu·∫•t: " + error.message, key: "export" });
        } finally {
            setLoading(false);
        }
    };

    // C·ªôt cho b·∫£ng Preview UI
    const columns = [
        { title: "Ng√†y", dataIndex: "ngay" },
        { title: "NV Nh·∫≠p", dataIndex: "nvNhap" },
        { title: "M√£ B·ªô ph·∫≠n", dataIndex: "boPhan" },
        { title: "M√£ c√¥ng TG", dataIndex: "maCongThoiGian" },
        { title: "M√£ NV", dataIndex: "maNv" },
        { title: "T√™n NV", dataIndex: "tenNv" },
        { title: "M√£ c√¥ng", dataIndex: "maCong" },
        { title: "Lo·∫°i c√¥ng", dataIndex: "loaiCong" },
    ];

    return (
        <AdminLayout>
            <div style={{ marginBottom: 24 }}>
                <Title level={3} style={{ margin: 0 }}>K·∫øt xu·∫•t d·ªØ li·ªáu cho BRAVO</Title>
                <Text type="secondary">Xu·∫•t d·ªØ li·ªáu ch·∫•m c√¥ng theo ƒë·ªãnh d·∫°ng chu·∫©n ƒë·ªÉ Import v√†o ph·∫ßn m·ªÅm BRAVO.</Text>
            </div>

            <CommonFilter
                dateMode="month"
                onFilterChange={handleFilterChange}
            />

            <Card style={{ marginTop: 16 }}>
                <Alert
                    message="L∆∞u √Ω quan tr·ªçng"
                    description="N·∫øu kh√¥ng ch·ªçn Nh√† m√°y / Ph√≤ng ban ·ªü b·ªô l·ªçc tr√™n, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông qu√©t v√† k·∫øt xu·∫•t d·ªØ li·ªáu c·ªßa TO√ÄN B·ªò C√îNG TY. Qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t v√†i gi√¢y do d·ªØ li·ªáu l·ªõn."
                    type="info"
                    showIcon
                    style={{ marginBottom: 20 }}
                />

                <Button
                    type="primary"
                    size="large"
                    icon={loading ? <SyncOutlined spin /> : <DownloadOutlined />}
                    onClick={handleExport}
                    loading={loading}
                    style={{ background: "#217346", width: 250, height: 50, fontSize: 16 }}
                >
                    B·∫ÆT ƒê·∫¶U K·∫æT XU·∫§T EXCEL
                </Button>
            </Card>

            {/* Hi·ªÉn th·ªã b·∫£ng Preview n·∫øu c√≥ */}
            {previewData.length > 0 && (
                <Card title="D·ªØ li·ªáu xem tr∆∞·ªõc (10 d√≤ng ƒë·∫ßu ti√™n)" size="small" style={{ marginTop: 16 }}>
                    <Table
                        dataSource={previewData}
                        columns={columns}
                        pagination={false}
                        size="small"
                        rowKey={(r) => r.maNv + r.ngay}
                    />
                </Card>
            )}

        </AdminLayout>
    );
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\bravo-data\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\dashboard\departments\page.tsx
================================================================================
"use client";

import React, { useEffect, useState } from "react";
import AdminLayout from "@/components/AdminLayout";
import { Table, Tag, DatePicker, Select, Card, Button, Breadcrumb } from "antd";
import {
  ReloadOutlined,
  HomeOutlined,
  CheckCircleOutlined,
  SyncOutlined,
  ClockCircleOutlined,
} from "@ant-design/icons";
import dayjs from "dayjs";

interface DeptStat {
  key: number;
  departmentName: string;
  factoryName: string;
  totalStaff: number;
  absentCount: number;
  absentRate: string;
  timekeepingCount: number;
  percent: number;
  status: "PENDING" | "PROCESSING" | "DONE";
}

export default function DepartmentDashboardPage() {
  const [loading, setLoading] = useState(false);
  const [data, setData] = useState<DeptStat[]>([]);

  // State b·ªô l·ªçc
  const [selectedFactory, setSelectedFactory] = useState<number | null>(null);
  const [selectedDate, setSelectedDate] = useState<dayjs.Dayjs>(dayjs());
  const [factories, setFactories] = useState<any[]>([]);

  useEffect(() => {
    fetch("/api/factories")
      .then((res) => res.json())
      .then(setFactories)
      .catch(console.error);
  }, []);

  const fetchData = async () => {
    setLoading(true);
    try {
      const dateStr = selectedDate.format("YYYY-MM-DD");
      let url = `/api/dashboard?date=${dateStr}`;
      if (selectedFactory) url += `&factoryId=${selectedFactory}`;

      const res = await fetch(url);
      const result = await res.json();

      if (result.stats) {
        setData(result.stats);
      }
    } catch (error) {
      console.error("L·ªói t·∫£i d·ªØ li·ªáu:", error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
  }, [selectedFactory, selectedDate]);

  // --- C·∫§U H√åNH C·ªòT (ƒê√£ b·ªè c·ªôt Ti·∫øn ƒë·ªô) ---
  const columns = [
    {
      title: "STT",
      key: "index",
      width: 50,
      align: "center" as const,
      render: (_: any, __: any, index: number) => index + 1,
    },
    {
      title: "Ph√≤ng ban / T·ªï",
      dataIndex: "departmentName",
      key: "departmentName",
      width: 280, // TƒÉng chi·ªÅu r·ªông m·ªôt ch√∫t cho tho·∫£i m√°i
      render: (text: string, record: DeptStat) => (
        <div>
          <div style={{ fontWeight: 600, fontSize: 15 }}>{text}</div>
          <div style={{ fontSize: 12, color: "#888" }}>
            {record.factoryName}
          </div>
        </div>
      ),
    },
    {
      title: "T·ªïng NS",
      dataIndex: "totalStaff",
      key: "totalStaff",
      align: "center" as const,
      width: 90,
      render: (val: number) => <b style={{ fontSize: 15 }}>{val}</b>,
    },
    {
      title: "Tr·∫°ng th√°i",
      key: "status",
      align: "center" as const,
      width: 150,
      render: (_: any, record: DeptStat) => {
        if (record.status === "DONE") {
          return (
            <Tag icon={<CheckCircleOutlined />} color="success">
              Ho√†n th√†nh
            </Tag>
          );
        }
        if (record.status === "PROCESSING") {
          // Hi·ªÉn th·ªã th√™m s·ªë l∆∞·ª£ng ƒë√£ ch·∫•m ƒë·ªÉ r√µ h∆°n
          return (
            <Tag icon={<SyncOutlined spin />} color="processing">
              ƒêang ch·∫•m ({record.timekeepingCount}/{record.totalStaff})
            </Tag>
          );
        }
        return (
          <Tag icon={<ClockCircleOutlined />} color="red">
            Ch∆∞a ch·∫•m
          </Tag>
        );
      },
    },
    {
      title: "V·∫Øng",
      dataIndex: "absentCount",
      key: "absentCount",
      align: "center" as const,
      width: 90,
      render: (val: number) => {
        if (val === 0) return <span style={{ color: "#ccc" }}>-</span>;
        return (
          <Tag color="error" style={{ fontSize: 14, padding: "4px 10px" }}>
            {val}
          </Tag>
        );
      },
    },
    {
      title: "% V·∫Øng",
      dataIndex: "absentRate",
      key: "absentRate",
      align: "right" as const,
      width: 100,
      render: (val: string) => {
        const rate = parseFloat(val);
        let color = "green";
        if (rate > 0) color = "orange";
        if (rate > 10) color = "red";
        return <span style={{ color, fontWeight: "bold" }}>{val}%</span>;
      },
    },
  ];

  return (
    <AdminLayout>
      <Breadcrumb style={{ marginBottom: 16 }}>
        <Breadcrumb.Item href="/dashboard">
          <HomeOutlined /> T·ªïng quan
        </Breadcrumb.Item>
        <Breadcrumb.Item>Chi ti·∫øt theo Ph√≤ng ban</Breadcrumb.Item>
      </Breadcrumb>

      <Card title="T√¨nh h√¨nh nh√¢n s·ª± theo B·ªô ph·∫≠n" bordered={false}>
        {/* THANH B·ªò L·ªåC */}
        <div
          style={{
            display: "flex",
            gap: 16,
            marginBottom: 24,
            flexWrap: "wrap",
          }}
        >
          <div>
            <div style={{ fontWeight: 500, marginBottom: 5 }}>Ch·ªçn ng√†y:</div>
            <DatePicker
              value={selectedDate}
              onChange={(val) => val && setSelectedDate(val)}
              allowClear={false}
              format="DD/MM/YYYY"
              style={{ width: 150 }}
            />
          </div>

          <div>
            <div style={{ fontWeight: 500, marginBottom: 5 }}>Nh√† m√°y:</div>
            <Select
              placeholder="T·∫•t c·∫£ nh√† m√°y"
              style={{ width: 200 }}
              allowClear
              options={factories.map((f) => ({ label: f.name, value: f.id }))}
              onChange={setSelectedFactory}
            />
          </div>

          <div style={{ display: "flex", alignItems: "end" }}>
            <Button icon={<ReloadOutlined />} onClick={fetchData}>
              L√†m m·ªõi
            </Button>
          </div>
        </div>

        {/* B·∫¢NG D·ªÆ LI·ªÜU */}
        <Table
          columns={columns}
          dataSource={data}
          loading={loading}
          pagination={false}
          bordered
          rowKey="key"
          scroll={{ y: 600 }}
          summary={(pageData) => {
            let totalStaff = 0;
            let totalAbsent = 0;
            let totalChecked = 0;

            pageData.forEach((item) => {
              totalStaff += item.totalStaff;
              totalAbsent += item.absentCount;
              totalChecked += item.timekeepingCount;
            });

            return (
              <Table.Summary fixed>
                <Table.Summary.Row
                  style={{ background: "#fafafa", fontWeight: "bold" }}
                >
                  {/* C·ªôt STT + T√™n b·ªô ph·∫≠n */}
                  <Table.Summary.Cell index={0} colSpan={2} align="right">
                    T·ªîNG C·ªòNG:
                  </Table.Summary.Cell>

                  {/* C·ªôt T·ªïng NS */}
                  <Table.Summary.Cell index={1} align="center">
                    {totalStaff}
                  </Table.Summary.Cell>

                  {/* C·ªôt Tr·∫°ng th√°i (T·ªïng h·ª£p) */}
                  <Table.Summary.Cell index={2} align="center">
                    <span style={{ color: "#1890ff" }}>
                      {totalChecked}/{totalStaff} ƒë√£ ch·∫•m
                    </span>
                  </Table.Summary.Cell>

                  {/* C·ªôt V·∫Øng */}
                  <Table.Summary.Cell index={3} align="center">
                    <span style={{ color: "red" }}>{totalAbsent}</span>
                  </Table.Summary.Cell>

                  {/* C·ªôt % V·∫Øng */}
                  <Table.Summary.Cell index={4} align="right">
                    {totalStaff > 0
                      ? ((totalAbsent / totalStaff) * 100).toFixed(1)
                      : 0}{" "}
                    %
                  </Table.Summary.Cell>
                </Table.Summary.Row>
              </Table.Summary>
            );
          }}
        />
      </Card>
    </AdminLayout>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\dashboard\departments\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\dashboard\page.tsx
================================================================================
"use client";

import React, { useEffect, useState, useMemo } from "react";
import AdminLayout from "@/components/AdminLayout";
import {
  Card,
  DatePicker,
  Row,
  Col,
  Statistic,
  Spin,
  Typography,
  Select,
  Empty,
} from "antd";
import {
  UsergroupAddOutlined,
  CheckCircleOutlined,
  CloseCircleOutlined,
  ReloadOutlined,
} from "@ant-design/icons";
import dayjs from "dayjs";
import type { Dayjs } from "dayjs";
import {
  PieChart,
  Pie,
  Cell,
  Tooltip as ReTooltip,
  Legend,
  ResponsiveContainer,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
} from "recharts";

const { Title } = Typography;

// --- M√ÄU S·∫ÆC BI·ªÇU ƒê·ªí ---
const COLORS = {
  present: "#00C49F", // Xanh l√° (ƒêi l√†m)
  absent: "#FF8042", // Cam (V·∫Øng)
  missing: "#d9d9d9", // X√°m (Ch∆∞a ch·∫•m)
};

export default function DashboardPage() {
  const [selectedDate, setSelectedDate] = useState<Dayjs>(dayjs());
  const [rawData, setRawData] = useState<any[]>([]);
  const [loading, setLoading] = useState(false);

  // 1. T·∫£i d·ªØ li·ªáu
  const fetchData = async () => {
    setLoading(true);
    try {
      const dateStr = selectedDate.format("YYYY-MM-DD");
      const res = await fetch(`/api/stats/daily?date=${dateStr}`);
      const data = await res.json();
      setRawData(data);
    } catch (error) {
      console.error(error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
  }, [selectedDate]);

  // 2. X·ª≠ l√Ω d·ªØ li·ªáu t·ªïng h·ª£p (Logic c·ªët l√µi)
  const stats = useMemo(() => {
    // ƒê·ªãnh nghƒ©a c√°c nh√≥m code
    const WORK_CODES = ["+", "XD", "CT", "Lƒê", "XL", "LE", "LD"];
    // C√°c nh√≥m ngh·ªâ ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì chi ti·∫øt
    const LEAVE_TYPES = {
      "Ph√©p (100%)": ["F", "R", "L", "ƒêC"],
      "·ªêm/BHXH": ["√î", "C√î", "TS", "DS", "T", "CL"],
      "Kh√¥ng l∆∞∆°ng": ["RO"],
      "V√¥ l√Ω do": ["O"],
    };

    // Helper ƒë·∫øm
    const getStatus = (emp: any) => {
      if (!emp.timesheets || emp.timesheets.length === 0) return "MISSING"; // Ch∆∞a ch·∫•m
      const code = emp.timesheets[0].attendanceCode.code;
      if (WORK_CODES.includes(code)) return "PRESENT"; // ƒêi l√†m
      return "ABSENT"; // Ngh·ªâ
    };

    // A. T·ªïng h·ª£p theo Nh√† m√°y (Cho 3 c√°i Card)
    // L·∫•y danh s√°ch nh√† m√°y duy nh·∫•t
    const factoryMap = new Map();

    rawData.forEach((emp) => {
      const factoryId = emp.department?.factory?.id || 0;
      const factoryName = emp.department?.factory?.name || "Kh√°c";

      if (!factoryMap.has(factoryId)) {
        factoryMap.set(factoryId, {
          id: factoryId,
          name: factoryName,
          total: 0,
          present: 0,
          absent: 0,
          missing: 0,
        });
      }

      const stat = factoryMap.get(factoryId);
      stat.total++;
      const status = getStatus(emp);
      if (status === "PRESENT") stat.present++;
      else if (status === "ABSENT") stat.absent++;
      else stat.missing++;
    });

    const factoryStats = Array.from(factoryMap.values());

    // B. T·ªïng h·ª£p bi·ªÉu ƒë·ªì tr√≤n (To√†n c√¥ng ty)
    let totalPresent = 0;
    let totalAbsent = 0;
    let totalMissing = 0;

    // C. T·ªïng h·ª£p bi·ªÉu ƒë·ªì c·ªôt (Chi ti·∫øt l√Ω do ngh·ªâ)
    const absenceDetail: any = {
      "Ph√©p (100%)": 0,
      "·ªêm/BHXH": 0,
      "Kh√¥ng l∆∞∆°ng": 0,
      "V√¥ l√Ω do": 0,
    };

    rawData.forEach((emp) => {
      const status = getStatus(emp);
      if (status === "PRESENT") totalPresent++;
      else if (status === "ABSENT") {
        totalAbsent++;
        // Ph√¢n lo·∫°i ngh·ªâ
        const code = emp.timesheets[0].attendanceCode.code;
        for (const [key, codes] of Object.entries(LEAVE_TYPES)) {
          if (codes.includes(code)) {
            absenceDetail[key]++;
            break;
          }
        }
      } else {
        totalMissing++;
      }
    });

    const pieData = [
      { name: "ƒêi l√†m", value: totalPresent, color: COLORS.present },
      { name: "Ngh·ªâ", value: totalAbsent, color: COLORS.absent },
      { name: "Ch∆∞a ch·∫•m", value: totalMissing, color: COLORS.missing },
    ];

    // Chuy·ªÉn object absenceDetail th√†nh array cho Recharts
    const barData = Object.keys(absenceDetail).map((key) => ({
      name: key,
      value: absenceDetail[key],
    }));

    return { factoryStats, pieData, barData, totalEmployees: rawData.length };
  }, [rawData]);

  return (
    <AdminLayout>
      <div
        style={{
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center",
          marginBottom: 24,
        }}
      >
        <Title level={3} style={{ margin: 0 }}>
          Dashboard T·ªïng quan
        </Title>
        <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
          <span style={{ fontWeight: 600 }}>Ng√†y xem:</span>
          <DatePicker
            value={selectedDate}
            onChange={(d) => d && setSelectedDate(d)}
            format="DD/MM/YYYY"
            allowClear={false}
          />
        </div>
      </div>

      <Spin spinning={loading}>
        {/* 1. TOP CARDS - TH·ªêNG K√ä THEO NH√Ä M√ÅY */}
        <Row gutter={[16, 16]} style={{ marginBottom: 24 }}>
          {stats.factoryStats.map((f: any) => (
            <Col xs={24} sm={12} lg={8} key={f.id}>
              <Card
                title={f.name}
                headStyle={{ background: "#fafafa", fontWeight: "bold" }}
                hoverable
              >
                <Row gutter={16} style={{ textAlign: "center" }}>
                  <Col span={8}>
                    <Statistic
                      title="T·ªïng NV"
                      value={f.total}
                      valueStyle={{ fontSize: 18, fontWeight: "bold" }}
                      prefix={<UsergroupAddOutlined />}
                    />
                  </Col>
                  <Col span={8}>
                    <Statistic
                      title="ƒêi l√†m"
                      value={f.present}
                      valueStyle={{ color: "#3f8600", fontSize: 18 }}
                      prefix={<CheckCircleOutlined />}
                    />
                  </Col>
                  <Col span={8}>
                    <Statistic
                      title="V·∫Øng"
                      value={f.absent}
                      valueStyle={{ color: "#cf1322", fontSize: 18 }}
                      prefix={<CloseCircleOutlined />}
                    />
                  </Col>
                </Row>
                {f.missing > 0 && (
                  <div
                    style={{
                      marginTop: 10,
                      textAlign: "center",
                      color: "#999",
                      fontSize: 12,
                    }}
                  >
                    ‚ö†Ô∏è C√≤n {f.missing} ng∆∞·ªùi ch∆∞a c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng
                  </div>
                )}
              </Card>
            </Col>
          ))}
        </Row>

        {/* 2. CHARTS SECTION */}
        {stats.totalEmployees > 0 ? (
          <Row gutter={[24, 24]}>
            {/* BI·ªÇU ƒê·ªí TR√íN - T·ª∂ L·ªÜ ƒêI L√ÄM */}
            <Col xs={24} lg={12}>
              <Card title="T·ª∑ l·ªá chuy√™n c·∫ßn to√†n c√¥ng ty">
                <div style={{ width: "100%", height: 300 }}>
                  <ResponsiveContainer>
                    <PieChart>
                      <Pie
                        data={stats.pieData}
                        cx="50%"
                        cy="50%"
                        innerRadius={60}
                        outerRadius={100}
                        paddingAngle={5}
                        dataKey="value"
                        label={({ name, percent }) =>
                          // Th√™m ƒëo·∫°n (percent || 0) ƒë·ªÉ b·∫£o ƒë·∫£m lu√¥n l√† s·ªë
                          `${name} ${((percent || 0) * 100).toFixed(0)}%`
                        }
                      >
                        {stats.pieData.map((entry, index) => (
                          <Cell key={`cell-${index}`} fill={entry.color} />
                        ))}
                      </Pie>
                      <ReTooltip />
                      <Legend />
                    </PieChart>
                  </ResponsiveContainer>
                </div>
              </Card>
            </Col>

            {/* BI·ªÇU ƒê·ªí C·ªòT - PH√ÇN T√çCH L√ù DO NGH·ªà */}
            <Col xs={24} lg={12}>
              <Card title="Ph√¢n t√≠ch l√Ω do v·∫Øng m·∫∑t">
                <div style={{ width: "100%", height: 300 }}>
                  <ResponsiveContainer>
                    <BarChart
                      data={stats.barData}
                      layout="vertical"
                      margin={{ left: 20 }}
                    >
                      <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                      <XAxis type="number" allowDecimals={false} />
                      <YAxis dataKey="name" type="category" width={100} />
                      <ReTooltip />
                      <Bar
                        dataKey="value"
                        name="S·ªë ng∆∞·ªùi"
                        fill="#8884d8"
                        barSize={30}
                      >
                        {stats.barData.map((entry, index) => (
                          <Cell
                            key={`cell-${index}`}
                            fill={
                              ["#2563eb", "#ca8a04", "#dc2626", "#000"][
                                index % 4
                              ]
                            }
                          />
                        ))}
                      </Bar>
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </Card>
            </Col>
          </Row>
        ) : (
          <Empty description="Ch∆∞a c√≥ d·ªØ li·ªáu" />
        )}
      </Spin>
    </AdminLayout>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\dashboard\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\departments\page.tsx
================================================================================
// src/app/departments/pages.tsx
"use client";

import React, { useEffect, useState, useMemo } from "react"; // Th√™m useMemo
import AdminLayout from "@/components/AdminLayout";
import { useSession } from "next-auth/react";
import {
  Table,
  Button,
  Modal,
  Form,
  Input,
  message,
  Select,
  Tag,
  Popconfirm,
  Space, // Import th√™m Space ƒë·ªÉ cƒÉn ch·ªânh n√∫t v√† √¥ l·ªçc
  type TableProps,
} from "antd";
import {
  PlusOutlined,
  DeleteOutlined,
  EditOutlined,
  FilterOutlined,
} from "@ant-design/icons";

// ... (Gi·ªØ nguy√™n c√°c Interface Factory v√† Department nh∆∞ c≈©)
interface Factory {
  id: number;
  name: string;
  code: string;
}

interface Department {
  id: number;
  code: string;
  name: string;
  factoryId?: number;
  factory?: {
    name: string;
  };
}

export default function DepartmentPage() {
  const { data: session } = useSession();
  const isViewOnly = !["ADMIN", "HR_MANAGER"].includes(
    session?.user?.role || ""
  );

  const [departments, setDepartments] = useState<Department[]>([]);
  const [factories, setFactories] = useState<Factory[]>([]);

  // --- 1. STATE M·ªöI CHO B·ªò L·ªåC ---
  const [filterFactoryId, setFilterFactoryId] = useState<number | null>(null);
  // ------------------------------

  const [loading, setLoading] = useState(false);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [form] = Form.useForm();
  const [editingId, setEditingId] = useState<number | null>(null);

  // ... (Gi·ªØ nguy√™n h√†m fetchDepartment v√† useEffect nh∆∞ c≈©)
  const fetchDepartment = async () => {
    setLoading(true);
    try {
      const [deptRes, facRes] = await Promise.all([
        fetch("/api/departments"),
        fetch("/api/factories"),
      ]);
      const deptData = await deptRes.json();
      const factData = await facRes.json();
      setDepartments(deptData);
      setFactories(factData);
    } catch (error) {
      message.error("L·ªói t·∫£i d·ªØ li·ªáu");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchDepartment();
  }, []);

  // ... (Gi·ªØ nguy√™n h√†m handleDelete, handleEdit, openAddModal, handleOK)
  const handleDelete = async (id: number) => {
    try {
      const res = await fetch(`/api/departments/${id}`, { method: "DELETE" });
      if (res.ok) {
        message.success("ƒê√£ x√≥a th√†nh c√¥ng!");
        fetchDepartment();
      } else {
        const errorData = await res.json();
        message.error(errorData.error || "L·ªói khi x√≥a");
      }
    } catch (error) {
      message.error("L·ªói k·∫øt n·ªëi, " + error);
    }
  };

  const handleEdit = (record: Department) => {
    setEditingId(record.id);
    form.setFieldsValue(record);
    setIsModalOpen(true);
  };

  const openAddModal = () => {
    setEditingId(null);
    form.resetFields();
    setIsModalOpen(true);
  };

  const handleOK = async () => {
    try {
      const values = await form.validateFields();
      const url = editingId
        ? `/api/departments/${editingId}`
        : "/api/departments";
      const method = editingId ? "PATCH" : "POST";

      const res = await fetch(url, {
        method: method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(values),
      });

      if (res.ok) {
        message.success(
          editingId ? "C·∫≠p nh·∫≠t th√†nh c√¥ng!" : "Th√™m m·ªõi th√†nh c√¥ng!"
        );
        setIsModalOpen(false);
        form.resetFields();
        setEditingId(null);
        fetchDepartment();
      } else {
        message.error("C√≥ l·ªói x·∫£y ra");
      }
    } catch (error) {
      console.log("Validate Failed !!!", error);
    }
  };

  // --- 2. LOGIC L·ªåC D·ªÆ LI·ªÜU ---
  // T·∫°o danh s√°ch m·ªõi d·ª±a tr√™n filterFactoryId
  const filteredDepartments = useMemo(() => {
    if (!filterFactoryId) return departments; // N·∫øu kh√¥ng ch·ªçn g√¨ th√¨ tr·∫£ v·ªÅ h·∫øt
    return departments.filter((dept) => dept.factoryId === filterFactoryId);
  }, [departments, filterFactoryId]);
  // ---------------------------

  // ... (Gi·ªØ nguy√™n columns)
  const columns: TableProps<Department>["columns"] = [
    { title: "ID", dataIndex: "id", key: "id", width: 50 },
    {
      title: "M√£ Ph√≤ng",
      dataIndex: "code",
      key: "code",
      render: (text: string) => <b>{text}</b>,
    },
    { title: "T√™n Ph√≤ng Ban", dataIndex: "name", key: "name" },
    {
      title: "Thu·ªôc Nh√† M√°y",
      dataIndex: "factory",
      key: "factory",
      render: (factory: Factory) => {
        if (!factory) return null;
        let color = "default";
        if (factory.code === "HC") color = "red";
        else if (factory.code === "NM1") color = "blue";
        else if (factory.code === "NM2") color = "green";
        else if (factory.code === "NM3") color = "#faad14";
        return <Tag color={color}>{factory.name}</Tag>;
      },
    },
    {
      title: "H√†nh ƒë·ªông",
      key: "action",
      render: (_: any, record: any) => (
        <>
          <Button
            type="text"
            icon={<EditOutlined />}
            style={{ color: "blue" }}
            onClick={() => handleEdit(record)}
          />
          <Popconfirm
            title="X√≥a b·ªô ph·∫≠n n√†y?"
            onConfirm={() => handleDelete(record.id)}
            okText="X√≥a"
            cancelText="H·ªßy"
          >
            <Button type="text" icon={<DeleteOutlined />} danger />
          </Popconfirm>
        </>
      ),
    },
  ].filter((col) => {
    if (isViewOnly && col.key === "action") return false;
    return true;
  });

  return (
    <AdminLayout>
      <div
        style={{
          marginBottom: 16,
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center", // CƒÉn gi·ªØa theo chi·ªÅu d·ªçc
        }}
      >
        <h2>Qu·∫£n l√Ω Ph√≤ng Ban</h2>

        {/* --- 3. C·∫¨P NH·∫¨T THANH C√îNG C·ª§ (L·ªåC + N√öT TH√äM) --- */}
        <Space>
          {/* √î dropdown L·ªçc */}
          <Select
            placeholder="L·ªçc theo nh√† m√°y"
            style={{ width: 200 }}
            allowClear // Cho ph√©p x√≥a ch·ªçn
            value={filterFactoryId}
            onChange={(val) => setFilterFactoryId(val)}
            suffixIcon={<FilterOutlined />} // Icon c√°i ph·ªÖu cho ƒë·∫πp
          >
            {/* Th√™m option hi·ªÉn th·ªã T·∫•t c·∫£ n·∫øu c·∫ßn, ho·∫∑c d√πng allowClear l√† ƒë·ªß */}
            {factories.map((f) => (
              <Select.Option key={f.id} value={f.id}>
                {f.name}
              </Select.Option>
            ))}
          </Select>

          {!isViewOnly && (
            <Button
              type="primary"
              icon={<PlusOutlined />}
              onClick={openAddModal}
            >
              Th√™m B·ªô Ph·∫≠n
            </Button>
          )}
        </Space>
        {/* ----------------------------------------------- */}
      </div>

      <Table
        // S·ª¨A: Thay departments b·∫±ng filteredDepartments
        dataSource={filteredDepartments}
        columns={columns}
        rowKey="id"
        loading={loading}
        bordered
      />

      {/* Modal gi·ªØ nguy√™n */}
      <Modal
        title={editingId ? "C·∫≠p nh·∫≠t b·ªô ph·∫≠n" : "Th√™m m·ªõi b·ªô ph·∫≠n"}
        open={isModalOpen}
        onOk={handleOK}
        onCancel={() => setIsModalOpen(false)}
      >
        <Form form={form} layout="vertical">
          <Form.Item name="code" label="M√£ Ph√≤ng" rules={[{ required: true }]}>
            <Input />
          </Form.Item>
          <Form.Item name="name" label="T√™n Ph√≤ng" rules={[{ required: true }]}>
            <Input />
          </Form.Item>
          <Form.Item name="factoryId" label="Thu·ªôc Nh√† M√°y">
            <Select placeholder="Ch·ªçn nh√† m√°y" allowClear>
              {factories.map((factory) => (
                <Select.Option key={factory.id} value={factory.id}>
                  {factory.name} ({factory.code})
                </Select.Option>
              ))}
            </Select>
          </Form.Item>
        </Form>
      </Modal>
    </AdminLayout>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\departments\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\employees\page.tsx
================================================================================
"use client";

import React, { useEffect, useState, useMemo } from "react";
import AdminLayout from "@/components/AdminLayout";
import { useSession } from "next-auth/react";
import {
  Table, Button, Modal, Form, Input, message, Select, DatePicker, Tag,
  Popconfirm, Card, Space, type TableProps, Divider // <-- Th√™m Divider
} from "antd";
import {
  PlusOutlined, DeleteOutlined, EditOutlined, FilterOutlined, PhoneOutlined, SearchOutlined
} from "@ant-design/icons";
import dayjs from "dayjs";

// --- 1. DEFINITIONS (INTERFACES) ---
interface Factory {
  id: number; code: string; name: string;
}
interface Department {
  id: number; name: string; factory?: Factory;
}
interface Kip {
  id: number; name: string; factoryId: number; factory?: Factory;
}

// [M·ªöI] C·∫≠p nh·∫≠t Interface Employee
interface Employee {
  id: number;
  code: string;
  fullName: string;
  birthday?: string;
  gender?: string;
  phone: string;
  department?: Department;
  kip?: Kip;
  position?: string;
  address?: string;
  // C√°c tr∆∞·ªùng m·ªõi
  startDate?: string;
  idCardNumber?: string;
  idCardDate?: string;
  idCardPlace?: string;
  bankAccount?: string;
  taxCode?: string;
}

export default function EmployeePage() {
  const { data: session } = useSession();
  const isViewOnly = !["ADMIN", "HR_MANAGER"].includes(session?.user?.role || "");

  // --- STATE ---
  const [employees, setEmployees] = useState<Employee[]>([]);
  const [departments, setDepartments] = useState<Department[]>([]);
  const [kips, setKips] = useState<Kip[]>([]);
  const [loading, setLoading] = useState(false);

  // State Modal
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [form] = Form.useForm();
  const [editingId, setEditingId] = useState<number | null>(null);

  // State B·ªô l·ªçc
  const [selectedFactoryId, setSelectedFactoryId] = useState<number | null>(null);
  const [selectedDeptId, setSelectedDeptId] = useState<number | null>(null);
  const [searchText, setSearchText] = useState("");

  // --- FETCH DATA ---
  const fetchEmployees = async () => {
    setLoading(true);
    try {
      const [empRes, deptRes, kipRes] = await Promise.all([
        fetch("/api/employees"), fetch("/api/departments"), fetch("/api/kips"),
      ]);
      setEmployees(await empRes.json());
      setDepartments(await deptRes.json());
      setKips(await kipRes.json());
    } catch (error) {
      message.error("L·ªói t·∫£i d·ªØ li·ªáu: " + error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => { fetchEmployees(); }, []);

  // --- MEMOIZED DATA ---
  const factories = useMemo(() => {
    const map = new Map();
    departments.forEach((d) => { if (d.factory) map.set(d.factory.id, d.factory); });
    return Array.from(map.values()) as Factory[];
  }, [departments]);

  const availableDepartments = useMemo(() => {
    if (!selectedFactoryId) return departments;
    return departments.filter((d) => d.factory?.id === selectedFactoryId);
  }, [departments, selectedFactoryId]);

  const filteredEmployees = useMemo(() => {
    return employees.filter((emp) => {
      const matchFactory = selectedFactoryId ? emp.department?.factory?.id === selectedFactoryId : true;
      const matchDept = selectedDeptId ? emp.department?.id === selectedDeptId : true;
      const matchName = searchText
        ? emp.fullName.toLowerCase().includes(searchText.toLowerCase()) ||
          emp.code.toLowerCase().includes(searchText.toLowerCase())
        : true;
      return matchFactory && matchDept && matchName;
    });
  }, [employees, selectedFactoryId, selectedDeptId, searchText]);

  // --- ACTIONS ---
  const handleDelete = async (id: number) => {
    try {
      const res = await fetch(`/api/employees/${id}`, { method: "DELETE" });
      if (res.ok) {
        message.success("ƒê√£ x√≥a!");
        fetchEmployees();
      } else {
        message.error("L·ªói khi x√≥a");
      }
    } catch (error) {
      message.error("L·ªói k·∫øt n·ªëi");
    }
  };

  const handleEdit = (record: Employee) => {
    setEditingId(record.id);
    form.setFieldsValue({
      ...record,
      birthday: record.birthday ? dayjs(record.birthday) : null,
      departmentId: record.department?.id,
      kipId: record.kip?.id,
      // [M·ªöI] Map d·ªØ li·ªáu ng√†y th√°ng m·ªõi sang dayjs
      startDate: record.startDate ? dayjs(record.startDate) : null,
      idCardDate: record.idCardDate ? dayjs(record.idCardDate) : null,
    });
    setIsModalOpen(true);
  };

  const openAddModal = () => {
    setEditingId(null);
    form.resetFields();
    setIsModalOpen(true);
  };

  const handleOK = async () => {
    try {
      const values = await form.validateFields();
      
      // Helper format ng√†y
      const fmtDate = (d: any) => d ? d.format("YYYY-MM-DD") + "T00:00:00.000Z" : null;

      const payload = {
        ...values,
        birthday: fmtDate(values.birthday),
        // [M·ªöI] Format c√°c ng√†y m·ªõi
        startDate: fmtDate(values.startDate),
        idCardDate: fmtDate(values.idCardDate),
      };

      const url = editingId ? `/api/employees/${editingId}` : "/api/employees";
      const method = editingId ? "PATCH" : "POST";

      const res = await fetch(url, {
        method: method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (res.ok) {
        message.success(editingId ? "C·∫≠p nh·∫≠t xong!" : "Th√™m m·ªõi xong!");
        setIsModalOpen(false);
        form.resetFields();
        setEditingId(null);
        fetchEmployees();
      } else {
        message.error("C√≥ l·ªói x·∫£y ra");
      }
    } catch (error) {
      console.log("Validate Failed", error);
    }
  };

  // --- COLUMNS ---
  const columns: TableProps<Employee>["columns"] = [
    {
      title: "M√£ NV", dataIndex: "code", key: "code", width: 90,
      render: (text: string) => <b>{text}</b>,
    },
    { title: "H·ªç t√™n", dataIndex: "fullName", key: "fullName", width: 180 },
    {
      title: "K√≠p / T·ªï", dataIndex: "kip", key: "kip", width: 130,
      render: (kip: Kip | null) => <Tag color={kip ? "geekblue" : "default"}>{kip ? kip.name : "HC/Kh√°c"}</Tag>,
    },
    {
      title: "B·ªô ph·∫≠n", dataIndex: "department", key: "department", width: 200,
      render: (dept: Department) => (
        <div>
          <div>{dept?.name}</div>
          {dept?.factory && <small style={{ color: "#888" }}>({dept.factory.name})</small>}
        </div>
      ),
    },
    { title: "Ch·ª©c v·ª•", dataIndex: "position", key: "position" },
    {
      title: "H√†nh ƒë·ªông", key: "action", width: 100,
      render: (_: any, record: any) => (
        <Space>
          <Button type="text" icon={<EditOutlined />} style={{ color: "blue" }} onClick={() => handleEdit(record)} />
          <Popconfirm title="X√≥a nh√¢n vi√™n n√†y?" onConfirm={() => handleDelete(record.id)} okText="X√≥a" cancelText="H·ªßy">
            <Button type="text" icon={<DeleteOutlined />} danger />
          </Popconfirm>
        </Space>
      ),
    },
  ].filter((col) => !isViewOnly || col.key !== "action");

  // --- RENDER UI ---
  return (
    <AdminLayout>
      {/* Header & Filter UI (Gi·ªØ nguy√™n nh∆∞ c≈©) */}
      <div style={{ marginBottom: 16, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
        <h2 className="text-2xl font-bold">Qu·∫£n l√Ω nh√¢n s·ª± ({filteredEmployees.length})</h2>
        {!isViewOnly && (
          <Button type="primary" icon={<PlusOutlined />} onClick={openAddModal}>Th√™m nh√¢n vi√™n</Button>
        )}
      </div>

      <Card size="small" style={{ marginBottom: 16, background: "#f5f5f5" }}>
        <div style={{ display: "flex", gap: 12, alignItems: "center", flexWrap: "wrap" }}>
          <span style={{ fontWeight: 600 }}><FilterOutlined /> B·ªô l·ªçc:</span>
          <Input placeholder="T√¨m t√™n ho·∫∑c m√£ NV..." prefix={<SearchOutlined style={{ color: "#bfbfbf" }} />} style={{ width: 200 }} value={searchText} onChange={(e) => setSearchText(e.target.value)} allowClear />
          <Select style={{ width: 220 }} placeholder="T·∫•t c·∫£ Nh√† m√°y" allowClear value={selectedFactoryId} onChange={(val) => { setSelectedFactoryId(val); setSelectedDeptId(null); }}>
            {factories.map((f) => <Select.Option key={f.id} value={f.id}>{f.name}</Select.Option>)}
          </Select>
          <Select style={{ width: 220 }} placeholder="T·∫•t c·∫£ Ph√≤ng ban" allowClear value={selectedDeptId} onChange={(val) => setSelectedDeptId(val)} disabled={!selectedFactoryId && departments.length > 50}>
            {availableDepartments.map((d) => <Select.Option key={d.id} value={d.id}>{d.name}</Select.Option>)}
          </Select>
          {(selectedFactoryId || selectedDeptId || searchText) && (
            <Button type="link" onClick={() => { setSelectedFactoryId(null); setSelectedDeptId(null); setSearchText(""); }}>X√≥a l·ªçc</Button>
          )}
        </div>
      </Card>

      <Table columns={columns} dataSource={filteredEmployees} rowKey="id" loading={loading} bordered scroll={{ x: 900 }} pagination={{ pageSize: 20, showSizeChanger: true }} />

      {/* --- MODAL FORM --- */}
      <Modal
        title={editingId ? "C·∫≠p nh·∫≠t th√¥ng tin" : "Th√™m m·ªõi nh√¢n vi√™n"}
        open={isModalOpen}
        onOk={handleOK}
        onCancel={() => setIsModalOpen(false)}
        width={800} // TƒÉng chi·ªÅu r·ªông Modal m·ªôt ch√∫t cho ƒë·∫πp
        confirmLoading={loading}
      >
        <Form form={form} layout="vertical">
          {/* --- PH·∫¶N 1: TH√îNG TIN C∆† B·∫¢N --- */}
          <Divider style={{ marginTop: 0 }}>Th√¥ng tin c∆° b·∫£n</Divider>
          
          <div style={{ display: "flex", gap: 16 }}>
            <Form.Item name="code" label="M√£ NV" style={{ flex: 1 }} rules={[{ required: true, message: "B·∫Øt bu·ªôc" }]}>
              <Input placeholder="NV..." />
            </Form.Item>
            <Form.Item name="fullName" label="H·ªç v√† t√™n" style={{ flex: 2 }} rules={[{ required: true, message: "B·∫Øt bu·ªôc" }]}>
              <Input placeholder="Nh·∫≠p t√™n..." />
            </Form.Item>
          </div>

          <div style={{ display: "flex", gap: 16 }}>
            <Form.Item name="departmentId" label="Ph√≤ng ban / C√¥ng ƒëo·∫°n" style={{ flex: 1 }} rules={[{ required: true }]}>
              <Select placeholder="Ch·ªçn ph√≤ng ban" showSearch optionFilterProp="children">
                {departments.map((dept) => (
                  <Select.Option key={dept.id} value={dept.id}>{dept.name} - {dept.factory?.name}</Select.Option>
                ))}
              </Select>
            </Form.Item>
            <Form.Item name="kipId" label="K√≠p / T·ªï (T√πy ch·ªçn)" style={{ flex: 1 }}>
              <Select placeholder="Ch·ªçn K√≠p" allowClear>
                {kips.map((k) => (
                  <Select.Option key={k.id} value={k.id}>{k.name} - {k.factory?.name}</Select.Option>
                ))}
              </Select>
            </Form.Item>
          </div>

          <div style={{ display: "flex", gap: 16 }}>
            <Form.Item name="position" label="Ch·ª©c v·ª•" style={{ flex: 1 }}>
              <Input />
            </Form.Item>
            <Form.Item name="startDate" label="Ng√†y v√†o l√†m" style={{ flex: 1 }}>
               {/* [M·ªöI] Ng√†y v√†o l√†m */}
               <DatePicker style={{ width: "100%" }} format="DD/MM/YYYY" placeholder="Ch·ªçn ng√†y" />
            </Form.Item>
          </div>

          <div style={{ display: "flex", gap: 16 }}>
            <Form.Item name="phone" label="S·ªë ƒëi·ªán tho·∫°i" style={{ flex: 1 }}>
              <Input prefix={<PhoneOutlined />} />
            </Form.Item>
            <Form.Item name="gender" label="Gi·ªõi t√≠nh" style={{ width: 120 }}>
              <Select>
                <Select.Option value="Nam">Nam</Select.Option>
                <Select.Option value="N·ªØ">N·ªØ</Select.Option>
              </Select>
            </Form.Item>
             <Form.Item name="birthday" label="Ng√†y sinh" style={{ flex: 1 }}>
              <DatePicker style={{ width: "100%" }} format="DD/MM/YYYY" placeholder="Ch·ªçn ng√†y" />
            </Form.Item>
          </div>

           <Form.Item name="address" label="ƒê·ªãa ch·ªâ th∆∞·ªùng tr√∫">
            <Input.TextArea rows={1} />
          </Form.Item>

          {/* --- PH·∫¶N 2: TH√îNG TIN B·ªî SUNG --- */}
          <Divider>Th√¥ng tin ƒë·ªãnh danh & Ng√¢n h√†ng</Divider>

          <div style={{ display: "flex", gap: 16 }}>
             <Form.Item name="idCardNumber" label="S·ªë CCCD" style={{ flex: 1 }}>
               <Input placeholder="S·ªë cƒÉn c∆∞·ªõc..." />
             </Form.Item>
             <Form.Item name="idCardDate" label="Ng√†y c·∫•p" style={{ flex: 1 }}>
               <DatePicker style={{ width: "100%" }} format="DD/MM/YYYY" placeholder="Ch·ªçn ng√†y c·∫•p" />
             </Form.Item>
              <Form.Item name="idCardPlace" label="N∆°i c·∫•p" style={{ flex: 1 }}>
               <Input placeholder="C·ª•c CS..." />
             </Form.Item>
          </div>

          <div style={{ display: "flex", gap: 16 }}>
             <Form.Item name="bankAccount" label="S·ªë t√†i kho·∫£n" style={{ flex: 1 }}>
               <Input placeholder="STK ng√¢n h√†ng..." />
             </Form.Item>
             <Form.Item name="taxCode" label="M√£ s·ªë thu·∫ø" style={{ flex: 1 }}>
               <Input placeholder="MST c√° nh√¢n..." />
             </Form.Item>
          </div>

        </Form>
      </Modal>
    </AdminLayout>
  );
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\employees\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\evaluations\monthly\page.tsx
================================================================================
"use client";

import React, { useState } from "react";
import AdminLayout from "@/components/AdminLayout";
import { useSession } from "next-auth/react";
import { useRouter } from "next/navigation";
import {
    Table,
    Select,
    Button,
    message,
    Input,
    Typography,
    Popconfirm,
} from "antd";
import {
    SaveOutlined,
    ThunderboltOutlined,
    BarChartOutlined,
} from "@ant-design/icons";

// [QUAN TR·ªåNG] Import Component l·ªçc d√πng chung
import CommonFilter, { FilterResult } from "@/components/CommonFilter";

const { Title } = Typography;
const { Option } = Select;

// --- INTERFACES ---
interface EvaluationData {
    id: number;
    code: string;
    fullName: string;
    departmentName: string;
    kipName: string;
    grade: string | null;
    note: string;
}

export default function MonthlyEvaluationPage() {
    const { data: session } = useSession();
    const router = useRouter();

    // --- STATE ---
    const [loading, setLoading] = useState(false);
    const [data, setData] = useState<EvaluationData[]>([]);

    // State l∆∞u c√°c thay ƒë·ªïi ch∆∞a l∆∞u
    const [changes, setChanges] = useState<Record<number, { grade: string; note: string }>>({});

    // State l∆∞u b·ªô l·ªçc hi·ªán t·∫°i (ƒë·ªÉ d√πng cho h√†m Save)
    const [currentFilter, setCurrentFilter] = useState<FilterResult | null>(null);

    // --- 1. FETCH DATA (G·ªçi khi CommonFilter thay ƒë·ªïi) ---
    const fetchData = async (filter: FilterResult) => {
        // N·∫øu ch∆∞a ch·ªçn ph√≤ng ban -> X√≥a b·∫£ng & X√≥a thay ƒë·ªïi
        if (!filter.realDepartmentIds || filter.realDepartmentIds.length === 0) {
            setData([]);
            setChanges({});
            return;
        }

        setLoading(true);
        // Reset thay ƒë·ªïi khi load d·ªØ li·ªáu m·ªõi
        setChanges({});

        try {
            const m = filter.date.month() + 1;
            const y = filter.date.year();

            let url = `/api/evaluations/monthly?month=${m}&year=${y}`;

            if (filter.factoryId) url += `&factoryId=${filter.factoryId}`;

            // G·ª≠i danh s√°ch ID ph√≤ng ƒë√£ gi·∫£i m√£
            url += `&departmentId=${filter.realDepartmentIds.join(",")}`;

            // G·ª≠i danh s√°ch K√≠p (n·∫øu c√≥) ƒë·ªÉ backend l·ªçc hi·ªÉn th·ªã n·∫øu c·∫ßn
            if (filter.selectedKipIds.length > 0) {
                url += `&kipIds=${filter.selectedKipIds.join(",")}`;
            }

            const res = await fetch(url);
            const result = await res.json();

            if (result.error) {
                message.error(result.error);
                setData([]);
            } else {
                setData(result);
            }
        } catch (err) {
            message.error("L·ªói t·∫£i d·ªØ li·ªáu");
        } finally {
            setLoading(false);
        }
    };

    // Callback t·ª´ Component con
    const handleFilterChange = (result: FilterResult) => {
        setCurrentFilter(result); // L∆∞u filter
        fetchData(result); // Load d·ªØ li·ªáu
    };

    // --- 2. LOGIC X·ª¨ L√ù D·ªÆ LI·ªÜU (Gi·ªØ nguy√™n) ---
    const handleGradeChange = (empId: number, val: string) => {
        setChanges((prev) => ({
            ...prev,
            [empId]: {
                ...prev[empId],
                grade: val,
                note: prev[empId]?.note || getDataNote(empId)
            },
        }));
    };

    const handleNoteChange = (empId: number, val: string) => {
        setChanges((prev) => ({
            ...prev,
            [empId]: {
                ...prev[empId],
                grade: prev[empId]?.grade || getDataGrade(empId) || "",
                note: val
            },
        }));
    };

    const getDataGrade = (empId: number) => {
        if (changes[empId]?.grade !== undefined) return changes[empId].grade;
        const item = data.find((d) => d.id === empId);
        return item?.grade || undefined;
    };

    const getDataNote = (empId: number) => {
        if (changes[empId]?.note !== undefined) return changes[empId].note;
        const item = data.find((d) => d.id === empId);
        return item?.note || "";
    };

    const handleQuickFill = (targetGrade: string) => {
        const newChanges = { ...changes };
        data.forEach((emp) => {
            // Ch·ªâ ƒëi·ªÅn n·∫øu ch∆∞a c√≥ gi√° tr·ªã
            newChanges[emp.id] = {
                grade: targetGrade,
                note: newChanges[emp.id]?.note || emp.note || ""
            };
        });
        setChanges(newChanges);
        message.success(`ƒê√£ x·∫øp lo·∫°i ${targetGrade} to√†n b·ªô!`);
    };

    // --- 3. SAVE ---
    const handleSave = async () => {
        if (!currentFilter) return;

        const payload = data.map((emp) => {
            const changed = changes[emp.id];
            return {
                employeeId: emp.id,
                // N·∫øu c√≥ thay ƒë·ªïi th√¨ l·∫•y gi√° tr·ªã m·ªõi, kh√¥ng th√¨ l·∫•y gi√° tr·ªã c≈©
                grade: changed ? changed.grade : emp.grade,
                note: changed ? changed.note : emp.note,
            };
        }).filter((item) => item.grade); // Ch·ªâ l∆∞u nh·ªØng ng∆∞·ªùi c√≥ x·∫øp lo·∫°i

        if (payload.length === 0) {
            message.warning("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ l∆∞u");
            return;
        }

        setLoading(true);
        try {
            const res = await fetch("/api/evaluations/bulk", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    month: currentFilter.date.month() + 1,
                    year: currentFilter.date.year(),
                    evaluations: payload,
                }),
            });

            if (res.ok) {
                message.success("ƒê√£ l∆∞u th√†nh c√¥ng!");
                // Load l·∫°i data ƒë·ªÉ clear state `changes` v√† c·∫≠p nh·∫≠t d·ªØ li·ªáu g·ªëc
                fetchData(currentFilter);
            } else {
                message.error("L·ªói khi l∆∞u");
            }
        } catch (e) {
            message.error("L·ªói k·∫øt n·ªëi");
        } finally {
            setLoading(false);
        }
    };

    // Quy·ªÅn s·ª≠a: Kh√¥ng ph·∫£i STAFF
    const canEdit = session?.user?.role !== "STAFF";

    const columns = [
        { title: "STT", key: "idx", width: 50, align: "center" as const, render: (_: any, __: any, i: number) => i + 1 },
        { title: "M√£ NV", dataIndex: "code", key: "code", width: 80, render: (t: string) => <b>{t}</b> },
        { title: "H·ªç t√™n", dataIndex: "fullName", key: "fullName", width: 180, render: (t: string, r: EvaluationData) => (<div><div>{t}</div><div style={{ fontSize: 11, color: "#888" }}>{r.kipName}</div></div>) },
        {
            title: "X·∫øp lo·∫°i", key: "grade", width: 100, align: "center" as const,
            render: (_: any, r: EvaluationData) => (
                <Select
                    style={{ width: 80 }}
                    value={getDataGrade(r.id)}
                    onChange={(val) => handleGradeChange(r.id, val)}
                    placeholder="-"
                    disabled={!canEdit}
                >
                    <Option value="A"><span style={{ color: "green", fontWeight: "bold" }}>A</span></Option>
                    <Option value="A-">A-</Option>
                    <Option value="B"><span style={{ color: "blue", fontWeight: "bold" }}>B</span></Option>
                    <Option value="B-">B-</Option>
                    <Option value="C"><span style={{ color: "red", fontWeight: "bold" }}>C</span></Option>
                </Select>
            )
        },
        { title: "Ghi ch√∫ / L√Ω do", key: "note", render: (_: any, r: EvaluationData) => (<Input disabled={!canEdit} value={getDataNote(r.id)} onChange={(e) => handleNoteChange(r.id, e.target.value)} placeholder="Ghi ch√∫..." maxLength={100} />) },
    ];

    return (
        <AdminLayout>
            <div style={{ marginBottom: 16, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                <Title level={3} style={{ margin: 0 }}>X·∫øp lo·∫°i nh√¢n vi√™n trong th√°ng</Title>
            </div>

            {/* --- S·ª¨ D·ª§NG COMPONENT L·ªåC (Thay th·∫ø to√†n b·ªô Card c≈©) --- */}
            <CommonFilter
                dateMode="month" // Ch·∫ø ƒë·ªô Th√°ng
                onFilterChange={handleFilterChange}
            />

            {/* Thanh c√¥ng c·ª• (ƒêi·ªÅn nhanh & L∆∞u) */}
            {data.length > 0 && canEdit && (
                <div style={{ marginBottom: 16, display: "flex", justifyContent: "space-between", alignItems: "center", background: "#fff", padding: 12, borderRadius: 8, border: "1px solid #f0f0f0" }}>
                    <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                        <span style={{ fontWeight: 500, color: "#666" }}>
                            <ThunderboltOutlined style={{ color: "#faad14" }} /> ƒêi·ªÅn nhanh:
                        </span>
                        <Popconfirm title="X·∫øp lo·∫°i A t·∫•t c·∫£?" onConfirm={() => handleQuickFill("A")}>
                            <Button>T·∫•t c·∫£ A</Button>
                        </Popconfirm>
                    </div>

                    <Button
                        type="primary"
                        icon={<SaveOutlined />}
                        size="large"
                        onClick={handleSave}
                        loading={loading}
                        style={{ background: "#217346", borderColor: "#217346" }}
                    >
                        L∆∞u thay ƒë·ªïi ({Object.keys(changes).length})
                    </Button>
                </div>
            )}

            {/* B·∫£ng d·ªØ li·ªáu */}
            {data.length > 0 ? (
                <Table
                    dataSource={data}
                    columns={columns}
                    rowKey="id"
                    bordered
                    pagination={false}
                    scroll={{ y: 600 }}
                    loading={loading}
                    size="small"
                />
            ) : (
                <div style={{ textAlign: "center", padding: "50px", color: "#999", background: "#fff", border: "1px dashed #ddd" }}>
                    Vui l√≤ng ch·ªçn ƒëi·ªÅu ki·ªán l·ªçc ƒë·ªÉ xem danh s√°ch.
                </div>
            )}
        </AdminLayout>
    );
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\evaluations\monthly\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\evaluations\yearly\page.tsx
================================================================================
"use client";

import React, { useState, useMemo } from "react";
import AdminLayout from "@/components/AdminLayout";
import { Table, Button, message, Typography, Tabs } from "antd";
import { ArrowLeftOutlined, BarChartOutlined, CalendarOutlined, CheckSquareOutlined } from "@ant-design/icons";
import { useRouter } from "next/navigation";
import dayjs from "dayjs";

// Import Component l·ªçc d√πng chung
import CommonFilter, { FilterResult } from "@/components/CommonFilter";

const { Title } = Typography;

// --- INTERFACES ---
interface YearlyData {
    id: number;
    code: string;
    fullName: string;
    departmentName: string;
    kipName: string;
    data: (string | number | null)[]; // M·∫£ng 12 ph·∫ßn t·ª≠ (Chu·ªói A/B/C ho·∫∑c S·ªë c√¥ng)
    summary: { col1: number; col2?: number; col3?: number };
}

export default function YearlyEvaluationPage() {
    const router = useRouter();

    // --- STATE ---
    const [loading, setLoading] = useState(false);
    const [reportData, setReportData] = useState<YearlyData[]>([]);
    const [displayYear, setDisplayYear] = useState<number>(dayjs().year());

    // State qu·∫£n l√Ω lo·∫°i b√°o c√°o
    const [reportType, setReportType] = useState<"evaluation" | "workday" | "leave">("evaluation");

    // State l∆∞u filter hi·ªán t·∫°i ƒë·ªÉ g·ªçi l·∫°i API khi ƒë·ªïi Tab
    const [activeFilter, setActiveFilter] = useState<FilterResult | null>(null);

    // --- FETCH DATA ---
    const fetchData = async (filter: FilterResult, type: string) => {
        setDisplayYear(filter.date.year());

        if (!filter.realDepartmentIds || filter.realDepartmentIds.length === 0) {
            setReportData([]);
            return;
        }

        setLoading(true);
        try {
            const year = filter.date.year();
            let url = `/api/reports/yearly?year=${year}&type=${type}`; // G·ªçi API m·ªõi

            if (filter.factoryId) url += `&factoryId=${filter.factoryId}`;
            url += `&departmentId=${filter.realDepartmentIds.join(",")}`;
            if (filter.selectedKipIds.length > 0) {
                url += `&kipIds=${filter.selectedKipIds.join(",")}`;
            }

            const res = await fetch(url);
            const result = await res.json();

            if (result.error) {
                message.error(result.error);
                setReportData([]);
            } else {
                setReportData(result);
            }
        } catch (err) {
            message.error("L·ªói t·∫£i d·ªØ li·ªáu");
            setReportData([]);
        } finally {
            setLoading(false);
        }
    };

    // --- HANDLERS ---
    const handleFilterChange = (result: FilterResult) => {
        setActiveFilter(result);
        fetchData(result, reportType);
    };

    const handleTabChange = (key: string) => {
        const newType = key as "evaluation" | "workday" | "leave";
        setReportType(newType);
        // N·∫øu ƒë√£ c√≥ b·ªô l·ªçc th√¨ reload data theo type m·ªõi
        if (activeFilter) {
            fetchData(activeFilter, newType);
        }
    };

    // --- COLUMNS DEFINITION (Dynamic theo Report Type) ---
    const columns = useMemo(() => {
        const baseCols: any[] = [
            {
                title: "STT", width: 50, align: "center", fixed: "left",
                render: (_: any, __: any, i: number) => i + 1,
            },
            {
                title: "H·ªç v√† T√™n", dataIndex: "fullName", width: 180, fixed: "left",
                render: (t: string, r: YearlyData) => (
                    <div>
                        <div style={{ fontWeight: 500 }}>{t}</div>
                        <div style={{ fontSize: 11, color: "#888" }}>
                            {r.kipName ? `K√≠p: ${r.kipName}` : r.departmentName}
                        </div>
                    </div>
                ),
            },
        ];

        // C·ªôt 12 th√°ng
        const monthCols = [];
        for (let i = 1; i <= 12; i++) {
            monthCols.push({
                title: `T${i}`,
                width: 50,
                align: "center",
                render: (_: any, r: YearlyData) => {
                    const val = r.data[i - 1]; // Gi√° tr·ªã th√°ng

                    if (reportType === "evaluation") {
                        // Logic m√†u s·∫Øc cho X·∫øp lo·∫°i
                        let color = "#000";
                        const sVal = String(val || "");
                        if (sVal.startsWith("A")) color = "green";
                        if (sVal.startsWith("B")) color = "blue";
                        if (sVal.startsWith("C")) color = "red";
                        return <b style={{ color }}>{val || "-"}</b>;
                    } else {
                        // Logic hi·ªÉn th·ªã s·ªë (C√¥ng / Ph√©p)
                        // N·∫øu l√† 0 th√¨ hi·ªÉn th·ªã nh·∫°t ho·∫∑c g·∫°ch
                        return <span style={{ color: val === 0 ? "#ccc" : "#000" }}>{val}</span>;
                    }
                },
            });
        }

        // C·ªôt T·ªïng h·ª£p (Kh√°c nhau theo t·ª´ng lo·∫°i)
        let summaryCols: any[] = [];

        if (reportType === "evaluation") {
            summaryCols = [
                { title: "T·ªïng A", width: 60, align: "center", fixed: "right", render: (_: any, r: YearlyData) => <b style={{ color: "green" }}>{r.summary.col1}</b> },
                { title: "T·ªïng B", width: 60, align: "center", fixed: "right", render: (_: any, r: YearlyData) => <b style={{ color: "blue" }}>{r.summary.col2}</b> },
                { title: "T·ªïng C", width: 60, align: "center", fixed: "right", render: (_: any, r: YearlyData) => <b style={{ color: "red" }}>{r.summary.col3}</b> },
            ];
        } else if (reportType === "workday") {
            summaryCols = [
                {
                    title: "T·ªïng C√¥ng", width: 80, align: "center", fixed: "right",
                    render: (_: any, r: YearlyData) => <b style={{ color: "#1677ff", fontSize: 15 }}>{r.summary.col1}</b>
                },
            ];
        } else if (reportType === "leave") {
            summaryCols = [
                {
                    title: "ƒê√£ ngh·ªâ", width: 70, align: "center", fixed: "right",
                    render: (_: any, r: YearlyData) => <b style={{ color: "#faad14" }}>{r.summary.col1}</b>
                },
                {
                    title: "C√≤n l·∫°i", width: 70, align: "center", fixed: "right",
                    render: (_: any, r: YearlyData) => {
                        const val = r.summary.col2 || 0;
                        // N·∫øu √¢m th√¨ b√°o ƒë·ªè
                        return <b style={{ color: val < 0 ? "red" : "green" }}>{val}</b>
                    }
                },
            ];
        }

        return [...baseCols, ...monthCols, ...summaryCols];
    }, [reportType]); // Render l·∫°i c·ªôt khi ƒë·ªïi lo·∫°i b√°o c√°o

    // C·∫•u h√¨nh Tabs
    const items = [
        { key: 'evaluation', label: <span><CheckSquareOutlined /> T·ªïng h·ª£p X·∫øp lo·∫°i</span> },
        { key: 'workday', label: <span><BarChartOutlined /> T·ªïng c√¥ng ƒëi l√†m (+, XD)</span> },
        { key: 'leave', label: <span><CalendarOutlined /> T·ªïng h·ª£p Ph√©p (F)</span> },
    ];

    return (
        <AdminLayout>
            <div style={{ marginBottom: 16, display: "flex", justifyContent: "space-between", alignItems: 'center' }}>
                <Title level={3} style={{ margin: 0 }}>B√°o c√°o T·ªïng h·ª£p NƒÉm {displayYear}</Title>
            </div>

            <CommonFilter
                dateMode="year"
                onFilterChange={handleFilterChange}
            />

            {/* Tabs chuy·ªÉn ƒë·ªïi b√°o c√°o */}
            <Tabs
                defaultActiveKey="evaluation"
                items={items}
                onChange={handleTabChange}
                type="card"
                style={{ marginTop: 16 }}
            />

            <Table
                dataSource={reportData}
                columns={columns}
                rowKey="id"
                bordered
                pagination={false}
                scroll={{ x: "max-content", y: 600 }}
                loading={loading}
                size="small"
            />
        </AdminLayout>
    );
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\evaluations\yearly\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\factories\page.tsx
================================================================================
// src/app/factories/page.tsx
"use client"; // B·∫Øt bu·ªôc v√¨ c√≥ t∆∞∆°ng t√°c (click, nh·∫≠p li·ªáu)

import React, { useEffect, useState } from "react";
import AdminLayout from "@/components/AdminLayout";
import { useSession } from "next-auth/react";
import {
  Table,
  Button,
  Modal,
  Form,
  Input,
  message,
  Space,
  Popconfirm,
} from "antd";
import { PlusOutlined, DeleteOutlined, EditOutlined } from "@ant-design/icons";

// 1. ƒê·ªãnh nghƒ©a ki·ªÉu d·ªØ li·ªáu cho Nh√† m√°y (gi√∫p code g·ª£i √Ω th√¥ng minh)
interface Factory {
  id: number;
  code: string;
  name: string;
}

export default function FactoryPage() {
  const { data: session } = useSession();
  // ƒê·ªãnh nghƒ©a ch·∫ø ƒë·ªô CH·ªà XEM
  // 1. Bi·∫øn th·∫ßn th√°nh ki·ªÉm tra quy·ªÅn
  // LOGIC M·ªöI: C·∫£ LEADER v√† TIMEKEEPER ƒë·ªÅu kh√¥ng ƒë∆∞·ª£c s·ª≠a danh m·ª•c
  // (Ch·ªâ ADMIN v√† HR_MANAGER m·ªõi ƒë∆∞·ª£c s·ª≠a)
  const isViewOnly = !["ADMIN", "HR_MANAGER"].includes(
    session?.user?.role || ""
  );

  // --- PH·∫¶N 1: QU·∫¢N L√ù TR·∫†NG TH√ÅI (STATE) ---
  const [factories, setFactories] = useState<Factory[]>([]); // Ch·ª©a danh s√°ch nh√† m√°y
  const [loading, setLoading] = useState(false); // Tr·∫°ng th√°i ƒëang t·∫£i xoay v√≤ng v√≤ng
  const [isModalOpen, setIsModalOpen] = useState(false); // Tr·∫°ng th√°i m·ªü/ƒë√≥ng Modal
  const [form] = Form.useForm(); // Hook ƒë·ªÉ qu·∫£n l√Ω Form c·ªßa AntD
  // State m·ªõi, l∆∞u ID c·ªßa d√≤ng ƒëang s·ª≠a (n·∫øu null nghƒ©a l√† ƒëang th√™m m·ªõi)
  const [editingId, setEditingId] = useState<number | null>(null);

  // --- PH·∫¶N 2: T∆Ø∆†NG T√ÅC V·ªöI API (BACKEND) ---
  // --- H√ÄM L·∫§Y DANH S√ÅCH T·ª™ API GET ---
  const fetchFactories = async () => {
    setLoading(true);
    try {
      const res = await fetch("/api/factories");
      const data = await res.json();
      setFactories(data);
    } catch (error) {
      message.error("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu: " + error);
    } finally {
      setLoading(false);
    }
  };

  // G·ªçi h√†m l·∫•y d·ªØ li·ªáu ngay khi trang v·ª´a m·ªü l√™n
  useEffect(() => {
    fetchFactories();
  }, []);

  // --- H√ÄM X·ª¨ L√ù X√ìA ---
  const handleDelete = async (id: number) => {
    try {
      const res = await fetch(`/api/factories/${id}`, {
        method: "DELETE",
      });

      if (res.ok) {
        message.success("ƒê√£ x√≥a th√†nh c√¥ng!");
        fetchFactories(); // Load l·∫°i b·∫£ng
      } else {
        const errorData = await res.json();
        message.error(errorData.error || "L·ªói khi x√≥a");
      }
    } catch (error) {
      message.error("L·ªói k·∫øt n·ªëi" + error);
    }
  };

  // --- H√ÄM M·ªû MODAL ƒê·ªÇ S·ª¨A
  const handleEdit = (record: Factory) => {
    setEditingId(record.id); // ƒê√°nh d·∫•u l√† ƒëang s·ª≠a ID n√†y
    form.setFieldsValue(record); // ƒêi·ªÅn d·ªØ li·ªáu c≈© v√†o form
    setIsModalOpen(true); // M·ªü Modal l√™n
  };

  // --- H√ÄM M·ªû MODAL ƒê·ªÇ TH√äM M·ªöI ---
  const openAddModal = () => {
    setEditingId(null); // ƒê√°nh d·∫•u l√† th√™m m·ªõi
    form.resetFields(); // X√≥a tr·∫Øng form
    setIsModalOpen(true); // M·ªü Modal
  };

  // --- H√ÄM KHI NH·∫§N N√öT L∆ØU TR√äN FORM (API POST) ---
  const handleOk = async () => {
    try {
      const values = await form.validateFields();

      // LOGIC PH√ÇN LU·ªíNG
      // N·∫øu editingId c√≥ gi√° tr·ªã th√¨ g·ªçi API s·ª≠a (PATCH)
      // N·∫øu editingID l√† null th√¨ g·ªçi API th√™m m·ªõi (POST)

      const url = editingId ? `/api/factories/${editingId}` : "/api/factories";
      const method = editingId ? "PATCH" : "POST";

      const res = await fetch(url, {
        method: method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(values),
      });

      if (res.ok) {
        message.success(
          editingId ? "C·∫≠p nh·∫≠t th√†nh c√¥ng!" : "Th√™m m·ªõi th√†nh c√¥ng!"
        );
        setIsModalOpen(false); // ƒê√≥ng Modal
        form.resetFields(); // X√≥a tr·∫Øng form
        setEditingId(null); // Reset tr·∫°ng th√°i
        fetchFactories(); // Load l·∫°i d·ªØ li·ªáu
      } else {
        message.error("C√≥ l·ªói x·∫£y ra...");
      }
    } catch (error) {
      console.log("Validation Failed: ", error);
    }
  };

  // --- PH·∫¶N 3: C·∫§U H√åNH B·∫¢NG (TABLE COLUMNS) ---
  const columns = [
    {
      title: "ID",
      dataIndex: "id",
      key: "id",
      width: 80,
    },
    {
      title: "M√£ Nh√† M√°y",
      dataIndex: "code",
      key: "code",
      render: (text: string) => <b>{text}</b>, // T√πy ch·ªânh CSS n·∫øu mu·ªën
    },
    {
      title: "T√™n Nh√† M√°y",
      dataIndex: "name",
      key: "name",
    },
    {
      title: "H√†nh ƒë·ªông",
      key: "action",
      render: (_: any, record: Factory) => (
        <Space size="middle">
          {/* N√öT S·ª¨A */}
          <Button
            type="text"
            icon={<EditOutlined />}
            style={{ color: "blue" }}
            onClick={() => handleEdit(record)}
          />
          {/* N√öT X√ìA C√ì X√ÅC NH·∫¨N */}
          <Popconfirm
            title="X√≥a nh√† m√°y n√†y?"
            description="H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c"
            onConfirm={() => handleDelete(record.id)}
            okText="X√≥a"
            cancelText="H·ªßy"
          >
            <Button type="text" icon={<DeleteOutlined />} danger />
          </Popconfirm>
        </Space>
      ),
    },
  ].filter((col) => {
    // N·∫øu l√† Leader V√Ä c·ªôt l√† 'action' -> Lo·∫°i b·ªè (return false)
    if (isViewOnly && col.key === "action") return false;
    return true;
  });

  // --- PH·∫¶N 4: GIAO DI·ªÜN NG∆Ø·ªúI D√ôNG (UI) ---
  return (
    <AdminLayout>
      <div
        style={{
          marginBottom: 16,
          display: "flex",
          justifyContent: "space-between",
        }}
      >
        <h2>Qu·∫£n l√Ω Nh√† m√°y</h2>
        {/* G·ªçi h√†m openAddModal thay v√¨ set tr·ª±c ti·∫øp */}

        {/* 3. Ch·ªâ hi·ªán n√∫t Th√™m m·ªõi n·∫øu ƒë∆∞·ª£c ph√©p s·ª≠a */}
        {!isViewOnly && (
          <Button type="primary" icon={<PlusOutlined />} onClick={openAddModal}>
            Th√™m Nh√† m√°y
          </Button>
        )}
      </div>

      {/* B·∫£ng d·ªØ li·ªáu */}
      <Table
        columns={columns}
        dataSource={factories}
        rowKey="id"
        loading={loading}
        bordered
      />

      {/* Modal nh·∫≠p li·ªáu */}
      <Modal
        title={editingId ? "C·∫≠p nh·∫≠t nh√† m√°y" : "Th√™m nh√† m√°y m·ªõi"}
        open={isModalOpen}
        onOk={handleOk}
        onCancel={() => setIsModalOpen(false)}
      >
        <Form form={form} layout="vertical" name="form_factory">
          <Form.Item
            name="code"
            label="M√£ Nh√† M√°y"
            rules={[{ required: true, message: "Vui l√≤ng nh·∫≠p m√£ nh√† m√°y!" }]}
          >
            <Input placeholder="V√≠ d·ª•: NM1" />
          </Form.Item>

          <Form.Item
            name="name"
            label="T√™n Nh√† M√°y"
            rules={[{ required: true, message: "Vui l√≤ng nh·∫≠p t√™n nh√† m√°y!" }]}
          >
            <Input placeholder="V√≠ d·ª•: Nh√† m√°y S·ª£i" />
          </Form.Item>
        </Form>
      </Modal>
    </AdminLayout>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\factories\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\globals.css
================================================================================
@import "tailwindcss";

:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\globals.css ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\help\page.tsx
================================================================================
"use client";

import React from "react";
import AdminLayout from "@/components/AdminLayout";
import { Typography, Card, Divider, Image } from "antd";

const { Title, Paragraph, Text } = Typography;

export default function ManualPage() {
  return (
    <AdminLayout>
      <div style={{ maxWidth: 800, margin: "0 auto" }}>
        <Card>
          <Typography>
            <Title level={2}>üìñ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng Ph·∫ßn m·ªÅm Ch·∫•m c√¥ng</Title>
            <Paragraph>
              Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi h·ªá th·ªëng HRM (Qu·∫£n l√Ω nh√¢n s·ª±), phi√™n b·∫£n
              V.1.0.0. Ph√°t tri·ªÉn b·ªüi Nguy·ªÖn Thi·ªán Minh Tr√≠. D∆∞·ªõi ƒë√¢y l√† c√°c
              b∆∞·ªõc c∆° b·∫£n ƒë·ªÉ s·ª≠ d·ª•ng ph·∫ßn m·ªÅm.
              <p>
                Click v√†o{" "}
                <a
                  href="https://drive.google.com/file/d/1JmZaeR7wq4_abRDmTU5nbUJz55K87JgB/view?usp=sharing"
                  target="_blank"
                >
                  ƒë∆∞·ªùng link n√†y
                </a>{" "}
                ƒë·ªÉ xem file h∆∞·ªõng d·∫´n chi ti·∫øt
              </p>
            </Paragraph>

            <Divider />

            {/* PH·∫¶N 1 */}
            <Title level={3}>1. C√°ch xem ch·∫•m c√¥ng h√†ng ng√†y</Title>
            <Paragraph>
              ƒê·ªÉ xem ch·∫•m c√¥ng, b·∫°n h√£y truy c·∫≠p v√†o menu{" "}
              <Text strong>T·ªïng h·ª£p c√¥ng</Text>
            </Paragraph>
            <Paragraph>
              <ul>
                <li>
                  Ch·ªçn <Text code>Th√°ng</Text> ƒë·∫øn <Text code>Nh√† m√°y</Text> v√†{" "}
                  <Text code>Ph√≤ng ban</Text>.
                </li>
                <li>H·ªá th·ªëng s·∫Ω hi·ªÉn th·ªã danh s√°ch nh√¢n vi√™n.</li>
                <li>Nh·ªØng √¥ m√†u xanh l√† ƒë√£ ƒëi l√†m, m√†u ƒë·ªè l√† v·∫Øng.</li>
              </ul>
            </Paragraph>

            {/* N·∫øu b·∫°n mu·ªën ch√®n ·∫£nh h∆∞·ªõng d·∫´n (b·ªè ·∫£nh v√†o th∆∞ m·ª•c public/images) */}
            {/* <Image src="/images/huong-dan-1.png" alt="·∫¢nh minh h·ªça" /> */}

            <Divider />

            {/* PH·∫¶N 2 */}
            <Title level={3}>2. Quy ƒë·ªãnh v·ªÅ c√°c k√Ω hi·ªáu</Title>
            <Paragraph>
              <ul>
                <li>
                  <Text strong>X:</Text> ƒêi l√†m c·∫£ ng√†y (C√¥ng 1.0)
                </li>
                <li>
                  <Text strong>X/2:</Text> ƒêi l√†m n·ª≠a ng√†y (C√¥ng 0.5)
                </li>
                <li>
                  <Text strong>P:</Text> Ngh·ªâ ph√©p nƒÉm
                </li>
                <li>
                  <Text strong>KL:</Text> Ngh·ªâ kh√¥ng l∆∞∆°ng
                </li>
                <Text italic>Xem th√™m ·ªü danh m·ª•c k√Ω hi·ªáu ch·∫•m c√¥ng</Text>
              </ul>
            </Paragraph>

            <Divider />

            {/* PH·∫¶N 3 */}
            <Paragraph>
              <Title level={3}>3. Th·ª±c hi·ªán ch·∫•m c√¥ng</Title>
              <Paragraph>
                ƒê·ªÉ th·ª±c hi·ªán ch·∫•m c√¥ng, b·∫°n h√£y truy c·∫≠p v√†o menu{" "}
                <Text strong>Ch·∫•m c√¥ng</Text>
              </Paragraph>
              <Paragraph>
                <ul>
                  <li>
                    Ch·ªçn <Text code>Ng√†y</Text> r·ªìi ch·ªçn{" "}
                    <Text code>Nh√† m√°y</Text> sau ƒë√≥ <Text code>Ph√≤ng ban</Text>
                    . N·∫øu kh√¥ng ch·ªçn ng√†y th√¨ m·∫∑c ƒë·ªãnh l·∫•y ng√†y h√¥m nay
                  </li>
                  <li>
                    H·ªá th·ªëng s·∫Ω hi·ªÉn th·ªã danh s√°ch nh√¢n vi√™n c·ªßa ph√≤ng ban ƒë∆∞·ª£c
                    ch·ªçn.
                  </li>
                  <li>
                    C√≥ th·ªÉ b·∫•m n√∫t t·∫•t c·∫£ ƒëi l√†m ƒë·ªÉ ch·∫•m nhanh, sau ƒë√≥ s·ª≠a l·∫°i
                    cho ph√π h·ª£p v·ªõi t·ª´ng ng∆∞·ªùi nh∆∞ l√†: ngh·ªâ ph√©p, ngh·ªâ ·ªëm,vv...
                    cho ph√π h·ª£p
                  </li>
                  <li>Sau ƒë√≥ nh·∫•n n√∫t L∆ØU B·∫¢NG C√îNG l√† xong.</li>
                </ul>
              </Paragraph>
            </Paragraph>

            <Divider />

            <Paragraph>
              <Text italic style={{ color: "red" }}>
                N·∫øu g·∫∑p l·ªói trong qu√° tr√¨nh s·ª≠ d·ª•ng, vui l√≤ng li√™n h·ªá b·ªô ph·∫≠n
                IT: Mr Tr√≠: 0984 857 190
              </Text>
            </Paragraph>
          </Typography>
        </Card>
      </div>
    </AdminLayout>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\help\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\layout.tsx
================================================================================
// src/app/layout.tsx
import React from "react";
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";
import StyledComponentsRegistry from "@/lib/AntdRegistry"; // Import v√†o
import { ConfigProvider } from "antd"; // C·∫•u h√¨nh thi·∫øt k·∫ø b·∫£ng d·ªØ li·ªáu

// 1. IMPORT C√ÅI N√ÄY V√ÄO
import SessionProviderWrapper from "@/components/SessionProviderWrapper";

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "HR Management App",
  description: "·ª®ng d·ª•ng qu·∫£n l√Ω nh√¢n s·ª±",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body className={inter.className}>
        {/* B·ªçc Registry ·ªü ƒë√¢y ƒë·ªÉ Ant Design ho·∫°t ƒë·ªông m∆∞·ª£t m√† */}
        <StyledComponentsRegistry>
          <SessionProviderWrapper>
            <ConfigProvider
              theme={{
                components: {
                  Table: {
                    // --- C·∫§U H√åNH M√ÄU S·∫ÆC B·∫¢NG ·ªû ƒê√ÇY ---
                    headerBg: "#12174A", // M√†u n·ªÅn Header (V√≠ d·ª•: Xanh ƒëen)
                    headerColor: "#ffffff", // M√†u ch·ªØ Header (Tr·∫Øng)
                    headerSortActiveBg: "#002140", // M√†u n·ªÅn khi c·ªôt ƒëang ƒë∆∞·ª£c sort
                    headerSortHoverBg: "#002140", // M√†u n·ªÅn khi di chu·ªôt v√†o header
                    rowHoverBg: "#A1E0FF", // M√†u n·ªÅn d√≤ng khi di chu·ªôt v√†o (t√πy ch·ªçn)
                  },
                },
              }}
            >
              {children}
            </ConfigProvider>
          </SessionProviderWrapper>
        </StyledComponentsRegistry>
      </body>
    </html>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\layout.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\login\page.tsx
================================================================================
"use client";

import React, { useState } from "react";
import { Form, Input, Button, Card, message, Typography } from "antd";
import { UserOutlined, LockOutlined } from "@ant-design/icons";
import { signIn } from "next-auth/react"; // H√†m ƒëƒÉng nh·∫≠p c·ªßa client
import { useRouter } from "next/navigation";
import Image from "next/image";

const { Title } = Typography;

export default function LoginPage() {
  const [loading, setLoading] = useState(false);
  const router = useRouter();

  const onFinish = async (values: any) => {
    setLoading(true);
    try {
      // G·ªçi h√†m ƒëƒÉng nh·∫≠p c·ªßa NextAuth
      const result = await signIn("credentials", {
        username: values.username,
        password: values.password,
        redirect: false, // Kh√¥ng t·ª± chuy·ªÉn trang ƒë·ªÉ m√¨nh t·ª± x·ª≠ l√Ω
      });

      if (result?.error) {
        message.error("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u");
      } else {
        message.success("ƒêƒÉng nh·∫≠p th√†nh c√¥ng!");
        router.push("/dashboard"); // Chuy·ªÉn h∆∞·ªõng v√†o trong
        router.refresh();
      }
    } catch (error) {
      message.error("L·ªói h·ªá th·ªëng");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div
      style={{
        height: "100vh",
        display: "flex",
        justifyContent: "center",
        alignItems: "center",
        background: "linear-gradient(135deg, #1890ff 0%, #001529 100%)", // M√†u xanh c√¥ng nghi·ªáp
      }}
    >
      <Card
        style={{
          width: 400,
          borderRadius: 10,
          boxShadow: "0 4px 12px rgba(0,0,0,0.2)",
        }}
      >
        <div
          style={{
            display: "flex", // 1. K√≠ch ho·∫°t Flexbox
            flexDirection: "column", // 2. X·∫øp c√°c ph·∫ßn t·ª≠ theo chi·ªÅu d·ªçc
            alignItems: "center", // 3. CƒÉn gi·ªØa theo chi·ªÅu ngang (Quan tr·ªçng!)
            marginBottom: 24,
          }}
        >
          <Image
            src="/image/logo/LogoSPB.png"
            alt="Logo"
            width={60} // Ch·ªânh ƒë·ªô r·ªông t√πy √Ω
            height={60} // Ch·ªânh ƒë·ªô cao t√πy √Ω
            style={{
              objectFit: "contain",
              marginBottom: 16, // Kho·∫£ng c√°ch v·ªõi d√≤ng ch·ªØ d∆∞·ªõi
            }}
            priority
          />
          <Title level={3} style={{ margin: 0 }}>
            QU·∫¢N L√ù CH·∫§M C√îNG
          </Title>
          <div style={{ color: "#888" }}>C√¥ng ty C·ªï ph·∫ßn S·ª£i Ph√∫ B√†i</div>
        </div>

        <Form name="login" onFinish={onFinish} layout="vertical" size="large">
          <Form.Item
            name="username"
            rules={[{ required: true, message: "Vui l√≤ng nh·∫≠p t√†i kho·∫£n!" }]}
          >
            <Input prefix={<UserOutlined />} placeholder="T√†i kho·∫£n" />
          </Form.Item>

          <Form.Item
            name="password"
            rules={[{ required: true, message: "Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u!" }]}
          >
            <Input.Password prefix={<LockOutlined />} placeholder="M·∫≠t kh·∫©u" />
          </Form.Item>

          <Form.Item>
            <Button type="primary" htmlType="submit" block loading={loading}>
              ƒêƒÇNG NH·∫¨P
            </Button>
          </Form.Item>
        </Form>
        <div style={{ textAlign: "center", fontSize: 12, color: "#999" }}>
          ¬© 2025 Phu Bai Spinning. Designed by Mr.Tri
        </div>
      </Card>
    </div>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\login\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\overtime\page.tsx
================================================================================
"use client";

import React, { useEffect, useState, useMemo } from "react";
import AdminLayout from "@/components/AdminLayout";
import { useSession } from "next-auth/react";
import {
    Card,
    Form,
    Select,
    DatePicker,
    Button,
    Table,
    Row,
    Col,
    Typography,
    message,
    Tag,
    Modal,
    Popconfirm,
    Tooltip,
    Input,
    Divider,
} from "antd";
import {
    PlusOutlined,
    ClockCircleOutlined,
    ReloadOutlined,
    EditOutlined,
    DeleteOutlined,
    UserOutlined,
    FilterOutlined,
} from "@ant-design/icons";
import dayjs from "dayjs";
import type { Dayjs } from "dayjs";

const { Title } = Typography;
const { RangePicker } = DatePicker;
const { TextArea } = Input;

// --- INTERFACES ---
interface Factory { id: number; name: string; }
interface Department { id: number; code: string; name: string; factory?: Factory; }
interface Employee { id: number; code: string; fullName: string; }
interface OvertimeRecord {
    id: number;
    content: string;
    startTime: string;
    endTime: string;
    totalMinutes: number;
    createdBy?: string;
    employeeId: number;
    employee: {
        fullName: string;
        code: string;
        departmentId: number;
        department: { id: number; name: string; factory: { name: string } };
    };
}

export default function OvertimePage() {
    const { data: session } = useSession();
    const [form] = Form.useForm();
    const [editForm] = Form.useForm();

    // --- STATE D·ªÆ LI·ªÜU ---
    const [departments, setDepartments] = useState<Department[]>([]);

    // State cho Form Nh·∫≠p li·ªáu (C·ªôt tr√°i)
    const [formEmployees, setFormEmployees] = useState<Employee[]>([]);
    const [selectedFormFactoryId, setSelectedFormFactoryId] = useState<number | null>(null);
    const [selectedFormDeptId, setSelectedFormDeptId] = useState<number | null>(null);

    // State cho Danh s√°ch Xem (C·ªôt ph·∫£i)
    const [records, setRecords] = useState<OvertimeRecord[]>([]);
    const [filterFactoryId, setFilterFactoryId] = useState<number | null>(null);
    const [filterDeptId, setFilterDeptId] = useState<number | null>(null);
    const [viewMonth, setViewMonth] = useState<Dayjs>(dayjs());

    const [loading, setLoading] = useState(false);
    const [isModalVisible, setIsModalVisible] = useState(false);
    const [editingRecord, setEditingRecord] = useState<OvertimeRecord | null>(null);

    // --- 1. LOAD DANH M·ª§C PH√íNG BAN ---
    useEffect(() => {
        fetch("/api/departments")
            .then((res) => res.json())
            .then(setDepartments)
            .catch(() => message.error("L·ªói t·∫£i danh m·ª•c"));
    }, []);

    // --- 2. LOGIC PH√ÇN QUY·ªÄN (QUAN TR·ªåNG) ---
    const userRole = session?.user?.role;
    const isStaff = userRole === "STAFF";
    const isManager = userRole === "TIMEKEEPER";
    const isAdmin = userRole === "ADMIN";

    // L·∫•y danh s√°ch c√°c ph√≤ng ban m√† User ƒë∆∞·ª£c ph√©p t√°c ƒë·ªông
    const authorizedDepartments = useMemo(() => {
        if (!session || departments.length === 0) return [];

        // Admin/Leader/HR: Th·∫•y h·∫øt
        if (["ADMIN", "HR_MANAGER", "LEADER"].includes(userRole as string)) {
            return departments;
        }

        // Staff/Timekeeper: Ch·ªâ th·∫•y ph√≤ng ƒë∆∞·ª£c ph√¢n c√¥ng
        if (isStaff || isManager) {
            const allowedIds = session.user.managedDeptIds || [];
            return departments.filter((d) => allowedIds.includes(d.id));
        }
        return [];
    }, [departments, session, userRole]);

    // L·ªçc ti·∫øp: Ch·ªâ l·∫•y c√°c ph√≤ng H√†nh ch√≠nh/Ph·ª• tr·ª£ (M√£ kh√¥ng b·∫Øt ƒë·∫ßu b·∫±ng s·ªë)
    const officeDepartments = useMemo(() => {
        return authorizedDepartments.filter(d => !/^\d/.test(d.code));
    }, [authorizedDepartments]);

    // L·∫•y danh s√°ch Nh√† m√°y t·ª´ c√°c ph√≤ng ban h·ª£p l·ªá ·ªü tr√™n
    const availableFactories = useMemo(() => {
        const map = new Map();
        officeDepartments.forEach((d) => {
            if (d.factory) map.set(d.factory.id, d.factory);
        });
        return Array.from(map.values()) as Factory[];
    }, [officeDepartments]);

    // --- 3. LOGIC T·ª∞ ƒê·ªòNG NH·∫¨N DI·ªÜN STAFF (TR√ÅNH CH·ªåN NH·∫¶M) ---
    useEffect(() => {
        const autoSelectForStaff = async () => {
            // Ch·ªâ ch·∫°y n·∫øu l√† STAFF v√† ch∆∞a ch·ªçn g√¨ c·∫£
            if (isStaff && session?.user && officeDepartments.length > 0) {
                try {
                    // L·∫•y danh s√°ch nh√¢n vi√™n c·ªßa t·∫•t c·∫£ ph√≤ng m√† Staff thu·ªôc v·ªÅ
                    // (Th∆∞·ªùng Staff ch·ªâ thu·ªôc 1 ph√≤ng, nh∆∞ng code h·ªó tr·ª£ nhi·ªÅu ph√≤ng)
                    const promises = officeDepartments.map(d =>
                        fetch(`/api/employees?departmentId=${d.id}`).then(r => r.json())
                    );
                    const results = await Promise.all(promises);
                    const allEmps: Employee[] = results.flat();

                    // T√¨m nh√¢n vi√™n c√≥ CODE tr√πng v·ªõi USERNAME (Ch√≠nh x√°c nh·∫•t)
                    // N·∫øu kh√¥ng th·∫•y th√¨ t√¨m theo T√™n (K√©m ch√≠nh x√°c h∆°n)
                    const me = allEmps.find(e =>
                        // L∆∞u √Ω: N·∫øu mu·ªën ch·∫Øc ch·∫Øn kh√¥ng l·ªói ch·ªØ hoa/th∆∞·ªùng th√¨ d√πng:
                        e.code.toLowerCase() === session.user.username.toLowerCase()
                    );

                    if (me) {
                        // T·ª± ƒë·ªông set d·ªØ li·ªáu v√†o Form
                        // C·∫ßn t√¨m department c·ªßa nh√¢n vi√™n ƒë√≥ ƒë·ªÉ set Factory v√† Dept
                        const myDept = officeDepartments.find(d =>
                            // Logic t√¨m ph√≤ng h∆°i ph·ª©c t·∫°p v√¨ API employee tr·∫£ v·ªÅ dept ri√™ng
                            // N√™n ta t√¨m trong allEmps xem employee n√†y thu·ªôc deptId n√†o
                            // Gi·∫£ s·ª≠ API employee c√≥ tr·∫£ departmentId, ·ªü ƒë√¢y ta l√†m ƒë∆°n gi·∫£n:
                            true
                        ); // ·ªû b∆∞·ªõc n√†y ta ch·ªâ c·∫ßn set EmployeeID l√† ƒë·ªß ƒë·ªÉ submit

                        // ƒê·ªÉ hi·ªÉn th·ªã ƒë·∫πp, ta set list nh√¢n vi√™n ch·ªâ c√≥ 1 m√¨nh ng∆∞·ªùi ƒë√≥
                        setFormEmployees([me]);
                        form.setFieldsValue({ employeeId: me.id });

                        // (T√πy ch·ªçn) N·∫øu mu·ªën fill c·∫£ Factory/Dept th√¨ c·∫ßn logic ph·ª©c t·∫°p h∆°n ch√∫t,
                        // nh∆∞ng v·ªõi y√™u c·∫ßu c·ªßa b·∫°n th√¨ ch·ªâ c·∫ßn kh√≥a √¥ Nh√¢n vi√™n l√† ƒë∆∞·ª£c.
                    }
                } catch (e) { console.error(e); }
            }
        };
        autoSelectForStaff();
    }, [isStaff, officeDepartments, session]);

    // --- 4. HANDLERS FORM NH·∫¨P (C·ªòT TR√ÅI) ---
    const handleFormFactoryChange = (val: number) => {
        setSelectedFormFactoryId(val);
        setSelectedFormDeptId(null);
        setFormEmployees([]);
        form.setFieldsValue({ departmentId: null, employeeId: null });
    };

    const handleFormDeptChange = async (deptId: number) => {
        setSelectedFormDeptId(deptId);
        form.setFieldsValue({ employeeId: null });
        try {
            const res = await fetch(`/api/employees?departmentId=${deptId}`);
            setFormEmployees(await res.json());
        } catch (e) { message.error("L·ªói t·∫£i nh√¢n vi√™n"); }
    };

    const handleCreate = async (values: any) => {
        if (!session?.user?.name) return;
        setLoading(true);
        try {
            const res = await fetch("/api/overtime", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    employeeId: values.employeeId,
                    content: values.content,
                    startTime: values.timeRange[0],
                    endTime: values.timeRange[1],
                    createdBy: session.user.username, // L∆∞u ng∆∞·ªùi t·∫°o
                }),
            });

            if (res.ok) {
                message.success("ƒê√£ l∆∞u th√†nh c√¥ng!");
                form.resetFields(["content", "timeRange"]);
                // N·∫øu kh√¥ng ph·∫£i STAFF th√¨ reset c·∫£ nh√¢n vi√™n ƒë·ªÉ nh·∫≠p ng∆∞·ªùi ti·∫øp theo
                if (!isStaff) {
                    form.resetFields(["employeeId"]);
                }
                // Reload danh s√°ch b√™n ph·∫£i n·∫øu ƒëang xem ƒë√∫ng ph√≤ng ƒë√≥
                if (filterDeptId) loadRecords(filterDeptId);
            } else {
                message.error("L·ªói khi l∆∞u");
            }
        } catch (e) { message.error("L·ªói k·∫øt n·ªëi"); } finally { setLoading(false); }
    };

    // --- 5. HANDLERS DANH S√ÅCH (C·ªòT PH·∫¢I) ---
    const loadRecords = async (deptId: number | null) => {
        if (!deptId) { setRecords([]); return; }
        try {
            const m = viewMonth.month() + 1;
            const y = viewMonth.year();
            const res = await fetch(`/api/overtime?departmentId=${deptId}&month=${m}&year=${y}`);
            setRecords(await res.json());
        } catch (e) { message.error("L·ªói t·∫£i d·ªØ li·ªáu"); }
    };

    // T·ª± ƒë·ªông reload khi ƒë·ªïi th√°ng ho·∫∑c ƒë·ªïi ph√≤ng xem
    useEffect(() => {
        if (filterDeptId) loadRecords(filterDeptId);
    }, [viewMonth]);

    // --- 6. X·ª¨ L√ù S·ª¨A / X√ìA ---
    const handleDelete = async (id: number) => {
        const res = await fetch(`/api/overtime?id=${id}`, { method: "DELETE" });
        if (res.ok) {
            message.success("ƒê√£ x√≥a");
            setRecords((prev) => prev.filter((r) => r.id !== id));
        } else message.error("L·ªói x√≥a");
    };

    const handleUpdate = async () => {
        const values = await editForm.validateFields();
        const res = await fetch("/api/overtime", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                id: editingRecord?.id,
                content: values.content,
                startTime: values.timeRange[0],
                endTime: values.timeRange[1],
            }),
        });
        if (res.ok) {
            message.success("C·∫≠p nh·∫≠t xong");
            setIsModalVisible(false);
            if (filterDeptId) loadRecords(filterDeptId);
        } else message.error("L·ªói c·∫≠p nh·∫≠t");
    };

    // --- COLUMNS ---
    const columns = [
        { title: "Ng√†y", dataIndex: "startTime", width: 90, render: (d: string) => dayjs(d).format("DD/MM") },
        { title: "Nh√¢n vi√™n", dataIndex: ["employee", "fullName"], render: (t: string) => <b>{t}</b> },
        { title: "N·ªôi dung", dataIndex: "content" },
        {
            title: "Gi·ªù", width: 110, render: (_: any, r: OvertimeRecord) => (
                <div style={{ fontSize: 11 }}>
                    <span style={{ color: "green" }}>{dayjs(r.startTime).format("HH:mm")}</span> - <span style={{ color: "red" }}>{dayjs(r.endTime).format("HH:mm")}</span>
                </div>
            )
        },
        {
            title: "T·ªïng", dataIndex: "totalMinutes", align: "center" as const, width: 70, render: (m: number) => {
                const h = Math.floor(m / 60); const min = m % 60; return <Tag color="blue">{h}h{min}</Tag>;
            }
        },
        {
            title: <UserOutlined />, dataIndex: "createdBy", width: 70, align: 'center' as const,
            render: (u: string) => <span style={{ fontSize: 10, color: '#999' }}>{u}</span>
        },
        {
            title: "", width: 80, align: "center" as const,
            render: (_: any, r: OvertimeRecord) => {
                // [LOGIC PH√ÇN QUY·ªÄN N√öT S·ª¨A/X√ìA]
                const checkAdmin = isAdmin;
                const checkOwner = session?.user?.username === r.createdBy;
                // Check Manager: Ph·∫£i l√† Timekeeper V√Ä ƒëang qu·∫£n l√Ω ph√≤ng c·ªßa nh√¢n vi√™n n√†y
                const managedIds = session?.user?.managedDeptIds || [];
                const checkManager = isManager && managedIds.includes(r.employee.departmentId);

                if (checkAdmin || checkOwner || checkManager) {
                    return (
                        <div style={{ display: "flex", gap: 8, justifyContent: "center" }}>
                            <Tooltip title="S·ª≠a"><Button type="text" icon={<EditOutlined style={{ color: "orange" }} />} size="small" onClick={() => { setEditingRecord(r); editForm.setFieldsValue({ content: r.content, timeRange: [dayjs(r.startTime), dayjs(r.endTime)] }); setIsModalVisible(true); }} /></Tooltip>
                            <Popconfirm title="X√≥a?" onConfirm={() => handleDelete(r.id)}><Button type="text" danger icon={<DeleteOutlined />} size="small" /></Popconfirm>
                        </div>
                    );
                }
                return null;
            },
        },
    ];

    // Danh s√°ch ph√≤ng ban cho Dropdown b√™n Form nh·∫≠p li·ªáu (L·ªçc theo Factory ƒë√£ ch·ªçn)
    const formDepts = useMemo(() => {
        if (!selectedFormFactoryId) return [];
        return officeDepartments.filter(d => d.factory?.id === selectedFormFactoryId);
    }, [officeDepartments, selectedFormFactoryId]);

    // Danh s√°ch ph√≤ng ban cho Dropdown b√™n Danh s√°ch xem (L·ªçc theo Factory ƒë√£ ch·ªçn)
    const filterDepts = useMemo(() => {
        if (!filterFactoryId) return [];
        return officeDepartments.filter(d => d.factory?.id === filterFactoryId);
    }, [officeDepartments, filterFactoryId]);


    return (
        <AdminLayout>
            <Title level={3}>Ghi nh·∫≠n l√†m th√™m gi·ªù (OT)</Title>

            <Row gutter={16}>
                {/* === C·ªòT TR√ÅI: FORM NH·∫¨P LI·ªÜU === */}
                <Col xs={24} md={8}>
                    <Card title={<span><PlusOutlined /> Nh·∫≠p li·ªáu m·ªõi</span>} bordered={false}>
                        <Form layout="vertical" form={form} onFinish={handleCreate}>

                            {/* N·∫øu l√† STAFF -> ·∫®n ch·ªçn NM/Ph√≤ng -> Ch·ªâ hi·ªán t√™n m√¨nh */}
                            {isStaff ? (
                                <>
                                    <Form.Item label="Nh√¢n vi√™n" tooltip="H·ªá th·ªëng t·ª± ƒë·ªông nh·∫≠n di·ªán b·∫°n">
                                        <Select disabled value={form.getFieldValue("employeeId")}>
                                            {formEmployees.map(e => <Select.Option key={e.id} value={e.id}>{e.fullName}</Select.Option>)}
                                        </Select>
                                    </Form.Item>
                                    {/* Input ·∫©n ƒë·ªÉ ƒë·∫£m b·∫£o validator ho·∫°t ƒë·ªông n·∫øu select disabled kh√¥ng g·ª≠i value */}
                                    <Form.Item name="employeeId" hidden rules={[{ required: true, message: "Kh√¥ng t√¨m th·∫•y th√¥ng tin nh√¢n vi√™n c·ªßa b·∫°n" }]}><Input /></Form.Item>
                                </>
                            ) : (
                                <>
                                    {/* Admin & Manager ƒë∆∞·ª£c ch·ªçn t·ª± do trong ph·∫°m vi quy·ªÅn h·∫°n */}
                                    <Form.Item label="Nh√† m√°y">
                                        <Select placeholder="Ch·ªçn Nh√† m√°y..." onChange={handleFormFactoryChange}>
                                            {availableFactories.map(f => <Select.Option key={f.id} value={f.id}>{f.name}</Select.Option>)}
                                        </Select>
                                    </Form.Item>
                                    <Form.Item label="Ph√≤ng ban" name="departmentId" rules={[{ required: true }]}>
                                        <Select placeholder="Ch·ªçn ph√≤ng..." onChange={handleFormDeptChange} disabled={!selectedFormFactoryId} showSearch optionFilterProp="children">
                                            {formDepts.map(d => <Select.Option key={d.id} value={d.id}>{d.name}</Select.Option>)}
                                        </Select>
                                    </Form.Item>
                                    <Form.Item label="Nh√¢n vi√™n" name="employeeId" rules={[{ required: true }]}>
                                        <Select placeholder="Ch·ªçn nh√¢n vi√™n..." disabled={!selectedFormDeptId} showSearch optionFilterProp="children">
                                            {formEmployees.map(e => <Select.Option key={e.id} value={e.id}>{e.fullName} ({e.code})</Select.Option>)}
                                        </Select>
                                    </Form.Item>
                                </>
                            )}

                            <Form.Item label="Th·ªùi gian" name="timeRange" rules={[{ required: true }]}>
                                <RangePicker showTime={{ format: "HH:mm" }} format="DD/MM/YYYY HH:mm" style={{ width: "100%" }} />
                            </Form.Item>
                            <Form.Item label="N·ªôi dung" name="content" rules={[{ required: true }]}>
                                <TextArea rows={2} placeholder="N·ªôi dung c√¥ng vi·ªác..." />
                            </Form.Item>
                            <Button type="primary" htmlType="submit" block loading={loading} icon={<ClockCircleOutlined />}>L∆∞u b·∫£n ghi</Button>
                        </Form>
                    </Card>
                </Col>

                {/* === C·ªòT PH·∫¢I: DANH S√ÅCH XEM & L·ªåC === */}
                <Col xs={24} md={16}>
                    <Card bordered={false}>
                        {/* B·ªô l·ªçc xem ri√™ng bi·ªát */}
                        <div style={{ marginBottom: 16, padding: 12, background: "#f9f9f9", borderRadius: 8, border: "1px solid #eee" }}>
                            <div style={{ fontWeight: 600, marginBottom: 8, color: '#1890ff' }}><FilterOutlined /> B·ªô l·ªçc danh s√°ch:</div>
                            <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>
                                <Select
                                    placeholder="Ch·ªçn Nh√† m√°y" style={{ width: 150 }}
                                    onChange={(val) => { setFilterFactoryId(val); setFilterDeptId(null); setRecords([]); }}
                                >
                                    {availableFactories.map(f => <Select.Option key={f.id} value={f.id}>{f.name}</Select.Option>)}
                                </Select>
                                <Select
                                    placeholder="Ch·ªçn Ph√≤ng ban ƒë·ªÉ xem" style={{ flex: 1, minWidth: 200 }}
                                    disabled={!filterFactoryId}
                                    onChange={(val) => { setFilterDeptId(val); loadRecords(val); }}
                                >
                                    {filterDepts.map(d => <Select.Option key={d.id} value={d.id}>{d.name}</Select.Option>)}
                                </Select>
                                <DatePicker picker="month" value={viewMonth} onChange={(val) => val && setViewMonth(val)} format="MM/YYYY" allowClear={false} style={{ width: 110 }} />
                            </div>
                        </div>

                        {!filterDeptId ? (
                            <div style={{ textAlign: "center", color: "#999", padding: 40, border: '1px dashed #ddd', borderRadius: 8 }}>
                                Vui l√≤ng ch·ªçn Ph√≤ng ban b√™n tr√™n ƒë·ªÉ xem d·ªØ li·ªáu
                            </div>
                        ) : (
                            <Table dataSource={records} columns={columns} rowKey="id" pagination={{ pageSize: 8 }} size="small" />
                        )}
                    </Card>
                </Col>
            </Row>

            <Modal title="S·ª≠a th√¥ng tin" open={isModalVisible} onOk={handleUpdate} onCancel={() => setIsModalVisible(false)} okText="C·∫≠p nh·∫≠t" cancelText="H·ªßy">
                <Form form={editForm} layout="vertical">
                    <div style={{ marginBottom: 16 }}><b>Nh√¢n vi√™n:</b> {editingRecord?.employee.fullName}</div>
                    <Form.Item label="Th·ªùi gian m·ªõi" name="timeRange" rules={[{ required: true }]}><RangePicker showTime={{ format: "HH:mm" }} format="DD/MM/YYYY HH:mm" style={{ width: "100%" }} /></Form.Item>
                    <Form.Item label="N·ªôi dung" name="content" rules={[{ required: true }]}><TextArea rows={3} /></Form.Item>
                </Form>
            </Modal>
        </AdminLayout>
    );
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\overtime\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\page.tsx
================================================================================
// src/app/page.tsx
"use client";
import AdminLayout from "@/components/AdminLayout";
import { useSession } from "next-auth/react";
import { Typography, Space } from "antd";
import {
  CheckCircleTwoTone,
  SafetyCertificateTwoTone,
  DashboardTwoTone
} from "@ant-design/icons";

const { Title, Text } = Typography;

export default function Home() {
  const { data: session } = useSession();
  const userName = session?.user?.fullName || session?.user?.name || session?.user?.username || "b·∫°n";

  return (
    <AdminLayout>
      <div
        style={{
          width: "100%",
          minHeight: "85vh",
          display: "flex",
          flexDirection: "column",
          alignItems: "center",
          justifyContent: "center",
          // N·ªÅn gradient xanh nh·∫°t sang tr·∫Øng (r·∫•t d·ªãu m·∫Øt v√† chuy√™n nghi·ªáp)
          background: "linear-gradient(135deg, #f0f5ff 0%, #ffffff 100%)",
          borderRadius: "16px",
          padding: "20px",
          border: "1px solid #e6f0ff",
        }}
      >
        {/* KH·ªêI N·ªòI DUNG CH√çNH (White Card) */}
        <div
          style={{
            background: "#ffffff",
            padding: "50px 60px",
            borderRadius: "24px",
            boxShadow: "0 20px 40px rgba(0, 58, 140, 0.08)", // ƒê·ªï b√≥ng xanh nh·∫°t
            textAlign: "center",
            maxWidth: "800px",
            width: "100%",
            border: "1px solid #f0f0f0",
          }}
        >
          {/* L·ªúI CH√ÄO C√Å NH√ÇN */}
          <div
            style={{
              display: "inline-block",
              padding: "8px 24px",
              background: "#e6f4ff", // N·ªÅn xanh ant design
              color: "#1677ff",
              borderRadius: "50px",
              fontWeight: 600,
              fontSize: "16px",
              marginBottom: "24px",
              border: "1px solid #91caff",
            }}
          >
            üëã Xin ch√†o, <span style={{ color: "#d9363e", fontWeight: "bold" }}>{userName}</span>!
          </div>

          {/* TI√äU ƒê·ªÄ CH√çNH */}
          <h1
            style={{
              fontSize: "32px",
              fontWeight: 800,
              color: "#003a8c",
              marginBottom: "16px",
              lineHeight: 1.4,
              textTransform: "uppercase",
            }}
          >
            H·ªá th·ªëng Qu·∫£n l√Ω Nh√¢n s·ª± <br />
            <span style={{ color: "#1677ff", fontSize: "38px" }}>C√¥ng ty CP S·ª£i Ph√∫ B√†i</span>
          </h1>

          {/* L·ªúI D·∫™N */}
          <p style={{ fontSize: "18px", color: "#595959", marginBottom: "40px" }}>
            Ch√∫c b·∫°n m·ªôt ng√†y l√†m vi·ªác hi·ªáu qu·∫£. Vui l√≤ng ch·ªçn c√°c ch·ª©c nƒÉng tr√™n thanh menu b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu.
          </p>

          {/* C√ÅC ICON TRANG TR√ç (Hi·ªÉn th·ªã t√≠nh nƒÉng h·ªá th·ªëng) */}
          <div style={{ display: "flex", justifyContent: "center", gap: "50px", marginTop: "20px" }}>
            <div style={{ textAlign: "center" }}>
              <DashboardTwoTone twoToneColor="#1677ff" style={{ fontSize: "36px", marginBottom: "12px" }} />
              <div style={{ color: "#8c8c8c", fontSize: "14px", fontWeight: 500 }}>Tr·ª±c quan</div>
            </div>
            <div style={{ textAlign: "center" }}>
              <CheckCircleTwoTone twoToneColor="#52c41a" style={{ fontSize: "36px", marginBottom: "12px" }} />
              <div style={{ color: "#8c8c8c", fontSize: "14px", fontWeight: 500 }}>Ch√≠nh x√°c</div>
            </div>
            <div style={{ textAlign: "center" }}>
              <SafetyCertificateTwoTone twoToneColor="#faad14" style={{ fontSize: "36px", marginBottom: "12px" }} />
              <div style={{ color: "#8c8c8c", fontSize: "14px", fontWeight: 500 }}>B·∫£o m·∫≠t</div>
            </div>
          </div>

        </div>
      </div>
    </AdminLayout>
  );
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\timesheets\daily\page.tsx
================================================================================
"use client";

import React, { useEffect, useState, useMemo } from "react";
import AdminLayout from "@/components/AdminLayout";
import { useSession } from "next-auth/react";
import {
    Table,
    Select,
    Button,
    message,
    Input,
    Tag,
    Space,
    Typography,
    Alert,
} from "antd";
import { SaveOutlined } from "@ant-design/icons";
import dayjs from "dayjs";

// [QUAN TR·ªåNG] Import Component l·ªçc d√πng chung
import CommonFilter, { FilterResult } from "@/components/CommonFilter";

const { Title } = Typography;

// --- INTERFACES ---
interface AttendanceCode {
    id: number;
    code: string;
    name: string;
    color: string;
}

interface TimesheetRow {
    employeeId: number;
    employeeCode: string;
    fullName: string;
    attendanceCodeId: number | null;
    note: string;
    updatedAt?: string;
    departmentName?: string;
    kipName?: string;
}

export default function DailyTimesheetPage() {
    const { data: session } = useSession();

    // 1. [S·ª¨A ƒê·ªîI QUAN TR·ªåNG] Logic x√°c ƒë·ªãnh ch·∫ø ƒë·ªô "Ch·ªâ xem"
    // N·∫øu l√† LEADER ho·∫∑c STAFF th√¨ b·∫≠t ch·∫ø ƒë·ªô Ch·ªâ xem (·∫®n n√∫t L∆∞u, Kh√≥a nh·∫≠p li·ªáu)
    const isViewOnly = ["LEADER", "STAFF"].includes(session?.user?.role as string);

    // --- STATE ---
    const [employees, setEmployees] = useState<TimesheetRow[]>([]);
    const [attendanceCodes, setAttendanceCodes] = useState<AttendanceCode[]>([]);
    const [loading, setLoading] = useState(false);
    const [saving, setSaving] = useState(false);

    // L∆∞u tr·ªØ k·∫øt qu·∫£ l·ªçc hi·ªán t·∫°i ƒë·ªÉ d√πng cho h√†m Save v√† Reload
    const [currentFilter, setCurrentFilter] = useState<FilterResult | null>(null);

    // 1. Ch·ªâ c·∫ßn t·∫£i danh s√°ch M√£ c√¥ng (Danh m·ª•c Ph√≤ng/K√≠p ƒë√£ do CommonFilter lo)
    useEffect(() => {
        const fetchCodes = async () => {
            try {
                const res = await fetch("/api/attendance-codes");
                const codes: AttendanceCode[] = await res.json();

                // S·∫Øp x·∫øp m√£ c√¥ng theo ∆∞u ti√™n
                const PRIORITY = ["+", "XD", "ƒêC", "X/2", "F", "NB", "√î", "XL", "L", "TS"];
                codes.sort((a, b) => {
                    const iA = PRIORITY.indexOf(a.code), iB = PRIORITY.indexOf(b.code);
                    if (iA !== -1 && iB !== -1) return iA - iB;
                    if (iA !== -1) return -1;
                    if (iB !== -1) return 1;
                    return a.code.localeCompare(b.code);
                });
                setAttendanceCodes(codes);
            } catch (error) {
                message.error("L·ªói t·∫£i m√£ ch·∫•m c√¥ng");
            }
        };
        fetchCodes();
    }, []);

    // --- H√ÄM T·∫¢I D·ªÆ LI·ªÜU (G·ªçi m·ªói khi b·ªô l·ªçc thay ƒë·ªïi) ---
    const fetchTimesheetData = async (filter: FilterResult) => {
        // N·∫øu ch∆∞a ch·ªçn ph√≤ng ban n√†o -> X√≥a b·∫£ng
        if (!filter.realDepartmentIds || filter.realDepartmentIds.length === 0) {
            setEmployees([]);
            return;
        }

        setLoading(true);
        try {
            const dateStr = filter.date.format("YYYY-MM-DD");
            // G·ª≠i danh s√°ch ID ph√≤ng ban ƒë√£ ƒë∆∞·ª£c CommonFilter gi·∫£i m√£ (VD: 15,16,17)
            const deptParam = filter.realDepartmentIds.join(",");

            const url = `/api/timesheets/daily?date=${dateStr}&departmentId=${deptParam}`;

            const res = await fetch(url);
            if (!res.ok) throw new Error("L·ªói t·∫£i");
            const data = await res.json();
            setEmployees(data);
        } catch (error) {
            message.error("L·ªói t·∫£i d·ªØ li·ªáu");
            setEmployees([]);
        } finally {
            setLoading(false);
        }
    };

    // --- CALLBACK T·ª™ COMPONENT L·ªåC ---
    const handleFilterChange = (result: FilterResult) => {
        setCurrentFilter(result); // L∆∞u state ƒë·ªÉ d√πng khi Save
        fetchTimesheetData(result); // G·ªçi API
    };

    // --- H√ÄM L∆ØU D·ªÆ LI·ªÜU ---
    const handleSave = async () => {
        if (!currentFilter || employees.length === 0) return;

        // [S·ª¨A ƒê·ªîI] KH√îNG d√πng .filter lo·∫°i b·ªè null n·ªØa. 
        // G·ª≠i to√†n b·ªô danh s√°ch hi·ªÉn th·ªã tr√™n m√†n h√¨nh l√™n Server.
        const recordsToSend = employees.map((e) => ({
            employeeId: e.employeeId,
            attendanceCodeId: e.attendanceCodeId || null, // N·∫øu b·ªã x√≥a tr·∫Øng th√¨ g·ª≠i l√™n l√† null
            note: e.note || "",
        }));

        setSaving(true);
        try {
            // Logic x√°c ƒë·ªãnh ID ph√≤ng ban ƒë·ªÉ check kh√≥a s·ªï
            const payloadDeptId = currentFilter.realDepartmentIds.length === 1
                ? currentFilter.realDepartmentIds[0]
                : null;

            const payload = {
                date: currentFilter.date.format("YYYY-MM-DD"),
                departmentId: payloadDeptId,
                records: recordsToSend,
            };

            const res = await fetch("/api/timesheets/daily", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });

            if (res.ok) {
                // ƒê·∫øm nh·ªØng ng∆∞·ªùi th·ª±c s·ª± ƒë∆∞·ª£c ch·∫•m c√¥ng ƒë·ªÉ hi·ªán th√¥ng b√°o cho ƒë·∫πp
                const validCount = recordsToSend.filter(r => r.attendanceCodeId !== null).length;
                message.success(`ƒê√£ l∆∞u b·∫£ng c√¥ng! (C√≥ ${validCount} ng∆∞·ªùi ƒë∆∞·ª£c ch·∫•m)`);

                fetchTimesheetData(currentFilter); // T·∫£i l·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t updatedAt
            } else {
                const err = await res.json();
                message.error(res.status === 403 ? `KH√ìA S·ªî: ${err.error}` : err.error || "L·ªói l∆∞u");
            }
        } catch (error) {
            message.error("L·ªói k·∫øt n·ªëi");
        } finally {
            setSaving(false);
        }
    };

    // --- HELPERS (Logic UI n·ªôi b·ªô) ---
    const handleRowChange = (empId: number, field: string, value: any) => {
        const newData = [...employees];
        const index = newData.findIndex((i) => i.employeeId === empId);
        if (index > -1) {
            newData[index] = { ...newData[index], [field]: value };
            setEmployees(newData);
        }
    };

    const setAllStatus = (codeStr: string) => {
        const targetCode = attendanceCodes.find((c) => c.code === codeStr);
        if (!targetCode) return;
        setEmployees(employees.map((e) => ({ ...e, attendanceCodeId: targetCode.id })));
    };

    const timesheetStatus = useMemo(() => {
        if (employees.length === 0) return null;
        const hasData = employees.some((e) => e.attendanceCodeId !== null);
        const lastUpdate = employees.find((e) => e.updatedAt)?.updatedAt;
        return {
            isSubmitted: hasData,
            lastUpdate: lastUpdate ? dayjs(lastUpdate).format("HH:mm - DD/MM/YYYY") : null,
        };
    }, [employees]);

    // --- COLUMNS ---
    const columns = [
        {
            title: "STT",
            key: "index",
            width: 50,
            align: "center" as const,
            render: (_: any, __: any, index: number) => <span style={{ color: "#888" }}>{index + 1}</span>,
        },
        { title: "H·ªç v√† t√™n", dataIndex: "fullName", width: 220 },
        {
            title: "B·ªô ph·∫≠n",
            key: "deptInfo",
            width: 150,
            render: (_: any, record: TimesheetRow) => (
                <div style={{ fontSize: 12 }}>
                    {record.kipName ? (
                        <Tag color="blue">{record.kipName}</Tag>
                    ) : (
                        <Tag>{record.departmentName}</Tag>
                    )}
                </div>
            ),
        },
        {
            title: "Tr·∫°ng th√°i",
            dataIndex: "attendanceCodeId",
            width: 200,
            render: (value: number, record: TimesheetRow) => (
                <Select
                    value={value}
                    allowClear
                    style={{ width: "100%" }}
                    placeholder="Ch·ªçn"
                    disabled={isViewOnly} // KH√ìA NH·∫¨P LI·ªÜU N·∫æU L√Ä STAFF/LEADER
                    onChange={(val) => handleRowChange(record.employeeId, "attendanceCodeId", val)}
                    options={attendanceCodes.map((c) => ({
                        value: c.id,
                        label: `${c.code} - ${c.name}`,
                        item: c,
                    }))}
                    optionRender={(opt) => (
                        <Space>
                            <Tag color={opt.data.item.color} style={{ fontWeight: "bold", minWidth: 40, textAlign: "center" }}>
                                {opt.data.item.code}
                            </Tag>
                            {opt.data.item.name}
                        </Space>
                    )}
                    labelRender={(props) => {
                        const c = attendanceCodes.find((x) => x.id === props.value);
                        return c ? (
                            <Tag color={c.color} style={{ fontWeight: "bold", width: "100%", textAlign: "center" }}>
                                {c.code} - {c.name}
                            </Tag>
                        ) : (props.label);
                    }}
                />
            ),
        },
        {
            title: "Ghi ch√∫",
            dataIndex: "note",
            render: (txt: string, rec: TimesheetRow) => (
                <Input
                    value={txt}
                    disabled={isViewOnly} // KH√ìA NH·∫¨P LI·ªÜU
                    onChange={(e) => handleRowChange(rec.employeeId, "note", e.target.value)}
                    placeholder="..."
                />
            ),
        },
    ];

    return (
        <AdminLayout>
            <Title level={3} style={{ marginBottom: 24 }}>Ch·∫•m c√¥ng h√†ng ng√†y</Title>

            {/* --- S·ª¨ D·ª§NG COMPONENT L·ªåC D√ôNG CHUNG --- */}
            <CommonFilter
                dateMode="date"
                onFilterChange={handleFilterChange}
            />

            {/* --- PH·∫¶N HI·ªÇN TH·ªä TR·∫†NG TH√ÅI --- */}
            {employees.length > 0 && (
                <div style={{ marginBottom: 16 }}>
                    {timesheetStatus?.isSubmitted ? (
                        <Alert
                            message={`ƒê√£ ch·∫•m c√¥ng (C·∫≠p nh·∫≠t: ${timesheetStatus.lastUpdate})`}
                            type="success"
                            showIcon
                        />
                    ) : (
                        <Alert message="Ch∆∞a c√≥ d·ªØ li·ªáu." type="info" showIcon />
                    )}
                </div>
            )}

            {employees.length > 0 ? (
                <>
                    {/* Thanh c√¥ng c·ª•: Ch·ªâ hi·ªán n·∫øu KH√îNG PH·∫¢I l√† ViewOnly */}
                    {!isViewOnly ? (
                        <div style={{ marginBottom: 16, display: "flex", justifyContent: "space-between" }}>
                            <Space>
                                <span style={{ fontWeight: 600 }}>Thao t√°c nhanh:</span>
                                <Button size="small" onClick={() => setAllStatus("+")}>ƒêi l√†m (+)</Button>
                                <Button size="small" onClick={() => setAllStatus("XD")}>L√†m ca ƒë√™m (XD)</Button>
                                <Button size="small" onClick={() => setAllStatus("ƒêC")}>ƒê·∫£o ca (ƒêC)</Button>
                                <Button size="small" onClick={() => setAllStatus("L")}>Ngh·ªâ l·ªÖ (L)</Button>
                                <Button size="small" onClick={() => setAllStatus("F")}>Ngh·ªâ F (F)</Button>
                            </Space>

                            <Button type="primary" icon={<SaveOutlined />} onClick={handleSave} loading={saving}>
                                L∆ØU D·ªÆ LI·ªÜU
                            </Button>
                        </div>
                    ) : (
                        <div style={{ marginBottom: 16, fontStyle: "italic", color: "#888" }}>
                            * B·∫°n ƒëang ·ªü ch·∫ø ƒë·ªô xem, kh√¥ng c√≥ quy·ªÅn ch·ªânh s·ª≠a b·∫£ng c√¥ng.
                        </div>
                    )}

                    <Table
                        bordered
                        dataSource={employees}
                        columns={columns}
                        rowKey="employeeId"
                        loading={loading}
                        pagination={false}
                        scroll={{ y: 600 }}
                        size="middle"
                    />
                </>
            ) : (
                <div style={{ textAlign: "left", padding: "50px", color: "#999", background: "#fff", border: "1px dashed #ddd" }}>
                    <b>H∆∞·ªõng d·∫´n:</b> <br />
                    <b>B∆∞·ªõc 1:</b> Ch·ªçn ng√†y c·∫ßn ch·∫•m <br />
                    <b>B∆∞·ªõc 2:</b> Ch·ªçn nh√† m√°y c√≥ ph√≤ng ban hay t·ªï m√¨nh c·∫ßn ch·∫•m. <br />
                    <b>B∆∞·ªõc 3:</b> Ch·ªçn Ph√≤ng ban ho·∫∑c T·ªï, n·∫øu l√† ca k√≠p th√¨ ch·ªçn t·ªï c·ªßa k√≠p c·∫ßn ch·∫•m (v√≠ d·ª• t·ªï b√¥ng ch·∫£i, t·ªï gh√©p th√¥, t·ªï s·ª£i con, vv...) <br />
                    <b>B∆∞·ªõc 4:</b> Sau khi ch·ªçn t·ªï th√¨ t·∫•t c·∫£ nh√¢n vi√™n c·ªßa 7 k√≠p ho·∫∑c 10 k√≠p s·∫Ω hi·ªán ra c√πng l√∫c, l√∫c n√†y ch·ªçn v√†o √¥ k√≠p ƒë·ªÉ l·ªçc l·∫°i nh·ªØng k√≠p c·∫ßn ch·∫•m (v√≠ d·ª• k√≠p 2, k√≠p 3,...) <br />
                    <b>B∆∞·ªõc 5:</b> L·ªçc k√≠p xong ti·∫øn h√†nh ch·∫•m v√† l∆∞u b√¨nh th∆∞·ªùng. <br />
                    ƒê·ªëi v·ªõi ph√≤ng ban kh√¥ng ph·∫£i ca k√≠p th√¨ kh√¥ng c·∫ßn ch·ªçn √¥ k√≠p
                </div>
            )}
        </AdminLayout>
    );
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\timesheets\daily\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\timesheets\monthly\page.tsx
================================================================================
// src/app/timesheets/monthly/page.tsx

"use client";

import ExcelJS from "exceljs";
import { saveAs } from "file-saver";
import React, { useState, useMemo } from "react";
import AdminLayout from "@/components/AdminLayout";
import {
  Table,
  Button,
  message,
  Typography,
  Tooltip,
} from "antd";
import { FileExcelOutlined, AppstoreOutlined } from "@ant-design/icons"; // [M·ªöI] Th√™m icon
import dayjs from "dayjs";

// [QUAN TR·ªåNG] Import Component l·ªçc d√πng chung
import CommonFilter, { FilterResult } from "@/components/CommonFilter";

const { Title } = Typography;

// [M·ªöI] M·ªü r·ªông interface ƒë·ªÉ h·ªó tr·ª£ d√≤ng ti√™u ƒë·ªÅ nh√≥m
interface TableRowData extends Partial<MonthlyEmployeeData> {
  key: string | number;
  isGroupHeader?: boolean;
  groupTitle?: string;
}

// --- INTERFACES ---
interface AttendanceCode {
  id: number;
  code: string;
  name: string;
  color: string;
}
interface MonthlyEmployeeData {
  id: number;
  code: string;
  fullName: string;
  department?: { name: string; factory?: { name: string } }; // [S·ª¨A] Th√™m factory ƒë·ªÉ l·∫•y t√™n hi·ªÉn th·ªã
  kip?: { name: string };
  timesheets: { date: string; attendanceCode: AttendanceCode }[];
  classification?: string | null;
}

export default function MonthlyTimesheetPage() {
  // --- STATE ---
  const [employees, setEmployees] = useState<MonthlyEmployeeData[]>([]);
  const [loading, setLoading] = useState(false);

  // State l∆∞u b·ªô l·ªçc hi·ªán t·∫°i (ƒë·ªÉ d√πng cho Excel v√† render c·ªôt ng√†y)
  const [currentFilter, setCurrentFilter] = useState<FilterResult | null>(null);

  // --- 1. FETCH DATA (G·ªçi khi CommonFilter thay ƒë·ªïi) ---
  const fetchMonthlyData = async (filter: FilterResult) => {
    // N·∫øu ch∆∞a ch·ªçn ph√≤ng ban -> X√≥a b·∫£ng
    if (!filter.realDepartmentIds || filter.realDepartmentIds.length === 0) {
      setEmployees([]);
      return;
    }

    setLoading(true);
    try {
      const month = filter.date.month() + 1;
      const year = filter.date.year();

      let url = `/api/timesheets/monthly?month=${month}&year=${year}`;

      if (filter.factoryId) {
        url += `&factoryId=${filter.factoryId}`;
      }

      // G·ª≠i danh s√°ch ID ph√≤ng ƒë√£ gi·∫£i m√£ t·ª´ CommonFilter
      url += `&departmentId=${filter.realDepartmentIds.join(",")}`;

      // G·ª≠i danh s√°ch K√≠p (n·∫øu c√≥)
      if (filter.selectedKipIds.length > 0) {
        url += `&kipIds=${filter.selectedKipIds.join(",")}`;
      }

      const res = await fetch(url);
      const data = await res.json();

      if (data.error) {
        message.error(data.error);
        setEmployees([]);
      } else {
        setEmployees(data);
      }
    } catch (error) {
      message.error("L·ªói t·∫£i d·ªØ li·ªáu");
      setEmployees([]);
    } finally {
      setLoading(false);
    }
  };

  // [M·ªöI] H√†m t·∫£i t·∫•t c·∫£
  const handleLoadAll = async () => {
    if (!currentFilter) {
      message.warning("Vui l√≤ng ch·ªù b·ªô l·ªçc kh·ªüi t·∫°o xong.");
      return;
    }
    setLoading(true);
    try {
      const month = currentFilter.date.month() + 1;
      const year = currentFilter.date.year();
      // G·ªçi API v·ªõi tham s·ªë view=all (C·∫ßn ƒë·∫£m b·∫£o Backend ƒë√£ h·ªó tr·ª£ tham s·ªë n√†y)
      const res = await fetch(`/api/timesheets/monthly?month=${month}&year=${year}&view=all`);
      const data = await res.json();

      if (data.error) {
        message.error(data.error);
        setEmployees([]);
      } else {
        setEmployees(data);
        message.success(`ƒê√£ t·∫£i d·ªØ li·ªáu c·ªßa ${data.length} nh√¢n vi√™n.`);
      }
    } catch (e) {
      message.error("L·ªói k·∫øt n·ªëi server");
    } finally {
      setLoading(false);
    }
  };

  // [QUAN TR·ªåNG] X·ª≠ l√Ω d·ªØ li·ªáu ƒë·ªÉ ch√®n d√≤ng ti√™u ƒë·ªÅ ph√¢n c√°ch (Group Header)
  const groupedDataSource = useMemo(() => {
    const processed: TableRowData[] = [];
    let currentGroupKey = "";

    employees.forEach((emp) => {
      // T·∫°o key ƒë·ªãnh danh nh√≥m: T√™n Nh√† m√°y - T√™n Ph√≤ng - T√™n K√≠p
      // Logic n√†y gi√∫p gom nh√≥m c√°c nh√¢n vi√™n c√πng b·ªô ph·∫≠n l·∫°i v·ªõi nhau
      const factoryName = emp.department?.factory?.name || "Kh√°c";
      const deptName = emp.department?.name || "Ch∆∞a ph√¢n lo·∫°i";
      const kipName = emp.kip?.name ? ` - ${emp.kip.name}` : "";

      const groupKey = `${factoryName} - ${deptName}${kipName}`;

      // N·∫øu chuy·ªÉn sang nh√≥m m·ªõi -> Ch√®n d√≤ng Header
      if (groupKey !== currentGroupKey) {
        processed.push({
          key: `group-${groupKey}-${emp.id}`, // Key unique
          isGroupHeader: true,
          groupTitle: groupKey.toUpperCase(), // VD: NH√Ä M√ÅY S·ª¢I 2 - S·ª¢I CON - K√çP 1
        });
        currentGroupKey = groupKey;
      }

      // Push nh√¢n vi√™n v√†o
      processed.push({ ...emp, key: emp.id });
    });

    return processed;
  }, [employees]);

  // Callback nh·∫≠n t·ª´ Component con
  const handleFilterChange = (result: FilterResult) => {
    setCurrentFilter(result); // L∆∞u l·∫°i ƒë·ªÉ d√πng cho Columns v√† Excel
    fetchMonthlyData(result);
  };

  // --- 2. COLUMNS DEFINITION ---
  const columns = useMemo(() => {
    // N·∫øu ch∆∞a c√≥ filter th√¨ d√πng th√°ng hi·ªán t·∫°i l√†m m·∫´u
    const viewDate = currentFilter?.date || dayjs();
    const daysInMonth = viewDate.daysInMonth();

    // 2.1 ƒê·ªãnh nghƒ©a c√°c c·ªôt c∆° b·∫£n (nh∆∞ c≈©)
    const fixedColumns: any[] = [
      {
        title: "STT",
        key: "index", // Key n√†y quan tr·ªçng ƒë·ªÉ x·ª≠ l√Ω colSpan
        width: 50,
        fixed: "left",
        align: "center",
        render: (_: any, __: any, index: number) => (
          <span style={{ color: "#888", fontWeight: 600 }}>{index + 1}</span>
        ),
      },
      {
        title: "H·ªç t√™n",
        dataIndex: "fullName",
        key: "fullName",
        width: 160,
        fixed: "left",
        render: (text: string, record: MonthlyEmployeeData) => (
          <div>
            <div style={{ fontWeight: 500 }}>{text}</div>
            <div style={{ fontSize: 11, color: "#888" }}>
              {record.kip ? `(${record.kip.name})` : record.department?.name || ""}
            </div>
          </div>
        ),
      },
    ];

    const dayColumns = [];
    for (let i = 1; i <= daysInMonth; i++) {
      const currentDay = dayjs(`${viewDate.year()}-${viewDate.month() + 1}-${i}`);
      const isWeekend = currentDay.day() === 0;
      const dateStr = currentDay.format("YYYY-MM-DD");

      dayColumns.push({
        title: (
          <div style={{ textAlign: "center", color: isWeekend ? "#ff4d4f" : "inherit" }}>
            <div>{i}</div>
            <div style={{ fontSize: 10, color: "#999" }}>
              {["CN", "T2", "T3", "T4", "T5", "T6", "T7"][currentDay.day()]}
            </div>
          </div>
        ),
        width: 40,
        align: "center",
        key: `day-${i}`,
        render: (_: any, record: MonthlyEmployeeData) => {
          // [Fix] Ki·ªÉm tra record.timesheets t·ªìn t·∫°i tr∆∞·ªõc khi find
          const log = record.timesheets?.find((t) => t.date.startsWith(dateStr));
          if (log) {
            return (
              <Tooltip title={log.attendanceCode.name}>
                <div style={{
                  background: log.attendanceCode.color,
                  color: "#fff",
                  fontSize: 11,
                  fontWeight: "bold",
                  borderRadius: 2,
                  height: 22,
                  lineHeight: "22px",
                  cursor: "default",
                }}
                >
                  {log.attendanceCode.code}
                </div>
              </Tooltip>
            );
          }
          return null;
        },
      });
    }

    const countCodes = (record: MonthlyEmployeeData, fullCodes: string[], halfCodes: string[] = []) => {
      // [Fix] Ki·ªÉm tra m·∫£ng timesheets
      return (record.timesheets || []).reduce((total, t) => {
        const code = t.attendanceCode.code;
        if (fullCodes.includes(code)) return total + 1;
        if (halfCodes.includes(code)) return total + 0.5;
        return total;
      }, 0);
    };

    const summaryColumns = [
      {
        title: <span style={{ color: "#05FA46", fontSize: 12 }}>T.C√¥ng</span>,
        width: 60, align: "center", fixed: "right", className: "bg-green-50", key: "sum_total",
        render: (_: any, r: MonthlyEmployeeData) => {
          const total = countCodes(r, ["+", "XD", "CT", "Lƒê", "XL", "LE", "LD"], ["X/2"]);
          return total > 0 ? <b style={{ color: "#16a34a" }}>{total}</b> : "-";
        },
      },
      {
        title: <span style={{ fontSize: 12 }}>Ca 3</span>, width: 50, align: "center", fixed: "right", key: "sum_ca3",
        render: (_: any, r: MonthlyEmployeeData) => {
          const total = countCodes(r, ["XD", "LD"]);
          return total > 0 ? <b>{total}</b> : "-";
        },
      },
      {
        title: <span style={{ color: "#ff78cf", fontSize: 12 }}>100%</span>, width: 50, align: "center", fixed: "right", key: "sum_100",
        render: (_: any, r: MonthlyEmployeeData) => {
          const total = countCodes(r, ["F", "R", "L"]);
          return total > 0 ? <b style={{ color: "#2563eb" }}>{total}</b> : "-";
        },
      },
      {
        title: <span style={{ color: "#F8FF3B", fontSize: 12 }}>BHXH</span>, width: 50, align: "center", fixed: "right", key: "sum_bhxh",
        render: (_: any, r: MonthlyEmployeeData) => {
          const total = countCodes(r, ["√î", "C√î", "TS", "DS", "T", "CL"]);
          return total > 0 ? <b style={{ color: "#ca8a04" }}>{total}</b> : "-";
        },
      },
      {
        title: <span style={{ color: "#FF4545", fontSize: 12 }}>K.L∆∞∆°ng</span>, width: 60, align: "center", fixed: "right", key: "sum_kl",
        render: (_: any, r: MonthlyEmployeeData) => {
          const total = countCodes(r, ["RO"]);
          return total > 0 ? <b style={{ color: "#dc2626" }}>{total}</b> : "-";
        },
      },
      {
        title: <span style={{ fontSize: 12 }}>V√¥ LD</span>, width: 50, align: "center", fixed: "right", key: "sum_vld",
        render: (_: any, r: MonthlyEmployeeData) => {
          const total = countCodes(r, ["O"]);
          return total > 0 ? <b style={{ color: "red", textDecoration: "underline" }}>{total}</b> : "-";
        },
      },
      {
        title: <span style={{ fontSize: 12 }}>B√£o</span>, width: 50, align: "center", fixed: "right", key: "sum_bao",
        render: (_: any, r: MonthlyEmployeeData) => {
          const total = countCodes(r, ["B"]);
          return total > 0 ? <b>{total}</b> : "-";
        },
      },
      {
        title: <span style={{ fontSize: 12 }}>X.Lo·∫°i</span>, width: 60, align: "center", fixed: "right", key: "classification",
        render: (_: any, r: MonthlyEmployeeData) => {
          const grade = r.classification;
          let color = "#000";
          if (grade === "A" || grade === "A+") color = "#16a34a";
          if (grade === "B") color = "#2563eb";
          if (grade === "C") color = "#ca8a04";
          return <b style={{ color: color, fontSize: 13 }}>{grade || "-"}</b>;
        },
      },
    ];

    // 2.2 G·ªôp t·∫•t c·∫£ c·ªôt l·∫°i
    const originalColumns = [...fixedColumns, ...dayColumns, ...summaryColumns];

    // 2.3 [QUAN TR·ªåNG] Bi·∫øn ƒë·ªïi c·ªôt ƒë·ªÉ x·ª≠ l√Ω Row Span (G·ªôp √¥) cho d√≤ng ti√™u ƒë·ªÅ
    const processedColumns = originalColumns.map((col) => ({
      ...col,
      onCell: (record: TableRowData, index: number) => {
        if (record.isGroupHeader) {
          // N·∫øu l√† d√≤ng ti√™u ƒë·ªÅ:
          // C·ªôt 'index' (STT) s·∫Ω chi·∫øm tr·ªçn chi·ªÅu ngang (colSpan = t·ªïng s·ªë c·ªôt)
          if (col.key === "index") {
            return { colSpan: originalColumns.length };
          }
          // C√°c c·ªôt kh√°c ·∫©n ƒëi
          return { colSpan: 0 };
        }
        return {};
      },
      render: (text: any, record: TableRowData, index: number) => {
        // Render n·ªôi dung d√≤ng ti√™u ƒë·ªÅ
        if (record.isGroupHeader) {
          if (col.key === "index") {
            return (
              <div style={{
                background: "#e6f7ff",
                color: "#0050b3",
                padding: "6px 16px",
                fontWeight: "bold",
                textAlign: "left",
                borderTop: "2px solid #1890ff",
                textTransform: "uppercase"
              }}>
                <AppstoreOutlined style={{ marginRight: 8 }} />
                {record.groupTitle}
              </div>
            );
          }
          return null;
        }
        // Render b√¨nh th∆∞·ªùng cho d√≤ng nh√¢n vi√™n
        return col.render ? col.render(text, record, index) : text;
      }
    }));

    return processedColumns;

  }, [currentFilter, employees]);

  // --- 3. EXPORT EXCEL (ƒê√É C·∫¨P NH·∫¨T ƒê·ªò R·ªòNG C·ªòT) ---
  const handleExportExcel = async () => {
    if (employees.length === 0 || !currentFilter) return;
    setLoading(true);

    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet("BangCong");

    // Setup trang in
    worksheet.pageSetup = {
      paperSize: 9,
      orientation: "landscape",
      fitToPage: true,
      fitToWidth: 1,
      fitToHeight: 0,
      margins: {
        left: 0.25, right: 0.25, top: 0.75, bottom: 0.75,
        header: 0.3, footer: 0.3
      }
    };

    // --- T√çNH TO√ÅN S·ªê C·ªòT ---
    const daysInMonth = currentFilter.date.daysInMonth();
    // 2 c·ªôt ƒë·∫ßu (STT, T√™n) + S·ªë ng√†y + 8 c·ªôt t·ªïng h·ª£p
    const totalColumns = 2 + daysInMonth + 8;

    // --- [M·ªöI] THI·∫æT L·∫¨P ƒê·ªò R·ªòNG C·ªòT (QUAN TR·ªåNG) ---
    // C·ªôt 1: STT -> H·∫πp
    worksheet.getColumn(1).width = 5;
    // C·ªôt 2: H·ªç t√™n -> R·ªông
    worksheet.getColumn(2).width = 28;

    // C√°c c·ªôt ng√†y: T·ª´ c·ªôt 3 ƒë·∫øn c·ªôt (2 + s·ªë ng√†y) -> R·∫•t h·∫πp
    for (let i = 1; i <= daysInMonth; i++) {
      worksheet.getColumn(2 + i).width = 4.5;
    }

    // C√°c c·ªôt t·ªïng h·ª£p cu·ªëi c√πng -> V·ª´a ph·∫£i
    for (let i = 2 + daysInMonth + 1; i <= totalColumns; i++) {
      worksheet.getColumn(i).width = 7;
    }
    // -----------------------------------------------

    // --- HEADER (CƒÇN GI·ªÆA) ---
    const row1 = worksheet.getCell("A1");
    row1.value = "C√îNG TY C·ªî PH·∫¶N S·ª¢I PH√ö B√ÄI";
    row1.font = { name: "Times New Roman", size: 14, bold: true };
    row1.alignment = { vertical: "middle", horizontal: "center" };
    worksheet.mergeCells(1, 1, 1, totalColumns);

    const row2 = worksheet.getCell("A2");
    row2.value = `B·∫¢NG CH·∫§M C√îNG TH√ÅNG ${currentFilter.date.format("MM/YYYY")}`;
    row2.font = { name: "Times New Roman", size: 16, bold: true };
    row2.alignment = { vertical: "middle", horizontal: "center" };
    worksheet.mergeCells(2, 1, 2, totalColumns);

    // T√™n b·ªô ph·∫≠n
    const deptDisplayName = employees.length > 0
      ? (employees[0].kip ? `K√≠p: ${employees[0].kip.name}` : `B·ªô ph·∫≠n: ${employees[0].department?.name || 'T·ªïng h·ª£p'}`)
      : "T·ªïng h·ª£p";

    const row3 = worksheet.getCell("A3");
    row3.value = deptDisplayName.toUpperCase();
    row3.font = { name: "Times New Roman", size: 14, bold: true };
    row3.alignment = { vertical: "middle", horizontal: "center" };
    worksheet.mergeCells(3, 1, 3, totalColumns);

    // --- TABLE HEADER ---
    const headerRow = ["STT", "H·ªç v√† t√™n"];
    for (let i = 1; i <= daysInMonth; i++) headerRow.push(`${i}`);
    headerRow.push("T.C√¥ng", "Ca 3", "100%", "BHXH", "K.L∆∞∆°ng", "V√¥ LD", "L.B√£o", "X.Lo·∫°i");

    const headerRowExcel = worksheet.addRow(headerRow);
    headerRowExcel.eachCell((cell) => {
      cell.font = { name: "Times New Roman", bold: true };
      cell.alignment = { vertical: "middle", horizontal: "center" };
      cell.border = { top: { style: "thin" }, left: { style: "thin" }, bottom: { style: "thin" }, right: { style: "thin" } };
      cell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFE0E0E0" } };
    });

    // --- TABLE DATA ---
    employees.forEach((emp, index) => {
      const rowData: any[] = [index + 1, emp.fullName];
      for (let i = 1; i <= daysInMonth; i++) {
        const dateStr = dayjs(`${currentFilter.date.year()}-${currentFilter.date.month() + 1}-${i}`).format("YYYY-MM-DD");
        const log = emp.timesheets.find((t) => t.date.startsWith(dateStr));
        rowData.push(log ? log.attendanceCode.code : "");
      }

      const count = (codes: string[]) => emp.timesheets.reduce((acc, t) => codes.includes(t.attendanceCode.code) ? acc + 1 : acc, 0);
      const countComplex = (full: string[], half: string[]) => emp.timesheets.reduce((acc, t) => {
        if (full.includes(t.attendanceCode.code)) return acc + 1;
        if (half.includes(t.attendanceCode.code)) return acc + 0.5;
        return acc;
      }, 0);

      rowData.push(countComplex(["+", "XD", "CT", "Lƒê", "XL", "LE", "LD"], ["X/2"]) || "");
      rowData.push(count(["XD", "LD"]) || "");
      rowData.push(count(["F", "R", "L"]) || "");
      rowData.push(count(["√î", "C√î", "TS", "DS", "T", "CL"]) || "");
      rowData.push(count(["RO"]) || "");
      rowData.push(count(["O"]) || "");
      rowData.push(count(["B"]) || "");
      rowData.push(emp.classification || "");

      const row = worksheet.addRow(rowData);
      row.eachCell((cell, colNumber) => {
        cell.font = { name: "Times New Roman" };
        cell.border = { top: { style: "thin" }, left: { style: "thin" }, bottom: { style: "thin" }, right: { style: "thin" } };
        // Canh tr√°i cho H·ªç t√™n, c√≤n l·∫°i canh gi·ªØa
        if (colNumber === 2) cell.alignment = { horizontal: "left", indent: 1 };
        else cell.alignment = { horizontal: "center" };
      });
    });

    // --- FOOTER CH·ªÆ K√ù (3 C·ªòT) ---
    worksheet.addRow([]);
    worksheet.addRow([]);

    const signRowIndex = worksheet.lastRow!.number + 1;

    // 1. NG∆Ø·ªúI CH·∫§M C√îNG
    worksheet.mergeCells(signRowIndex, 2, signRowIndex, 6);
    const cellLeft = worksheet.getCell(signRowIndex, 2);
    cellLeft.value = "Ng∆∞·ªùi ch·∫•m c√¥ng";

    // 2. PH·ª§ TR√ÅCH ƒê∆†N V·ªä
    const midCol = Math.floor(totalColumns / 2);
    worksheet.mergeCells(signRowIndex, midCol - 2, signRowIndex, midCol + 2);
    const cellMid = worksheet.getCell(signRowIndex, midCol - 2);
    cellMid.value = "Ph·ª• tr√°ch ƒë∆°n v·ªã";

    // 3. C√ÅN B·ªò KI·ªÇM TRA
    worksheet.mergeCells(signRowIndex, totalColumns - 4, signRowIndex, totalColumns);
    const cellRight = worksheet.getCell(signRowIndex, totalColumns - 4);
    cellRight.value = "C√°n b·ªô ki·ªÉm tra";

    [cellLeft, cellMid, cellRight].forEach(cell => {
      cell.font = { name: "Times New Roman", bold: true, size: 11 };
      cell.alignment = { horizontal: "center" };
    });

    // --- L∆ØU FILE ---
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
    saveAs(blob, `BangCong_${currentFilter.date.format("MM-YYYY")}.xlsx`);
    setLoading(false);
  };

  return (
    <AdminLayout>
      <div style={{ marginBottom: 24, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
        <Title level={3} style={{ margin: 0 }}>T·ªïng h·ª£p ch·∫•m c√¥ng th√°ng</Title>
        <div style={{ display: 'flex', gap: 10 }}>
          {/* [M·ªöI] N√∫t Load T·∫•t c·∫£ */}
          <Button
            style={{ background: "#F54F2F", color: "white" }}
            onClick={handleLoadAll}
            loading={loading}
            icon={<AppstoreOutlined />}
          >
            Xem t·∫•t c·∫£ c√°c ph√≤ng
          </Button>

          <Button
            type="primary"
            style={{ background: "#217346" }}
            icon={<FileExcelOutlined />}
            onClick={handleExportExcel}
            disabled={employees.length === 0}
            loading={loading}
          >
            Xu·∫•t Excel
          </Button>
        </div>
      </div>

      {/* --- S·ª¨ D·ª§NG COMPONENT L·ªåC D√ôNG CHUNG --- */}
      <CommonFilter
        dateMode="month" // Ch·∫ø ƒë·ªô Th√°ng
        onFilterChange={handleFilterChange}
      />

      <Table
        bordered
        dataSource={groupedDataSource} // [QUAN TR·ªåNG] D√πng data ƒë√£ group ƒë·ªÉ hi·ªÉn th·ªã
        columns={columns}
        rowKey="key"
        loading={loading}
        pagination={false}
        scroll={{ x: "max-content", y: 600 }}
        size="small"
        sticky // Gi·ªØ ti√™u ƒë·ªÅ khi cu·ªôn
      />
    </AdminLayout>
  );
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\app\timesheets\monthly\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\auth.config.ts
================================================================================
import type { NextAuthConfig } from "next-auth";

// C·∫•u h√¨nh n√†y an to√†n ƒë·ªÉ ch·∫°y tr√™n Edge (Middleware)
export const authConfig = {
  pages: {
    signIn: "/login", // Trang ƒëƒÉng nh·∫≠p t√πy ch·ªânh
  },
  callbacks: {
    // Logic ki·ªÉm tra quy·ªÅn truy c·∫≠p (Authorized)
    authorized({ auth, request: { nextUrl } }) {
      const isLoggedIn = !!auth?.user;

      // Danh s√°ch c√°c trang c·∫ßn b·∫£o v·ªá
      const protectedRoutes = [
        "/",
        "/dashboard",
        "/timesheets",
        "/employees",
        "/departments",
      ];

      // Ki·ªÉm tra xem trang hi·ªán t·∫°i c√≥ n·∫±m trong danh s√°ch b·∫£o v·ªá kh√¥ng
      const isProtectedRoute = protectedRoutes.some(
        (route) =>
          nextUrl.pathname === route || nextUrl.pathname.startsWith(route + "/")
      );

      if (isProtectedRoute) {
        if (isLoggedIn) return true;
        return false; // Ch∆∞a ƒëƒÉng nh·∫≠p -> T·ª± ƒë·ªông ƒë√° v·ªÅ Login
      } else if (isLoggedIn && nextUrl.pathname.startsWith("/login")) {
        // ƒê√£ ƒëƒÉng nh·∫≠p m√† v√†o trang login -> ƒê√° v·ªÅ Dashboard
        return Response.redirect(new URL("/dashboard", nextUrl));
      }

      return true;
    },
    // Chuy·ªÉn d·ªØ li·ªáu t·ª´ Token sang Session (ƒê·ªÉ Client d√πng)
    async session({ session, token }: any) {
      if (session.user) {
        session.user.id = token.sub;
        session.user.role = token.role;
        session.user.managedDeptIds = token.managedDeptIds;
        session.user.username = token.username;
      }
      return session;
    },
    async jwt({ token, user }: any) {
      if (user) {
        token.role = user.role;
        token.managedDeptIds = user.managedDeptIds;
        token.username = user.username;
      }
      return token;
    },
  },
  providers: [], // ƒê·ªÉ tr·ªëng ·ªü ƒë√¢y, s·∫Ω n·∫°p Provider ·ªü file auth.ts
} satisfies NextAuthConfig;


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\auth.config.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\auth.ts
================================================================================
// auth.ts (N·∫±m c√πng c·∫•p v·ªõi folder app)
import NextAuth from "next-auth";
import Credentials from "next-auth/providers/credentials";
import { prisma } from "@/lib/prisma";
import bcrypt from "bcryptjs";
import { z } from "zod";
import { authConfig } from "./auth.config"; // Gi·ªØ nguy√™n import n√†y

const loginSchema = z.object({
  username: z.string().min(1, "Vui l√≤ng nh·∫≠p t√†i kho·∫£n"),
  password: z.string().min(1, "Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u"),
});

export const { handlers, signIn, signOut, auth } = NextAuth({
  ...authConfig,
  providers: [
    Credentials({
      credentials: {
        username: { label: "T√†i kho·∫£n", type: "text" },
        password: { label: "M·∫≠t kh·∫©u", type: "password" },
      },
      authorize: async (credentials) => {
        try {
          const { username, password } = await loginSchema.parseAsync(credentials);

          const user = await prisma.user.findUnique({
            where: { username },
            include: { managedDepartments: true },
          });

          if (!user) return null; // v5 khuy·∫øn kh√≠ch return null thay v√¨ throw

          const isMatch = await bcrypt.compare(password, user.password);
          if (!isMatch) return null;

          // Tr·∫£ v·ªÅ object user
          return {
            id: user.id.toString(),
            name: user.fullName, // Map fullName v√†o name chu·∫©n c·ªßa Auth.js
            username: user.username,
            role: user.role,
            // L∆∞u √Ω: Auth.js v5 √©p ki·ªÉu User tr·∫£ v·ªÅ kh√° ch·∫∑t, ta s·∫Ω x·ª≠ l√Ω d·ªØ li·ªáu m·ªü r·ªông ·ªü callback b√™n d∆∞·ªõi
            managedDepartments: user.managedDepartments, 
          } as any;
        } catch (e) {
          return null;
        }
      },
    }),
  ],
  callbacks: {
    // 1. Chuy·ªÉn d·ªØ li·ªáu t·ª´ User (l√∫c ƒëƒÉng nh·∫≠p) sang Token (JWT)
    async jwt({ token, user }) {
      if (user) {
        token.id = user.id;
        token.username = (user as any).username;
        token.role = (user as any).role;
        // L·∫•y danh s√°ch ID ph√≤ng ban
        token.managedDeptIds = (user as any).managedDepartments?.map((d: any) => d.id) || [];
        token.fullName = (user as any).name; // L·∫•y t·ª´ field 'name' ·ªü tr√™n
      }
      return token;
    },
    // 2. Chuy·ªÉn d·ªØ li·ªáu t·ª´ Token sang Session (ƒë·ªÉ Client d√πng)
    async session({ session, token }) {
      if (session.user) {
        // G√°n l·∫°i c√°c tr∆∞·ªùng t√πy ch·ªânh
        (session.user as any).id = token.id;
        (session.user as any).username = token.username;
        (session.user as any).role = token.role;
        (session.user as any).fullName = token.fullName;
        (session.user as any).managedDeptIds = token.managedDeptIds;
      }
      return session;
    },
  },
});

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\auth.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\components\AdminLayout.tsx
================================================================================
"use client";

import React, { useState } from "react";
import {
  Layout,
  Menu,
  theme,
  Dropdown,
  Button,
  Avatar,
  Typography,
  message,
  Tooltip,
  Modal,
  Form,
  Input,
  ConfigProvider,
} from "antd";
import {
  ApartmentOutlined,
  TeamOutlined,
  BankOutlined,
  UnorderedListOutlined,
  FormOutlined,
  LogoutOutlined,
  TableOutlined,
  DashboardOutlined,
  UserOutlined,
  MenuUnfoldOutlined,
  MenuFoldOutlined,
  DownOutlined,
  QuestionCircleOutlined,
  AppstoreOutlined,
  CloudDownloadOutlined,
  LockOutlined,
  ImportOutlined,
  SettingOutlined,
  FieldTimeOutlined,
  KeyOutlined,
  BarChartOutlined,
  DownloadOutlined,
} from "@ant-design/icons";
import saveAs from "file-saver";
import Link from "next/link";
import { usePathname } from "next/navigation";
import { signOut, useSession } from "next-auth/react";

const { Header, Sider, Content, Footer } = Layout;

export default function AdminLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const [collapsed, setCollapsed] = useState(false);
  const pathname = usePathname();
  const { data: session } = useSession();

  // --- STATE CHO ƒê·ªîI M·∫¨T KH·∫®U ---
  const [isChangePassOpen, setIsChangePassOpen] = useState(false);
  const [passForm] = Form.useForm();
  const [passLoading, setPassLoading] = useState(false);

  const {
    token: { colorBgContainer, borderRadiusLG },
  } = theme.useToken();

  // 1. H√†m x·ª≠ l√Ω ƒêƒÉng xu·∫•t
  const handleLogout = () => {
    signOut({ callbackUrl: "/login" });
  };

  // 2. H√†m x·ª≠ l√Ω Backup
  const handleDownloadBackup = async () => {
    const hide = message.loading("ƒêang t·∫°o b·∫£n backup...", 0);
    try {
      const res = await fetch("/api/system/backup");

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "L·ªói server");
      }

      const blob = await res.blob();
      const dateStr = new Date().toISOString().slice(0, 10);
      saveAs(blob, `backup_phubai_hrm_${dateStr}.sql`);

      message.success("T·∫£i backup th√†nh c√¥ng!");
    } catch (error: any) {
      message.error(error.message);
    } finally {
      hide();
    }
  };

  // 3. H√†m x·ª≠ l√Ω ƒê·ªïi m·∫≠t kh·∫©u
  const handleChangePassword = async (values: any) => {
    setPassLoading(true);
    try {
      const res = await fetch("/api/user/change-password", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(values),
      });

      const data = await res.json();
      if (res.ok) {
        message.success("ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
        setIsChangePassOpen(false);
        passForm.resetFields();
        signOut({ callbackUrl: "/login" }); // ƒêƒÉng xu·∫•t ƒë·ªÉ user ƒëƒÉng nh·∫≠p l·∫°i
      } else {
        message.error(data.error || "C√≥ l·ªói x·∫£y ra");
      }
    } catch (error) {
      message.error("L·ªói k·∫øt n·ªëi server");
    } finally {
      setPassLoading(false);
    }
  };

  // 4. Menu User x·ªï xu·ªëng
  const userMenuItems = [
    {
      key: "info",
      label: (
        <div style={{ padding: "4px 8px", cursor: "default" }}>
          <div style={{ fontWeight: "bold" }}>
            {session?.user?.fullName || session?.user?.name || session?.user?.username}
          </div>
          <div style={{ fontSize: 12, color: "#666" }}>
            {session?.user?.role}
          </div>
        </div>
      ),
      disabled: true,
    },
    { type: "divider" as const },
    {
      key: "change-pass",
      icon: <KeyOutlined />,
      label: "ƒê·ªïi m·∫≠t kh·∫©u",
      onClick: () => setIsChangePassOpen(true),
    },
    { type: "divider" as const },
    {
      key: "logout",
      danger: true,
      icon: <LogoutOutlined />,
      label: "ƒêƒÉng xu·∫•t",
      onClick: handleLogout,
    },
  ];

  return (
    <Layout style={{ minHeight: "100vh" }}>
      <Sider trigger={null} collapsible collapsed={collapsed}>
        {/* --- [S·ª¨A ƒê·ªîI] B·ªåC LINK QUANH LOGO ƒê·ªÇ V·ªÄ TRANG CH·ª¶ --- */}
        <Link href="/">
          <div
            className="demo-logo-vertical"
            style={{
              height: 32,
              margin: 16,
              background: "rgba(255, 255, 255, 0.2)",
              display: "flex",
              alignItems: "center",
              justifyContent: "center",
              color: "#fff",
              fontWeight: "bold",
              cursor: "pointer", // Hi·ªÉn th·ªã h√¨nh b√†n tay khi r√™ chu·ªôt
              borderRadius: "6px", // Bo g√≥c nh·∫π cho logo nh√¨n m∆∞·ª£t h∆°n
              transition: "background 0.3s", // Hi·ªáu ·ª©ng chuy·ªÉn m√†u m∆∞·ª£t m√†
            }}
            onMouseEnter={(e) => (e.currentTarget.style.background = "rgba(255, 255, 255, 0.3)")}
            onMouseLeave={(e) => (e.currentTarget.style.background = "rgba(255, 255, 255, 0.2)")}
          >
            {collapsed ? "PB" : "PHU BAI HRM"}
          </div>
        </Link>

        <ConfigProvider
          theme={{
            components: {
              Menu: {
                darkItemHoverBg: "#1677ff", // M√†u n·ªÅn xanh s√°ng khi r√™ chu·ªôt
                darkItemHoverColor: "#ffffff", // Ch·ªØ m√†u tr·∫Øng khi r√™ chu·ªôt
                darkItemSelectedBg: "#003a8c", // M√†u n·ªÅn ƒë·∫≠m h∆°n cho menu ƒëang ƒë∆∞·ª£c ch·ªçn (Active)
              },
            },
          }}
        >
          <Menu
            theme="dark"
            mode="inline"
            defaultSelectedKeys={[pathname]}
            items={[
              {
                key: "catalog-management",
                icon: <AppstoreOutlined />,
                label: "Danh m·ª•c",
                children: [
                  {
                    key: "/factories",
                    icon: <BankOutlined />,
                    label: <Link href="/factories">Nh√† m√°y</Link>,
                  },
                  {
                    key: "/departments",
                    icon: <ApartmentOutlined />,
                    label: <Link href="/departments">Ph√≤ng ban</Link>,
                  },
                  {
                    key: "/employees",
                    icon: <TeamOutlined />,
                    label: <Link href="/employees">Nh√¢n vi√™n</Link>,
                  },
                  {
                    key: "/attendance-codes",
                    icon: <UnorderedListOutlined />,
                    label: <Link href="/attendance-codes">K√Ω hi·ªáu</Link>,
                  },
                ],
              },
              {
                key: "/timesheets/daily",
                icon: <FormOutlined />,
                label: <Link href="/timesheets/daily">Ch·∫•m c√¥ng</Link>,
              },
              {
                key: "/evaluations/monthly",
                icon: <FormOutlined />,
                label: <Link href="/evaluations/monthly">X·∫øp lo·∫°i A,B,C</Link>,
              },
              {
                key: "/timesheets/monthly",
                icon: <TableOutlined />,
                label: <Link href="/timesheets/monthly">T·ªïng h·ª£p c√¥ng</Link>,
              },
              {
                key: "/bravo-data",
                icon: <DownloadOutlined />,
                label: <Link href="/bravo-data">Xu·∫•t Excel BRAVO</Link>,
              },
              {
                key: "/overtime",
                icon: <FieldTimeOutlined />,
                label: <Link href="/overtime">L√†m th√™m gi·ªù</Link>,
              },
              {
                key: "/dashboard",
                icon: <DashboardOutlined />,
                label: <Link href="/dashboard">T·ªïng quan</Link>,
              },
              {
                key: "/dashboard/departments",
                icon: <UnorderedListOutlined />,
                label: (
                  <Link href="/dashboard/departments">T√¨nh h√¨nh lao ƒë·ªông</Link>
                ),
              },
              {
                key: "/evaluations/yearly",
                icon: <BarChartOutlined />,
                label: (
                  <Link href="/evaluations/yearly">T·ªïng h·ª£p nƒÉm</Link>
                ),
              },

              // --- [S·ª¨A ƒê·ªîI QUAN TR·ªåNG T·∫†I ƒê√ÇY] ---
              // Hi·ªán Menu Qu·∫£n tr·ªã n·∫øu l√† ADMIN HO·∫∂C HR_MANAGER
              ...(["ADMIN", "HR_MANAGER"].includes(session?.user?.role as string)
                ? [
                  {
                    key: "admin-management",
                    icon: <SettingOutlined />,
                    label: "Qu·∫£n tr·ªã",
                    children: [
                      // Ng∆∞·ªùi d√πng: Ch·ªâ hi·ªÉn th·ªã cho ADMIN
                      ...(session?.user?.role === "ADMIN"
                        ? [
                          {
                            key: "/admin/users",
                            icon: <UserOutlined />,
                            label: <Link href="/admin/users">Ng∆∞·ªùi d√πng</Link>,
                          },
                        ]
                        : []),

                      // Kh√≥a s·ªï: C·∫£ ADMIN v√† HR_MANAGER ƒë·ªÅu th·∫•y
                      {
                        key: "/admin/lock-rules",
                        icon: <LockOutlined />,
                        label: <Link href="/admin/lock-rules">Kh√≥a s·ªï</Link>,
                      },

                      // Import: Ch·ªâ hi·ªÉn th·ªã cho ADMIN
                      ...(session?.user?.role === "ADMIN"
                        ? [
                          {
                            key: "/admin/employees/import",
                            icon: <ImportOutlined />,
                            label: <Link href="/admin/employees/import">Import</Link>,
                          },
                        ]
                        : []),
                    ],
                  },
                ]
                : []),
              // ------------------------------------

              {
                key: "/help",
                icon: <QuestionCircleOutlined />,
                label: <Link href="/help">H∆∞·ªõng d·∫´n</Link>,
              },
            ]}
          />
        </ConfigProvider>
      </Sider>

      <Layout>
        <Header
          style={{
            padding: 0,
            background: colorBgContainer,
            display: "flex",
            justifyContent: "space-between",
            alignItems: "center",
            paddingRight: 24,
          }}
        >
          <div
            onClick={() => setCollapsed(!collapsed)}
            style={{
              fontSize: "16px",
              width: 64,
              height: 64,
              display: "flex",
              alignItems: "center",
              justifyContent: "center",
              cursor: "pointer",
            }}
          >
            {collapsed ? <MenuUnfoldOutlined /> : <MenuFoldOutlined />}
          </div>

          <div style={{ display: "flex", alignItems: "center" }}>
            {/* N√∫t Backup (Ch·ªâ Admin) */}
            {session?.user?.role === "ADMIN" && (
              <Tooltip title="Sao l∆∞u D·ªØ li·ªáu">
                <Button
                  type="text"
                  icon={
                    <CloudDownloadOutlined
                      style={{ fontSize: 20, color: "#1890ff" }}
                    />
                  }
                  onClick={handleDownloadBackup}
                  style={{ marginRight: 15 }}
                >
                  Backup DB
                </Button>
              </Tooltip>
            )}

            {/* Dropdown User */}
            <Dropdown menu={{ items: userMenuItems }} trigger={["click"]}>
              <div
                style={{
                  cursor: "pointer",
                  display: "flex",
                  alignItems: "center",
                  gap: 10,
                }}
              >
                <Avatar
                  style={{ backgroundColor: "#1677ff" }}
                  icon={<UserOutlined />}
                />
                <span style={{ fontWeight: 500 }}>
                  {session?.user?.fullName || session?.user?.name || "Ng∆∞·ªùi d√πng"}{" "}
                  <DownOutlined style={{ fontSize: 10 }} />
                </span>
              </div>
            </Dropdown>
          </div>
        </Header>

        <Content
          style={{
            margin: "24px 16px",
            padding: 24,
            minHeight: 280,
            background: colorBgContainer,
            borderRadius: borderRadiusLG,
          }}
        >
          {children}
        </Content>
        <Footer style={{ textAlign: "center" }}>
          Qu·∫£n l√Ω nh√¢n s·ª± ¬©2026 Thi·∫øt k·∫ø b·ªüi Nguy·ªÖn Thi·ªán Minh Tr√≠
        </Footer>

        {/* --- MODAL ƒê·ªîI M·∫¨T KH·∫®U --- */}
        <Modal
          title="ƒê·ªïi m·∫≠t kh·∫©u c√° nh√¢n"
          open={isChangePassOpen}
          onCancel={() => {
            setIsChangePassOpen(false);
            passForm.resetFields();
          }}
          onOk={() => passForm.submit()}
          confirmLoading={passLoading}
          okText="X√°c nh·∫≠n"
          cancelText="H·ªßy"
        >
          <Form form={passForm} layout="vertical" onFinish={handleChangePassword}>
            <Form.Item
              name="oldPassword"
              label="M·∫≠t kh·∫©u hi·ªán t·∫°i"
              rules={[{ required: true, message: "Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u c≈©" }]}
            >
              <Input.Password placeholder="Nh·∫≠p m·∫≠t kh·∫©u c≈©..." />
            </Form.Item>

            <Form.Item
              name="newPassword"
              label="M·∫≠t kh·∫©u m·ªõi"
              rules={[
                { required: true, message: "Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u m·ªõi" },
                { min: 6, message: "M·∫≠t kh·∫©u ph·∫£i t·ª´ 6 k√Ω t·ª±" },
              ]}
            >
              <Input.Password placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi..." />
            </Form.Item>

            <Form.Item
              name="confirmPassword"
              label="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi"
              dependencies={["newPassword"]}
              rules={[
                { required: true, message: "Vui l√≤ng nh·∫≠p l·∫°i m·∫≠t kh·∫©u" },
                ({ getFieldValue }) => ({
                  validator(_, value) {
                    if (!value || getFieldValue("newPassword") === value) {
                      return Promise.resolve();
                    }
                    return Promise.reject(new Error("M·∫≠t kh·∫©u nh·∫≠p l·∫°i kh√¥ng kh·ªõp!"));
                  },
                }),
              ]}
            >
              <Input.Password placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi..." />
            </Form.Item>
          </Form>
        </Modal>
      </Layout>
    </Layout >
  );
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\components\AdminLayout.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\components\CommonFilter.tsx
================================================================================
"use client";

import React, { useEffect, useState, useMemo, useCallback } from "react";
import { Select, DatePicker, Button, message, Card, Space } from "antd";
import { FilterOutlined } from "@ant-design/icons";
import { useSession } from "next-auth/react";
import dayjs, { Dayjs } from "dayjs";

// --- INTERFACES ---
interface Factory { id: number; name: string; }
interface Department { id: number; code: string; name: string; factory?: Factory; }
interface Kip { id: number; name: string; factoryId: number; }
interface DeptOption { value: string; label: string; type: "SECTION" | "DEPT"; }

// D·ªØ li·ªáu b·ªô l·ªçc tr·∫£ v·ªÅ cho trang cha
export interface FilterResult {
    date: Dayjs;
    factoryId: number | null;
    realDepartmentIds: number[]; // ƒê√£ gi·∫£i m√£ th√†nh ID th·∫≠t (VD: [15, 16])
    selectedKipIds: number[]; // K√≠p ƒë√£ ch·ªçn (ƒë·ªÉ trang cha hi·ªÉn th·ªã n·∫øu c·∫ßn)
    mixedDeptValues: string[]; // Gi√° tr·ªã UI (ƒë·ªÉ debug n·∫øu c·∫ßn)
}

interface Props {
    dateMode?: "date" | "month" | "year" | "none"; // Ch·∫ø ƒë·ªô ng√†y
    onFilterChange: (result: FilterResult) => void; // H√†m b√°o ra ngo√†i
    loading?: boolean; // Tr·∫°ng th√°i loading t·ª´ trang cha
}

export default function CommonFilter({ dateMode = "date", onFilterChange, loading = false }: Props) {
    const { data: session } = useSession();

    // --- STATE ---
    const [departments, setDepartments] = useState<Department[]>([]);
    const [kips, setKips] = useState<Kip[]>([]);

    // Selection State
    const [date, setDate] = useState<Dayjs>(dayjs());
    const [selectedFactoryId, setSelectedFactoryId] = useState<number | null>(null);
    const [mixedDeptValues, setMixedDeptValues] = useState<string[]>([]);
    const [selectedKipIds, setSelectedKipIds] = useState<number[]>([]);

    // Config
    const MATRIX_FACTORY_IDS = [1, 2, 3]; // C√°c nh√† m√°y √°p d·ª•ng logic g·ªôp T·ªï

    // 1. Load Danh m·ª•c (Ch·ªâ 1 l·∫ßn)
    useEffect(() => {
        const init = async () => {
            try {
                const [dRes, kRes] = await Promise.all([
                    fetch("/api/departments"),
                    fetch("/api/kips")
                ]);
                setDepartments(await dRes.json());
                setKips(await kRes.json());
            } catch (e) {
                message.error("L·ªói t·∫£i b·ªô l·ªçc");
            }
        };
        init();
    }, []);

    // 2. Logic Ph√¢n quy·ªÅn
    const availableDepartments = useMemo(() => {
        if (departments.length === 0 || !session) return [];
        const user = session.user;
        if (["ADMIN", "HR_MANAGER", "LEADER"].includes(user.role)) return departments;
        if (["TIMEKEEPER", "STAFF"].includes(user.role)) {
            const allowedIds = user.managedDeptIds || [];
            return departments.filter((d) => allowedIds.includes(d.id));
        }
        return [];
    }, [departments, session]);

    const isMatrix = useMemo(() => selectedFactoryId ? MATRIX_FACTORY_IDS.includes(selectedFactoryId) : false, [selectedFactoryId]);

    // 3. T·∫°o Dropdown G·ªôp (Section/Dept)
    const mixedDeptOptions = useMemo<DeptOption[]>(() => {
        if (!selectedFactoryId) return [];
        const currentDepts = availableDepartments.filter(d => d.factory?.id === selectedFactoryId);
        const options: DeptOption[] = [];
        const processedSections = new Set<string>();

        currentDepts.forEach((d) => {
            const matrixRegex = new RegExp(`^${selectedFactoryId}([a-zA-Z]+)(\\d+)$`);
            const match = d.code?.match(matrixRegex);

            if (isMatrix && match) {
                const sectionCode = match[1];
                if (!processedSections.has(sectionCode)) {
                    const displayName = d.name.replace(/(k√≠p|ca)\s*\d+.*$/gi, "").replace(/-+.*$/gi, "").trim();
                    options.push({ value: `SECTION:${sectionCode}`, label: displayName, type: "SECTION" });
                    processedSections.add(sectionCode);
                }
            } else {
                options.push({ value: `DEPT:${d.id}`, label: d.name, type: "DEPT" });
            }
        });
        return options.sort((a, b) => a.label.localeCompare(b.label));
    }, [availableDepartments, selectedFactoryId, isMatrix]);

    // 4. H√†m gi·∫£i m√£ ID th·ª±c t·∫ø (Core Logic)
    const resolveRealDepartmentIds = useCallback(() => {
        if (!selectedFactoryId || mixedDeptValues.length === 0) return [];

        let targetKipNumbers: string[] = [];
        if (selectedKipIds.length > 0) {
            const names = kips.filter((k) => selectedKipIds.includes(k.id)).map((k) => k.name);
            targetKipNumbers = names.map((name) => name.match(/\d+/)?.[0] || "").filter(Boolean);
        }

        const allRealIds: number[] = [];
        mixedDeptValues.forEach((val) => {
            if (val.startsWith("DEPT")) {
                const id = parseInt(val.split(":")[1]);
                if (!isNaN(id)) allRealIds.push(id);
            } else if (val.startsWith("SECTION")) {
                const sectionCode = val.split(":")[1];
                availableDepartments.forEach((d) => {
                    if (d.factory?.id !== selectedFactoryId) return;
                    const regex = new RegExp(`^${selectedFactoryId}${sectionCode}(\\d+)$`);
                    const match = d.code?.match(regex);
                    if (match) {
                        const deptKipNum = match[1];
                        if (targetKipNumbers.length === 0 || targetKipNumbers.includes(deptKipNum)) {
                            allRealIds.push(d.id);
                        }
                    }
                });
            }
        });
        return Array.from(new Set(allRealIds));
    }, [selectedFactoryId, mixedDeptValues, selectedKipIds, kips, availableDepartments]);

    // 5. Trigger change ra ngo√†i (Debounce nh·∫π)
    useEffect(() => {
        const timer = setTimeout(() => {
            const realIds = resolveRealDepartmentIds();
            // B·∫Øn d·ªØ li·ªáu ra trang cha
            onFilterChange({
                date,
                factoryId: selectedFactoryId,
                realDepartmentIds: realIds,
                selectedKipIds,
                mixedDeptValues
            });
        }, 300);
        return () => clearTimeout(timer);
    }, [date, selectedFactoryId, mixedDeptValues, selectedKipIds]);

    // UI Handlers
    const handleFactoryChange = (val: number) => {
        setSelectedFactoryId(val);
        setMixedDeptValues([]);
        setSelectedKipIds([]);
    };

    const handleReset = () => {
        setSelectedFactoryId(null);
        setMixedDeptValues([]);
        setSelectedKipIds([]);
    };

    return (
        <Card size="small" style={{ marginBottom: 16, background: "#f5f5f5" }} bodyStyle={{ padding: 12 }}>
            <div style={{ display: "flex", gap: 12, flexWrap: "wrap", alignItems: "center" }}>

                {/* 1. CH·ªåN TH·ªúI GIAN */}
                {dateMode !== "none" && (
                    <div>
                        <div style={{ fontWeight: 600, fontSize: 12, marginBottom: 4 }}>
                            {dateMode === 'date' ? 'Ng√†y:' : dateMode === 'month' ? 'Th√°ng:' : 'NƒÉm:'}
                        </div>
                        <DatePicker
                            value={date}
                            onChange={(d) => d && setDate(d)}
                            format={dateMode === 'date' ? "DD/MM/YYYY" : dateMode === 'month' ? "MM/YYYY" : "YYYY"}
                            picker={dateMode === 'date' ? undefined : dateMode}
                            allowClear={false}
                            style={{ width: 130 }}
                        />
                    </div>
                )}

                {/* 2. CH·ªåN NH√Ä M√ÅY */}
                <div>
                    <div style={{ fontWeight: 600, fontSize: 12, marginBottom: 4 }}>Nh√† m√°y:</div>
                    <Select
                        style={{ width: 180 }}
                        placeholder="Ch·ªçn Nh√† m√°y"
                        value={selectedFactoryId}
                        onChange={handleFactoryChange}
                        options={availableDepartments.reduce((acc: any[], curr) => {
                            if (curr.factory && !acc.find((f) => f.value === curr.factory!.id))
                                acc.push({ value: curr.factory!.id, label: curr.factory!.name });
                            return acc;
                        }, [])}
                    />
                </div>

                {/* 3. CH·ªåN PH√íNG BAN / T·ªî */}
                <div>
                    <div style={{ fontWeight: 600, fontSize: 12, marginBottom: 4 }}>
                        {isMatrix ? "T·ªï / B·ªô ph·∫≠n:" : "Ph√≤ng ban:"}
                    </div>
                    <Select
                        mode="multiple"
                        style={{ width: 300 }}
                        placeholder="Ch·ªçn..."
                        value={mixedDeptValues}
                        onChange={setMixedDeptValues}
                        options={mixedDeptOptions}
                        disabled={!selectedFactoryId}
                        showSearch
                        optionFilterProp="label"
                        maxTagCount="responsive"
                        allowClear
                    />
                </div>

                {/* 4. CH·ªåN K√çP */}
                <div>
                    <div style={{ fontWeight: 600, fontSize: 12, marginBottom: 4 }}>
                        {isMatrix ? "L·ªçc theo K√≠p:" : "Ch·ªçn K√≠p:"}
                    </div>
                    <Select
                        mode="multiple"
                        style={{ width: 200 }}
                        placeholder="T·∫•t c·∫£"
                        value={selectedKipIds}
                        onChange={setSelectedKipIds}
                        disabled={!selectedFactoryId}
                        options={kips.filter(k => k.factoryId === selectedFactoryId).map(k => ({ value: k.id, label: k.name }))}
                        allowClear
                    />
                </div>

                {/* 5. N√öT X√ìA */}
                <div style={{ marginTop: 20 }}>
                    <Button
                        danger
                        icon={<FilterOutlined />}
                        onClick={handleReset}
                        disabled={!selectedFactoryId}
                    />
                </div>
            </div>
        </Card>
    );
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\components\CommonFilter.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\components\SessionProviderWrapper.tsx
================================================================================
"use client"; // B·∫Øt bu·ªôc ph·∫£i c√≥ d√≤ng n√†y

import { SessionProvider } from "next-auth/react";

export default function SessionProviderWrapper({
  children,
}: {
  children: React.ReactNode;
}) {
  return <SessionProvider>{children}</SessionProvider>;
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\components\SessionProviderWrapper.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\lib\AntdRegistry.tsx
================================================================================
// src/lib/AntdRegistry.tsx
"use client";

import React from "react";
import { createCache, extractStyle, StyleProvider } from "@ant-design/cssinjs";
import type Entity from "@ant-design/cssinjs/es/Cache";
import { useServerInsertedHTML } from "next/navigation";

const StyledComponentsRegistry = ({ children }: React.PropsWithChildren) => {
  const cache = React.useMemo<Entity>(() => createCache(), []);
  useServerInsertedHTML(() => (
    <style
      id="antd"
      dangerouslySetInnerHTML={{ __html: extractStyle(cache, true) }}
    />
  ));
  return <StyleProvider cache={cache}>{children}</StyleProvider>;
};

export default StyledComponentsRegistry;


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\lib\AntdRegistry.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\lib\prisma.ts
================================================================================
// src/lib/prisma.ts
import { PrismaClient } from "@prisma/client";

const globalForPrisma = global as unknown as { prisma: PrismaClient };

export const prisma =
  globalForPrisma.prisma ||
  new PrismaClient({
    log: ["query"], // D√≤ng n√†y gi√∫p in ra c√¢u l·ªánh SQL ƒë·ªÉ b·∫°n d·ªÖ theo d√µi
  });

if (process.env.NODE_ENV !== "production") globalForPrisma.prisma = prisma;


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\lib\prisma.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\middleware.ts
================================================================================
import NextAuth from "next-auth";
import { authConfig } from "./auth.config";

// T·∫°o m·ªôt b·∫£n auth nh·∫π d√†nh ri√™ng cho Middleware
export default NextAuth(authConfig).auth;

export const config = {
  // Ch·∫°y tr√™n t·∫•t c·∫£ c√°c route tr·ª´ file tƒ©nh
  matcher: ["/((?!api|_next/static|_next/image|favicon.ico).*)"],
};


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\middleware.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\types\next-auth.d.ts
================================================================================
import NextAuth, { DefaultSession } from "next-auth";
import { JWT } from "next-auth/jwt";
import { Role } from "@prisma/client";

// ƒê·ªãnh nghƒ©a l·∫°i c√°c tr∆∞·ªùng m·ªü r·ªông
declare module "next-auth" {
  /**
   * M·ªü r·ªông ki·ªÉu Session (ƒë∆∞·ª£c tr·∫£ v·ªÅ t·ª´ useSession, auth())
   */
  interface Session {
    user: {
      id: string;
      username: string;
      fullName: string;
      role: Role;
      managedDeptIds: number[];
    } & DefaultSession["user"];
  }

  /**
   * M·ªü r·ªông ki·ªÉu User (ƒë∆∞·ª£c tr·∫£ v·ªÅ l√∫c login)
   */
  interface User {
    id: string;
    username: string;
    fullName: string;
    role: Role;
    managedDeptIds: number[];
  }
}

declare module "next-auth/jwt" {
  interface JWT {
    id: string;
    username: string;
    fullName: string;
    role: Role;
    managedDeptIds: number[];
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-HRM\phubai-hrm\src\types\next-auth.d.ts ---
